<lg-fade-in>
  <lg-container>
    <lg-flex-column>
      @let calculation = result()?.calculation;
      @let hasIngredients = (result()?.calculation?.ingredients?.length || 0) > 0;
      <lg-flex-row [center]="true" [mobileMode]="true">
        <lg-title>
          {{ result()?.calculation?.recipeName }} {{ 'recipe.calculation.title.after-text'  | translate }}
        </lg-title>

        @if (hasIngredients) {
          <lg-button [link]="'/recipes/edit/' + result()?.calculation?.recipeUuid"
                     [outlined]="true"
                     [size]="'tiny'"
                     [style]="'default'"
                     lgSelfStart>
            {{ 'edit-label' | translate }}
          </lg-button>
        }
      </lg-flex-row>

      @if (result()?.calculation?.totalPrice) {
        <lg-flex-row [mobileMode]="true"
                     style="max-width: 1200px"
                     lgExpand>
          <lg-flex-column [position]="'stretch'">
            @if (calculation?.hasWeight) {
              <lg-card size="small">
                <lg-flex-row [size]="'small'"
                             [mobileMode]="true"
                             [relaxed]="true">
                  <div>{{ 'recipe.calculation.outcome.label' | translate }}</div>

                  <lg-flex-row size="tiny">
                    <div class="text-bold">
                      {{ result()?.calculation?.outcomeAmount | number: pipesDigits() }}
                      {{ result()?.calculation?.outcomeUnit | unitString | translate }}
                    </div>

                    @if (hasPortions()) {
                      <span>/</span>

                      <div>
                        {{ result()?.calculation?.weightForUnit |  number: pipesDigits() }} {{ 'recipe.calculation.gram' | translate }}
                      </div>
                    }
                  </lg-flex-row>
                </lg-flex-row>
              </lg-card>

              <lg-card size="small">
                <lg-flex-row [size]="'small'"
                             [mobileMode]="true"
                             [relaxed]="true">
                  <div>
                    {{ 'recipe.calculation.one-unit.label' | translate }}
                    <b>{{ result()?.calculation?.outcomeUnit | unitString | translate }}</b>
                  </div>

                  <lg-flex-row size="tiny">
                    @let diff = result()?.calculation?.pricePerUnitFromTotalDifference ?? 0;
                    <lg-flex-row [size]="'tiny'">
                      <div [class.text-bold]="!result()?.calculation?.hasPriceDifference">
                        @if (hasPortions()) {
                          {{ result()?.calculation?.pricePerOutcomeUnit | userCurrency: pipesDigits() }}
                        } @else {
                          {{ result()?.calculation?.pricePerUnit | userCurrency:pipesDigits() }}
                        }
                      </div>

                      @if (result()?.calculation?.hasPriceDifference) {
                        <span>></span>
                        <div
                          class="text-underlined text-bold">{{ result()?.calculation?.pricePerUnitFromTotal |  userCurrency: pipesDigits() }}
                        </div>
                      }
                    </lg-flex-row>

                    @if (result()?.calculation?.hasPriceDifference) {
                      <lg-flex-row [size]="'tiny'"
                                   class="text-bold"
                                   [ngClass]="diff > 0 ? 'text-success' : 'text-danger'">
                        <span>(</span>
                        <div>
                          {{ diff > 0 ? '+' : '' }}{{ diff |  userCurrency: pipesDigits() }}
                        </div>
                        <span>)</span>
                      </lg-flex-row>
                    }
                  </lg-flex-row>
                </lg-flex-row>
              </lg-card>
            }

            <lg-flex-column [position]="'stretch'" size="small">
              <lg-card size="small">
                <lg-flex-row [size]="'small'"
                             [mobileMode]="true"
                             [relaxed]="true">
                  <div>{{ 'recipe.calculation.total-price.label' | translate }}</div>

                  <lg-flex-row [size]="'tiny'">
                    @let diff = totalPriceDifference();
                    <lg-flex-row [class.text-bold]="!totalPriceDifference()"
                                 size="tiny">
                      <div> {{ totalPrice() | userCurrency: totalPipesDigits }}</div>

                      @if (totalPriceDifference()) {
                        <span>></span>
                        <div class="text-bold text-underlined">
                          {{ totalPriceWithAdditions() |  userCurrency: pipesDigits() }}
                        </div>
                      }
                    </lg-flex-row>

                    @if (totalPriceDifference()) {
                      <lg-flex-row [ngClass]="diff > 0 ? 'text-success' : 'text-danger'"
                                   class="text-bold"
                                   size="tiny">
                        <span>(</span>
                        <div [ngClass]="diff > 0 ? 'text-success' : 'text-danger'">
                          {{ diff > 0 ? '+' : '' }}{{ diff |  userCurrency: pipesDigits() }}
                        </div>
                        <span>/</span>
                        <div class="text-no-wrap">{{ totalPriceProfit() |number:totalPipesDigits }}%</div>
                        <span>)</span>
                      </lg-flex-row>
                    }
                  </lg-flex-row>
                </lg-flex-row>
              </lg-card>

              <lg-flex-column [position]="'stretch'"
                              size="small"
                              [style.padding]="isMobile() ? '0' : '0 16px'"
                              style="--control-bg: var(--hr-bg-strong);">
                <lg-number-input lgParseMath
                                 [placeholder]="'recipe.calculation.recalculate.placeholder' | translate"
                                 [(ngModel)]="recalculateTotalsModel">
                  <ng-template lgExtraTpl place="before">
                    {{ 'recipe.calculation.recalculate.label'  | translate }}
                  </ng-template>

                  <ng-template lgExtraTpl place="after">
                    <b>
                      {{ result()?.calculation?.outcomeUnit | unitString | translate }}
                    </b>
                  </ng-template>
                </lg-number-input>

                <div>
                  {{ 'recipe.calculation.price-modifiers.title' | translate }}
                </div>

                <lg-calculation-price-modifiers
                  [formControl]="recipePriceAdditionsForm"
                  [recipeCost]="result()?.calculation"></lg-calculation-price-modifiers>
              </lg-flex-column>
            </lg-flex-column>
          </lg-flex-column>

          <lg-card lgWidth="270px" size="small">
            <lg-flex-column [fill]="true"
                            [size]="'small'">
              <lg-title [level]="5">
                <div>{{ 'recipe.calculation.price-chart' | translate }}</div>
              </lg-title>

              <canvas [data]="doughnutChartData().prices"
                      [options]="doughnutChartOptions"
                      [type]="doughnutChartType"
                      (chartHover)="onChartHover('price', $event.event, $event.active)"
                      #priceChart
                      baseChart>
              </canvas>
            </lg-flex-column>
          </lg-card>

          @if (calculation?.hasWeight) {
            <lg-card lgWidth="270px" size="small">
              <lg-flex-column [fill]="true"
                              [size]="'small'">
                <lg-title [level]="5">
                  <div>{{ 'recipe.calculation.weight-chart' | translate }}</div>
                </lg-title>

                <canvas [data]="doughnutChartData().weight"
                        [options]="doughnutChartOptions"
                        (chartHover)="onChartHover('weight', $event.event, $event.active)"
                        [type]="doughnutChartType"
                        #weightChart
                        baseChart>
                </canvas>
              </lg-flex-column>
            </lg-card>
          }
        </lg-flex-row>
      }


      <lg-title [level]="3">
        {{ 'recipe.calculation.table.title'  | translate }}
      </lg-title>

      @if (hasIngredients) {
        <lg-table-card>
          <table>
            <colgroup>
              <col span="1" style="width: 1%;">
              <col span="1" style="width: 20%;">
              <col span="1" style="width: 10%;">
              <col span="1" style="width: 7%;">
              <col span="1" style="width: 10%;">
            </colgroup>
            <thead>

            <tr>
              <th>#</th>
              <th>{{ 'recipe.calculation.table.name.title' | translate }}</th>
              <th>{{ 'recipe.calculation.table.amount.title' | translate }}</th>
              <th>{{ 'recipe.calculation.table.price.title' | translate }}</th>
              <th>{{ 'recipe.calculation.table.total.title' | translate }}</th>
            </tr>
            </thead>

            <tbody>
              @for (row of result()?.table; track $index; let i = $index) {
                <tr [ngClass]="row.type">
                  <td>{{ i + 1 }}</td>

                  <td width="200">
                    <div class="text-no-wrap"
                         [ngClass]="'indent-' + row.indent">
                      <!--                      <pre>{{row.ingredient|json}}</pre>-->
                      @if (row.type === 'recipe-row') {
                        <a [routerLink]="['/recipes/edit/' ,row.uuid]">
                          {{ row.name }}
                        </a>
                      } @else if (row.type == 'total') {
                        {{ row.name | translate }}
                      } @else {
                        <a [routerLink]="['/products/edit/', row.uuid]">
                          {{ productLabelFactory(row.ingredient?.product_id) }}
                        </a>
                      }
                    </div>
                  </td>

                  <td>
                    @if (row.type !== 'total') {
                      {{ row.amount | number: pipesDigits() }}
                    } @else {
                      {{ row.amount | number: totalPipesDigits }}
                    }
                    {{ row.unit | unitString | translate }}
                  </td>

                  <td class="text-no-wrap"
                      [class.text-muted]="row.ingredient?.hasMicroPerUnitPrice">
                    @if (row.ingredient?.hasMicroPerUnitPrice) {
                      {{ 'micro-amount'|translate }}
                      {{ userSettings()['currency']|currencySymbol }}
                    } @else {
                      {{ row.price_per_unit | userCurrency: pipesDigits() }}
                    }
                    <span [translateParams]="{unit:row.unit | unitString | translate}"
                          [translate]="'per-unit.label'"></span>
                  </td>

                  <td class="text-bold text-no-wrap">
                    @if (row.type !== 'total') {
                      @if (row.ingredient?.hasMicroTotalPrice) {
                        {{ 'micro-amount'|translate }}
                        {{ userSettings()['currency']|currencySymbol }}
                      } @else {
                        {{ row.total | userCurrency: pipesDigits() }}
                      }
                    } @else {
                      {{ row.total | userCurrency: totalPipesDigits }}
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </lg-table-card>
      } @else {
        <lg-flex-column position="start"
                        size="medium">
          {{ 'recipe.calculation.empty-state.text' | translate }}

          <lg-button [size]="'medium'"
                     [routerLink]="'/recipes/edit/' + result()?.calculation?.recipeUuid">
            {{ 'recipe.calculation.empty-state.btn' | translate }}
          </lg-button>
        </lg-flex-column>
      }
    </lg-flex-column>
  </lg-container>
</lg-fade-in>
