<!doctype html>
<html id="html-root" lang="en">
<head>
  <meta charset="utf-8">
  <title>What does lasagna cost?</title>
  <base href="/">
  <meta content="width=device-width, initial-scale=1,viewport-fit=cover" name="viewport">
  <link href="favicon.png" rel="icon" type="image/png">
  <link href="logo.png" rel="apple-touch-icon">
  <link href="manifest.webmanifest" rel="manifest">
  <meta content="#F6B0DB" name="theme-color">
  <meta content="yes" name="mobile-web-app-capable"/>
  <meta content="yes" name="apple-touch-fullscreen"/>
  <meta content="Lasagna" name="apple-mobile-web-app-title"/>
  <meta content="yes" name="apple-mobile-web-app-capable"/>
  <meta content="default" name="apple-mobile-web-app-status-bar-style"/>

  <link href="/img/splash_screens/iPhone_17_Pro_Max__iPhone_16_Pro_Max_landscape.png"
        media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_landscape.png"
        media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_landscape.png"
        media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_Air_landscape.png"
        media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_landscape.png"
        media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_landscape.png"
        media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link
    href="/img/splash_screens/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_landscape.png"
    media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_landscape.png"
        media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_11_Pro_Max__iPhone_XS_Max_landscape.png"
        media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_11__iPhone_XR_landscape.png"
        media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_landscape.png"
        media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_landscape.png"
        media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/4__iPhone_SE__iPod_touch_5th_generation_and_later_landscape.png"
        media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/13__iPad_Pro_M4_landscape.png"
        media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/12.9__iPad_Pro_landscape.png"
        media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/11__iPad_Pro_M4_landscape.png"
        media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/11__iPad_Pro__10.5__iPad_Pro_landscape.png"
        media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.9__iPad_Air_landscape.png"
        media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.5__iPad_Air_landscape.png"
        media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.2__iPad_landscape.png"
        media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_landscape.png"
        media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/8.3__iPad_Mini_landscape.png"
        media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_17_Pro_Max__iPhone_16_Pro_Max_portrait.png"
        media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_portrait.png"
        media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_portrait.png"
        media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_Air_portrait.png"
        media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_portrait.png"
        media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_portrait.png"
        media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link
    href="/img/splash_screens/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_portrait.png"
    media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_portrait.png"
        media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_11_Pro_Max__iPhone_XS_Max_portrait.png"
        media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_11__iPhone_XR_portrait.png"
        media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_portrait.png"
        media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_portrait.png"
        media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/4__iPhone_SE__iPod_touch_5th_generation_and_later_portrait.png"
        media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/13__iPad_Pro_M4_portrait.png"
        media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/12.9__iPad_Pro_portrait.png"
        media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/11__iPad_Pro_M4_portrait.png"
        media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/11__iPad_Pro__10.5__iPad_Pro_portrait.png"
        media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.9__iPad_Air_portrait.png"
        media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.5__iPad_Air_portrait.png"
        media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/10.2__iPad_portrait.png"
        media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_portrait.png"
        media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">
  <link href="/img/splash_screens/8.3__iPad_Mini_portrait.png"
        media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
        rel="apple-touch-startup-image">

  <script>
    (function () {
      const START_TIMEOUT = 20000;
      const CHECK_INTERVAL = 300;
      let started = false;
      const logs = [];

      // --- Перехват console ошибок ---
      const origConsoleError = console.error;
      console.error = function (...args) {
        logs.push({type: 'console.error', args, time: Date.now()});
        origConsoleError.apply(console, args);
      };

      const origConsoleWarn = console.warn;
      console.warn = function (...args) {
        logs.push({type: 'console.warn', args, time: Date.now()});
        origConsoleWarn.apply(console, args);
      };

      // --- Глобальные ошибки ---
      window.addEventListener('error', function (e) {
        logs.push({type: 'window.error', msg: e.message, filename: e.filename, lineno: e.lineno});
      });
      window.addEventListener('unhandledrejection', function (e) {
        logs.push({type: 'unhandledrejection', reason: e.reason});
      });

      // --- Проверка, запустился ли Angular ---
      function hasAngularStarted() {
        return !!document.querySelector('[ng-version]');
      }

      window.addEventListener('AngularStarted', function (e) {
        console.log('AngularStarted event detected');
        started = true;
      });

      const t0 = Date.now();
      const timer = setInterval(function () {
        if (started || hasAngularStarted()) {
          clearInterval(timer);
          return;
        }

        if (Date.now() - t0 > START_TIMEOUT) {
          clearInterval(timer);
          handleTimeout();
        }
      }, CHECK_INTERVAL);

      function handleTimeout() {
        const resources = performance.getEntriesByType('resource')
          .map(function (r) {
            return {
              name: r.name,
              type: r.initiatorType,
              duration: Math.round(r.duration),
              transferSize: r.transferSize
            }
          });

        const payload = {
          message: 'Angular app failed to start within 10s',
          userAgent: navigator.userAgent,
          online: navigator.onLine,
          connection: navigator.connection?.effectiveType,
          url: location.href,
          resources,
          consoleLogs: logs.slice(-50)
        };

        console.warn('Startup timeout detected', payload);

        showFailureModal(payload);
        sendToSentry(payload);
      }

      // --- Кастомная модалка ---
      function showFailureModal(data) {
        const modal = document.createElement('div');
        Object.assign(modal.style, {
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.65)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 9999,
          fontFamily: 'sans-serif'
        });

        modal.innerHTML = `
      <div style="background:#fff;padding:24px 28px;border-radius:12px;max-width:440px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.25)">
        <h2 style="margin-top:0;">Приложение не загрузилось 😕</h2>
        <p>Кажется, что-то пошло не так. Хотите отправить отчёт, чтобы мы починили?</p>
        <input id="emailInput" placeholder="Ваш email (необязательно)" style="width:100%;padding:8px 10px;margin:8px 0;border:1px solid #ccc;border-radius:6px;font-size:14px;"
          type="email"/>
        <button id="sendReportBtn"
          style="background:#007bff;color:#fff;border:none;border-radius:6px;padding:10px 18px;margin-top:8px;cursor:pointer;font-size:14px;">
          Отправить отчёт
        </button>
        <p id="statusMsg" style="margin-top:12px;color:#444;font-size:14px;display:none;"></p>
        <br><br>
       <a href="https://lasagnacost.ru/home" style="font-size: 12px; opacity: 0.8">Если вы находитесь в России, для вас будет удобнее использовать оптимизированное приложение lasagnacost.ru</a>
     </div>
    `;
        document.body.appendChild(modal);

        const btn = modal.querySelector('#sendReportBtn');
        const emailInput = modal.querySelector('#emailInput');
        const statusMsg = modal.querySelector('#statusMsg');

        btn.onclick = function () {
          btn.disabled = true;
          btn.textContent = 'Отправляем...';
          sendToSentry(data, true, emailInput.value);
          btn.style.display = 'none';
          emailInput.style.display = 'none';
          statusMsg.textContent = 'Спасибо! Зайдите в приложение позднее 💙';
          statusMsg.style.display = 'block';

          setTimeout(() => {
            window.location.reload();
          }, 2000)
        };
      }

      // --- Отправка в Sentry ---
      function sendToSentry(data, showDialog = false, email = null) {
        if (!window.Sentry) {
          console.warn('Sentry SDK not loaded yet.');
          return;
        }

        if (email) {
          // Устанавливаем email для контекста пользователя
          window.Sentry.setUser({email});
        }

        const err = new Error(data.message);

        window.Sentry.captureException(err, {
          level: 'error',
          tags: {
            stage: 'pwa_startup',
            cause: 'timeout_10s'
          },
          extra: data
        });

        // После отправки очищаем, чтобы не “прилипло” к следующему событию
        if (email) {
          window.Sentry.setUser(null);
        }
      }

      // --- Подключаем Sentry, если не подключен ---
      if (!window.Sentry) {
        const script = document.createElement('script');
        script.src = 'https://browser.sentry-cdn.com/10.19.0/bundle.tracing.replay.min.js';
        script.crossOrigin = 'anonymous';
        script.integrity = 'sha384-9jBRZL7VtE2wKJdi3L8yhjcqeXGUASfuWtw7t6fTPhWBrF8Gcom99en+s9OiqBUA';
        script.onload = function () {
          window.Sentry.init({
            dsn: "https://6f5f68ff28550996e10e8c4a49edc46e@o4509209983057920.ingest.de.sentry.io/4509209987645520",
            release: 'pwa-watchdog@1.0.0',
            sendDefaultPii: true,
            tracesSampleRate: 0,
            integrations: [
              Sentry.replayIntegration()
            ],
            replaysOnErrorSampleRate: 1.0, // If you're not already sampling the entire session, change the sample rate to 100% when sampling sessions where errors occur.
            beforeSend(event) {
              if (event.extra?.resources?.length > 50) {
                event.extra.resources = event.extra.resources.slice(-50);
              }
              return event;
            }
          });
        };
        document.head.appendChild(script);
      }
    })();
  </script>
</head>
<body>
<app-root></app-root>
<noscript>Please enable JavaScript to continue using this application.</noscript>
<script defer src="detect-language.js"></script>
<script defer src="pwa-update-compoent.js"></script>
<script defer src="google-analytics-consent.js"></script>
</body>
</html>
