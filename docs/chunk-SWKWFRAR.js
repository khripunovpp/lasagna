import{c as P}from"./chunk-ICIIFJYZ.js";import{a as _,g as k}from"./chunk-ZCOBSX6T.js";import{U as b,Y as x}from"./chunk-VOOOUGHD.js";import{a as y,b as R,f as l}from"./chunk-2WH2EVR6.js";var f=class{constructor(e){this.recipe=e}result;get totalAmount(){return this.recipe?this.recipe.ingredients.reduce((e,t)=>e+t.totalAmountGram,0):0}get totalWeight(){return 0}};var A=class p{constructor(e,t){this._recipeRepository=e;this._productRepository=t}calculation;linkTaxTemplate(e,t){return new Promise((a,i)=>l(this,null,function*(){yield this._recipeRepository.getOne(e).then(o=>l(this,null,function*(){if(!o){a(null);return}o.taxTemplateName=t,yield this._recipeRepository.editRecipe(o.uuid,o),a(o)}))}))}calculateRecipe(e,t=0){return new Promise((a,i)=>l(this,null,function*(){let o=[],n=0,d=0,h=yield this._recipeRepository.getOne(e,!0),s=new f(h);console.log({calculation:s,totalAmount:s.totalAmount}),yield this._recipeRepository.getOne(e).then(u=>l(this,null,function*(){let m=(t||u?.outcome_amount||1)/(u?.outcome_amount||1),{table:r,totalAmount:T,totalWeight:g}=yield this._makeIngredientTable(u,m);n+=T||0,d+=g||0,o.push(...r),o.push(this._makeTotal(n,d)),a({recipe:u,result:o,total:n,totalWeight:d})}))}))}getRecipe(e){return l(this,null,function*(){if(!e)return;let t=yield this._recipeRepository.getOne(e);if(!t)return;let a=0;return t.outcome_unit&&t.outcome_amount?a=t.outcome_amount:a=t?.ingredients?.reduce((i,o)=>{if(o.unit!=="gram")return i;let n=_(o.amount)||0;return i+n},0)??0,R(y({totalAmountInGrams:a||0},t.toDTO()),{pricePerUnit:0})})}_makeRecipeSubTable(e,t=0){return l(this,null,function*(){return new Promise((a,i)=>l(this,null,function*(){let o=[],n=0,d=0,h=e.amount;yield this.getRecipe(e.recipe_id).then(s=>l(this,null,function*(){let u=h/(s?.totalAmountInGrams||1),m=yield this._makeIngredientTable(s,t);m.table=m.table.map((c,w)=>{let I=(c.amount||0)*(t||1)*u;return R(y({},c),{amount:parseFloat((I||0).toFixed(5)),total:parseFloat((c.total?c.total*u:0).toFixed(5)),indent:c.indent+1})});let r=m.totalAmount?m.totalAmount/m.totalWeight:0,T=(s?.totalAmountInGrams||0)*t*u,g=m.totalAmount*u;o.push(this._makeRecipeCaption({name:s?.name||"Unknown recipe",price_per_gram:r,amount:T,total:g,unit:e.unit,uuid:s?.uuid||""})),o.push(...m.table),d+=g,n+=m.totalWeight*u,a({table:o,totalAmount:d,totalWeight:n})}))}))})}_makeIngredientTable(e,t=0){let a=[],i=0,o=0;return Promise.all(e?.ingredients.map((n,d)=>l(this,null,function*(){let h=n.recipe_id,s=n.product_id,u=n.name;if(!h&&!s&&!u){let m=n.amount;return}if(h){let m=yield this._makeRecipeSubTable(n,t);a.push(...m.table),o+=m.totalAmount,i+=m.totalWeight}else if(s){let m=yield this._productRepository.getOne(n.product_id).then(r=>l(this,null,function*(){if(!r){a.push(this._makeRow({name:"Unknown product",price_per_gram:void 0,amount:n.amount*(t||1),total:void 0,uuid:r?.uuid||""}));return}if(!r?.price){a.push(this._makeRow({name:r.name,price_per_gram:0,amount:n.amount*(t||1),total:0,uuid:r?.uuid||""}));return}if(!r?.amount){a.push(this._makeRow({name:r.name,price_per_gram:0,amount:n.amount*(t||1),total:0,uuid:r?.uuid||""}));return}let T=n.amount*(t||1),g=(_(r.price)||1)/(_(r.amount)||1),c=g*(_(T)||1),w=r.unit==="gram"||!r.unit;a.push(this._makeRow({name:r.name,price_per_gram:g,amount:T,total:c,unit:r.unit,uuid:r?.uuid||""})),o+=c,w&&(i+=+T)}))}else u&&(a.push(this._makeRow({name:n.name??"Unknown ingredient",price_per_gram:void 0,amount:n.amount*(t||1),total:void 0,uuid:""})),i+=+n.amount*(t||1))}))??[]).then(()=>({table:a,totalAmount:o,totalWeight:i}))}_makeRow(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram?.toFixed(5)??"0"),amount:e.amount,total:parseFloat(e.total?.toFixed(5)??"0"),unit:e.unit||"gram",indent:e.indent??0,type:"row",uuid:e.uuid}}_makeCaption(e){return{name:e,unit:void 0,price_per_gram:void 0,amount:void 0,total:void 0,indent:0,type:"caption"}}_makeRecipeCaption(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram.toFixed(5)),amount:e.amount,total:parseFloat(e.total.toFixed(2)),unit:e.unit||"gram",indent:0,type:"recipe-row",uuid:e.uuid}}_makeTotal(e,t){return{name:"Total (without taxes and fees)",amount:t,unit:"gram",price_per_gram:parseFloat((e/t).toFixed(5)),total:parseFloat(e.toFixed(2)),indent:0,type:"total"}}static \u0275fac=function(t){return new(t||p)(x(P),x(k))};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};var v=class p{constructor(){}getTemplates(e){let t=localStorage.getItem(this.getStorageKey(e));return t?JSON.parse(t):[]}getTemplateById(e,t){return this.getTemplates(e).find(i=>i.id===t)}getTemplateByName(e,t){return this.getTemplates(e).find(i=>i.name===t)}saveTemplate(e,t){let a=this.getTemplates(e);this._checkUniqName(a,t.name)?(a.push(t),this._storeTemplates(e,a)):this.updateTemplateData(e,t.name,t.data)}updateTemplateData(e,t,a){let i=this.getTemplates(e),o=i.find(n=>n.name===t);o&&(o.data=a,this._storeTemplates(e,i))}deleteTemplate(e,t){let a=this.getTemplates(e).filter(i=>i.id!==t);this._storeTemplates(e,a)}updateTemplate(e,t){let a=this.getTemplates(e).map(i=>i.id===t.id?t:i);this._storeTemplates(e,a)}_checkUniqName(e,t){return!e.some(a=>a.name===t)}getStorageKey(e){return`template-${e}`}_storeTemplates(e,t){localStorage.setItem(this.getStorageKey(e),JSON.stringify(t))}static \u0275fac=function(t){return new(t||p)};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{A as a,v as b};
