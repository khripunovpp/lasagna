import{b as ye,e as Se,i as xe,p as ve}from"./chunk-MQ26JLPX.js";import{c as z,d as L}from"./chunk-4IYXQRQ2.js";import{a as B}from"./chunk-FTNH4PRO.js";import{a as W}from"./chunk-PFLOR5BA.js";import{b as he}from"./chunk-42ANHTC5.js";import{b as ge,d as Ce,e as we}from"./chunk-2WRE22FH.js";import{$ as U,$b as _e,Ac as P,Cb as ae,Cc as fe,Db as se,Dc as S,Eb as a,Fb as s,Jb as H,Kb as h,Nb as m,Ob as c,Pb as x,Qb as v,T as Z,Tb as ce,Ub as pe,V as $,Vb as de,Wb as me,Xa as p,Xb as V,Yb as F,Za as oe,Zb as ue,_b as u,a as te,ab as j,b as ne,cc as b,da as J,dc as T,ec as D,f as I,fb as y,hb as re,hc as K,ka as _,kb as q,la as f,lc as X,m as Q,mc as Y,ra as ie,sb as d,tb as le,ub as G,vb as g,yb as C,yc as N,zb as w,zc as R}from"./chunk-7IKCFNVS.js";var O=class o{constructor(n){this.templateRef=n}static \u0275fac=function(e){return new(e||o)(j(oe))};static \u0275dir=re({type:o,selectors:[["","lgImportRowTpl",""]]})};var A=class o{constructor(){}readFromCSVFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{let r=i.result,l=this.parseData(r),[Ae,...Me]=l,Ie=this.arrayToObjects(Me,Ae);e(Ie)},i.onerror=()=>{t(i.error)},i.readAsText(n)})}readFromJSONFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{try{let r=i.result,l=JSON.parse(r);e(l)}catch(r){t(r)}},i.onerror=()=>{t(i.error)},i.readAsText(n)})}parseData(n){return n.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(n,e){return n.map(t=>{let i={};return e.forEach((r,l)=>{i[r]=t[l]}),i})}makeCsv(n){let e=Object.keys(n[0]),t=n.map(r=>e.map(l=>r[l]));return[e,...t].map(r=>r.join(",")).join(`\r
`)}saveToCSVFile(n,e){let t=this.makeCsv(n),i=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(i),l=document.createElement("a");document.body.appendChild(l),l.setAttribute("href",r),l.setAttribute("download",e),l.click(),URL.revokeObjectURL(r)}saveToJSONFile(n,e){let t=JSON.stringify(n,null,2),i=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(i),l=document.createElement("a");document.body.appendChild(l),l.setAttribute("href",r),l.setAttribute("download",e),l.click(),URL.revokeObjectURL(r)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=U({token:o,factory:o.\u0275fac,providedIn:"root"})};var je=["input"],Fe=["*"],M=class o{filesSelected=N();accept=R(".csv");input=P("input");onFileChange(n){let t=n.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&V(t.input,je,5),e&2&&F()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Fe,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let i=h();x(),a(0,"div",1),m("click",function(){_(i);let l=ue(2);return f(l.click())}),a(1,"input",2,0),m("change",function(l){return _(i),f(t.onFileChange(l))}),s(),a(3,"div",3),v(4),s()()}e&2&&(p(),d("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Re=["*"],E=class o{constructor(){}displayed=ie(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Re,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(x(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),v(5),s()()()()()),e&2&&le("display",t.displayed()?"flex":"none")},dependencies:[he],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var Ee=o=>({$implicit:o,flow:"new"}),Ue=o=>({$implicit:o,flow:"old"}),Ve=(o,n)=>n.name+n.uuid;function Ne(o,n){if(o&1){let e=h();a(0,"input",9),D("ngModelChange",function(i){_(e);let r=c().$implicit,l=c(3);return T(l.rowsToUpdate[r.name],i)||(l.rowsToUpdate[r.name]=i),f(i)}),s(),u(1," Update ")}if(o&2){let e=c().$implicit,t=c(3);b("ngModel",t.rowsToUpdate[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Pe(o,n){if(o&1){let e=h();a(0,"input",10),D("ngModelChange",function(i){_(e);let r=c().$implicit,l=c(3);return T(l.rowsToAdd[r.name],i)||(l.rowsToAdd[r.name]=i),f(i)}),s(),u(1," Add ")}if(o&2){let e=c().$implicit,t=c(3);b("ngModel",t.rowsToAdd[e.name]),d("disabled",t.rowsToSkip[e.name])}}function ze(o,n){o&1&&H(0)}function We(o,n){if(o&1&&q(0,ze,1,0,"ng-container",11),o&2){let e=c().$implicit,t=c(3);d("ngTemplateOutlet",t.rowTemplate().templateRef)("ngTemplateOutletContext",K(2,Ee,e))}}function Le(o,n){o&1&&H(0)}function Be(o,n){if(o&1&&q(0,Le,1,0,"ng-container",11),o&2){let e=c(2).$implicit,t=c(),i=c(2);d("ngTemplateOutlet",i.rowTemplate().templateRef)("ngTemplateOutletContext",K(2,Ue,t[e.uuid]||t[e.name]))}}function Qe(o,n){if(o&1){let e=h();a(0,"div",12)(1,"input",9),D("ngModelChange",function(i){_(e);let r=c().$implicit,l=c(3);return T(l.rowsToSkip[r.name],i)||(l.rowsToSkip[r.name]=i),f(i)}),s(),a(2,"span"),u(3),s(),C(4,Be,1,4,"ng-container"),s()}if(o&2){let e=c().$implicit,t=c(3);G("disabled",t.rowsToUpdate[e.name])("skip",t.rowsToUpdate[e.name]),d("ngClass",t.rowsToSkip[e.name]?"skip":"duplicated"),p(),b("ngModel",t.rowsToSkip[e.name]),d("disabled",t.rowsToAdd[e.name]||t.rowsToUpdate[e.name]),p(2),_e(t.rowsToSkip[e.name]?"Skip":"Duplicates"),p(),w(t.rowTemplate()?4:-1)}}function Ze(o,n){if(o&1&&(a(0,"lg-gap-column",6)(1,"div",7),C(2,Ne,2,2)(3,Pe,2,2),C(4,We,1,4,"ng-container"),s(),C(5,Qe,5,9,"div",8),s()),o&2){let e=n.$implicit,t=c(),i=c(2);d("size","small"),p(),G("update",i.rowsToUpdate[e.name])("add",i.rowsToAdd[e.name])("disabled",i.rowsToSkip[e.name]),p(),w(t[e.uuid]||t[e.name]?2:3),p(2),w(i.rowTemplate()?4:-1),p(),w(t[e.uuid]||t[e.name]?5:-1)}}function $e(o,n){if(o&1&&(a(0,"lg-gap-column",6),ae(1,Ze,6,10,"lg-gap-column",6,Ve),s()),o&2){let e=c();d("size","medium"),p(),se(e)}}function Je(o,n){if(o&1&&(C(0,$e,3,1,"lg-gap-column",6),X(1,"async")),o&2){let e,t=c();w((e=Y(1,1,t.analize$))?0:-1,e)}}var Te=class o{constructor(n,e){this._csvReaderService=n;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=N();storeName=R(null);schema=R();skipAllDuplicates=S(!1);replaceAll=S(!1);rowTemplate=fe(O);analizeSubject=new Q;dataSubject=new Q;data$=this.dataSubject.asObservable().pipe($([]),Z((n,e)=>e==null?[]:[...n,e]));analize$=this.analizeSubject.asObservable().pipe($([]),Z((n,e)=>e==null?[]:!e.uuid||!e.name?n:ne(te({},n),{[e.uuid]:e,[e.name]:e})));dialog;upload=P(M);parsedData=[];onConfirm(){return I(this,null,function*(){for(let n of this.parsedData)this.rowsToAdd[n.name]?yield this._indexDbService.addData(this.storeName(),n):this.rowsToUpdate[n.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),n.uuid,n));this.clear(),this.onDone.emit(),this.dialog.close()})}onClose(){this.clear(),this.dialog.close()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToUpdate[n.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToSkip[n.name]=!0,this.rowsToUpdate[n.name]&&(this.rowsToUpdate[n.name]=!1))}):this.rowsToSkip={}}onFileSelected(n){this.dialog.open(),this._csvReaderService.readFromJSONFile(n[0]).then(e=>I(this,null,function*(){for(let t of e){let i=this.schema()?.safeParse(t);if(!i?.success){console.log("error",i?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(i.data),yield this._analyzeDuplicates(i.data).then(r=>{r.duplicate?this.analizeSubject.next(r.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(n){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",n.name).then(i=>{i.length?e({data:i,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(j(A),j(z))};static \u0275cmp=y({type:o,selectors:[["lg-import"]],contentQueries:function(e,t,i){e&1&&me(i,t.rowTemplate,O,5),e&2&&F()},viewQuery:function(e,t){if(e&1&&(V(t.upload,M,5),ce(E,5)),e&2){F();let i;pe(i=de())&&(t.dialog=i.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:20,vars:23,consts:[[3,"filesSelected","accept"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(a(0,"lg-upload",0),m("filesSelected",function(r){return t.onFileSelected(r)}),a(1,"lg-button",1),u(2," Import "),s()(),a(3,"lg-dialog")(4,"lg-gap-column"),C(5,Je,2,3),X(6,"async"),a(7,"lg-gap-row",2)(8,"input",3),m("change",function(){return t.onSkipAllDuplicates()}),D("ngModelChange",function(r){return T(t.skipAllDuplicates,r)||(t.skipAllDuplicates=r),r}),s(),a(9,"label"),u(10,"Skip all duplicates"),s()(),a(11,"lg-gap-row",2)(12,"input",3),m("change",function(){return t.onReplaceAll()}),D("ngModelChange",function(r){return T(t.replaceAll,r)||(t.replaceAll=r),r}),s(),a(13,"label"),u(14,"Replace all with new"),s()(),a(15,"lg-gap-row",4)(16,"lg-button",5),m("click",function(){return t.onClose()}),u(17," Close "),s(),a(18,"lg-button",5),m("click",function(){return t.onConfirm()}),u(19," Confirm "),s()()()()),e&2){let i;d("accept",".json"),p(),g("warning"),d("flat",!0)("size","small"),p(4),w((i=Y(6,21,t.data$))?5:-1,i),p(2),d("center",!0)("hidden",t.replaceAll())("size","small"),p(),b("ngModel",t.skipAllDuplicates),p(3),d("center",!0)("hidden",t.skipAllDuplicates())("size","small"),p(),b("ngModel",t.replaceAll),p(3),d("center",!0),p(),g("danger"),d("size","small"),p(2),g("success"),d("size","small")}},dependencies:[M,L,E,we,W,B,ve,ye,Se,xe,ge,Ce],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var qe=["*"];function Ge(o,n){if(o&1){let e=h();a(0,"lg-button",2),m("click",function(){_(e);let i=c();return f(i.onSelection())}),u(1," Hide selection "),s(),a(2,"lg-button",2),m("click",function(){_(e);let i=c();return f(i.onAllSelection())}),u(3," Select all "),s(),a(4,"lg-button",2),m("click",function(){_(e);let i=c();return f(i.onDeselectAll())}),u(5," Deselect all "),s()}o&2&&(g("success"),d("flat",!0)("size","small"),p(2),g("danger"),d("flat",!0)("size","small"),p(2),g("danger"),d("flat",!0)("size","small"))}function He(o,n){if(o&1){let e=h();a(0,"lg-button",2),m("click",function(){_(e);let i=c();return f(i.onSelection())}),u(1," Select many "),s()}o&2&&(g("success"),d("flat",!0)("size","small"))}var De=class o{constructor(){}selectionMode=S("default");selectAll=S(!1);deselectAll=S(!1);selected=S(new Set);onSelection(){this.selectionMode.set(this.selectionMode()==="default"?"selection":"default"),this.selected.set(new Set)}onAllSelection(){this.selectAll.set(!0),this.deselectAll.set(!1)}onDeselectAll(){this.selectAll.set(!1),this.deselectAll.set(!0)}putSelected(n){let[e,t]=n;this.selected.update(i=>(e?i.add(t):i.delete(t),i)),console.log("selected",this.selected())}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-selection-zone"]],inputs:{selectionMode:[1,"selectionMode"],selectAll:[1,"selectAll"],deselectAll:[1,"deselectAll"],selected:[1,"selected"]},outputs:{selectionMode:"selectionModeChange",selectAll:"selectAllChange",deselectAll:"deselectAllChange",selected:"selectedChange"},ngContentSelectors:qe,decls:5,vars:2,consts:[[3,"center"],[3,"flat","size","style"],[3,"click","flat","size"]],template:function(e,t){e&1&&(x(),a(0,"lg-gap-column")(1,"lg-gap-row",0),C(2,Ge,6,12)(3,He,2,4,"lg-button",1),s(),v(4),s()),e&2&&(p(),d("center",!0),p(),w(t.selectionMode()==="selection"?2:3))},dependencies:[L,W,B],encapsulation:2})};var ke=class o{constructor(n,e){this._indexDbService=n;this._csvReaderService=e}exportTable(i){return I(this,arguments,function*(n,e="csv",t={}){let r=[];if(t.selected?.length?r=yield this._indexDbService.getMany(n,t.selected):r=yield this._indexDbService.getAll(n),e==="json"){this._csvReaderService.saveToJSONFile(r,this._getFileName(n,e));return}this._csvReaderService.saveToCSVFile(r,this._getFileName(n,e))})}makeCsv(n){return this._csvReaderService.makeCsv(n)}_getFileName(n,e){let t=new Date().toISOString();return`${n}_export_${t}.${e}`}static \u0275fac=function(e){return new(e||o)(J(z),J(A))};static \u0275prov=U({token:o,factory:o.\u0275fac,providedIn:"root"})};var jt=(o,n)=>o.reduce((e,t)=>{let i=t[n]||"unknown";return e[i]||(e[i]=[]),e[i].push(t),e},{});export{O as a,A as b,Te as c,jt as d,De as e,ke as f};
