import{a as f}from"./chunk-ZG5DSIBK.js";import{a as e}from"./chunk-BBWM53XJ.js";import{a as p,b as y}from"./chunk-IPKCCBOY.js";import{g}from"./chunk-LT4T7YA7.js";import{U as m,Y as a,f as d}from"./chunk-SYQBEC7E.js";import{f as s}from"./chunk-2WH2EVR6.js";var c=n=>{if(typeof n=="number")return n;if(typeof n=="string"){let r=n.replace(",","."),t=parseFloat(r);return isNaN(t)?null:t}return null};var _=e.object({name:e.string(),price:e.number().or(e.string()),amount:e.number().or(e.string()),source:e.string(),category_id:e.string().nullable().optional(),uuid:e.string().optional(),unit:e.string()});var P=class n{constructor(r,t,o,i){this._indexDbService=r;this._categoryRepository=t;this._usingHistoryService=o;this._draftFormsService=i}_stream$=new d;get products$(){return this._stream$.asObservable()}loadRecipes(){return this._indexDbService.getAll("productsStore").then(r=>(this._stream$.next(r),r))}addProduct(r){return this._indexDbService.addData("productsStore",this._toDbValue(r)).then(t=>(r.category_id&&this._saveCategory(r.category_id),r.source&&this._saveSource(r.source),this._saveProductToHistory(t),t))}getOne(r){return s(this,null,function*(){return new Promise((t,o)=>s(this,null,function*(){if(!r){t(void 0);return}r=r.uuid||r,yield this._indexDbService.getOne("productsStore",r).then(i=>{t(i)})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}getLastProducts(){let{top:r}=this._usingHistoryService.read("products"),t=Object.keys(r);return t.length===0?Promise.resolve([]):this._indexDbService.getMany("productsStore",t).then(o=>o.toSorted((i,u)=>r[u.uuid].count>r[i.uuid].count?1:-1).map(i=>({product:i,updatedAt:r[i.uuid].updatedAt,count:r[i.uuid].count})))}editProduct(r,t){return s(this,null,function*(){yield this._indexDbService.replaceData("productsStore",r,this._toDbValue(t)),this._saveProductToHistory(r)})}deleteProduct(r){return this._indexDbService.remove("productsStore",r)}makeFromData(r){return Array.isArray(r)?r.map(t=>({uuid:t.uuid,name:t.name,price:t.price,amount:t.amount,source:t.source,category_id:t.category_id,unit:t.unit})):{uuid:r.uuid,name:r.name,price:r.price,amount:r.amount,source:r.source,category_id:r.category_id,unit:r.unit}}getTopCategories(){let{top:r}=this._usingHistoryService.read("products_categories"),t=Object.keys(r);return this._categoryRepository.getManyCategories(t).then(o=>o.toSorted((i,u)=>r[u.uuid].count>r[i.uuid].count?1:-1))}getTopSources(){return s(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(r,t){return this._draftFormsService.setDraftForm("draft_products",r,t?.length?"edit":"add",t?{uuid:t}:{})}updateDraftProduct(r,t,o){return this._draftFormsService.updateDraftForm("draft_products",t,r,o?.length?"edit":"add",o?{uuid:o}:{})}getDraftProducts(r){let t=this._draftFormsService.getDraftForms("draft_products");return r&&t?.[r]?[t?.[r]]:t?Object.values(t):[]}removeDraftProduct(r){this._draftFormsService.removeDraftForm("draft_products",r)}_toDbValue(r){return r!=null?_.parse({name:String(r.name||""),price:c(r.price)||0,amount:c(r.amount)||0,source:String(r.source||""),category_id:String(r.category_id||""),unit:String(r.unit||"")}):null}_saveCategory(r){this._usingHistoryService.count("products_categories",r)}_saveSource(r){this._usingHistoryService.count("products_sources",r)}_saveProductToHistory(r){this._usingHistoryService.count("products",r)}static \u0275fac=function(t){return new(t||n)(a(g),a(f),a(p),a(y))};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{c as a,_ as b,P as c};
