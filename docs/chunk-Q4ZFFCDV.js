import{a as je}from"./chunk-K5DQMW66.js";import{a as Ve,b as Pe}from"./chunk-OGFSV377.js";import{a as ae,b as z,c as B}from"./chunk-MWFZAAYT.js";import"./chunk-GSWW333I.js";import{a as Ae}from"./chunk-5JM7SBCC.js";import{a as Me,b as Ge,c as Oe}from"./chunk-KSONETDE.js";import{f as De}from"./chunk-KXBJ5KW3.js";import{a as N}from"./chunk-ETPBTK6B.js";import{a as ke,b as Ne,c as $e}from"./chunk-AE7VNXL7.js";import{a as Ee}from"./chunk-NVFEA3DU.js";import{a as Te}from"./chunk-P6RB7BRR.js";import{a as Ie}from"./chunk-YJU6N6KC.js";import{b as H}from"./chunk-5BXU3IBH.js";import{a as fe}from"./chunk-NOAISKLM.js";import{a as Q,d as ge,f as Ce,g as Re,h as K,i as h,k as he,m as ve,n as xe,o as we,p as ye,q as be,r as Se,s as Fe}from"./chunk-QUOF2WSA.js";import{a as ue}from"./chunk-HVINHRVA.js";import{a as pe,b as se,c as _e}from"./chunk-EZZ7OFHX.js";import"./chunk-LI2AZUAT.js";import"./chunk-HG4USQGA.js";import{a as de}from"./chunk-XINH5I7V.js";import{a as me}from"./chunk-WG6RLDGA.js";import"./chunk-SNDQO5FA.js";import{o as U,r as L}from"./chunk-GRZ5ELRS.js";import"./chunk-AUMTO3XJ.js";import{Ab as l,Bb as v,Cb as F,Db as A,F as M,Fb as R,Ib as f,Jb as a,Kb as P,Lb as D,Sa as c,Sb as I,Tb as G,Ub as k,Vb as m,Wb as ie,Xa as C,Xb as O,ab as b,ac as oe,ea as d,fa as u,gc as ne,hc as re,la as x,nb as p,pb as Z,pc as le,qb as V,qc as ce,r as X,tb as _,ub as g,uc as T,vc as j,wc as $,xb as ee,yb as te,zb as r}from"./chunk-RDTQHNEQ.js";import"./chunk-DELOOZDJ.js";import{a as w,b as y}from"./chunk-2WH2EVR6.js";var Le=["*"];function ze(o,t){if(o&1&&(r(0,"p",1),m(1),l()),o&2){let e=a();c(),O(" ",e.label()," ")}}var q=class o{constructor(){}label=T("");static \u0275fac=function(e){return new(e||o)};static \u0275cmp=b({type:o,selectors:[["lg-control-group"]],inputs:{label:[1,"label"]},ngContentSelectors:Le,decls:4,vars:1,consts:[[1,"control-group"],[1,"control-group__label"],[1,"control-group__content"]],template:function(e,i){e&1&&(P(),r(0,"div",0),_(1,ze,2,1,"p",1),r(2,"div",2),D(3),l()()),e&2&&(c(),g(i.label()?1:-1))},styles:["[_nghost-%COMP%]{display:flex;flex:1}.control-group[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:16px}.control-group__label[_ngcontent-%COMP%]{font-size:1.2rem;margin:0}.control-group__content[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:flex-end}.control-group__content[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{flex:1}"]})};var Be=["*",[["rowActions"]]],Qe=["*","rowActions"],W=class o{constructor(){}mobileMode=T(!1);static \u0275fac=function(e){return new(e||o)};static \u0275cmp=b({type:o,selectors:[["lg-controls-row"]],inputs:{mobileMode:[1,"mobileMode"]},ngContentSelectors:Qe,decls:5,vars:2,consts:[[1,"controls-row"],[1,"controls-row__controls"],[1,"controls-row__actions"]],template:function(e,i){e&1&&(P(Be),r(0,"div",0)(1,"div",1),D(2),l(),r(3,"div",2),D(4,1),l()()),e&2&&Z("controls-row__mobile",i.mobileMode())},styles:[`:host{display:flex;gap:16px}.controls-row{width:100%;display:flex;align-items:flex-end;gap:16px;flex:1}.controls-row__controls,.controls-row__actions{display:flex;align-items:flex-end;gap:16px}.controls-row__controls{flex:1}.controls-row__actions{flex:0;white-space:nowrap}.controls-row__controls>*,.controls-row__actions>*{flex:1}@media (max-width: 600px){.controls-row__mobile,.controls-row__mobile .controls-row__controls{flex-direction:column;align-items:stretch}}
`],encapsulation:2})};var Ke=["tooltipComponent"],Je=["products"],Ye=["productsSelector"],Xe=["nameField"],Ze=(o,t)=>t.value.amount+o;function et(o,t){if(o&1){let e=R();r(0,"lg-gap-column",22)(1,"lg-control",27),F(2,28),r(3,"span",29),f("click",function(){d(e);let n=a().$index,s=a();return u(s.closeTextField(n))}),m(4,"Hide"),l(),A(),r(5,"lg-input",30),f("onInputChanged",function(){d(e);let n=a().$index,s=k(6),S=a();return u(S.onIngredientSelected(s,n,["product_id","recipe_id"]))}),l()()()}o&2&&(p("size","small"),c(5),p("placeholder","Here you can write the name of the ingredient"))}function tt(o,t){if(o&1){let e=R();r(0,"lg-multiselect",36),f("onSelected",function(){d(e);let n=a(2).$index,s=k(6),S=a();return u(S.onIngredientSelected(s,n,["product_id","name"]))}),l()}o&2&&p("resource","recipes")("autoLoad",!0)}function it(o,t){if(o&1){let e=R();r(0,"lg-multiselect",37,3),f("onSelected",function(){d(e);let n=a(2).$index,s=k(6),S=a();return u(S.onIngredientSelected(s,n,["recipe_id","name"]))}),l()}o&2&&p("resource","products")("autoLoad",!0)}function ot(o,t){if(o&1){let e=R();r(0,"lg-gap-column",22)(1,"lg-control"),F(2,31),r(3,"lg-button",32),f("click",function(){d(e);let n=a().$index,s=a();return u(s.closeRecipeField(n))}),m(4," Product "),l(),A(),F(5,33),r(6,"lg-button",32),f("click",function(){d(e);let n=a().$index,s=a();return u(s.openRecipeField(n))}),m(7,"Recipe "),l(),A(),F(8,28),r(9,"span",29),f("click",function(){d(e);let n=a().$index,s=a();return u(s.openTextField(n))}),m(10,"As text"),l(),A(),_(11,tt,1,2,"lg-multiselect",34)(12,it,2,2,"lg-multiselect",35),l()()}if(o&2){let e=a().$index,i=a();p("size","small"),c(3),p("flat",!0)("size","small")("active",!i.recipeFieldState()[e]),c(3),p("flat",!0)("size","small")("active",i.recipeFieldState()[e]),c(5),g(i.recipeFieldState()[e]?11:12)}}function nt(o,t){if(o&1){let e=R();F(0,16),r(1,"lg-controls-row",21),_(2,et,6,2,"lg-gap-column",22)(3,ot,13,8,"lg-gap-column",22),r(4,"lg-control",23)(5,"lg-number-input",24,1),f("onKeydown",function(){d(e);let n=a();return u(n.addLast())}),l()(),v(7,"lg-buttons-group",25),F(8,26),r(9,"lg-button",17),f("click",function(){let n=d(e).$index,s=a();return u(s.deleteIngredient(n))}),m(10," Delete Ingredient "),l(),A(),l(),A()}if(o&2){let e=t.$index,i=a();p("formGroupName",e),c(),p("mobileMode",!0),c(),g(i.textFieldState()[e]?2:3),c(3),p("placeholder","In "+((i.form.value.ingredients==null||i.form.value.ingredients[e]==null?null:i.form.value.ingredients[e].unit)||"gram")),c(2),p("items",i.buttons),c(2),V("danger"),p("size","small")}}function rt(o,t){if(o&1&&v(0,"lg-chips-list",20),o&2){let e=a(),i=k(21);p("control",i)("items",e.topCategories())}}var E=class o{constructor(t,e,i,n,s){this._recipesRepository=t;this._selectResourcesService=e;this._router=i;this._aRoute=n;this._notificationsService=s}recipe=T(void 0);uuid=Pe("uuid");form=new K({name:new h(null,ge.required),description:new h(""),outcome_amount:new h(null),outcome_unit:new h(""),ingredients:new be([this._getIngredientGroup()]),category_id:new h(null)},t=>z.fromRaw(t.value).outcomeAmountGreaterThanIngredients?{outcomeAmountGreaterThanIngredients:!0}:null);textFieldState=x({});recipeFieldState=x({});buttons=[{label:"Grams",value:"gram",style:"secondary",onClick:()=>{console.log("Grams")}},{label:"Pieces",value:"piece",style:"secondary",onClick:()=>{console.log("Piece")}}];tooltipComponent=$("tooltipComponent");productsWidget=$("products");productsSelector=$("productsSelector");nameField=j("nameField");topCategories=x([]);recipeEffect=ce(()=>{this.recipe()&&this.fillForm(this.recipe())});get ingredients(){return this.form.get("ingredients")}get _formValid(){return this.form.valid&&!this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())}fillForm(t){this.form.reset({ingredients:[]}),this.ingredients.clear(),t&&(this.form.reset(y(w({},je(t)),{ingredients:[]})),t.ingredients.forEach((e,i)=>{this.ingredients.push(this._getIngredientGroup(e)),e.recipe_id&&this.openRecipeField(i),e.name&&this.openTextField(i)}),this.form.updateValueAndValidity(),this.form.markAsPristine())}resetForm(t){this.fillForm(t),this._loadUsingHistory(),this.form.markAsPristine()}validateForm(){return this._formValid?!0:(this._notificationsService.error(this._notificationsService.parseFormErrors(this.form).join(", ")),!1)}addLast(){let t=this.ingredients.at(this.ingredients.length-1);(t.value.name||t.value.amount||t.value.product_id)&&this.addIngredient()}ngOnInit(){this._loadUsingHistory(),this.form.valueChanges.pipe(M(100)).subscribe({next:t=>{this.recipe()?.update(this.form.getRawValue()),this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())&&this._notificationsService.error("You cannot add a recipe to itself")}})}ngAfterViewInit(){this._selectResourcesService.load().then(t=>{}),this.nameField().focus()}addIngredient(){this.ingredients.push(this._getIngredientGroup())}deleteIngredient(t){this.ingredients.removeAt(t)}onIngredientSelected(t,e,i){t.focus();let n=this.ingredients.at(e).value;this.ingredients.at(e).patchValue(y(w({},Array.isArray(i)?i.reduce((s,S)=>y(w({},s),{[S]:null}),{}):{[i]:null}),{unit:n.product_id?.unit||n.recipe_id?.unit||"gram"}))}openTextField(t){this.textFieldState.update(e=>y(w({},e),{[t]:!0}))}closeTextField(t){this.textFieldState.update(e=>y(w({},e),{[t]:!1}))}openRecipeField(t){this.recipeFieldState.update(e=>y(w({},e),{[t]:!0}))}closeRecipeField(t){this.recipeFieldState.update(e=>y(w({},e),{[t]:!1}))}checkCycleRecipe(t,e){let i=!1;for(let n of t){let s=n.recipe_id?.uuid;if(s&&s===e){i=!0;break}}return i}_loadUsingHistory(){this._recipesRepository.getTopCategories().then(t=>{this.topCategories.set(t.map(e=>({label:e.name,value:{uuid:e.uuid,name:e.name}})))})}_getIngredientGroup(t){return new K({name:new h(t?.name),amount:new h(t?.amount?.toString()??null),product_id:new h(t?.product_id?t.product_id:null),recipe_id:new h(t?.recipe_id?t.recipe_id:null),unit:new h(t?.unit??"gram")},e=>{let i=ae.fromRaw(e.value);if(i.allEmpty)return null;if(i.typeSelected&&!i.amountValid)return{ingredientAmountRequired:!0};if(!this.uuid)return null;let n=this.uuid();return this.checkCycleRecipe([e.value],n)?{cycleRecipe:!0}:i.typeSelected?null:{ingredientRequired:!0}})}static \u0275fac=function(e){return new(e||o)(C(B),C(N),C(L),C(U),C(H))};static \u0275cmp=b({type:o,selectors:[["lg-add-recipe-form"]],viewQuery:function(e,i){e&1&&(I(i.tooltipComponent,Ke,5),I(i.productsWidget,Je,5),I(i.productsSelector,Ye,5),I(i.nameField,Xe,5)),e&2&&G(4)},inputs:{recipe:[1,"recipe"]},features:[oe([{provide:N,useClass:N}])],decls:23,vars:14,consts:[["nameField",""],["amount",""],["categorySelect",""],["productsSelector",""],[3,"formGroup"],[3,"position"],["label","Name","lgExpand",""],["formControlName","name",3,"key","resource"],["label","Description","lgExpand",""],["formControlName","description",3,"placeholder"],["lgExpand","",3,"mobileMode"],["label","Amount of the outcome","lgExpand",""],["formControlName","outcome_amount","lgParseMath","",3,"placeholder"],["formControlName","outcome_unit",3,"items"],["label","Ingredients","lgExpand",""],["formArrayName","ingredients","lgExpand",""],[3,"formGroupName"],[3,"click","size"],["label","Category","lgExpand",""],["formControlName","category_id",3,"resource"],[3,"control","items"],[3,"mobileMode"],[3,"size"],["label","Amount"],["lgParseMath","","formControlName","amount",3,"onKeydown","placeholder"],["formControlName","unit",3,"items"],["ngProjectAs","rowActions",5,["rowActions"]],["label","Name"],["ngProjectAs","endLabelTpl",5,["endLabelTpl"]],[3,"click"],["formControlName","name",3,"onInputChanged","placeholder"],["ngProjectAs","labelTpl",5,["labelTpl"]],[3,"click","flat","size","active"],["ngProjectAs","afterLabelTpl",5,["afterLabelTpl"]],["formControlName","recipe_id",3,"resource","autoLoad"],["formControlName","product_id",3,"resource","autoLoad"],["formControlName","recipe_id",3,"onSelected","resource","autoLoad"],["formControlName","product_id",3,"onSelected","resource","autoLoad"]],template:function(e,i){if(e&1){let n=R();r(0,"form",4)(1,"lg-gap-column",5)(2,"lg-control",6),v(3,"lg-autocomplete",7,0),l(),r(5,"lg-control",8),v(6,"lg-textarea",9),l(),r(7,"lg-controls-row",10)(8,"lg-control",11),v(9,"lg-number-input",12,1),l(),v(11,"lg-buttons-group",13),l(),r(12,"lg-control-group",14)(13,"lg-gap-column",5)(14,"lg-gap-column",15),ee(15,nt,11,8,"ng-container",16,Ze),l(),r(17,"lg-button",17),f("click",function(){return d(n),u(i.addIngredient())}),m(18," Add Ingredient "),l()()(),r(19,"lg-control",18),v(20,"lg-multiselect",19,2),l(),_(22,rt,1,2,"lg-chips-list",20),l()()}e&2&&(p("formGroup",i.form),c(),p("position","start"),c(2),p("key","name")("resource","recipes-names"),c(3),p("placeholder","Describe your recipe, how to make it, what to pay attention to, etc."),c(),p("mobileMode",!0),c(2),p("placeholder",i.form.value.outcome_unit||"Here you can write the amount of the outcome (e.g. 100, 12, etc.)"),c(2),p("items",i.buttons),c(2),p("position","start"),c(2),te(i.ingredients.controls),c(2),V("success"),p("size","small"),c(3),p("resource","recipes-categories"),c(2),g(i.topCategories().length?22:-1))},dependencies:[Fe,he,Ce,Re,ve,ye,xe,we,Te,Ee,q,ue,Q,Ve,De,ke,W,Ie,Ne,Me,Ge,Oe,Se],encapsulation:2})};function lt(o,t){if(o&1&&(m(0),ne(1,"timeAgo")),o&2){let e,i=a(2);O(" (last edited ",re(1,1,(e=i.recipe())==null?null:e.updatedAt),") ")}}function ct(o,t){if(o&1&&(r(0,"lg-title"),m(1," Edit "),r(2,"span",5),m(3),l()(),_(4,lt,2,3)),o&2){let e,i,n=a();c(3),ie((e=n.recipe())==null?null:e.name),c(),g((i=n.recipe())!=null&&i.updatedAt?4:-1)}}function at(o,t){o&1&&(r(0,"lg-title"),m(1,"Add Recipe"),l())}function pt(o,t){o&1&&m(0," (saved as draft) ")}function st(o,t){if(o&1){let e=R();r(0,"lg-button",6),f("click",function(){d(e);let n=a();return u(n.onEditRecipe())}),m(1," Edit Recipe "),l()}}function mt(o,t){if(o&1){let e=R();r(0,"lg-button",6),f("click",function(){d(e);let n=a();return u(n.onAddRecipe())}),m(1," Add Recipe "),l()}}function dt(o,t){if(o&1){let e=R();r(0,"lg-button",6),f("click",function(){d(e);let n=a();return u(n.onRemoveDraft())}),m(1," Delete this draft "),l()}o&2&&V("danger")}var Ue=class o{constructor(t,e,i,n){this._router=t;this._aRoute=e;this._recipesRepository=i;this._notificationsService=n;this._aRoute.data.pipe(Ae()).subscribe(s=>{this.recipe.set(s.recipe||null)})}draftOrRecipeUUID=x(void 0);recipe=x(void 0);formComponent=j(E);draftRef=x(void 0);draftByExistingRecipe=le(()=>this.draftRef().meta?.uuid);isDraftRoute=x(!1);draftRecipeModel;ngOnInit(){X([this._aRoute.params,this._aRoute.data]).subscribe(([t,e])=>{let i=e.draft;this.draftOrRecipeUUID.set(t.uuid),i?(this.draftRef.set(i),this.recipe.set(i.data)):e.recipe?this.recipe.set(e.recipe):this._loadRecipe(this.draftOrRecipeUUID()),this.isDraftRoute.set(!!e.draftRoute)})}ngAfterViewInit(){this.formComponent()?.form.valueChanges.pipe(M(500)).subscribe(t=>{this.formComponent().form.dirty&&(this.recipe.update(e=>e?(e.update(t),e):z.fromRaw(t)),this.draftRef()?.uuid?this._recipesRepository.updateDraftRecipe(this.draftRef().uuid,this.recipe(),this.draftRef().meta?.uuid):this.draftRef.set(this._recipesRepository.saveDraftRecipe(this.recipe(),this.draftOrRecipeUUID()??"")))})}onAddRecipe(){!this.formComponent()?.validateForm()||!this.recipe()||this._addRecipe(this.recipe())}onEditRecipe(){!this.formComponent()?.validateForm()||!this.recipe()||this._editRecipe(this.recipe())}onRemoveDraft(){this._removeDraft(),this._router.navigate(["recipes"])}_addRecipe(t){this._recipesRepository.addRecipe(t).then(()=>{this.formComponent()?.resetForm(),this._notificationsService.success("Recipe added"),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes"])})}_editRecipe(t){if(!this.draftOrRecipeUUID())return;let e=this.draftRef()?.meta?.uuid??this.draftOrRecipeUUID();this._recipesRepository.editRecipe(e,t).then(()=>{this.formComponent()?.resetForm(t),this._notificationsService.success("Recipe edited"),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes","edit",e])})}_removeDraft(){this.draftRef()&&(this._recipesRepository.removeDraftRecipe(this.draftRef().uuid),this.draftRef.set(void 0))}_loadRecipe(t){t&&this._recipesRepository.getOne(t).then(e=>{e&&this.recipe.set(e)})}static \u0275fac=function(e){return new(e||o)(C(L),C(U),C(B),C(H))};static \u0275cmp=b({type:o,selectors:[["app-add-recipe"]],viewQuery:function(e,i){e&1&&I(i.formComponent,E,5),e&2&&G()},decls:12,vars:9,consts:[[3,"center","mobileMode"],[3,"recipe"],[3,"mobileMode","relaxed"],["lgShrink",""],["lgShrink","",3,"style"],[1,"text-active"],["lgShrink","",3,"click"]],template:function(e,i){e&1&&(r(0,"lg-fade-in")(1,"lg-container")(2,"lg-gap-row",0),_(3,ct,5,2)(4,at,2,0,"lg-title"),_(5,pt,1,0),l(),r(6,"lg-card"),v(7,"lg-add-recipe-form",1),l(),r(8,"lg-gap-row",2),_(9,st,2,0,"lg-button",3)(10,mt,2,0,"lg-button",3),_(11,dt,2,2,"lg-button",4),l()()()),e&2&&(c(2),p("center",!0)("mobileMode",!0),c(),g(i.recipe()&&!i.draftRef()||i.draftRef()&&i.draftByExistingRecipe()?3:4),c(2),g(i.draftRef()?5:-1),c(2),p("recipe",i.recipe()),c(),p("mobileMode",!0)("relaxed",!0),c(),g(i.recipe()&&!i.draftRef()||i.draftRef()&&i.draftByExistingRecipe()?9:10),c(2),g(i.isDraftRoute()?11:-1))},dependencies:[pe,se,me,E,Q,_e,de,$e,fe],encapsulation:2})};export{Ue as AddRecipeComponent};
