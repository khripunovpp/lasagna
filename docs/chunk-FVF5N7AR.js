import{a as T,b as D}from"./chunk-XBLVHOT4.js";import{a as o,b as _,c as b,d as S,e as w,f as P,g as O}from"./chunk-SPYA6ZNQ.js";import{B as x}from"./chunk-I5MUGXQZ.js";import{W as d,_ as m,f as v}from"./chunk-OZXQ5JHJ.js";import{a as y,b as R,f as u}from"./chunk-2WH2EVR6.js";var g=class a{constructor(e){this.name=e.name,this.amount=o(e.amount),this.product_id=e.product_id?b.fromRaw(typeof e.product_id=="string"?{uuid:e.product_id}:e.product_id):void 0,this.recipe_id=e.recipe_id?s.fromRaw(typeof e.recipe_id=="string"?{uuid:e.recipe_id}:e.recipe_id):void 0,this.unit=e.unit}name;product_id;recipe_id;amount;unit;get uuid(){return this.product_id?.uuid||this.recipe_id?.uuid}get generalName(){return this.product_id?.name||this.recipe_id?.name||this.name||"Unknown ingredient"}get totalWeightGram(){return this.unit!=="gram"?this.recipe_id?this.recipe_id.totalIngredientsWeight/this.recipe_id.outcome_amount*this.amount:0:o(this.amount)}get pricePerUnit(){return this.product_id&&this.product_id.unit!=="gram"?this.product_id?.pricePerUnit:this.recipe_id?this.recipe_id.pricePerUnit:this.totalPrice/this.totalWeightGram}get totalPrice(){let e=0;return this.product_id&&(this.product_id.unit!=="gram"?e+=this.product_id.pricePerUnit*this.amount:e+=this.product_id.pricePerUnit*this.totalWeightGram),this.recipe_id&&(e+=this.recipe_id.pricePerUnit*this.amount),e}get blanked(){return!this.amount}get typeSelected(){return!!this.product_id||!!this.recipe_id||!!this.name}get amountValid(){return o(this.amount)>0}get allEmpty(){return!this.name&&!this.amount&&!this.product_id&&!this.recipe_id}static fromRaw(e){return new a({name:e?.name,amount:e?.amount,product_id:e?.product_id,recipe_id:e?.recipe_id,unit:e?.unit})}static empty(){return new a({name:"",amount:0,product_id:void 0,recipe_id:void 0,unit:"gram"})}toDTO(){return{name:this.name?.trim(),amount:o(this.amount),product_id:this.product_id?.uuid,recipe_id:this.recipe_id?.uuid,unit:this.unit||"gram"}}update(e){return this.name=e?.name||this.name,this.amount=e?.amount||this.amount,this.product_id=e?.product_id||this.product_id,this.recipe_id=e?.recipe_id||this.recipe_id,this.unit=e?.unit||this.unit,this}};var s=class a{constructor(e){this.name=String(e.name??"").trim(),this.description=String(e.description??"").trim(),this.ingredients=e.ingredients.map(t=>g.fromRaw(t)),this.outcome_amount=parseFloat(String(e.outcome_amount??"")),this.outcome_unit=String(e.outcome_unit??"")||"gram",this.uuid=String(e.uuid??"").trim()||void 0,this.taxTemplateName=String(e.taxTemplateName??"").trim()||void 0,this.category_id=T.fromRaw(typeof e.category_id=="string"?{uuid:e.category_id}:e.category_id),this.tags=e.tags?.map(t=>_.fromRaw(t)),this.createdAt=e.createdAt?Number(e.createdAt):void 0,this.updatedAt=e.updatedAt?Number(e.updatedAt):void 0}name;description;ingredients;outcome_amount;outcome_unit;uuid;taxTemplateName;category_id;createdAt;updatedAt;tags;get valid(){return this.name&&this.ingredients.length>0&&this.outcome_amount>0&&this.category_id}get totalPrice(){return this.ingredients.reduce((e,t)=>e+t.totalPrice,0)}get perUnitLabel(){return!this.outcome_unit||this.outcome_unit==="gram"?"per gram":`per ${this.outcome_unit}`}get pricePerUnit(){return this.outcome_unit&&this.outcome_unit!=="gram"?this.totalPrice/this.outcome_amount:this.totalPrice/this.totalIngredientsWeight}get totalIngredientsWeight(){return this.ingredients.reduce((e,t)=>e+t.amount*(t.unit==="gram"?1:0),0)}get outcomeAmountGreaterThanIngredients(){return o(this.outcome_amount)>this.totalIngredientsWeight}static fromRaw(e){return new a({name:e?.name||"",description:e?.description||"",ingredients:e?.ingredients||[],outcome_amount:e?.outcome_amount||0,outcome_unit:e?.outcome_unit||"gram",uuid:e?.uuid,taxTemplateName:e?.taxTemplateName,category_id:e?.category_id,createdAt:e?.createdAt,updatedAt:e?.updatedAt,tags:e?.tags})}static empty(){return new a({name:"",description:"",ingredients:[],outcome_amount:0,outcome_unit:"gram",uuid:void 0,taxTemplateName:void 0,category_id:null,createdAt:void 0,updatedAt:void 0})}removeIngredient(e){this.ingredients.splice(e,1)}addIngredient(e){this.ingredients.push(e)}clearEmpty(){this.ingredients=this.ingredients.filter(e=>!e.blanked)}toDTO(){return{name:this.name,description:this.description,ingredients:this.ingredients.map(e=>e.toDTO()),outcome_amount:this.outcome_amount,outcome_unit:this.outcome_unit,uuid:this.uuid,taxTemplateName:this.taxTemplateName,category_id:this.category_id.toUUID(),createdAt:this.createdAt||Date.now(),updatedAt:this.updatedAt||Date.now(),tags:this.tags?.map(e=>e.toString())}}update(e){this.name=e?.name||this.name,this.description=e?.description||this.description,this.ingredients=e?.ingredients?e.ingredients.map(t=>g.fromRaw(t)):this.ingredients,this.outcome_amount=e?.outcome_amount||this.outcome_amount,this.outcome_unit=e?.outcome_unit||this.outcome_unit,this.uuid=e?.uuid||this.uuid,this.taxTemplateName=e?.taxTemplateName||this.taxTemplateName,this.category_id=T.fromRaw(e?.category_id)||this.category_id,this.createdAt=e?.createdAt||this.createdAt,this.updatedAt=e?.updatedAt||Date.now(),this.tags=e?.tags?e.tags.map(t=>_.fromRaw(t)):this.tags}};var h=class a{constructor(e,t,i,r,n,p){this._indexDbService=e;this._usingHistoryService=t;this._categoryRepository=i;this._draftFormsService=r;this._tagsRepository=n;this._productsRepository=p}_stream$=new v;get recipes$(){return this._stream$.asObservable()}addRecipe(e){return u(this,null,function*(){e.clearEmpty();let t=e.toDTO(),i=yield this._indexDbService.addData("recipesStore",t);if(t.category_id&&this._saveCategory(t.category_id),this._saveRecipeToHistory(i),e.tags?.length)for(let r of e.tags)yield this._saveTag(r);return i})}loadRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>{let t=e.map(i=>s.fromRaw(i));return this._stream$.next(t),t})}getRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>e.map(t=>s.fromRaw(t)).toSorted((t,i)=>t.name.localeCompare(i.name)))}getOne(e,t=!1){return u(this,null,function*(){return new Promise((i,r)=>u(this,null,function*(){if(!e){i(void 0);return}e=e.uuid||e,t?yield this._indexDbService.getOneWithRelations("recipesStore",e).then(n=>{i(s.fromRaw(n.data))}):yield this._indexDbService.getOne("recipesStore",e).then(n=>{i(s.fromRaw(n))})}))})}editRecipe(e,t){return u(this,null,function*(){if(t.clearEmpty(),yield this._indexDbService.replaceData("recipesStore",e,t.toDTO()),this._saveRecipeToHistory(e),t.tags?.length)for(let i of t.tags)yield this._saveTag(i)})}saveDraftRecipe(e,t){let i=this._draftFormsService.setDraftForm("draft_recipes",e.toDTO(),t?.length?"edit":"add",t?{uuid:t}:{});return i?R(y({},i),{data:e}):void 0}updateDraftRecipe(e,t,i){this._draftFormsService.updateDraftForm("draft_recipes",t.toDTO(),e,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftRecipe(e){let t=this._draftFormsService.getDraftForms("draft_recipes");return e&&t?.[e]?[t?.[e]]:t?Object.values(t):[]}removeDraftRecipe(e){this._draftFormsService.removeDraftForm("draft_recipes",e)}deleteRecipe(e){return this._indexDbService.remove("recipesStore",e)}getTopCategories(){let{top:e}=this._usingHistoryService.read("recipes_categories"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._categoryRepository.getManyCategories(t).then(i=>i.toSorted((r,n)=>!r.uuid||!n.uuid?0:e[n.uuid].count>e[r.uuid].count?1:-1))}getLastRecipes(){let{top:e}=this._usingHistoryService.read("recipes"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._indexDbService.getMany("recipesStore",t).then(i=>i.toSorted((r,n)=>e[n.uuid].count>e[r.uuid].count?1:-1).map(r=>({recipe:s.fromRaw(r),updatedAt:e[r.uuid].updatedAt,count:e[r.uuid].count})))}_saveCategory(e){this._usingHistoryService.count("recipes_categories",e)}_saveRecipeToHistory(e){this._usingHistoryService.count("recipes",e)}_saveTag(e){return this._tagsRepository.addOne(e)}static \u0275fac=function(t){return new(t||a)(m(x),m(S),m(D),m(w),m(P),m(O))};static \u0275prov=d({token:a,factory:a.\u0275fac,providedIn:"root"})};var f=class{constructor(e){this.recipe=e}result;get totalPrice(){return this.recipe?this.recipe.ingredients.reduce((e,t)=>e+t.totalPrice,0):0}get ingredients(){return this.recipe?.ingredients||[]}get pricePerUnit(){return this.recipe?this.totalPrice/this.totalWeight:0}get totalWeight(){return this.recipe?this.recipe.ingredients.reduce((e,t)=>e+t.totalWeightGram,0):0}get outcomeAmount(){return this.recipe?o(this.recipe.outcome_amount):0}get outcomeUnit(){return this.recipe&&this.recipe.outcome_unit||"gram"}};var U=class a{constructor(e){this._recipeRepository=e}calculation;linkTaxTemplate(e,t){return new Promise((i,r)=>u(this,null,function*(){yield this._recipeRepository.getOne(e).then(n=>u(this,null,function*(){if(!n){i(null);return}n.taxTemplateName=t,yield this._recipeRepository.editRecipe(n.uuid,n),i(n)}))}))}calculateRecipe(e,t=0){return new Promise((i,r)=>u(this,null,function*(){let n=[],p=yield this._recipeRepository.getOne(e,!0);console.log(p);let l=new f(p);l.ingredients.forEach(c=>{n.push(this._makeRow({name:c.generalName,price_per_gram:c.pricePerUnit,amount:c.amount,total:c.totalPrice,unit:c.unit,uuid:c.uuid||"",indent:0,type:c.recipe_id?"recipe-row":void 0}))}),n.push(this._makeTotal(l.totalPrice,l.totalWeight)),i({calculation:l,table:n})}))}_makeRow(e){return{name:e.name,price_per_gram:e.price_per_gram??0,amount:e.amount,total:e.total??0,unit:e.unit||"gram",indent:e.indent??0,type:e.type||"row",uuid:e.uuid}}_makeTotal(e,t){return{name:"Total (without taxes and fees)",amount:t,unit:"gram",price_per_gram:o(e/t),total:e,indent:0,type:"total"}}static \u0275fac=function(t){return new(t||a)(m(h))};static \u0275prov=d({token:a,factory:a.\u0275fac,providedIn:"root"})};var A=class a{constructor(){}getTemplates(e){let t=localStorage.getItem(this.getStorageKey(e));return t?JSON.parse(t):[]}getTemplateById(e,t){return this.getTemplates(e).find(r=>r.id===t)}getTemplateByName(e,t){return this.getTemplates(e).find(r=>r.name===t)}saveTemplate(e,t){let i=this.getTemplates(e);this._checkUniqName(i,t.name)?(i.push(t),this._storeTemplates(e,i)):this.updateTemplateData(e,t.name,t.data)}updateTemplateData(e,t,i){let r=this.getTemplates(e),n=r.find(p=>p.name===t);n&&(n.data=i,this._storeTemplates(e,r))}deleteTemplate(e,t){let i=this.getTemplates(e).filter(r=>r.id!==t);this._storeTemplates(e,i)}updateTemplate(e,t){let i=this.getTemplates(e).map(r=>r.id===t.id?t:r);this._storeTemplates(e,i)}_checkUniqName(e,t){return!e.some(i=>i.name===t)}getStorageKey(e){return`template-${e}`}_storeTemplates(e,t){localStorage.setItem(this.getStorageKey(e),JSON.stringify(t))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=d({token:a,factory:a.\u0275fac,providedIn:"root"})};export{g as a,s as b,h as c,U as d,A as e};
