import{a as p}from"./chunk-5H4YZ6OF.js";import{c,d as f,e as m,f as v}from"./chunk-MP75AJZN.js";import{e as g}from"./chunk-XWYXIH64.js";import{U as d,Y as a,f as u}from"./chunk-MV5CNZ6J.js";import{f as s}from"./chunk-2WH2EVR6.js";var y=class n{constructor(t,r,i,e,o){this._indexDbService=t;this._categoryRepository=r;this._usingHistoryService=i;this._draftFormsService=e;this._tagsRepository=o}_stream$=new u;get products$(){return this._stream$.asObservable()}loadAll(){return this._indexDbService.getAll("productsStore").then(t=>(this._stream$.next(t.map(r=>c.fromRaw(r))),t))}addOne(t){return s(this,null,function*(){let r=yield this._indexDbService.addData("productsStore",t.toDTO());if(t.category_id&&this._saveCategory(t.category_id.toString()),t.source&&this._saveSource(t.source),this._saveProductToHistory(r),t.tags)for(let i of t.tags)yield this._saveTag(i);return r})}updateOne(t,r){return s(this,null,function*(){if(yield this._indexDbService.replaceData("productsStore",t,r.toDTO()),this._saveProductToHistory(t),r.tags)for(let i of r.tags)yield this._saveTag(i)})}getOne(t){return s(this,null,function*(){return new Promise((r,i)=>s(this,null,function*(){if(t=typeof t=="string"?t:t.uuid,!t){r(void 0);return}yield this._indexDbService.getOne("productsStore",t).then(e=>{r(c.fromRaw(e))})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}getLastProducts(){let{top:t}=this._usingHistoryService.read("products"),r=Object.keys(t);return r.length===0?Promise.resolve([]):this._indexDbService.getMany("productsStore",r).then(i=>i.toSorted((e,o)=>!e.uuid||!o.uuid?0:t[o.uuid].count>t[e.uuid].count?1:-1).map(e=>({product:c.fromRaw(e),updatedAt:e.uuid?t[e.uuid].updatedAt:0,count:e.uuid?t[e.uuid].count:0})))}deleteProduct(t){return this._indexDbService.remove("productsStore",t)}getTopCategories(){let{top:t}=this._usingHistoryService.read("products_categories"),r=Object.keys(t);return this._categoryRepository.getMany(r).then(i=>i.toSorted((e,o)=>!e.uuid||!o.uuid?0:t[o.uuid].count>t[e.uuid].count?1:-1))}getTopSources(){return s(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(t,r){return this._draftFormsService.setDraftForm("draft_products",t.toDTO(),r?.length?"edit":"add",r?{uuid:r}:{})}updateDraftProduct(t,r,i){return this._draftFormsService.updateDraftForm("draft_products",r.toDTO(),t,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftProducts(t){let r=this._draftFormsService.getDraftForms("draft_products");return t&&r?.[t]?[r?.[t]]:r?Object.values(r):[]}removeDraftProduct(t){this._draftFormsService.removeDraftForm("draft_products",t)}_saveCategory(t){this._usingHistoryService.count("products_categories",t)}_saveSource(t){this._usingHistoryService.count("products_sources",t)}_saveProductToHistory(t){this._usingHistoryService.count("products",t)}_saveTag(t){return this._tagsRepository.addOne(t)}static \u0275fac=function(r){return new(r||n)(a(g),a(p),a(f),a(m),a(v))};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};export{y as a};
