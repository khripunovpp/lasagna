"use strict";(self.webpackChunklasagna=self.webpackChunklasagna||[]).push([[91],{1091:(H,j,r)=>{r.r(j),r.d(j,{CalculateRecipeComponent:()=>J});var t=r(1007),T=r(5642),G=r(1086),A=r(553);const $=["*"];let I=(()=>{class a{constructor(){}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=t.VBU({type:a,selectors:[["lg-table-card"]],ngContentSelectors:$,decls:4,vars:1,consts:[[3,"flat"],[1,"table"],[1,"table__scroll"]],template:function(n,o){1&n&&(t.NAR(),t.j41(0,"lg-card",0)(1,"div",1)(2,"div",2),t.SdG(3),t.k0s()()()),2&n&&t.Y8G("flat",!0)},dependencies:[A.i],styles:[":host{display:flex;width:100%}.table__scroll{overflow-x:auto}table{width:100%;border-collapse:collapse;--border-color: #efefef}table thead tr{border-bottom:1px solid var(--border-color)}table thead th{text-align:left;padding:16px 24px;opacity:.4;font-size:.8em}table tbody tr{border-bottom:1px solid var(--border-color)}table tbody tr:last-child{border-bottom:none}td{padding:16px 24px}\n"],encapsulation:2})}return a})();var k=r(177),w=r(1119),N=r(7512),Y=r(9895),y=r(9417),S=r(7480),M=r(1636),R=r(467),b=r(4625),X=r(9512),V=r(7201);let z=(()=>{class a{_recipeRepository;_productRepository;constructor(e,n){this._recipeRepository=e,this._productRepository=n}calculation;calculateRecipe(e,n=0){var o=this;return new Promise(function(){var l=(0,R.A)(function*(s,d){const m=[];let f=0,u=0;yield o._recipeRepository.getOne(e).then(function(){var x=(0,R.A)(function*(_){const{table:h,totalAmount:F}=yield o._makeIngredientTable(_,n);f+=F||0;const g=n/(_?.outcome_amount||1);u=_?.ingredients.reduce((p,i)=>"gram"!==i.unit?p:p+((0,b.N)(i.amount)||0)*(g||1),0)??0,m.push(...h),m.push(o._makeTotal(f,u)),s({recipe:_,result:m,total:f,totalWeight:u})});return function(_){return x.apply(this,arguments)}}())});return function(s,d){return l.apply(this,arguments)}}())}_makeRecipeSubTable(e,n=0){var o=this;return(0,R.A)(function*(){return new Promise(function(){var l=(0,R.A)(function*(s,d){const m=[];let f=0,u=0;const x=e.amount;yield o._recipeRepository.getOne(e.recipe_id).then(function(){var _=(0,R.A)(function*(h){const F=h?.ingredients.reduce((c,v)=>"gram"!==v.unit?c:c+((0,b.N)(v.amount)||0),0)??0,g=x/F,p=yield o._makeIngredientTable(h,n);p.table=p.table.map((c,v)=>({...c,amount:parseFloat((c.amount?c.amount*g:0).toFixed(5)),total:parseFloat((c.total?c.total*g:0).toFixed(5)),indent:c.indent+1}));const i=p.totalAmount?p.totalAmount/p.totalWeight:0;m.push(o._makeRecipeCaption({name:h?.name||"Unknown recipe",price_per_gram:i,amount:e.amount,total:i*e.amount})),m.push(...p.table),u+=i*e.amount,f+=p.totalWeight,s({table:m,totalAmount:u,totalWeight:f})});return function(h){return _.apply(this,arguments)}}())});return function(s,d){return l.apply(this,arguments)}}())})()}_makeIngredientTable(e,n=0){var o=this;const l=[];let s=0,d=0;const m=n/(e?.outcome_amount||1);return Promise.all(e?.ingredients.map(function(){var f=(0,R.A)(function*(u,x){const _=u.recipe_id,h=u.product_id,F=u.name;if(_||h||F)if(_){const g=yield o._makeRecipeSubTable(u,n);l.push(...g.table),d+=g.totalAmount,s+=g.totalWeight}else h?yield o._productRepository.getOne(u.product_id).then(function(){var p=(0,R.A)(function*(i){if(!i)return void l.push(o._makeRow({name:"Unknown product",price_per_gram:void 0,amount:u.amount*(m||1),total:void 0}));if(!i?.price)return void l.push(o._makeRow({name:i.name,price_per_gram:0,amount:u.amount*(m||1),total:0}));if(!i?.amount)return void l.push(o._makeRow({name:i.name,price_per_gram:0,amount:u.amount*(m||1),total:0}));const c=u.amount*(m||1),v=((0,b.N)(i.price)||1)/((0,b.N)(i.amount)||1),E=v*((0,b.N)(c)||1),K="gram"===i.unit||!i.unit;l.push(o._makeRow({name:i.name,price_per_gram:v,amount:c,total:E,unit:i.unit})),d+=E,K&&(s+=+c)});return function(i){return p.apply(this,arguments)}}()):F&&(l.push(o._makeRow({name:u.name,price_per_gram:void 0,amount:u.amount*(m||1),total:void 0})),s+=+u.amount*(m||1))});return function(u,x){return f.apply(this,arguments)}}())??[]).then(()=>({table:l,totalAmount:d,totalWeight:s}))}_makeRow(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram?.toFixed(5)??"0"),amount:e.amount,total:parseFloat(e.total?.toFixed(5)??"0"),unit:e.unit||"gram",indent:e.indent??0,type:"row"}}_makeCaption(e){return{name:e,unit:void 0,price_per_gram:void 0,amount:void 0,total:void 0,indent:0,type:"caption"}}_makeRecipeCaption(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram.toFixed(5)),amount:e.amount,total:parseFloat(e.total.toFixed(2)),unit:"gram",indent:0,type:"recipe-row"}}_makeTotal(e,n){return{name:"Total",amount:n,unit:"gram",price_per_gram:parseFloat((e/n).toFixed(5)),total:parseFloat(e.toFixed(2)),indent:0,type:"total"}}static \u0275fac=function(n){return new(n||a)(t.KVO(X.m),t.KVO(V.d))};static \u0275prov=t.jDH({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();function U(a,C){if(1&a){const e=t.RV6();t.j41(0,"lg-gap-row",2)(1,"lg-gap-row",3)(2,"div"),t.EFF(3," Calculation outcome: "),t.k0s(),t.j41(4,"div")(5,"lg-number-input",4),t.mxI("ngModelChange",function(o){t.eBV(e);const l=t.XpG(2);return t.DH7(l.outcome_amount,o)||(l.outcome_amount=o),t.Njj(o)}),t.bIt("onInputChange",function(o){t.eBV(e);const l=t.XpG(2);return t.Njj(l.onOutcomeChange(o))}),t.k0s()(),t.j41(6,"div"),t.EFF(7),t.k0s()(),t.j41(8,"lg-gap-row",5)(9,"div"),t.EFF(10," one "),t.k0s(),t.j41(11,"div"),t.EFF(12),t.k0s(),t.j41(13,"div"),t.EFF(14),t.nI1(15,"number"),t.k0s()()()}if(2&a){let e,n,o;const l=t.XpG(2);t.Y8G("fit",!0)("center",!0),t.R7$(),t.Y8G("size","small")("center",!0),t.R7$(4),t.R50("ngModel",l.outcome_amount),t.Y8G("placeholder","Amount"),t.R7$(2),t.SpI(" ",null==(e=l.result())||null==e.recipe?null:e.recipe.outcome_unit," "),t.R7$(),t.Y8G("size","small"),t.R7$(4),t.SpI(" ",null==(n=l.result())||null==n.recipe?null:n.recipe.outcome_unit," "),t.R7$(2),t.SpI(" costs: ",t.i5U(15,10,((null==(o=l.result())?null:o.total)||1)/((null==(o=l.result())||null==o.recipe?null:o.recipe.outcome_amount)||1),"1.2-2")," ")}}function O(a,C){if(1&a){const e=t.RV6();t.j41(0,"lg-gap-row",3)(1,"div"),t.EFF(2," Calculation outcome: "),t.k0s(),t.j41(3,"div")(4,"lg-number-input",4),t.mxI("ngModelChange",function(o){t.eBV(e);const l=t.XpG(2);return t.DH7(l.outcome_amount,o)||(l.outcome_amount=o),t.Njj(o)}),t.bIt("onInputChange",function(o){t.eBV(e);const l=t.XpG(2);return t.Njj(l.onOutcomeChange(o))}),t.k0s()(),t.j41(5,"div"),t.EFF(6),t.nI1(7,"number"),t.k0s()()}if(2&a){let e;const n=t.XpG(2);t.Y8G("size","small")("center",!0),t.R7$(4),t.R50("ngModel",n.outcome_amount),t.Y8G("placeholder","Amount"),t.R7$(2),t.SpI(" costs: ",t.i5U(7,5,null==(e=n.result())?null:e.total,"1.2-2")," ")}}function P(a,C){if(1&a&&(t.j41(0,"lg-gap-row",0),t.DNE(1,U,16,13,"lg-gap-row",2)(2,O,8,8,"lg-gap-row",3),t.k0s()),2&a){let e;const n=t.XpG();t.Y8G("center",!0),t.R7$(),t.vxM(null!=(e=n.result())&&null!=e.recipe&&e.recipe.outcome_unit?1:2)}}function B(a,C){if(1&a&&(t.j41(0,"tr",11)(1,"td"),t.EFF(2),t.k0s(),t.j41(3,"td")(4,"span",11),t.EFF(5),t.k0s()(),t.j41(6,"td"),t.EFF(7),t.k0s(),t.j41(8,"td"),t.EFF(9),t.k0s(),t.j41(10,"td"),t.EFF(11),t.k0s(),t.j41(12,"td"),t.EFF(13),t.k0s()()),2&a){const e=C.$implicit,n=C.$index;t.Y8G("ngClass",e.type),t.R7$(2),t.JRh(n+1),t.R7$(2),t.Y8G("ngClass","indent-"+e.indent),t.R7$(),t.JRh(e.name),t.R7$(2),t.JRh(e.amount),t.R7$(2),t.JRh(e.unit),t.R7$(2),t.JRh(e.price_per_gram),t.R7$(2),t.JRh(e.total)}}function D(a,C){if(1&a&&(t.j41(0,"table")(1,"colgroup"),t.nrm(2,"col",6)(3,"col",7)(4,"col",8)(5,"col",9)(6,"col",8)(7,"col",10),t.k0s(),t.j41(8,"thead")(9,"tr")(10,"th"),t.EFF(11,"#"),t.k0s(),t.j41(12,"th"),t.EFF(13,"Name"),t.k0s(),t.j41(14,"th"),t.EFF(15,"Amount"),t.k0s(),t.j41(16,"th"),t.EFF(17,"Unit"),t.k0s(),t.j41(18,"th"),t.EFF(19,"Price per unit"),t.k0s(),t.j41(20,"th"),t.EFF(21,"Total"),t.k0s()()(),t.j41(22,"tbody"),t.Z7z(23,B,14,8,"tr",11,t.Vm6),t.k0s()()),2&a){let e;const n=t.XpG();t.R7$(23),t.Dyx(null==(e=n.result())?null:e.result)}}function W(a,C){1&a&&(t.j41(0,"div"),t.EFF(1,"Loading..."),t.k0s())}let J=(()=>{class a{_aRoute;_calculateRecipeService;constructor(e,n){this._aRoute=e,this._calculateRecipeService=n}uuid=(0,t.vPA)("");result=(0,t.vPA)(null);outcome_amount=(0,t.geq)(0);onOutcomeChange=e=>{this._calculateRecipeService.calculateRecipe(this.uuid(),e).then(n=>{this.result.set(n)})};ngOnInit(){this._aRoute.params.subscribe(e=>{this.uuid.set(e.uuid),this._calculateRecipeService.calculateRecipe(e.uuid).then(n=>{this.result.set(n),this.outcome_amount.set(n?.recipe?.outcome_amount||0)})})}static \u0275fac=function(n){return new(n||a)(t.rXU(M.nX),t.rXU(z))};static \u0275cmp=t.VBU({type:a,selectors:[["lg-calculate-recipe"]],inputs:{outcome_amount:[1,"outcome_amount"]},outputs:{outcome_amount:"outcome_amountChange"},decls:12,vars:14,consts:[[3,"center"],[3,"flat","link","size"],[3,"fit","center"],[3,"size","center"],["lgParseMath","",3,"ngModelChange","onInputChange","ngModel","placeholder"],[3,"size"],["span","1",2,"width","1%"],["span","1",2,"width","20%"],["span","1",2,"width","5%"],["span","1",2,"width","3%"],["span","1",2,"width","7%"],[3,"ngClass"]],template:function(n,o){if(1&n&&(t.j41(0,"lg-container")(1,"lg-gap-row",0)(2,"lg-title"),t.EFF(3),t.k0s(),t.j41(4,"lg-button",1),t.EFF(5," Edit "),t.k0s(),t.j41(6,"lg-button",1),t.EFF(7," Back to list "),t.k0s()(),t.DNE(8,P,3,2,"lg-gap-row",0),t.j41(9,"lg-table-card"),t.DNE(10,D,25,0,"table")(11,W,2,0,"div"),t.k0s()()),2&n){let l,s,d;t.R7$(),t.Y8G("center",!0),t.R7$(2),t.SpI(" ",null==(l=o.result())||null==l.recipe?null:l.recipe.name," cost calculation "),t.R7$(),t.Aen("primary"),t.Y8G("flat",!0)("link","/edit-recipe/"+(null==(s=o.result())||null==s.recipe?null:s.recipe.uuid))("size","small"),t.R7$(2),t.Aen("warning"),t.Y8G("flat",!0)("link","/recipes")("size","small"),t.R7$(2),t.vxM(null!=(d=o.result())&&d.total?8:-1),t.R7$(2),t.vxM(o.result()?10:11)}},dependencies:[T.H,G.W,I,k.YU,w.Q,N.I,k.QX,Y.N,y.YN,y.BC,y.vS,S.t],styles:[":host{--control-bg: #fff}lg-number-input .lg-number-input{width:100px}\n"],encapsulation:2})}return a})()}}]);