import{a as g,b as v}from"./chunk-VFYW5T2O.js";import{a as u,b as m,c as y,d as l,e as D,f as S,g as T}from"./chunk-CSWOURBG.js";import{z as R}from"./chunk-ARNKAMDX.js";import{U as f,Y as s,f as _}from"./chunk-VOOOUGHD.js";import{a as p,b as h,f as c}from"./chunk-2WH2EVR6.js";var d=class a{constructor(t){this.name=t.name,this.amount=u(t.amount),this.product_id=t.product_id?y.fromRaw(typeof t.product_id=="string"?{uuid:t.product_id}:t.product_id):void 0,this.recipe_id=t.recipe_id?n.fromRaw(typeof t.recipe_id=="string"?{uuid:t.recipe_id}:t.recipe_id):void 0,this.unit=t.unit}name;product_id;recipe_id;amount;unit;get uuid(){return this.product_id?.uuid||this.recipe_id?.uuid}get generalName(){return this.product_id?.name||this.recipe_id?.name||this.name||"Unknown ingredient"}get totalWeightGram(){return this.unit!=="gram"?0:u(this.amount)}get pricePerUnit(){return this.product_id&&this.product_id.unit!=="gram"?this.product_id?.pricePerUnit:this.totalPrice/this.totalWeightGram}get totalPrice(){let t=0;return this.product_id&&(this.product_id.unit!=="gram"?t+=this.product_id.pricePerUnit*this.amount:t+=this.product_id.pricePerUnit*this.totalWeightGram),this.recipe_id&&(t+=this.recipe_id.totalPrice),t}get blanked(){return!this.amount}get typeSelected(){return!!this.product_id||!!this.recipe_id||!!this.name}get amountValid(){return u(this.amount)>0}get allEmpty(){return!this.name&&!this.amount&&!this.product_id&&!this.recipe_id}static fromRaw(t){return new a({name:t?.name,amount:t?.amount,product_id:t?.product_id,recipe_id:t?.recipe_id,unit:t?.unit})}static empty(){return new a({name:"",amount:0,product_id:void 0,recipe_id:void 0,unit:"gram"})}toDTO(){return{name:this.name?.trim(),amount:u(this.amount),product_id:this.product_id?.uuid,recipe_id:this.recipe_id?.uuid,unit:this.unit||"gram"}}update(t){return this.name=t?.name||this.name,this.amount=t?.amount||this.amount,this.product_id=t?.product_id||this.product_id,this.recipe_id=t?.recipe_id||this.recipe_id,this.unit=t?.unit||this.unit,this}};var n=class a{constructor(t){this.name=String(t.name).trim(),this.description=String(t.description).trim(),this.ingredients=t.ingredients.map(e=>d.fromRaw(e)),this.outcome_amount=parseFloat(String(t.outcome_amount)),this.outcome_unit=String(t.outcome_unit)||"gram",this.uuid=String(t.uuid).trim()||void 0,this.taxTemplateName=String(t.taxTemplateName).trim()||void 0,this.category_id=g.fromRaw(typeof t.category_id=="string"?{uuid:t.category_id}:t.category_id),this.tags=t.tags?.map(e=>m.fromRaw(e)),this.createdAt=t.createdAt?Number(t.createdAt):void 0,this.updatedAt=t.updatedAt?Number(t.updatedAt):void 0}name;description;ingredients;outcome_amount;outcome_unit;uuid;taxTemplateName;category_id;createdAt;updatedAt;tags;get valid(){return this.name&&this.ingredients.length>0&&this.outcome_amount>0&&this.category_id}get totalPrice(){return this.ingredients.reduce((t,e)=>t+e.totalPrice,0)}get perUnitLabel(){return!this.outcome_unit||this.outcome_unit==="gram"?"per gram":`per ${this.outcome_unit}`}get pricePerUnit(){return this.outcome_unit&&this.outcome_unit!=="gram"?this.totalPrice/this.outcome_amount:this.totalPrice/this.totalIngredientsWeight}get totalIngredientsWeight(){return this.ingredients.reduce((t,e)=>t+e.amount*(e.unit==="gram"?1:0),0)}get outcomeAmountGreaterThanIngredients(){return u(this.outcome_amount)>this.totalIngredientsWeight}static fromRaw(t){return new a({name:t?.name||"",description:t?.description||"",ingredients:t?.ingredients||[],outcome_amount:t?.outcome_amount||0,outcome_unit:t?.outcome_unit||"gram",uuid:t?.uuid,taxTemplateName:t?.taxTemplateName,category_id:t?.category_id,createdAt:t?.createdAt,updatedAt:t?.updatedAt,tags:t?.tags})}static empty(){return new a({name:"",description:"",ingredients:[],outcome_amount:0,outcome_unit:"gram",uuid:void 0,taxTemplateName:void 0,category_id:null,createdAt:void 0,updatedAt:void 0})}removeIngredient(t){this.ingredients.splice(t,1)}addIngredient(t){this.ingredients.push(t)}clearEmpty(){this.ingredients=this.ingredients.filter(t=>!t.blanked)}toDTO(){return{name:this.name,description:this.description,ingredients:this.ingredients.map(t=>t.toDTO()),outcome_amount:this.outcome_amount,outcome_unit:this.outcome_unit,uuid:this.uuid,taxTemplateName:this.taxTemplateName,category_id:this.category_id.toUUID(),createdAt:this.createdAt||Date.now(),updatedAt:this.updatedAt||Date.now(),tags:this.tags?.map(t=>t.toString())}}update(t){this.name=t?.name||this.name,this.description=t?.description||this.description,this.ingredients=t?.ingredients?t.ingredients.map(e=>d.fromRaw(e)):this.ingredients,this.outcome_amount=t?.outcome_amount||this.outcome_amount,this.outcome_unit=t?.outcome_unit||this.outcome_unit,this.uuid=t?.uuid||this.uuid,this.taxTemplateName=t?.taxTemplateName||this.taxTemplateName,this.category_id=g.fromRaw(t?.category_id)||this.category_id,this.createdAt=t?.createdAt||this.createdAt,this.updatedAt=t?.updatedAt||Date.now(),this.tags=t?.tags?t.tags.map(e=>m.fromRaw(e)):this.tags}};var b=class a{constructor(t,e,i,r,o,w){this._indexDbService=t;this._usingHistoryService=e;this._categoryRepository=i;this._draftFormsService=r;this._tagsRepository=o;this._productsRepository=w}_stream$=new _;get recipes$(){return this._stream$.asObservable()}addRecipe(t){return c(this,null,function*(){t.clearEmpty();let e=t.toDTO(),i=yield this._indexDbService.addData("recipesStore",e);if(e.category_id&&this._saveCategory(e.category_id),this._saveRecipeToHistory(i),t.tags?.length)for(let r of t.tags)yield this._saveTag(r);return i})}loadRecipes(){return this._indexDbService.getAll("recipesStore").then(t=>{let e=t.map(i=>n.fromRaw(i));return this._stream$.next(e),e})}getRecipes(){return this._indexDbService.getAll("recipesStore").then(t=>t.map(e=>n.fromRaw(e)).toSorted((e,i)=>e.name.localeCompare(i.name)))}getOne(t,e=!1){return c(this,null,function*(){return new Promise((i,r)=>c(this,null,function*(){if(!t){i(void 0);return}t=t.uuid||t,e?yield this._indexDbService.getOneWithRelations("recipesStore",t).then(o=>{i(n.fromRaw(o))}):yield this._indexDbService.getOne("recipesStore",t).then(o=>{i(n.fromRaw(o))})}))})}editRecipe(t,e){return c(this,null,function*(){if(e.clearEmpty(),yield this._indexDbService.replaceData("recipesStore",t,e.toDTO()),this._saveRecipeToHistory(t),e.tags?.length)for(let i of e.tags)yield this._saveTag(i)})}saveDraftRecipe(t,e){let i=this._draftFormsService.setDraftForm("draft_recipes",t.toDTO(),e?.length?"edit":"add",e?{uuid:e}:{});return i?h(p({},i),{data:t}):void 0}updateDraftRecipe(t,e,i){this._draftFormsService.updateDraftForm("draft_recipes",e.toDTO(),t,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftRecipe(t){let e=this._draftFormsService.getDraftForms("draft_recipes");return t&&e?.[t]?[e?.[t]]:e?Object.values(e):[]}removeDraftRecipe(t){this._draftFormsService.removeDraftForm("draft_recipes",t)}deleteRecipe(t){return this._indexDbService.remove("recipesStore",t)}getTopCategories(){let{top:t}=this._usingHistoryService.read("recipes_categories"),e=Object.keys(t);return e.length===0?Promise.resolve([]):this._categoryRepository.getManyCategories(e).then(i=>i.toSorted((r,o)=>!r.uuid||!o.uuid?0:t[o.uuid].count>t[r.uuid].count?1:-1))}getLastRecipes(){let{top:t}=this._usingHistoryService.read("recipes"),e=Object.keys(t);return e.length===0?Promise.resolve([]):this._indexDbService.getMany("recipesStore",e).then(i=>i.toSorted((r,o)=>t[o.uuid].count>t[r.uuid].count?1:-1).map(r=>({recipe:n.fromRaw(r),updatedAt:t[r.uuid].updatedAt,count:t[r.uuid].count})))}_saveCategory(t){this._usingHistoryService.count("recipes_categories",t)}_saveRecipeToHistory(t){this._usingHistoryService.count("recipes",t)}_saveTag(t){return this._tagsRepository.addOne(t)}static \u0275fac=function(e){return new(e||a)(s(R),s(l),s(v),s(D),s(S),s(T))};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})};export{d as a,n as b,b as c};
