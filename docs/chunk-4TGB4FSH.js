import{b as he,e as ye,i as ve,p as xe}from"./chunk-2XBDGHLZ.js";import{c as N,d as Ce}from"./chunk-T5OOR2YZ.js";import{a as we}from"./chunk-ZDTDYXDD.js";import{a as ge}from"./chunk-TTH7B7VT.js";import{b as fe}from"./chunk-XRFFTXPM.js";import{$a as pe,Ab as P,Ca as g,Cb as de,Da as C,Db as H,E as W,G as L,Ga as ne,Ha as oe,Ia as l,Ja as p,Lb as me,M as F,Na as J,Nb as ue,Oa as h,Ob as _e,P as Q,Pa as m,Qa as s,Ra as R,Sa as O,U as _,V as f,Va as re,Wa as ae,Xa as le,Ya as se,Z as Y,Za as E,_a as D,a as K,ab as u,b as X,bb as ce,eb as y,f as V,fb as v,gb as x,ia as c,j as z,ja as ee,jb as q,la as T,na as w,nb as G,ob as Z,pa as te,ra as B,wa as d,xa as ie,ya as $,yb as U,za as M,zb as k}from"./chunk-FL5UAJ26.js";var A=class o{constructor(i){this.templateRef=i}static \u0275fac=function(e){return new(e||o)(T(ee))};static \u0275dir=te({type:o,selectors:[["","lgImportRowTpl",""]]})};var S=class o{constructor(){}readFromCSVFile(i){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{let r=n.result,a=this.parseData(r),[ke,...Ae]=a,Ie=this.arrayToObjects(Ae,ke);e(Ie)},n.onerror=()=>{t(n.error)},n.readAsText(i)})}readFromJSONFile(i){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{try{let r=n.result,a=JSON.parse(r);e(a)}catch(r){t(r)}},n.onerror=()=>{t(n.error)},n.readAsText(i)})}parseData(i){return i.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(i,e){return i.map(t=>{let n={};return e.forEach((r,a)=>{n[r]=t[a]}),n})}makeCsv(i){let e=Object.keys(i[0]),t=i.map(r=>e.map(a=>r[a]));return[e,...t].map(r=>r.join(",")).join(`\r
`)}saveToCSVFile(i,e){let t=this.makeCsv(i),n=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(n),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",r),a.setAttribute("download",e),a.click(),URL.revokeObjectURL(r)}saveToJSONFile(i,e){let t=JSON.stringify(i,null,2),n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",r),a.setAttribute("download",e),a.click(),URL.revokeObjectURL(r)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=F({token:o,factory:o.\u0275fac,providedIn:"root"})};var je=["input"],Fe=["*"],b=class o{filesSelected=U();accept=k(".csv");input=P("input");onFileChange(i){let t=i.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=w({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&E(t.input,je,5),e&2&&D()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Fe,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let n=h();R(),l(0,"div",1),m("click",function(){_(n);let a=pe(2);return f(a.click())}),l(1,"input",2,0),m("change",function(a){return _(n),f(t.onFileChange(a))}),p(),l(3,"div",3),O(4),p()()}e&2&&(c(),d("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Me=["*"],j=class o{constructor(){}displayed=Y(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=w({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Me,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(R(),l(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),O(5),p()()()()()),e&2&&ie("display",t.displayed()?"flex":"none")},dependencies:[fe],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var Oe=o=>({$implicit:o,flow:"new"}),Ee=o=>({$implicit:o,flow:"old"}),Ue=(o,i)=>i.name+i.uuid;function Pe(o,i){if(o&1){let e=h();l(0,"input",9),x("ngModelChange",function(n){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToUpdate[r.name],n)||(a.rowsToUpdate[r.name]=n),f(n)}),p(),u(1," Update ")}if(o&2){let e=s().$implicit,t=s(3);y("ngModel",t.rowsToUpdate[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Ne(o,i){if(o&1){let e=h();l(0,"input",10),x("ngModelChange",function(n){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToAdd[r.name],n)||(a.rowsToAdd[r.name]=n),f(n)}),p(),u(1," Add ")}if(o&2){let e=s().$implicit,t=s(3);y("ngModel",t.rowsToAdd[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Ve(o,i){o&1&&J(0)}function ze(o,i){if(o&1&&B(0,Ve,1,0,"ng-container",11),o&2){let e=s().$implicit,t=s(3);d("ngTemplateOutlet",t.rowTemplate().templateRef)("ngTemplateOutletContext",q(2,Oe,e))}}function We(o,i){o&1&&J(0)}function Le(o,i){if(o&1&&B(0,We,1,0,"ng-container",11),o&2){let e=s(2).$implicit,t=s(),n=s(2);d("ngTemplateOutlet",n.rowTemplate().templateRef)("ngTemplateOutletContext",q(2,Ee,t[e.uuid]||t[e.name]))}}function Qe(o,i){if(o&1){let e=h();l(0,"div",12)(1,"input",9),x("ngModelChange",function(n){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToSkip[r.name],n)||(a.rowsToSkip[r.name]=n),f(n)}),p(),l(2,"span"),u(3),p(),g(4,Le,1,4,"ng-container"),p()}if(o&2){let e=s().$implicit,t=s(3);$("disabled",t.rowsToUpdate[e.name])("skip",t.rowsToUpdate[e.name]),d("ngClass",t.rowsToSkip[e.name]?"skip":"duplicated"),c(),y("ngModel",t.rowsToSkip[e.name]),d("disabled",t.rowsToAdd[e.name]||t.rowsToUpdate[e.name]),c(2),ce(t.rowsToSkip[e.name]?"Skip":"Duplicates"),c(),C(t.rowTemplate()?4:-1)}}function Be(o,i){if(o&1&&(l(0,"lg-gap-column",6)(1,"div",7),g(2,Pe,2,2)(3,Ne,2,2),g(4,ze,1,4,"ng-container"),p(),g(5,Qe,5,9,"div",8),p()),o&2){let e=i.$implicit,t=s(),n=s(2);d("size","small"),c(),$("update",n.rowsToUpdate[e.name])("add",n.rowsToAdd[e.name])("disabled",n.rowsToSkip[e.name]),c(),C(t[e.uuid]||t[e.name]?2:3),c(2),C(n.rowTemplate()?4:-1),c(),C(t[e.uuid]||t[e.name]?5:-1)}}function $e(o,i){if(o&1&&(l(0,"lg-gap-column",6),ne(1,Be,6,10,"lg-gap-column",6,Ue),p()),o&2){let e=s();d("size","medium"),c(),oe(e)}}function Je(o,i){if(o&1&&(g(0,$e,3,1,"lg-gap-column",6),G(1,"async")),o&2){let e,t=s();C((e=Z(1,1,t.analize$))?0:-1,e)}}var Te=class o{constructor(i,e){this._csvReaderService=i;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=U();storeName=k(null);schema=k();skipAllDuplicates=H(!1);replaceAll=H(!1);rowTemplate=de(A);analizeSubject=new z;dataSubject=new z;data$=this.dataSubject.asObservable().pipe(L([]),W((i,e)=>e==null?[]:[...i,e]));analize$=this.analizeSubject.asObservable().pipe(L([]),W((i,e)=>e==null?[]:!e.uuid||!e.name?i:X(K({},i),{[e.uuid]:e,[e.name]:e})));dialog;upload=P(b);parsedData=[];onConfirm(){return V(this,null,function*(){for(let i of this.parsedData)this.rowsToAdd[i.name]?yield this._indexDbService.addData(this.storeName(),i):this.rowsToUpdate[i.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),i.uuid,i));this.clear(),this.onDone.emit(),this.dialog.close()})}onClose(){this.clear(),this.dialog.close()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToUpdate[i.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToSkip[i.name]=!0,this.rowsToUpdate[i.name]&&(this.rowsToUpdate[i.name]=!1))}):this.rowsToSkip={}}onFileSelected(i){this.dialog.open(),this._csvReaderService.readFromJSONFile(i[0]).then(e=>V(this,null,function*(){for(let t of e){let n=this.schema()?.safeParse(t);if(!n?.success){console.log("error",n?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(n.data),yield this._analyzeDuplicates(n.data).then(r=>{r.duplicate?this.analizeSubject.next(r.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(i){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",i.name).then(n=>{n.length?e({data:n,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(T(S),T(N))};static \u0275cmp=w({type:o,selectors:[["lg-import"]],contentQueries:function(e,t,n){e&1&&se(n,t.rowTemplate,A,5),e&2&&D()},viewQuery:function(e,t){if(e&1&&(E(t.upload,b,5),re(j,5)),e&2){D();let n;ae(n=le())&&(t.dialog=n.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:20,vars:23,consts:[[3,"filesSelected","accept"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(l(0,"lg-upload",0),m("filesSelected",function(r){return t.onFileSelected(r)}),l(1,"lg-button",1),u(2," Import "),p()(),l(3,"lg-dialog")(4,"lg-gap-column"),g(5,Je,2,3),G(6,"async"),l(7,"lg-gap-row",2)(8,"input",3),m("change",function(){return t.onSkipAllDuplicates()}),x("ngModelChange",function(r){return v(t.skipAllDuplicates,r)||(t.skipAllDuplicates=r),r}),p(),l(9,"label"),u(10,"Skip all duplicates"),p()(),l(11,"lg-gap-row",2)(12,"input",3),m("change",function(){return t.onReplaceAll()}),x("ngModelChange",function(r){return v(t.replaceAll,r)||(t.replaceAll=r),r}),p(),l(13,"label"),u(14,"Replace all with new"),p()(),l(15,"lg-gap-row",4)(16,"lg-button",5),m("click",function(){return t.onClose()}),u(17," Close "),p(),l(18,"lg-button",5),m("click",function(){return t.onConfirm()}),u(19," Confirm "),p()()()()),e&2){let n;d("accept",".json"),c(),M("warning"),d("flat",!0)("size","small"),c(4),C((n=Z(6,21,t.data$))?5:-1,n),c(2),d("center",!0)("hidden",t.replaceAll())("size","small"),c(),y("ngModel",t.skipAllDuplicates),c(3),d("center",!0)("hidden",t.skipAllDuplicates())("size","small"),c(),y("ngModel",t.replaceAll),c(3),d("center",!0),c(),M("danger"),d("size","small"),c(2),M("success"),d("size","small")}},dependencies:[b,Ce,j,_e,ge,we,xe,he,ye,ve,me,ue],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var De=class o{constructor(i,e){this._indexDbService=i;this._csvReaderService=e}exportTable(i,e="csv"){return this._indexDbService.getAll(i).then(t=>{if(e==="json"){this._csvReaderService.saveToJSONFile(t,this._getFileName(i,e));return}this._csvReaderService.saveToCSVFile(t,this._getFileName(i,e))})}_getFileName(i,e){let t=new Date().toISOString();return`${i}_export_${t}.${e}`}makeCsv(i){return this._csvReaderService.makeCsv(i)}static \u0275fac=function(e){return new(e||o)(Q(N),Q(S))};static \u0275prov=F({token:o,factory:o.\u0275fac,providedIn:"root"})};export{A as a,S as b,Te as c,De as d};
