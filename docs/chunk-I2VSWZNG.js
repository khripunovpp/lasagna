import{a as w}from"./chunk-HJLFP4TR.js";import{a as h,c as P}from"./chunk-2MXD6BT6.js";import{M as b,P as R,a as y,b as f,f as u}from"./chunk-6C36DQV4.js";var k=class d{constructor(e,t){this._recipeRepository=e;this._productRepository=t}calculation;linkTaxTemplate(e,t){return new Promise((a,i)=>u(this,null,function*(){yield this._recipeRepository.getOne(e).then(o=>u(this,null,function*(){if(!o){a(null);return}o.taxTemplateName=t,yield this._recipeRepository.editRecipe(o.uuid,this._recipeRepository.recipeToDto(o)),a(o)}))}))}calculateRecipe(e,t=0){return new Promise((a,i)=>u(this,null,function*(){let o=[],n=0,T=0;yield this._recipeRepository.getOne(e).then(p=>u(this,null,function*(){let s=(t||p?.outcome_amount||1)/(p?.outcome_amount||1),{table:l,totalAmount:m,totalWeight:r}=yield this._makeIngredientTable(p,s);n+=m||0,T+=r||0,o.push(...l),o.push(this._makeTotal(n,T)),a({recipe:p,result:o,total:n,totalWeight:T})}))}))}getRecipe(e){return u(this,null,function*(){if(!e)return;let t=yield this._recipeRepository.getOne(e);if(!t)return;let a=0;return t.outcome_unit&&t.outcome_amount?a=t.outcome_amount:a=t?.ingredients?.reduce((i,o)=>{if(o.unit!=="gram")return i;let n=h(o.amount)||0;return i+n},0)??0,f(y({totalAmountInGrams:a||0},t),{pricePerUnit:0})})}_makeRecipeSubTable(e,t=0){return u(this,null,function*(){return new Promise((a,i)=>u(this,null,function*(){let o=[],n=0,T=0,p=e.amount;yield this.getRecipe(e.recipe_id).then(s=>u(this,null,function*(){let l=p/(s?.totalAmountInGrams||1),m=yield this._makeIngredientTable(s,t);m.table=m.table.map((c,x)=>{let I=(c.amount||0)*(t||1)*l;return f(y({},c),{amount:parseFloat((I||0).toFixed(5)),total:parseFloat((c.total?c.total*l:0).toFixed(5)),indent:c.indent+1})});let r=m.totalAmount?m.totalAmount/m.totalWeight:0,g=(s?.totalAmountInGrams||0)*t*l,_=m.totalAmount*l;o.push(this._makeRecipeCaption({name:s?.name||"Unknown recipe",price_per_gram:r,amount:g,total:_,unit:e.unit,uuid:s?.uuid||""})),o.push(...m.table),T+=_,n+=m.totalWeight*l,a({table:o,totalAmount:T,totalWeight:n})}))}))})}_makeIngredientTable(e,t=0){let a=[],i=0,o=0;return Promise.all(e?.ingredients.map((n,T)=>u(this,null,function*(){let p=n.recipe_id,s=n.product_id,l=n.name;if(!p&&!s&&!l){let m=n.amount;return}if(p){let m=yield this._makeRecipeSubTable(n,t);a.push(...m.table),o+=m.totalAmount,i+=m.totalWeight}else if(s){let m=yield this._productRepository.getOne(n.product_id).then(r=>u(this,null,function*(){if(!r){a.push(this._makeRow({name:"Unknown product",price_per_gram:void 0,amount:n.amount*(t||1),total:void 0,uuid:r?.uuid||""}));return}if(!r?.price){a.push(this._makeRow({name:r.name,price_per_gram:0,amount:n.amount*(t||1),total:0,uuid:r?.uuid||""}));return}if(!r?.amount){a.push(this._makeRow({name:r.name,price_per_gram:0,amount:n.amount*(t||1),total:0,uuid:r?.uuid||""}));return}let g=n.amount*(t||1),_=(h(r.price)||1)/(h(r.amount)||1),c=_*(h(g)||1),x=r.unit==="gram"||!r.unit;a.push(this._makeRow({name:r.name,price_per_gram:_,amount:g,total:c,unit:r.unit,uuid:r?.uuid||""})),o+=c,x&&(i+=+g)}))}else l&&(a.push(this._makeRow({name:n.name??"Unknown ingredient",price_per_gram:void 0,amount:n.amount*(t||1),total:void 0,uuid:""})),i+=+n.amount*(t||1))}))??[]).then(()=>({table:a,totalAmount:o,totalWeight:i}))}_makeRow(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram?.toFixed(5)??"0"),amount:e.amount,total:parseFloat(e.total?.toFixed(5)??"0"),unit:e.unit||"gram",indent:e.indent??0,type:"row",uuid:e.uuid}}_makeCaption(e){return{name:e,unit:void 0,price_per_gram:void 0,amount:void 0,total:void 0,indent:0,type:"caption"}}_makeRecipeCaption(e){return{name:e.name,price_per_gram:parseFloat(e.price_per_gram.toFixed(5)),amount:e.amount,total:parseFloat(e.total.toFixed(2)),unit:e.unit||"gram",indent:0,type:"recipe-row",uuid:e.uuid}}_makeTotal(e,t){return{name:"Total (without taxes and fees)",amount:t,unit:"gram",price_per_gram:parseFloat((e/t).toFixed(5)),total:parseFloat(e.toFixed(2)),indent:0,type:"total"}}static \u0275fac=function(t){return new(t||d)(R(w),R(P))};static \u0275prov=b({token:d,factory:d.\u0275fac,providedIn:"root"})};var v=class d{constructor(){}getTemplates(e){let t=localStorage.getItem(this.getStorageKey(e));return t?JSON.parse(t):[]}getTemplateById(e,t){return this.getTemplates(e).find(i=>i.id===t)}getTemplateByName(e,t){return this.getTemplates(e).find(i=>i.name===t)}saveTemplate(e,t){let a=this.getTemplates(e);this._checkUniqName(a,t.name)?(a.push(t),this._storeTemplates(e,a)):this.updateTemplateData(e,t.name,t.data)}updateTemplateData(e,t,a){let i=this.getTemplates(e),o=i.find(n=>n.name===t);o&&(o.data=a,this._storeTemplates(e,i))}deleteTemplate(e,t){let a=this.getTemplates(e).filter(i=>i.id!==t);this._storeTemplates(e,a)}updateTemplate(e,t){let a=this.getTemplates(e).map(i=>i.id===t.id?t:i);this._storeTemplates(e,a)}_checkUniqName(e,t){return!e.some(a=>a.name===t)}getStorageKey(e){return`template-${e}`}_storeTemplates(e,t){localStorage.setItem(this.getStorageKey(e),JSON.stringify(t))}static \u0275fac=function(t){return new(t||d)};static \u0275prov=b({token:d,factory:d.\u0275fac,providedIn:"root"})};export{k as a,v as b};
