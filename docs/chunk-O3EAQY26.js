import{a as Ue}from"./chunk-K5DQMW66.js";import{a as Ge}from"./chunk-5VR5YUUD.js";import{a as De}from"./chunk-USIJWNW5.js";import{a as pe,b as z,c as B}from"./chunk-NECHCYOO.js";import"./chunk-P7L2C53Q.js";import{a as Ie}from"./chunk-3QIAGCJF.js";import{a as ge}from"./chunk-PHGQT4GW.js";import{a as Pe,b as Oe,c as je}from"./chunk-WPTWQ6AD.js";import{f as ke}from"./chunk-L4SNU4IB.js";import{a as M}from"./chunk-DKKRBT3L.js";import{a as Me,b as Ne,c as $e}from"./chunk-67BCPUJW.js";import{a as Ve}from"./chunk-OW4OSQWU.js";import{a as Ee}from"./chunk-W6VMIXDL.js";import{a as Te}from"./chunk-UZ4ZOUQK.js";import{a as q}from"./chunk-TOH5IIUM.js";import"./chunk-H46Y7ZP7.js";import{a as fe}from"./chunk-GMS3E2FY.js";import{a as H,e as Ce,g as Re,h as he,i as Y,j as x,l as xe,n as ve,o as ye,p as we,q as be,r as Se,s as Ae,t as Fe}from"./chunk-E5I57XC6.js";import{a as Q}from"./chunk-C3YIVVSQ.js";import{a as se,b as de,c as _e}from"./chunk-UYEJDPNH.js";import{a as ue}from"./chunk-LVIA722N.js";import{a as me}from"./chunk-2ZEJWSE3.js";import"./chunk-SNDQO5FA.js";import"./chunk-5ZHT4QO7.js";import"./chunk-Z2KUFMIF.js";import{o as $,r as L}from"./chunk-K7R7MOA3.js";import"./chunk-IZT3LVRQ.js";import{Ab as r,Bb as l,Cb as h,Db as F,Eb as I,F as N,Gb as C,Jb as f,Kb as a,Lb as P,Mb as D,Ta as c,Tb as T,Ub as G,Vb as k,Wb as d,Xb as ne,Ya as R,Yb as O,bb as S,bc as oe,fa as m,ga as u,hc as re,ic as le,ma as y,ob as s,qb as ee,qc as ce,r as Z,rb as A,rc as ae,ub as _,vb as g,vc as E,wc as j,xc as U,yb as te,zb as ie}from"./chunk-PNZYYIKS.js";import"./chunk-DELOOZDJ.js";import{a as w,b}from"./chunk-2WH2EVR6.js";var ze=["*"];function Be(n,i){if(n&1&&(r(0,"p",1),d(1),l()),n&2){let e=a();c(),O(" ",e.label()," ")}}var W=class n{constructor(){}label=E("");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=S({type:n,selectors:[["lg-control-group"]],inputs:{label:[1,"label"]},ngContentSelectors:ze,decls:4,vars:1,consts:[[1,"control-group"],[1,"control-group__label"],[1,"control-group__content"]],template:function(e,t){e&1&&(P(),r(0,"div",0),_(1,Be,2,1,"p",1),r(2,"div",2),D(3),l()()),e&2&&(c(),g(t.label()?1:-1))},styles:["[_nghost-%COMP%]{display:flex;flex:1}.control-group[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:16px}.control-group__label[_ngcontent-%COMP%]{font-size:1.2rem;margin:0}.control-group__content[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:flex-end}.control-group__content[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{flex:1}"]})};var Qe=["*",[["rowActions"]]],He=["*","rowActions"],K=class n{constructor(){}mobileMode=E(!1);static \u0275fac=function(e){return new(e||n)};static \u0275cmp=S({type:n,selectors:[["lg-controls-row"]],inputs:{mobileMode:[1,"mobileMode"]},ngContentSelectors:He,decls:5,vars:2,consts:[[1,"controls-row"],[1,"controls-row__controls"],[1,"controls-row__actions"]],template:function(e,t){e&1&&(P(Qe),r(0,"div",0)(1,"div",1),D(2),l(),r(3,"div",2),D(4,1),l()()),e&2&&ee("controls-row__mobile",t.mobileMode())},styles:[`:host{display:flex;gap:16px}.controls-row{width:100%;display:flex;align-items:flex-end;gap:16px;flex:1}.controls-row__controls,.controls-row__actions{display:flex;align-items:flex-end;gap:16px}.controls-row__controls{flex:1}.controls-row__actions{flex:0;white-space:nowrap;align-self:center}.controls-row__controls>*,.controls-row__actions>*{flex:1}@media (max-width: 600px){.controls-row__mobile,.controls-row__mobile .controls-row__controls{flex-direction:column;align-items:stretch}.controls-row__mobile .controls-row__actions{align-self:flex-end}}
`],encapsulation:2})};var Ye=["tooltipComponent"],Je=["products"],Xe=["productsSelector"],Ze=["nameField"],et=(n,i)=>i.value.amount+n;function tt(n,i){if(n&1){let e=C();r(0,"lg-gap-column",22)(1,"lg-control",29),F(2,30),r(3,"span",31),f("click",function(){m(e);let o=a().$index,p=a();return u(p.closeTextField(o))}),d(4,"Hide"),l(),I(),r(5,"lg-input",32),f("onInputChanged",function(){m(e);let o=a().$index,p=k(6),v=a();return u(v.onIngredientSelected(p,o,["product_id","recipe_id"]))}),l()()()}n&2&&(s("size","small"),c(5),s("placeholder","Here you can write the name of the ingredient"))}function it(n,i){if(n&1){let e=C();r(0,"lg-multiselect",38),f("onSelected",function(){m(e);let o=a(2).$index,p=k(6),v=a();return u(v.onIngredientSelected(p,o,["product_id","name"]))}),l()}n&2&&s("resource","recipes")("autoLoad",!0)}function nt(n,i){if(n&1){let e=C();r(0,"lg-multiselect",39,3),f("onSelected",function(){m(e);let o=a(2).$index,p=k(6),v=a();return u(v.onIngredientSelected(p,o,["recipe_id","name"]))}),l()}n&2&&s("resource","products")("autoLoad",!0)}function ot(n,i){if(n&1){let e=C();r(0,"lg-gap-column",22)(1,"lg-control"),F(2,33),r(3,"lg-button",34),f("click",function(){m(e);let o=a().$index,p=a();return u(p.closeRecipeField(o))}),d(4," Product "),l(),I(),F(5,35),r(6,"lg-button",34),f("click",function(){m(e);let o=a().$index,p=a();return u(p.openRecipeField(o))}),d(7,"Recipe "),l(),I(),F(8,30),r(9,"span",31),f("click",function(){m(e);let o=a().$index,p=a();return u(p.openTextField(o))}),d(10,"As text"),l(),I(),_(11,it,1,2,"lg-multiselect",36)(12,nt,2,2,"lg-multiselect",37),l()()}if(n&2){let e=a().$index,t=a();s("size","small"),c(3),s("flat",!0)("size","small")("active",!t.recipeFieldState()[e]),c(3),s("flat",!0)("size","small")("active",t.recipeFieldState()[e]),c(5),g(t.recipeFieldState()[e]?11:12)}}function rt(n,i){if(n&1){let e=C();F(0,16),r(1,"lg-controls-row",21),_(2,tt,6,2,"lg-gap-column",22)(3,ot,13,8,"lg-gap-column",22),r(4,"lg-control",23)(5,"lg-number-input",24,1),f("onKeydown",function(){m(e);let o=a();return u(o.addLast())}),l()(),h(7,"lg-buttons-group",25),F(8,26),r(9,"lg-button",27),f("click",function(){let o=m(e).$index,p=a();return u(p.deleteIngredient(o))}),h(10,"mat-icon",28),l(),I(),l(),I()}if(n&2){let e=i.$index,t=a();s("formGroupName",e),c(),s("mobileMode",!0),c(),g(t.textFieldState()[e]?2:3),c(3),s("placeholder","In "+((t.form.value.ingredients==null||t.form.value.ingredients[e]==null?null:t.form.value.ingredients[e].unit)||"gram")),c(2),s("items",t.buttons),c(2),A("danger"),s("size","tiny")("icon",!0)}}function lt(n,i){if(n&1&&h(0,"lg-chips-list",20),n&2){let e=a(),t=k(21);s("control",t)("items",e.topCategories())}}var V=class n{constructor(i,e,t,o,p){this._recipesRepository=i;this._selectResourcesService=e;this._router=t;this._aRoute=o;this._notificationsService=p}recipe=E(void 0);uuid=Ge("uuid");form=new Y({name:new x(null,Ce.required),description:new x(""),outcome_amount:new x(null),outcome_unit:new x(""),ingredients:new Se([this._getIngredientGroup()]),category_id:new x(null)},i=>z.fromRaw(i.value).outcomeAmountGreaterThanIngredients?{outcomeAmountGreaterThanIngredients:!0}:null);textFieldState=y({});recipeFieldState=y({});buttons=[{label:"Grams",value:"gram",style:"secondary",onClick:()=>{console.log("Grams")}},{label:"Pieces",value:"piece",style:"secondary",onClick:()=>{console.log("Piece")}}];tooltipComponent=U("tooltipComponent");productsWidget=U("products");productsSelector=U("productsSelector");nameField=j("nameField");topCategories=y([]);recipeEffect=ae(()=>{this.recipe()&&this.fillForm(this.recipe())});get ingredients(){return this.form.get("ingredients")}get _formValid(){return this.form.valid&&!this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())}fillForm(i){this.form.reset({ingredients:[]}),this.ingredients.clear(),i&&(this.form.reset(b(w({},Ue(i)),{ingredients:[]})),i.ingredients.forEach((e,t)=>{this.ingredients.push(this._getIngredientGroup(e)),e.recipe_id&&this.openRecipeField(t),e.name&&this.openTextField(t)}),this.form.updateValueAndValidity(),this.form.markAsPristine())}resetForm(i){this.fillForm(i),this._loadUsingHistory(),this.form.markAsPristine()}validateForm(){return this._formValid?!0:(this._notificationsService.error(this._notificationsService.parseFormErrors(this.form).join(", ")),!1)}addLast(){let i=this.ingredients.at(this.ingredients.length-1);(i.value.name||i.value.amount||i.value.product_id)&&this.addIngredient()}ngOnInit(){this._loadUsingHistory(),this.form.valueChanges.pipe(N(100)).subscribe({next:i=>{if(!this.form.dirty)return;this.recipe()?.update(this.form.getRawValue()),this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())&&this._notificationsService.error("You cannot add a recipe to itself")}})}ngAfterViewInit(){this._selectResourcesService.load().then(i=>{}),this.nameField().focus()}addIngredient(){this.ingredients.push(this._getIngredientGroup())}deleteIngredient(i){this.ingredients.removeAt(i)}onIngredientSelected(i,e,t){i.focus();let o=this.ingredients.at(e).value;this.ingredients.at(e).patchValue(b(w({},Array.isArray(t)?t.reduce((p,v)=>b(w({},p),{[v]:null}),{}):{[t]:null}),{unit:o.product_id?.unit||o.recipe_id?.unit||"gram"}))}openTextField(i){this.textFieldState.update(e=>b(w({},e),{[i]:!0}))}closeTextField(i){this.textFieldState.update(e=>b(w({},e),{[i]:!1}))}openRecipeField(i){this.recipeFieldState.update(e=>b(w({},e),{[i]:!0}))}closeRecipeField(i){this.recipeFieldState.update(e=>b(w({},e),{[i]:!1}))}checkCycleRecipe(i,e){let t=!1;for(let o of i){let p=o.recipe_id?.uuid;if(p&&p===e){t=!0;break}}return t}_loadUsingHistory(){this._recipesRepository.getTopCategories().then(i=>{this.topCategories.set(i.map(e=>({label:e.name,value:{uuid:e.uuid,name:e.name}})))})}_getIngredientGroup(i){return new Y({name:new x(i?.name),amount:new x(i?.amount?.toString()??null),product_id:new x(i?.product_id?i.product_id:null),recipe_id:new x(i?.recipe_id?i.recipe_id:null),unit:new x(i?.unit??"gram")},e=>{let t=pe.fromRaw(e.value);if(t.allEmpty)return null;if(t.typeSelected&&!t.amountValid)return{ingredientAmountRequired:!0};if(!this.uuid)return null;let o=this.uuid();return this.checkCycleRecipe([e.value],o)?{cycleRecipe:!0}:t.typeSelected?null:{ingredientRequired:!0}})}static \u0275fac=function(e){return new(e||n)(R(B),R(M),R(L),R($),R(q))};static \u0275cmp=S({type:n,selectors:[["lg-add-recipe-form"]],viewQuery:function(e,t){e&1&&(T(t.tooltipComponent,Ye,5),T(t.productsWidget,Je,5),T(t.productsSelector,Xe,5),T(t.nameField,Ze,5)),e&2&&G(4)},inputs:{recipe:[1,"recipe"]},features:[oe([{provide:M,useClass:M}])],decls:23,vars:14,consts:[["nameField",""],["amount",""],["categorySelect",""],["productsSelector",""],[3,"formGroup"],[3,"position"],["label","Name","lgExpand",""],["formControlName","name",3,"key","resource"],["label","Description","lgExpand",""],["formControlName","description",3,"placeholder"],["lgExpand","",3,"mobileMode"],["label","Amount of the outcome","lgExpand",""],["formControlName","outcome_amount","lgParseMath","",3,"placeholder"],["formControlName","outcome_unit",3,"items"],["label","Ingredients","lgExpand",""],["formArrayName","ingredients","lgExpand",""],[3,"formGroupName"],[3,"click","size"],["label","Category","lgExpand",""],["formControlName","category_id",3,"resource"],[3,"control","items"],[3,"mobileMode"],[3,"size"],["label","Amount"],["lgParseMath","","formControlName","amount",3,"onKeydown","placeholder"],["formControlName","unit",3,"items"],["ngProjectAs","rowActions",5,["rowActions"]],[3,"click","size","icon"],["aria-hidden","false","fontIcon","close"],["label","Name"],["ngProjectAs","endLabelTpl",5,["endLabelTpl"]],[3,"click"],["formControlName","name",3,"onInputChanged","placeholder"],["ngProjectAs","labelTpl",5,["labelTpl"]],[3,"click","flat","size","active"],["ngProjectAs","afterLabelTpl",5,["afterLabelTpl"]],["formControlName","recipe_id",3,"resource","autoLoad"],["formControlName","product_id",3,"resource","autoLoad"],["formControlName","recipe_id",3,"onSelected","resource","autoLoad"],["formControlName","product_id",3,"onSelected","resource","autoLoad"]],template:function(e,t){if(e&1){let o=C();r(0,"form",4)(1,"lg-gap-column",5)(2,"lg-control",6),h(3,"lg-autocomplete",7,0),l(),r(5,"lg-control",8),h(6,"lg-textarea",9),l(),r(7,"lg-controls-row",10)(8,"lg-control",11),h(9,"lg-number-input",12,1),l(),h(11,"lg-buttons-group",13),l(),r(12,"lg-control-group",14)(13,"lg-gap-column",5)(14,"lg-gap-column",15),te(15,rt,11,9,"ng-container",16,et),l(),r(17,"lg-button",17),f("click",function(){return m(o),u(t.addIngredient())}),d(18," Add Ingredient "),l()()(),r(19,"lg-control",18),h(20,"lg-multiselect",19,2),l(),_(22,lt,1,2,"lg-chips-list",20),l()()}e&2&&(s("formGroup",t.form),c(),s("position","start"),c(2),s("key","name")("resource","recipes-names"),c(3),s("placeholder","Describe your recipe, how to make it, what to pay attention to, etc."),c(),s("mobileMode",!0),c(2),s("placeholder",t.form.value.outcome_unit||"Here you can write the amount of the outcome (e.g. 100, 12, etc.)"),c(2),s("items",t.buttons),c(2),s("position","start"),c(2),ie(t.ingredients.controls),c(2),A("success"),s("size","small"),c(3),s("resource","recipes-categories"),c(2),g(t.topCategories().length?22:-1))},dependencies:[Fe,xe,Re,he,ve,be,ye,we,Ee,Ve,W,Q,H,De,ke,Me,K,Te,Ne,Pe,Oe,je,Ae,ge],encapsulation:2})};function ct(n,i){if(n&1&&(d(0),re(1,"timeAgo")),n&2){let e,t=a(2);O(" (last edited ",le(1,1,(e=t.recipe())==null?null:e.updatedAt),") ")}}function at(n,i){if(n&1&&(r(0,"lg-gap-row",4)(1,"lg-title"),d(2," Edit "),r(3,"span",5),d(4),l()(),r(5,"lg-button",6),d(6," Calculate "),l()(),_(7,ct,2,3)),n&2){let e,t,o,p=a();s("mobileMode",!0)("center",!0),c(4),ne((e=p.recipe())==null?null:e.name),c(),A("primary"),s("flat",!0)("link","/recipes/calculate/"+((t=p.recipe())==null?null:t.uuid))("size","small"),c(2),g((o=p.recipe())!=null&&o.updatedAt?7:-1)}}function pt(n,i){n&1&&(r(0,"lg-title"),d(1,"Add Recipe"),l())}function st(n,i){n&1&&d(0," (saved as draft) ")}function dt(n,i){n&1&&d(0," Save recipe ")}function mt(n,i){n&1&&d(0," No changes ")}function ut(n,i){if(n&1){let e=C();r(0,"lg-button",7),f("click",function(){m(e);let o=a();return u(o.onEditRecipe())}),_(1,dt,1,0)(2,mt,1,0),l()}if(n&2){let e,t,o=a();s("disabled",!(!((e=o.formComponent())==null||e.form==null)&&e.form.dirty)),c(),g(!((t=o.formComponent())==null||t.form==null)&&t.form.dirty?1:2)}}function ft(n,i){n&1&&d(0," Add Recipe ")}function _t(n,i){n&1&&d(0," Enter a name ")}function gt(n,i){if(n&1){let e=C();r(0,"lg-button",7),f("click",function(){m(e);let o=a();return u(o.onAddRecipe())}),_(1,ft,1,0)(2,_t,1,0),l()}if(n&2){let e,t,o=a();s("disabled",!(!((e=o.formComponent())==null||e.form==null)&&e.form.dirty)),c(),g(!((t=o.formComponent())==null||t.form==null)&&t.form.dirty?1:2)}}function Ct(n,i){if(n&1){let e=C();r(0,"lg-button",8),f("click",function(){m(e);let o=a();return u(o.onRemoveDraft())}),d(1," Delete this draft "),l()}n&2&&A("danger")}function Rt(n,i){if(n&1){let e=C();r(0,"lg-button",8),f("click",function(){m(e);let o=a();return u(o.onDeleteRecipe())}),d(1," Delete Recipe "),l()}n&2&&A("danger")}var Le=class n{constructor(i,e,t,o){this._router=i;this._aRoute=e;this._recipesRepository=t;this._notificationsService=o;this._aRoute.data.pipe(Ie()).subscribe(p=>{this.recipe.set(p.recipe||null)})}draftOrRecipeUUID=y(void 0);recipe=y(void 0);formComponent=j(V);draftRef=y(void 0);draftByExistingRecipe=ce(()=>this.draftRef().meta?.uuid);isDraftRoute=y(!1);draftRecipeModel;ngOnInit(){Z([this._aRoute.params,this._aRoute.data]).subscribe(([i,e])=>{let t=e.draft;this.draftOrRecipeUUID.set(i.uuid),t?(this.draftRef.set(t),this.recipe.set(t.data)):e.recipe?this.recipe.set(e.recipe):this.draftOrRecipeUUID()?this._loadRecipe(this.draftOrRecipeUUID()):this.recipe.set(z.empty()),this.isDraftRoute.set(!!e.draftRoute)})}ngAfterViewInit(){this.formComponent()?.form.valueChanges.pipe(N(500)).subscribe(i=>{this.formComponent().form.dirty&&(this.draftRef()?.uuid?this._recipesRepository.updateDraftRecipe(this.draftRef().uuid,this.recipe(),this.draftRef().meta?.uuid):this.draftRef.set(this._recipesRepository.saveDraftRecipe(this.recipe(),this.draftOrRecipeUUID()??"")))})}onAddRecipe(){!this.formComponent()?.validateForm()||!this.recipe()||this._addRecipe(this.recipe())}onEditRecipe(){!this.formComponent()?.validateForm()||!this.formComponent()?.form.dirty||!this.recipe()||this._editRecipe(this.recipe())}onRemoveDraft(){this._removeDraft(),this._router.navigate(["recipes"])}onDeleteRecipe(){this.recipe()?.uuid&&this._recipesRepository.deleteRecipe(this.recipe().uuid).then(()=>{this._notificationsService.success("Recipe deleted"),this._router.navigate(["recipes"])})}_addRecipe(i){this._recipesRepository.addRecipe(i).then(()=>{this.formComponent()?.resetForm(),this._notificationsService.success("Recipe added"),this.recipe.set(void 0),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes"])})}_editRecipe(i){if(!this.draftOrRecipeUUID())return;let e=this.draftRef()?.meta?.uuid??this.draftOrRecipeUUID();this._recipesRepository.editRecipe(e,i).then(()=>{this.formComponent()?.resetForm(i),this._notificationsService.success("Recipe edited"),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes","edit",e])})}_removeDraft(){this.draftRef()&&(this._recipesRepository.removeDraftRecipe(this.draftRef().uuid),this.draftRef.set(void 0))}_loadRecipe(i){i&&this._recipesRepository.getOne(i).then(e=>{e&&this.recipe.set(e)})}static \u0275fac=function(e){return new(e||n)(R(L),R($),R(B),R(q))};static \u0275cmp=S({type:n,selectors:[["app-add-recipe"]],viewQuery:function(e,t){e&1&&T(t.formComponent,V,5),e&2&&G()},decls:13,vars:7,consts:[[3,"recipe"],[3,"mobileMode","relaxed"],["lgShrink","",3,"disabled"],["lgShrink","",3,"style"],[3,"mobileMode","center"],[1,"text-active"],[3,"flat","link","size"],["lgShrink","",3,"click","disabled"],["lgShrink","",3,"click"]],template:function(e,t){if(e&1&&(r(0,"lg-fade-in")(1,"lg-container")(2,"lg-gap-column"),_(3,at,8,9)(4,pt,2,0,"lg-title"),_(5,st,1,0),l(),r(6,"lg-card"),h(7,"lg-add-recipe-form",0),l(),r(8,"lg-gap-row",1),_(9,ut,3,2,"lg-button",2)(10,gt,3,2,"lg-button",2),_(11,Ct,2,2,"lg-button",3)(12,Rt,2,2,"lg-button",3),l()()()),e&2){let o,p,v;c(3),g((o=t.recipe())!=null&&o.uuid&&!t.draftRef()||t.draftRef()&&t.draftByExistingRecipe()?3:4),c(2),g(t.draftRef()?5:-1),c(2),s("recipe",t.recipe()),c(),s("mobileMode",!0)("relaxed",!0),c(),g((p=t.recipe())!=null&&p.uuid&&!t.draftRef()||t.draftRef()&&t.draftByExistingRecipe()?9:10),c(2),g(t.isDraftRoute()?11:(v=t.recipe())!=null&&v.uuid?12:-1)}},dependencies:[se,de,me,V,H,_e,ue,$e,fe,Q],encapsulation:2})};export{Le as AddRecipeComponent};
