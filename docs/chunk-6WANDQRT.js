import{a as $e}from"./chunk-XGYLWNA3.js";import{a as Le}from"./chunk-R5HZ2CHP.js";import{a as Qe}from"./chunk-HXFWMFTO.js";import{c as N}from"./chunk-AD2SMGJQ.js";import"./chunk-GALYHWJT.js";import{a as Be}from"./chunk-T4SSLVVO.js";import{a as He}from"./chunk-IHSXT6UN.js";import{a as Ve,c as ke}from"./chunk-4NJWONPW.js";import{a as je}from"./chunk-B4BPCK6P.js";import"./chunk-CWUUYJTE.js";import"./chunk-FK6H3RFT.js";import{a as We}from"./chunk-GFKJ3IXC.js";import{a as A}from"./chunk-ZL6WWUML.js";import{a as Oe}from"./chunk-VQHUADFJ.js";import{a as Ne}from"./chunk-IVWGGHZS.js";import{a as B}from"./chunk-OSRCQ3N6.js";import{c as Ae}from"./chunk-BJIJ7REJ.js";import{a as Ge}from"./chunk-I27O3RKJ.js";import"./chunk-MPFUNZLY.js";import{a as Ue}from"./chunk-Q75E6UIP.js";import{d as be,f as we,i as De}from"./chunk-5YH3DQLZ.js";import"./chunk-XF6QJ4WA.js";import{C as M,D as Pe,E as Ie,G as I,K as Te,L as Ee,O as Re,Q as Fe,R as D,T as Me,V as ze,d as Ze,g as ve,o as ge,p as F,q as xe,u as ye,w as Se}from"./chunk-2GBIJY5Z.js";import{m as Ce,p as fe,q as _e}from"./chunk-VYSMWHEC.js";import{c as he}from"./chunk-CABIONZL.js";import"./chunk-EMIJRNYJ.js";import{f as ue,i as se,m as de,n as me}from"./chunk-HDEG74LV.js";import{$b as k,Bc as s,Cb as h,Cc as m,Dc as f,Eb as v,Ec as oe,Fb as J,G as H,Hb as K,Ib as X,Jb as p,Kb as r,Lb as o,Lc as x,Mb as S,Mc as re,Pb as Y,Pc as le,Qb as Z,Qc as ce,Ub as W,Vb as d,Vc as pe,Wb as ee,Xb as te,Z as Q,Zb as j,_a as i,_b as V,da as L,db as b,dc as ie,gc as ne,ic as l,jc as C,ka as O,kb as T,kc as _,la as z,lc as P,oa as $,pb as w,ua as q,vc as R,yc as ae}from"./chunk-NHWKWTII.js";import"./chunk-2RGDSI3Q.js";import{e as Ye}from"./chunk-C6Q5SG76.js";var et=["*"],U=class t{constructor(){}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=T({type:t,selectors:[["lg-table-card"]],ngContentSelectors:et,decls:4,vars:1,consts:[[3,"flat"],[1,"table"],[1,"table__scroll"]],template:function(e,a){e&1&&(ee(),r(0,"lg-card",0)(1,"div",1)(2,"div",2),te(3),o()()()),e&2&&p("flat",!0)},dependencies:[A],styles:[`:host{display:flex;width:100%}.table__scroll{overflow-x:auto}table{width:100%;border-collapse:collapse;--border-color: #efefef}table thead tr{border-bottom:1px solid var(--border-color)}table thead th{text-align:left;padding:16px 24px;opacity:.4;font-size:.8em}table tbody tr{border-bottom:1px solid var(--border-color)}table tbody tr:last-child{border-bottom:none}td{padding:16px 24px}
`],encapsulation:2})};var Xe=Ye(Ze());function it(t,n){if(t&1&&S(0,"lg-unit-switcher",4)(1,"lg-unit-switcher",5),t&2){let e=d();p("items",e.additionalPriceType),i(),p("items",e.additionalPriceAction)}}function nt(t,n){if(t&1&&S(0,"lg-unit-switcher",6),t&2){let e=d(2);p("items",e.additionalPriceUnit)}}function at(t,n){t&1&&w(0,nt,1,1,"ng-template",3)}function ot(t,n){if(t&1&&(r(0,"b"),l(1),s(2,"currencySymbol"),o()),t&2){let e,a=d(2);i(),P("",m(2,2,a.userSettings().currency)," / ",(e=a.recipeCost())==null?null:e.outcomeUnit," ")}}function rt(t,n){t&1&&w(0,ot,3,4,"ng-template",3)}var G=class t{recipePriceAdditionsForm=new Ie({action:new I("add"),value:new I(0),unit:new I("currency"),type:new I("per_unit")});recipeCost=ce();values=F(this.recipePriceAdditionsForm.valueChanges);userSettings=L(Be);additionalPriceUnit=[{label:"$",value:"currency",style:"secondary"},{label:"%",value:"percent",style:"secondary"}];additionalPriceAction=[{label:"Add",value:"add",style:"secondary"},{label:"Round to",value:"round",style:"secondary"}];additionalPriceType=[{label:"Per unit",value:"per_unit",style:"secondary"},{label:"Total",value:"total",style:"secondary"}];onChanged=le();showPriceAdditionUnits=x(()=>!0);roundActionSelected=x(()=>this.values()?.action==="round");onChangeFn=()=>{};changesEffect=re(()=>{this.onChangeFn(this.values())});registerOnChange(n){this.onChangeFn=n}registerOnTouched(n){}writeValue(n){this.recipePriceAdditionsForm.patchValue({action:n?.action||"add",value:n?.value||0,unit:n?.unit||"currency",type:n?.type||"per_unit"},{emitEvent:!1})}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=T({type:t,selectors:[["lg-calculation-price-modifiers"]],inputs:{recipeCost:[1,"recipeCost"]},outputs:{onChanged:"onChanged"},features:[R([{provide:Se,useExisting:Q(()=>t),multi:!0}])],decls:5,vars:3,consts:[[3,"formGroup"],["formControlName","value","lgParseMath","","placeholder","extra price"],["lgExtraTpl","","place","before"],["lgExtraTpl","","place","after"],["formControlName","type",3,"items"],["formControlName","action",3,"items"],["formControlName","unit",3,"items"]],template:function(e,a){e&1&&(r(0,"lg-gap-row",0)(1,"lg-number-input",1),w(2,it,2,2,"ng-template",2),h(3,at,1,0,null,3),h(4,rt,1,0,null,3),o()()),e&2&&(p("formGroup",a.recipePriceAdditionsForm),i(3),v(a.showPriceAdditionUnits()?3:-1),i(),v(a.roundActionSelected()?4:-1))},dependencies:[Ve,ke,D,M,Pe,Ee,Re,He,je,$e,B],styles:["[_nghost-%COMP%]{width:100%}"]})};var lt=["priceChart"],ct=["weightChart"],pt=(t,n)=>[t,n];function ut(t,n){t&1&&Y(0)}function st(t,n){if(t&1&&w(0,ut,1,0,"ng-container",17),t&2){d(2);let e=ie(12);p("ngTemplateOutlet",e)}}function dt(t,n){if(t&1&&(l(0),s(1,"userCurrency")),t&2){let e,a=d(2);_(" ",f(1,1,(e=a.result())==null||e.calculation==null?null:e.calculation.pricePerUnit,"1.2-5")," ")}}function mt(t,n){if(t&1&&(l(0," > "),r(1,"span",18),l(2),s(3,"userCurrency"),o(),r(4,"span",19),l(5),s(6,"userCurrency"),o()),t&2){let e=d(2),a=e.totalPriceDifference();i(2),_(" ",f(3,4,e.totalPriceWithAdditions(),"1.2-2")," "),i(2),p("ngClass",a>0?"text-success":"text-danger"),i(),P(" (",a>0?"+":""," ",f(6,7,a,"1.2-2"),") ")}}function Ct(t,n){if(t&1){let e=Z();r(0,"lg-gap-row",5)(1,"lg-gap-column",6)(2,"lg-card",7)(3,"lg-gap-row",8)(4,"div"),l(5),s(6,"translate"),o(),r(7,"b"),l(8),s(9,"number"),o()()(),r(10,"lg-gap-column",9)(11,"lg-card",7)(12,"lg-gap-row",8)(13,"div"),l(14),s(15,"translate"),r(16,"b"),l(17),o()(),r(18,"b"),h(19,st,1,1,"ng-container")(20,dt,2,4),o()()(),S(21,"lg-gap-row",10),o(),r(22,"lg-gap-column",9)(23,"lg-card",7)(24,"lg-gap-row",8)(25,"div"),l(26),s(27,"translate"),o(),r(28,"b"),l(29),s(30,"userCurrency"),h(31,mt,7,10),o()()(),r(32,"lg-gap-column",11)(33,"div"),l(34," Price modifiers "),o(),S(35,"lg-calculation-price-modifiers",12),o()()(),r(36,"lg-card",13)(37,"lg-gap-column",14)(38,"lg-title",15)(39,"div"),l(40),s(41,"translate"),o()(),r(42,"canvas",16,1),W("chartHover",function(u){O(e);let c=d();return z(c.onChartHover("price",u.event,u.active))}),o()()(),r(44,"lg-card",13)(45,"lg-gap-column",14)(46,"lg-title",15)(47,"div"),l(48),s(49,"translate"),o()(),r(50,"canvas",16,2),W("chartHover",function(u){O(e);let c=d();return z(c.onChartHover("weight",u.event,u.active))}),o()()()()}if(t&2){let e,a,u,c=d();p("center",!0)("mobileMode",!0),i(),p("position","stretch"),i(2),p("size","small")("relaxed",!0),i(2),C(m(6,37,"recipe.calculation.outcome.label")),i(3),P(" ",f(9,39,(e=c.result())==null||e.calculation==null?null:e.calculation.outcomeAmount,"1.0-2")," ",(e=c.result())==null||e.calculation==null?null:e.calculation.outcomeUnit," "),i(2),p("position","stretch"),i(2),p("size","small")("relaxed",!0),i(2),_(" ",m(15,42,"recipe.calculation.one-unit.label")," "),i(3),_(" ",(a=c.result())==null||a.calculation==null?null:a.calculation.outcomeUnit," "),i(2),v(c.notInGrams()?19:20),i(2),p("size","small")("relaxed",!0),i(),p("position","stretch"),i(2),p("size","small")("relaxed",!0),i(2),C(m(27,44,"recipe.calculation.total-price.label")),i(3),_(" ",f(30,46,c.totalPrice(),"1.2-2")," "),i(2),v(c.totalPriceDifference()?31:-1),i(),p("position","stretch"),i(3),p("formControl",c.recipePriceAdditionsForm)("recipeCost",(u=c.result())==null?null:u.calculation),i(2),p("size","small"),i(),p("level",5),i(2),C(m(41,49,"recipe.calculation.price-chart")),i(2),p("data",c.doughnutChartData().prices)("options",c.doughnutChartOptions)("type",c.doughnutChartType),i(3),p("size","small"),i(),p("level",5),i(2),C(m(49,51,"recipe.calculation.weight-chart")),i(2),p("data",c.doughnutChartData().weight)("options",c.doughnutChartOptions)("type",c.doughnutChartType)}}function ft(t,n){if(t&1&&(l(0," > "),r(1,"span",18),l(2),s(3,"userCurrency"),o(),r(4,"span",19),l(5),s(6,"userCurrency"),o()),t&2){let e,a,u=d(3),c=((e=u.result())==null||e.calculation==null?null:e.calculation.pricePerUnitFromTotalDifference)??0;i(2),_(" ",f(3,4,(a=u.result())==null||a.calculation==null?null:a.calculation.pricePerUnitFromTotal,"1.2-2")," "),i(2),p("ngClass",c>0?"text-success":"text-danger"),i(),P(" (",c>0?"+":""," ",f(6,7,c,"1.2-2"),") ")}}function _t(t,n){if(t&1&&(l(0),s(1,"userCurrency"),h(2,ft,7,10),l(3),s(4,"number")),t&2){let e,a,u,c=d(2);_(" ",f(1,3,(e=c.result())==null||e.calculation==null?null:e.calculation.pricePerOutcomeUnit,"1.2-2")," "),i(2),v(!((a=c.result())==null||a.calculation==null)&&a.calculation.hasPriceDifference?2:-1),i(),_(" / ",f(4,6,(u=c.result())==null||u.calculation==null?null:u.calculation.weightForUnit,"1.0-2")," gram ")}}function ht(t,n){if(t&1&&(l(0),s(1,"userCurrency")),t&2){let e,a=d(2);_(" ",f(1,1,(e=a.result())==null||e.calculation==null?null:e.calculation.totalPrice,"1.2-2")," ")}}function vt(t,n){if(t&1&&h(0,_t,5,9)(1,ht,2,4),t&2){let e=d();v(e.notInGrams()?0:1)}}function gt(t,n){if(t&1&&(r(0,"a",25),l(1),o()),t&2){let e=d().$implicit;p("routerLink",ae(2,pt,e.type==="recipe-row"?"/recipes/edit/":"/products/edit/",e.uuid)),i(),_(" ",e.name," ")}}function xt(t,n){if(t&1&&(l(0),s(1,"translate")),t&2){let e=d().$implicit;_(" ",m(1,1,e.name)," ")}}function yt(t,n){if(t&1&&(r(0,"tr",19)(1,"td"),l(2),o(),r(3,"td")(4,"div",19),h(5,gt,2,5,"a",25)(6,xt,2,3),o()(),r(7,"td"),l(8),s(9,"number"),o(),r(10,"td"),l(11),o(),r(12,"td"),l(13),s(14,"userCurrency"),o(),r(15,"td"),l(16),s(17,"userCurrency"),o()()),t&2){let e=n.$implicit,a=n.$index;p("ngClass",e.type),i(2),C(a+1),i(2),p("ngClass","indent-"+e.indent),i(),v(e.type!=="total"?5:6),i(3),C(f(9,8,e.amount,"1.0-2")),i(3),C(e.unit),i(2),C(f(14,11,e.price_per_gram,"1.2-5")),i(3),C(f(17,14,e.total,"1.0-2"))}}function bt(t,n){if(t&1&&(r(0,"table")(1,"colgroup"),S(2,"col",20)(3,"col",21)(4,"col",22)(5,"col",23)(6,"col",22)(7,"col",24),o(),r(8,"thead")(9,"tr")(10,"th"),l(11,"#"),o(),r(12,"th"),l(13),s(14,"translate"),o(),r(15,"th"),l(16),s(17,"translate"),o(),r(18,"th"),l(19),s(20,"translate"),o(),r(21,"th"),l(22),s(23,"translate"),o(),r(24,"th"),l(25),s(26,"translate"),o()()(),r(27,"tbody"),K(28,yt,18,17,"tr",19,J),o()()),t&2){let e,a=d();i(13),C(m(14,5,"recipe.calculation.table.name.title")),i(3),C(m(17,7,"recipe.calculation.table.amount.title")),i(3),C(m(20,9,"recipe.calculation.table.unit.title")),i(3),C(m(23,11,"recipe.calculation.table.price.title")),i(3),C(m(26,13,"recipe.calculation.table.total.title")),i(3),X((e=a.result())==null?null:e.table)}}function wt(t,n){}var Ke=class t{constructor(n,e,a,u,c,g){this._aRoute=n;this._calculateRecipeService=e;this._formTemplateService=a;this._injector=u;this._router=c;this._notificationService=g;this._aRoute.data.pipe(ge()).subscribe(y=>{this.result.set(y.result);let[E]=this.result()?.calculation?.recipe?.priceModifiers||[];this.recipePriceAdditionsForm.patchValue({action:E?.action||"add",unit:E?.unit||"gram",value:E?.value||0,type:E?.type||"per_unit"})})}doughnutChartType="pie";uuid=xe("uuid");result=q(null);doughnutChartData=x(()=>{let n=this.result(),{prices:e,weight:a,labels:u,colors:c}=n?.calculation?.ingredients?.reduce((g,y)=>(g.prices.push(y.totalPrice),g.weight.push(y.totalWeightGram),g.labels.push(y.generalName),g.colors.push(y.product_id?.ownColor??y.recipe_id?.ownColor??he()),g),{prices:[],weight:[],labels:[],colors:[]})||{prices:[],weight:[],labels:[],colors:[]};return{prices:{labels:u,datasets:[{label:"Cost",data:e,backgroundColor:c,borderWidth:0}]},weight:{labels:u,datasets:[{label:"Amount",data:a,backgroundColor:c,borderWidth:0}]},ingredients:n?.calculation?.ingredients||[]}});doughnutChartOptions={plugins:{legend:{display:!1}},onClick:(n,e,a)=>{}};chartPrices;chartWeight;recalculateTotalsModel=pe(0);notInGrams=x(()=>this.result()?.calculation?.outcomeUnit&&this.result()?.calculation?.outcomeUnit!=="gram");recipePriceAdditionsForm=new I;values=F(this.recipePriceAdditionsForm.valueChanges);totalScaleFactor=x(()=>this.recalculateTotalsModel()?this.recalculateTotalsModel()/(this.result()?.calculation?.outcomeAmount||1):1);totalPrice=x(()=>(this.result()?.calculation?.totalPrice||0)*this.totalScaleFactor());totalPriceDifference=x(()=>(this.result()?.calculation?.totalPriceDifference||0)*this.totalScaleFactor());totalPriceWithAdditions=x(()=>(this.result()?.calculation?.totalPriceWithAdditions||0)*this.totalScaleFactor());difference=Xe.difference;ngOnInit(){}ngAfterViewInit(){window.chartPrices=this.chartPrices,window.chartWeight=this.chartWeight,this.recipePriceAdditionsForm.valueChanges.pipe(H(300)).subscribe(n=>{this.updatePriceAdditions(n)})}onChartHover(n,e,a){if(!a?.length)return;let u=n==="price"?this.chartWeight:this.chartPrices,c=a[0].index;u?.chart?.update()}async updatePriceAdditions(n){try{await this._calculateRecipeService.updateRecipe({priceModifiers:[new ye(n.action,n.unit,parseFloat(n.value)||0,n.type||"per_unit")]});let e=await this._calculateRecipeService.calculateRecipe(this.uuid());this.result.set(e)}catch(e){this._notificationService.error(ve(e))}}static \u0275fac=function(e){return new(e||t)(b(Ce),b(be),b(we),b($),b(fe),b(Me))};static \u0275cmp=T({type:t,selectors:[["lg-calculate-recipe"]],viewQuery:function(e,a){if(e&1&&(j(lt,5,N),j(ct,5,N)),e&2){let u;V(u=k())&&(a.chartPrices=u.first),V(u=k())&&(a.chartWeight=u.first)}},inputs:{recalculateTotalsModel:[1,"recalculateTotalsModel"]},outputs:{recalculateTotalsModel:"recalculateTotalsModelChange"},features:[R([De,me])],decls:16,vars:16,consts:[["totalAmount",""],["priceChart",""],["weightChart",""],[3,"center","mobileMode"],[3,"flat","link","size"],["lgExpand","",2,"max-width","1200px",3,"center","mobileMode"],[3,"position"],["size","small"],[3,"size","relaxed"],["size","small",3,"position"],[2,"--control-bg","#fff","padding","0 16px",3,"size","relaxed"],["size","small",2,"--control-bg","#fff","padding","0 16px",3,"position"],[3,"formControl","recipeCost"],["lgWidth","270px","size","small"],[3,"size"],[3,"level"],["baseChart","",3,"chartHover","data","options","type"],[4,"ngTemplateOutlet"],[1,"text-underlined"],[3,"ngClass"],["span","1",2,"width","1%"],["span","1",2,"width","20%"],["span","1",2,"width","5%"],["span","1",2,"width","3%"],["span","1",2,"width","7%"],[3,"routerLink"]],template:function(e,a){if(e&1&&(r(0,"lg-fade-in")(1,"lg-container")(2,"lg-gap-column")(3,"lg-gap-row",3)(4,"lg-title"),l(5),s(6,"translate"),o(),r(7,"lg-button",4),l(8),s(9,"translate"),o()(),h(10,Ct,52,53,"lg-gap-row",5),w(11,vt,2,1,"ng-template",null,0,oe),r(13,"lg-table-card"),h(14,bt,30,15,"table")(15,wt,0,0),o()()()()),e&2){let u,c,g;i(3),p("center",!0)("mobileMode",!0),i(2),P(" ",(u=a.result())==null||u.calculation==null?null:u.calculation.recipeName," ",m(6,12,"recipe.calculation.title.after-text")," "),i(2),ne("primary"),p("flat",!0)("link","/recipes/edit/"+((c=a.result())==null||c.calculation==null?null:c.calculation.recipeUuid))("size","small"),i(),_(" ",m(9,14,"edit-label")," "),i(2),v(!((g=a.result())==null||g.calculation==null)&&g.calculation.totalPrice?10:-1),i(4),v(a.result()?14:15)}},dependencies:[Ne,Ue,U,ue,ze,B,de,Fe,M,_e,Oe,se,Ge,N,A,Qe,We,Le,Ae,D,Te,G],styles:[`lg-number-input .lg-number-input{width:100px}
`],encapsulation:2})};export{Ke as CalculateRecipeComponent};
