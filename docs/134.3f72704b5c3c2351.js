"use strict";(self.webpackChunklasagna=self.webpackChunklasagna||[]).push([[134],{3134:(ne,g,l)=>{l.r(g),l.d(g,{ProductListComponent:()=>q});var m=l(467),e=l(1007),h=l(7512),C=l(1119),y=l(1072),x=l(5642),D=l(1086),p=l(177),v=l(4625),k=l(553);let T=(()=>{class i{template;constructor(t){this.template=t}static \u0275fac=function(n){return new(n||i)(e.rXU(e.C4Q))};static \u0275dir=e.FsC({type:i,selectors:[["","lgCardListItem",""]]})}return i})();function A(i,c){if(1&i&&(e.j41(0,"div",2),e.eu8(1,4),e.k0s()),2&i){const t=c.$implicit;e.R7$(),e.Y8G("ngTemplateOutlet",t.template)}}function G(i,c){1&i&&(e.j41(0,"div",3),e.EFF(1,"No items found"),e.k0s())}let I=(()=>{class i{constructor(){}items;static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-card-list"]],contentQueries:function(n,o,a){if(1&n&&e.wni(a,T,4),2&n){let s;e.mGM(s=e.lsd())&&(o.items=s)}},decls:5,vars:2,consts:[[3,"flat"],[1,"lg-card-list"],[1,"lg-card-list__item"],[2,"padding","0 24px"],[3,"ngTemplateOutlet"]],template:function(n,o){1&n&&(e.j41(0,"lg-card",0)(1,"section",1),e.Z7z(2,A,2,1,"div",2,e.Vm6,!1,G,2,0,"div",3),e.k0s()()),2&n&&(e.Y8G("flat",!0),e.R7$(2),e.Dyx(o.items))},dependencies:[k.i,p.T3],styles:[":host{display:flex;width:100%}.lg-card-list{display:flex;flex-direction:column;width:100%;gap:32px;padding:24px 0}.lg-card-list__item{padding:0 24px}\n"],encapsulation:2})}return i})();var F=l(4374);const $=["input"],P=["*"];let _=(()=>{class i{filesSelected=(0,e.CGW)();accept=(0,e.hFB)(".csv");input=(0,e.ebz)("input");onFileChange(t){const o=t.target.files?.[0];o&&this.filesSelected.emit([o])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-upload"]],viewQuery:function(n,o){1&n&&e.wEZ(o.input,$,5),2&n&&e.NyB()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:P,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(n,o){if(1&n){const a=e.RV6();e.NAR(),e.j41(0,"div",1),e.bIt("click",function(){e.eBV(a);const r=e.sdS(2);return e.Njj(r.click())}),e.j41(1,"input",2,0),e.bIt("change",function(r){return e.eBV(a),e.Njj(o.onFileChange(r))}),e.k0s(),e.j41(3,"div",3),e.SdG(4),e.k0s()()}2&n&&(e.R7$(),e.Y8G("accept",o.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})}return i})();var w=l(1413),b=l(9172),j=l(2816);const M=["*"];let R=(()=>{class i{constructor(){}displayed=(0,e.vPA)(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-dialog"]],ngContentSelectors:M,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(n,o){1&n&&(e.NAR(),e.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),e.SdG(5),e.k0s()()()()()),2&n&&e.xc7("display",o.displayed()?"flex":"none")},dependencies:[k.i],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})}return i})();var E=l(7782),d=l(9417);let f=(()=>{class i{constructor(){}readFromFile(t){return new Promise((n,o)=>{const a=new FileReader;a.onload=()=>{const r=this.parseData(a.result),[u,...ee]=r,te=this.arrayToObjects(ee,u);n(te)},a.onerror=()=>{o(a.error)},a.readAsText(t)})}parseData(t){return t.split("\r\n").map(n=>n.split(",")).filter(n=>n.length>1&&n.some(o=>o.length>0))}arrayToObjects(t,n){return t.map(o=>{const a={};return n.forEach((s,r)=>{a[s]=o[r]}),a})}makeCsv(t){const n=Object.keys(t[0]),o=t.map(s=>n.map(r=>s[r]));return[n,...o].map(s=>s.join(",")).join("\r\n")}saveToFile(t,n){const o=this.makeCsv(t),a=new Blob([o],{type:"text/csv"}),s=URL.createObjectURL(a),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",s),r.setAttribute("download",n),r.click(),URL.revokeObjectURL(s)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var S=l(6659);const U=(i,c)=>c.name+c.uuid;function z(i,c){if(1&i){const t=e.RV6();e.j41(0,"input",9),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.rowsToUpdate[a.name],o)||(s.rowsToUpdate[a.name]=o),e.Njj(o)}),e.k0s(),e.EFF(1," Update ")}if(2&i){const t=e.XpG().$implicit,n=e.XpG(3);e.R50("ngModel",n.rowsToUpdate[t.name]),e.Y8G("disabled",n.rowsToSkip[t.name])}}function N(i,c){if(1&i){const t=e.RV6();e.j41(0,"input",10),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.rowsToAdd[a.name],o)||(s.rowsToAdd[a.name]=o),e.Njj(o)}),e.k0s(),e.EFF(1," Add ")}if(2&i){const t=e.XpG().$implicit,n=e.XpG(3);e.R50("ngModel",n.rowsToAdd[t.name]),e.Y8G("disabled",n.rowsToSkip[t.name])}}function X(i,c){if(1&i&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&i){const t=e.XpG().$implicit;e.R7$(),e.SpI("from ",t.source,"")}}function O(i,c){if(1&i&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&i){const t=e.XpG(2).$implicit,n=e.XpG();e.R7$(),e.SpI("from ",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).source,"")}}function Y(i,c){if(1&i){const t=e.RV6();e.j41(0,"div",11)(1,"input",9),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.rowsToSkip[a.name],o)||(s.rowsToSkip[a.name]=o),e.Njj(o)}),e.k0s(),e.j41(2,"span"),e.EFF(3),e.k0s(),e.j41(4,"span"),e.EFF(5),e.k0s(),e.j41(6,"span"),e.EFF(7),e.k0s(),e.DNE(8,O,2,1,"span"),e.k0s()}if(2&i){const t=e.XpG().$implicit,n=e.XpG(),o=e.XpG(2);e.AVh("disabled",o.rowsToUpdate[t.name])("skip",o.rowsToUpdate[t.name]),e.Y8G("ngClass",o.rowsToSkip[t.name]?"skip":"duplicated"),e.R7$(),e.R50("ngModel",o.rowsToSkip[t.name]),e.Y8G("disabled",o.rowsToAdd[t.name]||o.rowsToUpdate[t.name]),e.R7$(2),e.JRh(o.rowsToSkip[t.name]?"Skip":"Duplicates"),e.R7$(2),e.JRh(null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).name),e.R7$(2),e.Lme("",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).amount," gr for ",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).price,""),e.R7$(),e.vxM(null!=(n[t.uuid]||n[t.name])&&(n[t.uuid]||n[t.name]).source?8:-1)}}function V(i,c){if(1&i&&(e.j41(0,"lg-gap-column",6)(1,"div",7),e.DNE(2,z,2,2)(3,N,2,2),e.j41(4,"span"),e.EFF(5),e.k0s(),e.j41(6,"span"),e.EFF(7),e.k0s(),e.DNE(8,X,2,1,"span"),e.k0s(),e.DNE(9,Y,9,12,"div",8),e.k0s()),2&i){const t=c.$implicit,n=e.XpG(),o=e.XpG(2);e.Y8G("size","small"),e.R7$(),e.AVh("update",o.rowsToUpdate[t.name])("add",o.rowsToAdd[t.name])("disabled",o.rowsToSkip[t.name]),e.R7$(),e.vxM(n[t.uuid]||n[t.name]?2:3),e.R7$(3),e.JRh(t.name),e.R7$(2),e.Lme("",t.amount,"gr for ",t.price,""),e.R7$(),e.vxM(t.source?8:-1),e.R7$(),e.vxM(n[t.uuid]||n[t.name]?9:-1)}}function L(i,c){if(1&i&&(e.j41(0,"lg-gap-column",6),e.Z7z(1,V,10,13,"lg-gap-column",6,U),e.k0s()),2&i){const t=e.XpG();e.Y8G("size","medium"),e.R7$(),e.Dyx(t)}}function B(i,c){if(1&i&&(e.DNE(0,L,3,1,"lg-gap-column",6),e.nI1(1,"async")),2&i){let t;const n=e.XpG();e.vxM((t=e.bMT(1,1,n.analize$))?0:-1,t)}}let Q=(()=>{class i{_csvReaderService;_indexDbService;constructor(t,n){this._csvReaderService=t,this._indexDbService=n}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=(0,e.CGW)();storeName=(0,e.hFB)(null);schema=(0,e.hFB)();skipAllDuplicates=(0,e.geq)(!1);replaceAll=(0,e.geq)(!1);analizeSubject=new w.B;dataSubject=new w.B;data$=this.dataSubject.asObservable().pipe((0,b.Z)([]),(0,j.S)((t,n)=>null==n?[]:[...t,n]));analize$=this.analizeSubject.asObservable().pipe((0,b.Z)([]),(0,j.S)((t,n)=>null==n?[]:n.uuid&&n.name?{...t,[n.uuid]:n,[n.name]:n}:t));dialog;upload=(0,e.ebz)(_);parsedData=[];onConfirm(){var t=this;return(0,m.A)(function*(){for(const n of t.parsedData)t.rowsToAdd[n.name]?(yield t._indexDbService.addData(t.storeName(),n),console.log("add",n)):t.rowsToUpdate[n.name]&&!t.skipAllDuplicates()&&(yield t._indexDbService.replaceData(t.storeName(),n.uuid,n),console.log("replace",n));t.clear(),t.onDone.emit(),t.dialog.close()})()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(t=>{this.rowsToAdd[t.name]||(this.rowsToUpdate[t.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(t=>{this.rowsToAdd[t.name]||(this.rowsToSkip[t.name]=!0,this.rowsToUpdate[t.name]&&(this.rowsToUpdate[t.name]=!1))}):this.rowsToSkip={}}onFileSelected(t){var n=this;this.dialog.open(),this._csvReaderService.readFromFile(t[0]).then(function(){var o=(0,m.A)(function*(a){for(const s of a){const r=n.schema()?.safeParse(s);if(!r?.success)return void console.log("error",r?.error);if(!n.storeName())return void console.log("storeName is not set");n.dataSubject.next(s),n.parsedData.push(r.data),yield n._analyzeDuplicates(r.data).then(u=>{u.duplicate?n.analizeSubject.next(u.data[0]):n.rowsToAdd[s.name]=!0})}});return function(a){return o.apply(this,arguments)}}())}_analyzeDuplicates(t){return new Promise((n,o)=>{this._indexDbService.search(this.storeName(),"name",t.name).then(a=>{n(a.length?{data:a,duplicate:!0}:{data:null,duplicate:!1})})})}static \u0275fac=function(n){return new(n||i)(e.rXU(f),e.rXU(S.j))};static \u0275cmp=e.VBU({type:i,selectors:[["lg-import"]],viewQuery:function(n,o){if(1&n&&(e.wEZ(o.upload,_,5),e.GBs(R,5)),2&n){let a;e.NyB(),e.mGM(a=e.lsd())&&(o.dialog=a.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(n,o){if(1&n&&(e.j41(0,"lg-upload",0),e.bIt("filesSelected",function(s){return o.onFileSelected(s)}),e.j41(1,"lg-button",1),e.EFF(2," Import "),e.k0s()(),e.j41(3,"lg-dialog")(4,"lg-gap-column"),e.DNE(5,B,2,3),e.nI1(6,"async"),e.j41(7,"lg-gap-row",2)(8,"input",3),e.bIt("change",function(){return o.onSkipAllDuplicates()}),e.mxI("ngModelChange",function(s){return e.DH7(o.skipAllDuplicates,s)||(o.skipAllDuplicates=s),s}),e.k0s(),e.j41(9,"label"),e.EFF(10,"Skip all duplicates"),e.k0s()(),e.j41(11,"lg-gap-row",2)(12,"input",3),e.bIt("change",function(){return o.onReplaceAll()}),e.mxI("ngModelChange",function(s){return e.DH7(o.replaceAll,s)||(o.replaceAll=s),s}),e.k0s(),e.j41(13,"label"),e.EFF(14,"Replace all with new"),e.k0s()(),e.j41(15,"lg-gap-row",4)(16,"lg-button",5),e.bIt("click",function(){return o.onConfirm()}),e.EFF(17," Confirm "),e.k0s()()()()),2&n){let a;e.R7$(),e.Aen("warning"),e.Y8G("flat",!0)("size","small"),e.R7$(4),e.vxM((a=e.bMT(6,17,o.data$))?5:-1,a),e.R7$(2),e.Y8G("center",!0)("hidden",o.replaceAll())("size","small"),e.R7$(),e.R50("ngModel",o.skipAllDuplicates),e.R7$(3),e.Y8G("center",!0)("hidden",o.skipAllDuplicates())("size","small"),e.R7$(),e.R50("ngModel",o.replaceAll),e.R7$(3),e.Y8G("center",!0),e.R7$(),e.Aen("success"),e.Y8G("size","small")}},dependencies:[_,C.Q,R,p.Jj,h.I,E.K,d.YN,d.Zm,d.BC,d.vS,p.YU],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})}return i})();var H=l(4726),Z=l(7201);let J=(()=>{class i{_indexDbService;_csvReaderService;constructor(t,n){this._indexDbService=t,this._csvReaderService=n}exportTable(t){return this._indexDbService.getAll(t).then(n=>{this._csvReaderService.saveToFile(n,`${t}_export_${(new Date).toISOString()}.csv`)})}makeCsv(t){return this._csvReaderService.makeCsv(t)}static \u0275fac=function(n){return new(n||i)(e.KVO(S.j),e.KVO(f))};static \u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function W(i,c){if(1&i){const t=e.RV6();e.j41(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6),e.EFF(4),e.k0s(),e.j41(5,"div",7),e.EFF(6),e.k0s(),e.j41(7,"div",8),e.EFF(8),e.nI1(9,"number"),e.k0s()()(),e.j41(10,"lg-button",9),e.EFF(11," Edit "),e.k0s(),e.j41(12,"lg-button",10),e.bIt("click",function(){e.eBV(t);const o=e.XpG().$implicit,a=e.XpG();return e.Njj(a.deleteProduct(o))}),e.nrm(13,"mat-icon",11),e.k0s()()}if(2&i){let t;const n=e.XpG().$implicit,o=e.XpG();e.Y8G("center",!0),e.R7$(2),e.Y8G("center",!0),e.R7$(2),e.JRh(n.name),e.R7$(2),e.SpI(" ",null!==(t=n.source)&&void 0!==t?t:"",""),e.R7$(2),e.SpI("",e.i5U(9,14,o.getPricePerGram(n),"1.2-5")," per gram "),e.R7$(2),e.Aen("primary"),e.Y8G("size","small")("link","/edit-product/"+n.uuid)("flat",!0),e.R7$(2),e.Aen("danger"),e.Y8G("size","small")("icon",!0)}}function K(i,c){1&i&&e.DNE(0,W,14,17,"ng-template",4)}let q=(()=>{class i{_productsRepository;_csvReaderService;_transferDataService;constructor(t,n,o){this._productsRepository=t,this._csvReaderService=n,this._transferDataService=o}products=(0,e.vPA)([]);ProductDbInputScheme=H.j;Stores=F.F;getPricePerGram(t){return((0,v.N)(t.price)||1)/((0,v.N)(t.amount)||1)}exportProducts(){this._transferDataService.exportTable(F.F.PRODUCTS)}deleteProduct(t){t.uuid&&this._productsRepository.deleteProduct(t.uuid).then(()=>{this.loadProducts()})}ngOnInit(){var t=this;return(0,m.A)(function*(){yield t.loadProducts()})()}loadProducts(){this._productsRepository.getProducts().then(t=>{const n=t.toSorted((o,a)=>o.name.localeCompare(a.name));this.products.set(n)})}static \u0275fac=function(n){return new(n||i)(e.rXU(Z.d),e.rXU(f),e.rXU(J))};static \u0275cmp=e.VBU({type:i,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[2,"flex","10%"],[2,"flex","70%"],[3,"size","link","flat"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(n,o){1&n&&(e.j41(0,"lg-container")(1,"lg-title"),e.EFF(2," Products "),e.k0s(),e.j41(3,"lg-gap-row",0)(4,"lg-button",1),e.EFF(5," Add "),e.k0s(),e.j41(6,"lg-button",2),e.bIt("click",function(){return o.exportProducts()}),e.EFF(7," Export "),e.k0s(),e.j41(8,"lg-import",3),e.bIt("onDone",function(){return o.loadProducts()}),e.k0s()(),e.j41(9,"lg-card-list"),e.Z7z(10,K,1,0,null,4,e.Vm6),e.k0s()()),2&n&&(e.R7$(3),e.Y8G("center",!0),e.R7$(),e.Aen("primary"),e.Y8G("flat",!0)("link","/add-product")("size","small"),e.R7$(2),e.Aen("info"),e.Y8G("flat",!0)("size","small"),e.R7$(2),e.Y8G("schema",o.ProductDbInputScheme)("storeName",o.Stores.PRODUCTS),e.R7$(2),e.Dyx(o.products()))},dependencies:[h.I,C.Q,y.d,x.H,D.W,p.QX,I,T,Q],styles:["[_nghost-%COMP%]{display:block}"]})}return i})()}}]);