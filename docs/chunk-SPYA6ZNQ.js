import{a as O,b as R}from"./chunk-BF6WJXXA.js";import{B as S,y as F}from"./chunk-I5MUGXQZ.js";import{W as u,_ as d,f as x}from"./chunk-OZXQ5JHJ.js";import{a as l,b as _,f as c}from"./chunk-2WH2EVR6.js";var A=()=>`rgb(${Math.floor(Math.random()*256)}, ${Math.floor(Math.random()*256)}, ${Math.floor(Math.random()*256)})`;var y=class i{constructor(t,e,r){this.name=t;this.color=e;this.uuid=r}static fromRaw(t){return typeof t=="string"?new i(t,A()):new i(t?.name||t?.label||t?.value||t,t?.color||A(),t?.uuid||void 0)}toDTO(){return{name:this.name,color:this.color,uuid:this.uuid}}toString(){return String(this.name)}};var D=i=>{if(typeof i=="number")return i;if(typeof i=="string"){let t=i.replace(",","."),e=parseFloat(t);return isNaN(e)?0:e}return 0};var f=class i{constructor(t){this.name=t.name,this.amount=parseFloat(String(t.amount)),this.price=t.price,this.unit=t.unit,this.source=t.source,this.category_id=O.fromRaw(t.category_id),this.tags=t.tags?.map(e=>y.fromRaw(e)),this.uuid=t.uuid,this.createdAt=t.createdAt?Number(t.createdAt):void 0,this.updatedAt=t.updatedAt?Number(t.updatedAt):void 0}name;amount;price;unit;category_id;source;tags;uuid;createdAt;updatedAt;get pricePerUnit(){return D(this.price)===0||D(this.amount)===0?0:D(this.price)/D(this.amount)}get perUnitLabel(){return!this.unit||this.unit==="gram"?"per gram":`per ${this.unit}`}static fromRaw(t){return new i({name:t?.name||"",amount:Number(t?.amount)||0,price:Number(t?.price)||0,unit:t?.unit||"gram",source:t?.source||"",category_id:t?.category_id||"",tags:t?.tags,uuid:t?.uuid,createdAt:t?.createdAt,updatedAt:t?.updatedAt})}static empty(){return new i({name:"",amount:0,price:0,unit:"gram",source:void 0,category_id:"",tags:[]})}update(t){return this.name=t.name||this.name,this.amount=t.amount?Number(t.amount):this.amount,this.price=t.price?Number(t.price):this.price,this.unit=t.unit||this.unit,this.source=t.source||this.source,this.category_id=O.fromRaw(t.category_id||""),this.tags=t.tags?.map(e=>y.fromRaw(e))||this.tags,this.uuid=t.uuid||this.uuid,this.createdAt=t.createdAt?Number(t.createdAt):this.createdAt,this.updatedAt=t?.updatedAt||Date.now(),this}toDTO(){return{name:this.name,amount:this.amount,price:this.price,unit:this.unit,source:this.source??"",category_id:this.category_id.toUUID(),tags:this.tags?.map(t=>t.toString()),uuid:this.uuid,createdAt:this.createdAt??Date.now(),updatedAt:this.updatedAt??Date.now()}}};var v=class i{constructor(){}read(t){try{let e=JSON.parse(localStorage.getItem(t+"_top")||"{}"),r=JSON.parse(localStorage.getItem(t+"_recent")||"{}");return{top:e,recent:r}}catch(e){return console.error("Error reading from localStorage:",e),{top:{},recent:{}}}}count(t,e){if(!e)return;let r=t+"_history",n=t+"_recent",o=t+"_top",a=JSON.parse(localStorage.getItem(r)||"{}"),s=Date.now(),m=s-30*24*60*60*1e3;a[e]={count:(a[e]?.count||0)+1,updatedAt:s};let p=Object.entries(a).filter(([h,g])=>g.updatedAt>=m),I=p.sort((h,g)=>g[1].updatedAt-h[1].updatedAt).slice(0,5),j=p.sort((h,g)=>g[1].count-h[1].count||g[1].updatedAt-h[1].updatedAt).slice(0,5);localStorage.setItem(r,JSON.stringify(Object.fromEntries(p))),localStorage.setItem(n,JSON.stringify(Object.fromEntries(I))),localStorage.setItem(o,JSON.stringify(Object.fromEntries(j)))}static \u0275fac=function(e){return new(e||i)};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};var T=class i{constructor(){}getDraftForms=t=>{let e=localStorage.getItem(t);return e?JSON.parse(e):null};setDraftForm=(t,e,r,n={})=>{let o=this.getDraftForms(t),a=Date.now(),s=F(),m={uuid:s,createdAt:a,data:e,mode:r,meta:n},p=_(l({},o),{[s]:m});return localStorage.setItem(t,JSON.stringify(p)),m};updateDraftForm=(t,e,r,n,o={})=>{let a=this.getDraftForms(t),s={},m=a;a?.[r]&&(s=_(l({},a?.[r]),{updatedAt:Date.now(),data:l(l({},a?.[r].data),e),mode:n,meta:o}),m[r]=s),localStorage.setItem(t,JSON.stringify(m))};removeDraftForm=(t,e)=>{let r=this.getDraftForms(t);if(r){if(e)delete r[e];else{localStorage.removeItem(t);return}localStorage.setItem(t,JSON.stringify(r))}};static \u0275fac=function(e){return new(e||i)};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};var b=class i{constructor(t){this._indexDbService=t}addOne(t){return this._indexDbService.addData("tags",t.toDTO(),t.name)}getOne(t){return c(this,null,function*(){return this._indexDbService.getOne("tags",t)})}getAll(){return this._indexDbService.getAll("tags")}getMany(t){return this._indexDbService.getMany("tags",t)}editOne(t,e){return this._indexDbService.replaceData("tags",t,e.toDTO())}deleteOne(t){return this._indexDbService.remove("tags",t)}static \u0275fac=function(e){return new(e||i)(d(S))};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};var w=class i{constructor(t,e,r,n,o){this._indexDbService=t;this._categoryRepository=e;this._usingHistoryService=r;this._draftFormsService=n;this._tagsRepository=o}_stream$=new x;get products$(){return this._stream$.asObservable()}loadAll(){return this._indexDbService.getAll("productsStore").then(t=>(this._stream$.next(t.map(e=>f.fromRaw(e))),t))}addOne(t){return c(this,null,function*(){let e=yield this._indexDbService.addData("productsStore",t.toDTO());if(t.category_id&&this._saveCategory(t.category_id.toString()),t.source&&this._saveSource(t.source),this._saveProductToHistory(e),t.tags)for(let r of t.tags)yield this._saveTag(r);return e})}updateOne(t,e){return c(this,null,function*(){if(yield this._indexDbService.replaceData("productsStore",t,e.toDTO()),this._saveProductToHistory(t),e.tags)for(let r of e.tags)yield this._saveTag(r)})}getOne(t){return c(this,null,function*(){return new Promise((e,r)=>c(this,null,function*(){if(t=typeof t=="string"?t:t.uuid,!t){e(void 0);return}yield this._indexDbService.getOne("productsStore",t).then(n=>{e(f.fromRaw(n))})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}getLastProducts(){let{top:t}=this._usingHistoryService.read("products"),e=Object.keys(t);return e.length===0?Promise.resolve([]):this._indexDbService.getMany("productsStore",e).then(r=>r.toSorted((n,o)=>!n.uuid||!o.uuid?0:t[o.uuid].count>t[n.uuid].count?1:-1).map(n=>({product:f.fromRaw(n),updatedAt:n.uuid?t[n.uuid].updatedAt:0,count:n.uuid?t[n.uuid].count:0})))}deleteProduct(t){return this._indexDbService.remove("productsStore",t)}getTopCategories(){let{top:t}=this._usingHistoryService.read("products_categories"),e=Object.keys(t);return this._categoryRepository.getMany(e).then(r=>r.toSorted((n,o)=>!n.uuid||!o.uuid?0:t[o.uuid].count>t[n.uuid].count?1:-1))}getTopSources(){return c(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(t,e){return this._draftFormsService.setDraftForm("draft_products",t.toDTO(),e?.length?"edit":"add",e?{uuid:e}:{})}updateDraftProduct(t,e,r){return this._draftFormsService.updateDraftForm("draft_products",e.toDTO(),t,r?.length?"edit":"add",r?{uuid:r}:{})}getDraftProducts(t){let e=this._draftFormsService.getDraftForms("draft_products");return t&&e?.[t]?[e?.[t]]:e?Object.values(e):[]}removeDraftProduct(t){this._draftFormsService.removeDraftForm("draft_products",t)}_saveCategory(t){this._usingHistoryService.count("products_categories",t)}_saveSource(t){this._usingHistoryService.count("products_sources",t)}_saveProductToHistory(t){this._usingHistoryService.count("products",t)}_saveTag(t){return this._tagsRepository.addOne(t)}static \u0275fac=function(e){return new(e||i)(d(S),d(R),d(v),d(T),d(b))};static \u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})};export{D as a,y as b,f as c,v as d,T as e,b as f,w as g};
