import{v as x,z as O}from"./chunk-ARNKAMDX.js";import{Ab as f,Fb as y,Ib as g,Kb as _,Lb as w,Sa as S,Sb as C,Tb as D,U as c,Ub as F,Y as d,ab as b,ea as m,fa as v,nb as h,tc as j,uc as k,vc as R,zb as l}from"./chunk-VOOOUGHD.js";import{f as s}from"./chunk-2WH2EVR6.js";var U=["input"],V=["*"],N=class a{filesSelected=j();accept=k(".csv");input=R("input");onFileChange(t){let n=t.target.files?.[0];n&&this.filesSelected.emit([n])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=b({type:a,selectors:[["lg-upload"]],viewQuery:function(e,n){e&1&&C(n.input,U,5),e&2&&D()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:V,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,n){if(e&1){let r=y();_(),l(0,"div",1),g("click",function(){m(r);let o=F(2);return v(o.click())}),l(1,"input",2,0),g("change",function(o){return m(r),v(n.onFileChange(o))}),f(),l(3,"div",3),w(4),f()()}e&2&&(S(),h("accept",n.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var p=class a{constructor(){}readFromCSVFile(t){return new Promise((e,n)=>{let r=new FileReader;r.onload=()=>{let i=r.result,o=this.parseData(i),[u,...A]=o,E=this.arrayToObjects(A,u);e(E)},r.onerror=()=>{n(r.error)},r.readAsText(t)})}readFromJSONFile(t){return new Promise((e,n)=>{let r=new FileReader;r.onload=()=>{try{let i=r.result,o=JSON.parse(i);e(o)}catch(i){n(i)}},r.onerror=()=>{n(r.error)},r.readAsText(t)})}parseData(t){return t.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(n=>n.length>0))}arrayToObjects(t,e){return t.map(n=>{let r={};return e.forEach((i,o)=>{r[i]=n[o]}),r})}makeCsv(t){let e=Object.keys(t[0]),n=t.map(i=>e.map(o=>i[o]));return[e,...n].map(i=>i.join(",")).join(`\r
`)}saveToCSVFile(t,e){let n=this.makeCsv(t),r=new Blob([n],{type:"text/csv"}),i=URL.createObjectURL(r),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("href",i),o.setAttribute("download",e),o.click(),URL.revokeObjectURL(i)}saveToJSONFile(t,e){let n=JSON.stringify(t,null,2),r=new Blob([n],{type:"application/json"}),i=URL.createObjectURL(r),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("href",i),o.setAttribute("download",e),o.click(),URL.revokeObjectURL(i)}static \u0275fac=function(e){return new(e||a)};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};var T=class a{constructor(t,e){this._indexDbService=t;this._csvReaderService=e}get currenBackupDate(){let t=localStorage.getItem("lastBackupDate");return t?new Date(Number(t)):null}exportTable(r){return s(this,arguments,function*(t,e="csv",n={}){let i=[];if(n.selected?.length?i=yield this._indexDbService.getMany(t,n.selected):i=yield this._indexDbService.getAll(t),e==="json"){this._csvReaderService.saveToJSONFile(i,this._getFileName(t,e));return}this._csvReaderService.saveToCSVFile(i,this._getFileName(t,e))})}exportAll(t="csv"){return s(this,null,function*(){let e=[],n=Object.values(x).filter(r=>r!=="indicesStore");for(let r of n){let i=yield this._indexDbService.getAll(r),o=yield this._indexDbService.getVersion(r),u=Date.now();e.push({store:r,data:i,version:o,createdAt:u})}if(t==="json"){this._csvReaderService.saveToJSONFile(e,this._getFileName("buckup",t));return}this._csvReaderService.saveToCSVFile(e,this._getFileName("buckup",t))})}restoreAllData(t){return s(this,null,function*(){if(t?.length&&t.length>1)throw new Error("Only one file is allowed");let e=yield this._csvReaderService.readFromJSONFile(t[0]);console.log({data:e}),yield this._indexDbService.restoreAllData(e)})}makeCsv(t){return this._csvReaderService.makeCsv(t)}_getFileName(t,e){let n=new Date().toISOString();return`${t}_export_${n}.${e}`}static \u0275fac=function(e){return new(e||a)(d(O),d(p))};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};export{N as a,p as b,T as c};
