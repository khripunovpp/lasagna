"use strict";(self.webpackChunklasagna=self.webpackChunklasagna||[]).push([[134],{3134:(oe,C,r)=>{r.r(C),r.d(C,{ProductListComponent:()=>ne});var d=r(467),e=r(1007),v=r(7512),R=r(1119),G=r(1072),I=r(5642),T=r(1086),u=r(177),F=r(4625),D=r(553);let y=(()=>{class i{template;constructor(t){this.template=t}static \u0275fac=function(n){return new(n||i)(e.rXU(e.C4Q))};static \u0275dir=e.FsC({type:i,selectors:[["","lgCardListItem",""]]})}return i})();function A(i,c){if(1&i&&(e.j41(0,"div",2),e.eu8(1,4),e.k0s()),2&i){const t=c.$implicit;e.R7$(),e.Y8G("ngTemplateOutlet",t.template)}}function M(i,c){1&i&&(e.j41(0,"div",3),e.EFF(1,"No items found"),e.k0s())}let P=(()=>{class i{constructor(){}items;static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-card-list"]],contentQueries:function(n,o,l){if(1&n&&e.wni(l,y,4),2&n){let s;e.mGM(s=e.lsd())&&(o.items=s)}},decls:5,vars:2,consts:[[3,"flat"],[1,"lg-card-list"],[1,"lg-card-list__item"],[2,"padding","0 24px"],[3,"ngTemplateOutlet"]],template:function(n,o){1&n&&(e.j41(0,"lg-card",0)(1,"section",1),e.Z7z(2,A,2,1,"div",2,e.Vm6,!1,M,2,0,"div",3),e.k0s()()),2&n&&(e.Y8G("flat",!0),e.R7$(2),e.Dyx(o.items))},dependencies:[D.i,u.T3],styles:[":host{display:flex;width:100%}.lg-card-list{display:flex;flex-direction:column;width:100%;gap:32px;padding:24px 0}.lg-card-list__item{padding:0 24px}\n"],encapsulation:2})}return i})();var x=r(4374);const $=["input"],N=["*"];let _=(()=>{class i{filesSelected=(0,e.CGW)();accept=(0,e.hFB)(".csv");input=(0,e.ebz)("input");onFileChange(t){const o=t.target.files?.[0];o&&this.filesSelected.emit([o])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-upload"]],viewQuery:function(n,o){1&n&&e.wEZ(o.input,$,5),2&n&&e.NyB()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:N,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(n,o){if(1&n){const l=e.RV6();e.NAR(),e.j41(0,"div",1),e.bIt("click",function(){e.eBV(l);const a=e.sdS(2);return e.Njj(a.click())}),e.j41(1,"input",2,0),e.bIt("change",function(a){return e.eBV(l),e.Njj(o.onFileChange(a))}),e.k0s(),e.j41(3,"div",3),e.SdG(4),e.k0s()()}2&n&&(e.R7$(),e.Y8G("accept",o.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})}return i})();var b=r(1413),j=r(9172),w=r(2816);const E=["*"];let k=(()=>{class i{constructor(){}displayed=(0,e.vPA)(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=e.VBU({type:i,selectors:[["lg-dialog"]],ngContentSelectors:E,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(n,o){1&n&&(e.NAR(),e.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),e.SdG(5),e.k0s()()()()()),2&n&&e.xc7("display",o.displayed()?"flex":"none")},dependencies:[D.i],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})}return i})();var O=r(7782),m=r(9417);let f=(()=>{class i{constructor(){}readFromFile(t){return new Promise((n,o)=>{const l=new FileReader;l.onload=()=>{const a=this.parseData(l.result),[p,...g]=a,h=this.arrayToObjects(g,p);n(h)},l.onerror=()=>{o(l.error)},l.readAsText(t)})}parseData(t){return t.split("\r\n").map(n=>n.split(",")).filter(n=>n.length>1&&n.some(o=>o.length>0))}arrayToObjects(t,n){return t.map(o=>{const l={};return n.forEach((s,a)=>{l[s]=o[a]}),l})}makeCsv(t){const n=Object.keys(t[0]),o=t.map(s=>n.map(a=>s[a]));return[n,...o].map(s=>s.join(",")).join("\r\n")}saveToFile(t,n){const o=this.makeCsv(t),l=new Blob([o],{type:"text/csv"}),s=URL.createObjectURL(l),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",s),a.setAttribute("download",n),a.click(),URL.revokeObjectURL(s)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var S=r(5559);const z=(i,c)=>c.name+c.uuid;function X(i,c){1&i&&e.EFF(0," Skip ")}function U(i,c){if(1&i){const t=e.RV6();e.j41(0,"input",11),e.mxI("ngModelChange",function(o){e.eBV(t);const l=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.selectedOldRows[l.name],o)||(s.selectedOldRows[l.name]=o),e.Njj(o)}),e.k0s(),e.DNE(1,X,1,0)}if(2&i){const t=e.XpG().$implicit,n=e.XpG(3);e.R50("ngModel",n.selectedOldRows[t.name]),e.Y8G("disabled",n.selectedDuplicates[t.name]),e.R7$(),e.vxM(n.selectedOldRows[t.name]?1:-1)}}function Y(i,c){if(1&i){const t=e.RV6();e.j41(0,"input",12),e.mxI("ngModelChange",function(o){e.eBV(t);const l=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.selectedNewRows[l.name],o)||(s.selectedNewRows[l.name]=o),e.Njj(o)}),e.k0s(),e.EFF(1," Add ")}if(2&i){const t=e.XpG().$implicit,n=e.XpG(3);e.R50("ngModel",n.selectedNewRows[t.name]),e.Y8G("disabled",n.selectedDuplicates[t.name])}}function V(i,c){if(1&i&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&i){const t=e.XpG().$implicit;e.R7$(),e.SpI("from ",t.source,"")}}function L(i,c){if(1&i&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&i){const t=e.XpG(2).$implicit,n=e.XpG();e.R7$(),e.SpI("from ",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).source,"")}}function B(i,c){if(1&i){const t=e.RV6();e.j41(0,"div",13)(1,"input",11),e.mxI("ngModelChange",function(o){e.eBV(t);const l=e.XpG().$implicit,s=e.XpG(3);return e.DH7(s.selectedDuplicates[l.name],o)||(s.selectedDuplicates[l.name]=o),e.Njj(o)}),e.k0s(),e.j41(2,"span"),e.EFF(3),e.k0s(),e.j41(4,"span"),e.EFF(5),e.k0s(),e.j41(6,"span"),e.EFF(7),e.k0s(),e.DNE(8,L,2,1,"span"),e.k0s()}if(2&i){const t=e.XpG().$implicit,n=e.XpG(),o=e.XpG(2);e.AVh("selected-old",o.selectedOldRows[t.name]),e.Y8G("ngClass",o.selectedDuplicates[t.name]?"selected-duplicated":"duplicated"),e.R7$(),e.R50("ngModel",o.selectedDuplicates[t.name]),e.Y8G("disabled",o.selectedNewRows[t.name]||o.selectedOldRows[t.name]),e.R7$(2),e.JRh(o.selectedDuplicates[t.name]?"Update with":"Duplicates"),e.R7$(2),e.JRh(null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).name),e.R7$(2),e.Lme("",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).amount," gr for ",null==(n[t.uuid]||n[t.name])?null:(n[t.uuid]||n[t.name]).price,""),e.R7$(),e.vxM(null!=(n[t.uuid]||n[t.name])&&(n[t.uuid]||n[t.name]).source?8:-1)}}function Q(i,c){if(1&i&&(e.j41(0,"lg-gap-column",8)(1,"div",9),e.DNE(2,U,2,3)(3,Y,2,2),e.j41(4,"span"),e.EFF(5),e.k0s(),e.j41(6,"span"),e.EFF(7),e.k0s(),e.DNE(8,V,2,1,"span"),e.k0s(),e.DNE(9,B,9,10,"div",10),e.k0s()),2&i){const t=c.$implicit,n=e.XpG(),o=e.XpG(2);e.Y8G("size","small")("hidden",o.skipAllDuplicates()&&(n[t.uuid]||n[t.name])),e.R7$(),e.AVh("old",o.selectedOldRows[t.name])("applying",o.selectedNewRows[t.name])("removing",o.selectedDuplicates[t.name]),e.R7$(),e.vxM(n[t.uuid]||n[t.name]?2:3),e.R7$(3),e.JRh(t.name),e.R7$(2),e.Lme("",t.amount,"gr for ",t.price,""),e.R7$(),e.vxM(t.source?8:-1),e.R7$(),e.vxM(n[t.uuid]||n[t.name]?9:-1)}}function H(i,c){if(1&i&&(e.j41(0,"lg-gap-column",7),e.Z7z(1,Q,10,14,"lg-gap-column",8,z),e.k0s()),2&i){const t=e.XpG();e.Y8G("size","medium"),e.R7$(),e.Dyx(t)}}function Z(i,c){if(1&i&&(e.DNE(0,H,3,1,"lg-gap-column",7),e.nI1(1,"async")),2&i){let t;const n=e.XpG();e.vxM((t=e.bMT(1,1,n.analize$))?0:-1,t)}}let J=(()=>{class i{_csvReaderService;_indexDbService;constructor(t,n){this._csvReaderService=t,this._indexDbService=n}selectedNewRows={};selectedOldRows={};selectedDuplicates={};onDone=(0,e.CGW)();storeName=(0,e.hFB)(null);schema=(0,e.hFB)();skipAllDuplicates=(0,e.geq)(!1);replaceAll=(0,e.geq)(!1);analizeSubject=new b.B;dataSubject=new b.B;data$=this.dataSubject.asObservable().pipe((0,j.Z)([]),(0,w.S)((t,n)=>null==n?[]:[...t,n]));analize$=this.analizeSubject.asObservable().pipe((0,j.Z)([]),(0,w.S)((t,n)=>null==n?[]:n.uuid&&n.name?{...t,[n.uuid]:n,[n.name]:n}:t));dialog;upload=(0,e.ebz)(_);parsedData=[];onConfirm(){var t=this;return(0,d.A)(function*(){for(const n of t.parsedData)t.selectedNewRows[n.name]?yield t._addData(n,t.storeName()):t.selectedDuplicates[n.name]&&!t.skipAllDuplicates()&&(yield t._indexDbService.replaceData(t.storeName(),n.uuid,n));t.clear(),t.onDone.emit(),t.dialog.close()})()}clear(){this.upload().clear(),this.selectedNewRows={},this.selectedOldRows={},this.selectedDuplicates={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(t=>{this.selectedNewRows[t.name]||this.selectedOldRows[t.name]||(this.selectedDuplicates[t.name]=!0)}):this.selectedDuplicates={}}onFileSelected(t){var n=this;this.dialog.open(),this._csvReaderService.readFromFile(t[0]).then(function(){var o=(0,d.A)(function*(l){for(const s of l){const a=n.schema()?.safeParse(s);if(!a?.success)return void console.log("error",a?.error);if(!n.storeName())return void console.log("storeName is not set");n.dataSubject.next(s),n.parsedData.push(a.data),yield n._analyzeDuplicates(a.data).then(p=>{p.duplicate?n.analizeSubject.next(p.data[0]):n.selectedNewRows[s.name]=!0})}});return function(l){return o.apply(this,arguments)}}())}_addData(t,n){var o=this;return new Promise(function(){var l=(0,d.A)(function*(s,a){yield o._indexDbService.addData(n,t),s()});return function(s,a){return l.apply(this,arguments)}}())}_analyzeDuplicates(t){return new Promise((n,o)=>{this._indexDbService.search(this.storeName(),"name",t.name,l=>{n(l.length?{data:l,duplicate:!0}:{data:null,duplicate:!1})})})}static \u0275fac=function(n){return new(n||i)(e.rXU(f),e.rXU(S.Q))};static \u0275cmp=e.VBU({type:i,selectors:[["lg-import"]],viewQuery:function(n,o){if(1&n&&(e.wEZ(o.upload,_,5),e.GBs(k,5)),2&n){let l;e.NyB(),e.mGM(l=e.lsd())&&(o.dialog=l.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"ngModelChange","ngModel"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[3,"size","hidden"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","selected-old"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(n,o){if(1&n&&(e.j41(0,"lg-upload",0),e.bIt("filesSelected",function(s){return o.onFileSelected(s)}),e.j41(1,"lg-button",1),e.EFF(2," Import "),e.k0s()(),e.j41(3,"lg-dialog")(4,"lg-gap-column"),e.DNE(5,Z,2,3),e.nI1(6,"async"),e.j41(7,"lg-gap-row",2)(8,"input",3),e.mxI("ngModelChange",function(s){return e.DH7(o.skipAllDuplicates,s)||(o.skipAllDuplicates=s),s}),e.k0s(),e.j41(9,"label"),e.EFF(10,"Skip all duplicates"),e.k0s()(),e.j41(11,"lg-gap-row",2)(12,"input",4),e.bIt("change",function(){return o.onReplaceAll()}),e.mxI("ngModelChange",function(s){return e.DH7(o.replaceAll,s)||(o.replaceAll=s),s}),e.k0s(),e.j41(13,"label"),e.EFF(14,"Replace all with new"),e.k0s()(),e.j41(15,"lg-gap-row",5)(16,"lg-button",6),e.bIt("click",function(){return o.onConfirm()}),e.EFF(17," Confirm "),e.k0s()()()()),2&n){let l;e.R7$(),e.Aen("warning"),e.Y8G("flat",!0)("size","small"),e.R7$(4),e.vxM((l=e.bMT(6,17,o.data$))?5:-1,l),e.R7$(2),e.Y8G("center",!0)("hidden",o.replaceAll())("size","small"),e.R7$(),e.R50("ngModel",o.skipAllDuplicates),e.R7$(3),e.Y8G("center",!0)("hidden",o.skipAllDuplicates())("size","small"),e.R7$(),e.R50("ngModel",o.replaceAll),e.R7$(3),e.Y8G("center",!0),e.R7$(),e.Aen("success"),e.Y8G("size","small")}},dependencies:[_,R.Q,k,u.Jj,v.I,O.K,m.YN,m.Zm,m.BC,m.vS,u.YU],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.removing[_ngcontent-%COMP%], .import-row.selected-old[_ngcontent-%COMP%]{opacity:.5}.import-row.selected-duplicated[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.applying[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}.import-row.old[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}"]})}return i})();var W=r(4726),K=r(7201);let q=(()=>{class i{_indexDbService;_csvReaderService;constructor(t,n){this._indexDbService=t,this._csvReaderService=n}exportTable(t){var n=this;this._indexDbService.openDb(function(){var o=(0,d.A)(function*(l){l.transaction(t,"readonly").objectStore(t).getAll().onsuccess=g=>{n._csvReaderService.saveToFile(g.target.result,"export.csv")}});return function(l){return o.apply(this,arguments)}}())}importTable(t,n,o){return this._csvReaderService.readFromFile(n).then(function(){var l=(0,d.A)(function*(s){for(const a of s);});return function(s){return l.apply(this,arguments)}}())}makeCsv(t){return this._csvReaderService.makeCsv(t)}static \u0275fac=function(n){return new(n||i)(e.KVO(S.Q),e.KVO(f))};static \u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function ee(i,c){if(1&i){const t=e.RV6();e.j41(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6),e.EFF(4),e.k0s(),e.j41(5,"div",7),e.EFF(6),e.k0s(),e.j41(7,"div",8),e.EFF(8),e.nI1(9,"number"),e.k0s()()(),e.j41(10,"lg-button",9),e.EFF(11," Edit "),e.k0s(),e.j41(12,"lg-button",10),e.bIt("click",function(){e.eBV(t);const o=e.XpG().$implicit,l=e.XpG();return e.Njj(l.deleteProduct(o))}),e.nrm(13,"mat-icon",11),e.k0s()()}if(2&i){let t;const n=e.XpG().$implicit,o=e.XpG();e.Y8G("center",!0),e.R7$(2),e.Y8G("center",!0),e.R7$(2),e.JRh(n.name),e.R7$(2),e.SpI(" ",null!==(t=n.source)&&void 0!==t?t:"",""),e.R7$(2),e.SpI("",e.i5U(9,14,o.getPricePerGram(n),"1.2-5")," per gram "),e.R7$(2),e.Aen("primary"),e.Y8G("size","small")("link","/edit-product/"+n.uuid)("flat",!0),e.R7$(2),e.Aen("danger"),e.Y8G("size","small")("icon",!0)}}function te(i,c){1&i&&e.DNE(0,ee,14,17,"ng-template",4)}let ne=(()=>{class i{_productsRepository;_csvReaderService;_transferDataService;constructor(t,n,o){this._productsRepository=t,this._csvReaderService=n,this._transferDataService=o}products=(0,e.vPA)([]);getPricePerGram(t){return((0,F.N)(t.price)||1)/((0,F.N)(t.amount)||1)}exportProducts(){this._transferDataService.exportTable(x.F.PRODUCTS)}deleteProduct(t){t.uuid&&this._productsRepository.deleteProduct(t.uuid,()=>{this.loadProducts()})}ngOnInit(){var t=this;return(0,d.A)(function*(){yield t.loadProducts()})()}loadProducts(){this._productsRepository.getProducts(t=>{const n=t.toSorted((o,l)=>o.name.localeCompare(l.name));this.products.set(n)})}ProductDbInputScheme=W.j;Stores=x.F;static \u0275fac=function(n){return new(n||i)(e.rXU(K.d),e.rXU(f),e.rXU(q))};static \u0275cmp=e.VBU({type:i,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[2,"flex","10%"],[2,"flex","70%"],[3,"size","link","flat"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(n,o){1&n&&(e.j41(0,"lg-container")(1,"lg-title"),e.EFF(2," Products "),e.k0s(),e.j41(3,"lg-gap-row",0)(4,"lg-button",1),e.EFF(5," Add "),e.k0s(),e.j41(6,"lg-button",2),e.bIt("click",function(){return o.exportProducts()}),e.EFF(7," Export "),e.k0s(),e.j41(8,"lg-import",3),e.bIt("onDone",function(){return o.loadProducts()}),e.k0s()(),e.j41(9,"lg-card-list"),e.Z7z(10,te,1,0,null,4,e.Vm6),e.k0s()()),2&n&&(e.R7$(3),e.Y8G("center",!0),e.R7$(),e.Aen("primary"),e.Y8G("flat",!0)("link","/add-product")("size","small"),e.R7$(2),e.Aen("info"),e.Y8G("flat",!0)("size","small"),e.R7$(2),e.Y8G("schema",o.ProductDbInputScheme)("storeName",o.Stores.PRODUCTS),e.R7$(2),e.Dyx(o.products()))},dependencies:[v.I,R.Q,G.d,I.H,T.W,u.QX,P,y,J],styles:["[_nghost-%COMP%]{display:block}"]})}return i})()}}]);