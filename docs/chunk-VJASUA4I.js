import{a as Ae,b as Ee,c as Re}from"./chunk-2PNTZ6X2.js";import{a as ne,b as we,c as ye}from"./chunk-WVQX6XZS.js";import"./chunk-DCMDCXSR.js";import{b as De,e as ke,i as Pe,p as Ie}from"./chunk-AJ3UBX7E.js";import{a as Me}from"./chunk-MCS5HOGQ.js";import{a as he,b as Q,c as $,d as G}from"./chunk-KZEI6RKT.js";import{a as be,b as Te}from"./chunk-VLWAUHYT.js";import{$a as c,$b as Se,Ab as ie,Ca as C,Da as g,E as J,Ea as ce,G as K,Ga as O,Ha as U,Ia as a,Ib as ge,Ja as l,Ka as de,Lb as xe,M as j,Mb as ve,Oa as h,P as X,Pa as u,Qa as p,Ra as z,Sa as L,U as _,V as f,Va as me,Wa as ue,Xa as _e,Ya as N,Z as F,Za as V,_a as fe,a as ae,ab as b,b as le,bb as S,cb as ee,db as T,eb as D,f as I,fb as k,ia as r,j as H,la as y,lb as M,mb as te,na as x,nb as Ce,ra as se,wa as m,wb as W,xa as pe,xb as A,ya as Y,yb as B,za as v}from"./chunk-7BPNVVWP.js";var ze=["input"],Le=["*"],P=class o{filesSelected=W();accept=A(".csv");input=B("input");onFileChange(i){let t=i.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&N(t.input,ze,5),e&2&&V()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Le,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let n=h();z(),a(0,"div",1),u("click",function(){_(n);let d=fe(2);return f(d.click())}),a(1,"input",2,0),u("change",function(d){return _(n),f(t.onFileChange(d))}),l(),a(3,"div",3),L(4),l()()}e&2&&(r(),m("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Ne=["*"],R=class o{constructor(){}displayed=F(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Ne,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(z(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),L(5),l()()()()()),e&2&&pe("display",t.displayed()?"flex":"none")},dependencies:[be],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var w=class o{constructor(){}readFromFile(i){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{let s=n.result,d=this.parseData(s),[Fe,...Oe]=d,Ue=this.arrayToObjects(Oe,Fe);e(Ue)},n.onerror=()=>{t(n.error)},n.readAsText(i)})}parseData(i){return i.split(`\r
`).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(i,e){return i.map(t=>{let n={};return e.forEach((s,d)=>{n[s]=t[d]}),n})}makeCsv(i){let e=Object.keys(i[0]),t=i.map(s=>e.map(d=>s[d]));return[e,...t].map(s=>s.join(",")).join(`\r
`)}saveToFile(i,e){let t=this.makeCsv(i),n=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(n),d=document.createElement("a");document.body.appendChild(d),d.setAttribute("href",s),d.setAttribute("download",e),d.click(),URL.revokeObjectURL(s)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})};var We=(o,i)=>i.name+i.uuid;function Be(o,i){if(o&1){let e=h();a(0,"input",9),k("ngModelChange",function(n){_(e);let s=p().$implicit,d=p(3);return D(d.rowsToUpdate[s.name],n)||(d.rowsToUpdate[s.name]=n),f(n)}),l(),c(1," Update ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToUpdate[e.name]),m("disabled",t.rowsToSkip[e.name])}}function Qe(o,i){if(o&1){let e=h();a(0,"input",10),k("ngModelChange",function(n){_(e);let s=p().$implicit,d=p(3);return D(d.rowsToAdd[s.name],n)||(d.rowsToAdd[s.name]=n),f(n)}),l(),c(1," Add ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToAdd[e.name]),m("disabled",t.rowsToSkip[e.name])}}function $e(o,i){if(o&1&&(a(0,"span"),c(1),l()),o&2){let e=p().$implicit;r(),S("from ",e.source)}}function Ge(o,i){if(o&1&&(a(0,"span"),c(1),l()),o&2){let e=p(2).$implicit,t=p();r(),S("from ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).source)}}function qe(o,i){if(o&1){let e=h();a(0,"div",11)(1,"input",9),k("ngModelChange",function(n){_(e);let s=p().$implicit,d=p(3);return D(d.rowsToSkip[s.name],n)||(d.rowsToSkip[s.name]=n),f(n)}),l(),a(2,"span"),c(3),l(),a(4,"span"),c(5),l(),a(6,"span"),c(7),l(),C(8,Ge,2,1,"span"),l()}if(o&2){let e=p().$implicit,t=p(),n=p(2);Y("disabled",n.rowsToUpdate[e.name])("skip",n.rowsToUpdate[e.name]),m("ngClass",n.rowsToSkip[e.name]?"skip":"duplicated"),r(),T("ngModel",n.rowsToSkip[e.name]),m("disabled",n.rowsToAdd[e.name]||n.rowsToUpdate[e.name]),r(2),b(n.rowsToSkip[e.name]?"Skip":"Duplicates"),r(2),b((t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).name),r(2),ee("",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).amount," gr for ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).price),r(),g((t[e.uuid]||t[e.name])!=null&&(t[e.uuid]||t[e.name]).source?8:-1)}}function Ze(o,i){if(o&1&&(a(0,"lg-gap-column",6)(1,"div",7),C(2,Be,2,2)(3,Qe,2,2),a(4,"span"),c(5),l(),a(6,"span"),c(7),l(),C(8,$e,2,1,"span"),l(),C(9,qe,9,12,"div",8),l()),o&2){let e=i.$implicit,t=p(),n=p(2);m("size","small"),r(),Y("update",n.rowsToUpdate[e.name])("add",n.rowsToAdd[e.name])("disabled",n.rowsToSkip[e.name]),r(),g(t[e.uuid]||t[e.name]?2:3),r(3),b(e.name),r(2),ee("",e.amount,"gr for ",e.price),r(),g(e.source?8:-1),r(),g(t[e.uuid]||t[e.name]?9:-1)}}function He(o,i){if(o&1&&(a(0,"lg-gap-column",6),O(1,Ze,10,13,"lg-gap-column",6,We),l()),o&2){let e=p();m("size","medium"),r(),U(e)}}function Je(o,i){if(o&1&&(C(0,He,3,1,"lg-gap-column",6),M(1,"async")),o&2){let e,t=p();g((e=te(1,1,t.analize$))?0:-1,e)}}var q=class o{constructor(i,e){this._csvReaderService=i;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=W();storeName=A(null);schema=A();skipAllDuplicates=ie(!1);replaceAll=ie(!1);analizeSubject=new H;dataSubject=new H;data$=this.dataSubject.asObservable().pipe(K([]),J((i,e)=>e==null?[]:[...i,e]));analize$=this.analizeSubject.asObservable().pipe(K([]),J((i,e)=>e==null?[]:!e.uuid||!e.name?i:le(ae({},i),{[e.uuid]:e,[e.name]:e})));dialog;upload=B(P);parsedData=[];onConfirm(){return I(this,null,function*(){for(let i of this.parsedData)this.rowsToAdd[i.name]?(yield this._indexDbService.addData(this.storeName(),i),console.log("add",i)):this.rowsToUpdate[i.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),i.uuid,i),console.log("replace",i));this.clear(),this.onDone.emit(),this.dialog.close()})}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToUpdate[i.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToSkip[i.name]=!0,this.rowsToUpdate[i.name]&&(this.rowsToUpdate[i.name]=!1))}):this.rowsToSkip={}}onFileSelected(i){this.dialog.open(),this._csvReaderService.readFromFile(i[0]).then(e=>I(this,null,function*(){for(let t of e){let n=this.schema()?.safeParse(t);if(!n?.success){console.log("error",n?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(n.data),yield this._analyzeDuplicates(n.data).then(s=>{s.duplicate?this.analizeSubject.next(s.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(i){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",i.name).then(n=>{n.length?e({data:n,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(y(w),y(Q))};static \u0275cmp=x({type:o,selectors:[["lg-import"]],viewQuery:function(e,t){if(e&1&&(N(t.upload,P,5),me(R,5)),e&2){V();let n;ue(n=_e())&&(t.dialog=n.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(a(0,"lg-upload",0),u("filesSelected",function(s){return t.onFileSelected(s)}),a(1,"lg-button",1),c(2," Import "),l()(),a(3,"lg-dialog")(4,"lg-gap-column"),C(5,Je,2,3),M(6,"async"),a(7,"lg-gap-row",2)(8,"input",3),u("change",function(){return t.onSkipAllDuplicates()}),k("ngModelChange",function(s){return D(t.skipAllDuplicates,s)||(t.skipAllDuplicates=s),s}),l(),a(9,"label"),c(10,"Skip all duplicates"),l()(),a(11,"lg-gap-row",2)(12,"input",3),u("change",function(){return t.onReplaceAll()}),k("ngModelChange",function(s){return D(t.replaceAll,s)||(t.replaceAll=s),s}),l(),a(13,"label"),c(14,"Replace all with new"),l()(),a(15,"lg-gap-row",4)(16,"lg-button",5),u("click",function(){return t.onConfirm()}),c(17," Confirm "),l()()()()),e&2){let n;r(),v("warning"),m("flat",!0)("size","small"),r(4),g((n=te(6,17,t.data$))?5:-1,n),r(2),m("center",!0)("hidden",t.replaceAll())("size","small"),r(),T("ngModel",t.skipAllDuplicates),r(3),m("center",!0)("hidden",t.skipAllDuplicates())("size","small"),r(),T("ngModel",t.replaceAll),r(3),m("center",!0),r(),v("success"),m("size","small")}},dependencies:[P,$,R,xe,G,Me,Ie,De,ke,Pe,ge],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var Z=class o{constructor(i,e){this._indexDbService=i;this._csvReaderService=e}exportTable(i){return this._indexDbService.getAll(i).then(e=>{this._csvReaderService.saveToFile(e,`${i}_export_${new Date().toISOString()}.csv`)})}makeCsv(i){return this._csvReaderService.makeCsv(i)}static \u0275fac=function(e){return new(e||o)(X(Q),X(w))};static \u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})};function Xe(o,i){o&1&&c(0," per gram ")}function Ye(o,i){if(o&1&&c(0),o&2){let e=p(2).$implicit;S(" per ",e.unit," ")}}function et(o,i){if(o&1){let e=h();a(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6),c(4),l(),a(5,"div",7),c(6),l(),a(7,"div",8),c(8),M(9,"number"),C(10,Xe,1,0)(11,Ye,1,1),l()()(),a(12,"lg-button",9),c(13," Edit "),l(),a(14,"lg-button",10),u("click",function(){_(e);let n=p().$implicit,s=p();return f(s.deleteProduct(n))}),de(15,"mat-icon",11),l()()}if(o&2){let e=p().$implicit,t=p();m("center",!0),r(2),m("center",!0),r(2),b(e.name),r(2),S(" ",e.source??""),r(2),S(" ",Ce(9,15,t.getPricePerGram(e),"1.2-5")," "),r(2),g(!e.unit||e.unit==="gram"?10:11),r(2),v("primary"),m("size","small")("link","/edit-product/"+e.uuid)("flat",!0),r(2),v("danger"),m("size","small")("icon",!0)}}function tt(o,i){o&1&&se(0,et,16,18,"ng-template",4)}var je=class o{constructor(i,e,t){this._productsRepository=i;this._csvReaderService=e;this._transferDataService=t}products=F([]);ProductDbInputScheme=we;Stores=he;getPricePerGram(i){return(ne(i.price)||1)/(ne(i.amount)||1)}exportProducts(){this._transferDataService.exportTable("productsStore")}deleteProduct(i){i.uuid&&this._productsRepository.deleteProduct(i.uuid).then(()=>{this.loadProducts()})}ngOnInit(){return I(this,null,function*(){yield this.loadProducts()})}loadProducts(){this._productsRepository.getProducts().then(i=>{let e=i.toSorted((t,n)=>t.name.localeCompare(n.name));this.products.set(e)})}static \u0275fac=function(e){return new(e||o)(y(ye),y(w),y(Z))};static \u0275cmp=x({type:o,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[2,"flex","10%"],[2,"flex","70%"],[3,"size","link","flat"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(e,t){e&1&&(a(0,"lg-container")(1,"lg-title"),c(2," Products "),l(),a(3,"lg-gap-row",0)(4,"lg-button",1),c(5," Add "),l(),a(6,"lg-button",2),u("click",function(){return t.exportProducts()}),c(7," Export "),l(),a(8,"lg-import",3),u("onDone",function(){return t.loadProducts()}),l()(),a(9,"lg-card-list"),O(10,tt,1,0,null,4,ce),l()()),e&2&&(r(3),m("center",!0),r(),v("primary"),m("flat",!0)("link","/add-product")("size","small"),r(2),v("info"),m("flat",!0)("size","small"),r(2),m("schema",t.ProductDbInputScheme)("storeName",t.Stores.PRODUCTS),r(2),U(t.products()))},dependencies:[G,$,Re,Se,Te,ve,Ee,Ae,q],styles:["[_nghost-%COMP%]{display:block}"]})};export{je as ProductListComponent};
