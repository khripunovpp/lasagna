import{a as ke}from"./chunk-65PCG7KQ.js";import{a as Oe}from"./chunk-G42TUXVK.js";import{c as Y,d as I,f as De,i as Ae,m as Me,t as Ie}from"./chunk-KQ2U72DB.js";import{a as te}from"./chunk-E64ZE4KI.js";import{a as ee}from"./chunk-5PVAHMKX.js";import{b as xe}from"./chunk-PXM5XOY4.js";import{b as he,d as K,e as be}from"./chunk-JUGNCNLY.js";import{$ as B,$a as Q,$b as J,Ab as C,Ac as G,Bb as w,Bc as E,Cc as H,Eb as _e,Ec as X,Fb as fe,Fc as v,Gb as a,Hb as s,Ib as q,Lb as P,Mb as h,Pb as _,Qb as d,Rb as b,Sb as x,Sc as ve,T as oe,Tc as Se,V as re,Vb as ge,Vc as pe,Wb as Ce,Wc as Te,Xb as we,Yb as Z,Za as c,Zb as $,_b as k,a as de,ac as f,b as me,bc as ye,cb as T,da as le,ec as D,f as R,fc as A,gc as M,hb as y,jb as W,jc as ae,la as m,m as ie,ma as u,mb as F,nc as se,oc as ce,sa as L,ub as p,vb as ue,wb as V,xb as g}from"./chunk-46OIECST.js";var N=class o{constructor(n){this.templateRef=n}static \u0275fac=function(e){return new(e||o)(T(Q))};static \u0275dir=W({type:o,selectors:[["","lgImportRowTpl",""]]})};var O=class o{constructor(){}readFromCSVFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{let r=i.result,l=this.parseData(r),[Ee,...Ne]=l,Ue=this.arrayToObjects(Ne,Ee);e(Ue)},i.onerror=()=>{t(i.error)},i.readAsText(n)})}readFromJSONFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{try{let r=i.result,l=JSON.parse(r);e(l)}catch(r){t(r)}},i.onerror=()=>{t(i.error)},i.readAsText(n)})}parseData(n){return n.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(n,e){return n.map(t=>{let i={};return e.forEach((r,l)=>{i[r]=t[l]}),i})}makeCsv(n){let e=Object.keys(n[0]),t=n.map(r=>e.map(l=>r[l]));return[e,...t].map(r=>r.join(",")).join(`\r
`)}saveToCSVFile(n,e){let t=this.makeCsv(n),i=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(i),l=document.createElement("a");document.body.appendChild(l),l.setAttribute("href",r),l.setAttribute("download",e),l.click(),URL.revokeObjectURL(r)}saveToJSONFile(n,e){let t=JSON.stringify(n,null,2),i=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(i),l=document.createElement("a");document.body.appendChild(l),l.setAttribute("href",r),l.setAttribute("download",e),l.click(),URL.revokeObjectURL(r)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=B({token:o,factory:o.\u0275fac,providedIn:"root"})};var ze=["input"],Be=["*"],j=class o{filesSelected=G();accept=E(".csv");input=H("input");onFileChange(n){let t=n.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&$(t.input,ze,5),e&2&&k()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Be,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let i=h();b(),a(0,"div",1),_("click",function(){m(i);let l=J(2);return u(l.click())}),a(1,"input",2,0),_("change",function(l){return m(i),u(t.onFileChange(l))}),s(),a(3,"div",3),x(4),s()()}e&2&&(c(),p("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Le=["*"],U=class o{constructor(){}displayed=L(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Le,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(b(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),x(5),s()()()()()),e&2&&ue("display",t.displayed()?"flex":"none")},dependencies:[xe],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:96px 32px 32px;display:flex;justify-content:center;align-items:center}"]})};var We=o=>({$implicit:o,flow:"new"}),qe=o=>({$implicit:o,flow:"old"}),Ze=(o,n)=>n.name+n.uuid;function $e(o,n){if(o&1){let e=h();a(0,"input",11),M("ngModelChange",function(i){m(e);let r=d().$implicit,l=d(3);return A(l.rowsToUpdate[r.name],i)||(l.rowsToUpdate[r.name]=i),u(i)}),s(),f(1," Update ")}if(o&2){let e=d().$implicit,t=d(3);D("ngModel",t.rowsToUpdate[e.name]),p("disabled",t.rowsToSkip[e.name])}}function Je(o,n){if(o&1){let e=h();a(0,"input",12),M("ngModelChange",function(i){m(e);let r=d().$implicit,l=d(3);return A(l.rowsToAdd[r.name],i)||(l.rowsToAdd[r.name]=i),u(i)}),s(),f(1," Add ")}if(o&2){let e=d().$implicit,t=d(3);D("ngModel",t.rowsToAdd[e.name]),p("disabled",t.rowsToSkip[e.name])}}function Ge(o,n){o&1&&P(0)}function He(o,n){if(o&1&&F(0,Ge,1,0,"ng-container",13),o&2){let e=d().$implicit,t=d(3);p("ngTemplateOutlet",t.rowTemplate().templateRef)("ngTemplateOutletContext",ae(2,We,e))}}function Xe(o,n){o&1&&P(0)}function Ke(o,n){if(o&1&&F(0,Xe,1,0,"ng-container",13),o&2){let e=d(2).$implicit,t=d(),i=d(2);p("ngTemplateOutlet",i.rowTemplate().templateRef)("ngTemplateOutletContext",ae(2,qe,t[e.uuid]||t[e.name]))}}function Ye(o,n){if(o&1){let e=h();a(0,"div",14)(1,"input",11),M("ngModelChange",function(i){m(e);let r=d().$implicit,l=d(3);return A(l.rowsToSkip[r.name],i)||(l.rowsToSkip[r.name]=i),u(i)}),s(),a(2,"span"),f(3),s(),C(4,Ke,1,4,"ng-container"),s()}if(o&2){let e=d().$implicit,t=d(3);V("disabled",t.rowsToUpdate[e.name])("skip",t.rowsToUpdate[e.name]),p("ngClass",t.rowsToSkip[e.name]?"skip":"duplicated"),c(),D("ngModel",t.rowsToSkip[e.name]),p("disabled",t.rowsToAdd[e.name]||t.rowsToUpdate[e.name]),c(2),ye(t.rowsToSkip[e.name]?"Skip":"Duplicates"),c(),w(t.rowTemplate()?4:-1)}}function et(o,n){if(o&1&&(a(0,"lg-gap-column",8)(1,"div",9),C(2,$e,2,2)(3,Je,2,2),C(4,He,1,4,"ng-container"),s(),C(5,Ye,5,9,"div",10),s()),o&2){let e=n.$implicit,t=d(),i=d(2);p("size","small"),c(),V("update",i.rowsToUpdate[e.name])("add",i.rowsToAdd[e.name])("disabled",i.rowsToSkip[e.name]),c(),w(t[e.uuid]||t[e.name]?2:3),c(2),w(i.rowTemplate()?4:-1),c(),w(t[e.uuid]||t[e.name]?5:-1)}}function tt(o,n){if(o&1&&(a(0,"lg-gap-column",8),_e(1,et,6,10,"lg-gap-column",8,Ze),s()),o&2){let e=d();p("size","medium"),c(),fe(e)}}function nt(o,n){if(o&1&&(C(0,tt,3,1,"lg-gap-column",8),se(1,"async")),o&2){let e,t=d();w((e=ce(1,1,t.analize$))?0:-1,e)}}var Re=class o{constructor(n,e){this._csvReaderService=n;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=G();storeName=E(null);schema=E();skipAllDuplicates=v(!1);replaceAll=v(!1);rowTemplate=X(N);analizeSubject=new ie;dataSubject=new ie;data$=this.dataSubject.asObservable().pipe(re([]),oe((n,e)=>e==null?[]:[...n,e]));analize$=this.analizeSubject.asObservable().pipe(re([]),oe((n,e)=>e==null?[]:!e.uuid||!e.name?n:me(de({},n),{[e.uuid]:e,[e.name]:e})));dialog;upload=H(j);parsedData=[];onConfirm(){return R(this,null,function*(){for(let n of this.parsedData)this.rowsToAdd[n.name]?yield this._indexDbService.addData(this.storeName(),n,n.uuid):this.rowsToUpdate[n.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),n.uuid,n));this.clear(),this.onDone.emit(),this.dialog.close()})}onClose(){this.clear(),this.dialog.close()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToUpdate[n.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToSkip[n.name]=!0,this.rowsToUpdate[n.name]&&(this.rowsToUpdate[n.name]=!1))}):this.rowsToSkip={}}onFileSelected(n){this.dialog.open(),this._csvReaderService.readFromJSONFile(n[0]).then(e=>R(this,null,function*(){for(let t of e){let i=this.schema()?.safeParse(t);if(!i?.success){console.log("error",i?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(i.data),yield this._analyzeDuplicates(i.data).then(r=>{r.duplicate?this.analizeSubject.next(r.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(n){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",n.name).then(i=>{i.length?e({data:i,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(T(O),T(Y))};static \u0275cmp=y({type:o,selectors:[["lg-import"]],contentQueries:function(e,t,i){e&1&&Z(i,t.rowTemplate,N,5),e&2&&k()},viewQuery:function(e,t){if(e&1&&($(t.upload,j,5),ge(U,5)),e&2){k();let i;Ce(i=we())&&(t.dialog=i.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:23,vars:25,consts:[["dialog",""],[3,"filesSelected","accept"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"appendTarget","targetElement"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1){let i=h();a(0,"lg-upload",1),_("filesSelected",function(l){return m(i),u(t.onFileSelected(l))}),a(1,"lg-button",2),f(2," Import "),s()(),a(3,"div",null,0)(5,"lg-dialog")(6,"lg-gap-column"),C(7,nt,2,3),se(8,"async"),a(9,"lg-gap-row",3)(10,"input",4),_("change",function(){return m(i),u(t.onSkipAllDuplicates())}),M("ngModelChange",function(l){return m(i),A(t.skipAllDuplicates,l)||(t.skipAllDuplicates=l),u(l)}),s(),a(11,"label"),f(12,"Skip all duplicates"),s()(),a(13,"lg-gap-row",3)(14,"input",4),_("change",function(){return m(i),u(t.onReplaceAll())}),M("ngModelChange",function(l){return m(i),A(t.replaceAll,l)||(t.replaceAll=l),u(l)}),s(),a(15,"label"),f(16,"Replace all with new"),s()(),a(17,"lg-gap-row",5)(18,"lg-button",6),_("click",function(){return m(i),u(t.onClose())}),f(19," Close "),s(),a(20,"lg-button",6),_("click",function(){return m(i),u(t.onConfirm())}),f(21," Confirm "),s()()()()(),q(22,"lg-portal",7)}if(e&2){let i,r=J(4);p("accept",".json"),c(),g("warning"),p("flat",!0)("size","small"),c(6),w((i=ce(8,23,t.data$))?7:-1,i),c(2),p("center",!0)("hidden",t.replaceAll())("size","small"),c(),D("ngModel",t.skipAllDuplicates),c(3),p("center",!0)("hidden",t.skipAllDuplicates())("size","small"),c(),D("ngModel",t.replaceAll),c(3),p("center",!0),c(),g("danger"),p("size","small"),c(2),g("success"),p("size","small"),c(2),p("appendTarget","body")("targetElement",r)}},dependencies:[j,I,U,be,ee,te,Ie,De,Ae,Me,he,K,Oe],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var it=["*"];function ot(o,n){if(o&1){let e=h();a(0,"lg-button",2),_("click",function(){m(e);let i=d();return u(i.onSelection())}),f(1," Hide selection "),s(),a(2,"lg-button",2),_("click",function(){m(e);let i=d();return u(i.onAllSelection())}),f(3," Select all "),s(),a(4,"lg-button",2),_("click",function(){m(e);let i=d();return u(i.onDeselectAll())}),f(5," Deselect all "),s()}o&2&&(g("success"),p("flat",!0)("size","small"),c(2),g("danger"),p("flat",!0)("size","small"),c(2),g("danger"),p("flat",!0)("size","small"))}function rt(o,n){if(o&1){let e=h();a(0,"lg-button",2),_("click",function(){m(e);let i=d();return u(i.onSelection())}),f(1," Select many "),s()}o&2&&(g("success"),p("flat",!0)("size","small"))}var Fe=class o{constructor(){}selectionMode=v("default");selectAll=v(!1);deselectAll=v(!1);selected=v(new Set);onSelection(){this.selectionMode.set(this.selectionMode()==="default"?"selection":"default"),this.selected.set(new Set)}onAllSelection(){this.selectAll.set(!0),this.deselectAll.set(!1)}onDeselectAll(){this.selectAll.set(!1),this.deselectAll.set(!0)}putSelected(n){let[e,t]=n;this.selected.update(i=>(e?i.add(t):i.delete(t),i)),console.log("selected",this.selected())}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-selection-zone"]],inputs:{selectionMode:[1,"selectionMode"],selectAll:[1,"selectAll"],deselectAll:[1,"deselectAll"],selected:[1,"selected"]},outputs:{selectionMode:"selectionModeChange",selectAll:"selectAllChange",deselectAll:"deselectAllChange",selected:"selectedChange"},ngContentSelectors:it,decls:5,vars:2,consts:[[3,"center"],[3,"flat","size","style"],[3,"click","flat","size"]],template:function(e,t){e&1&&(b(),a(0,"lg-gap-column")(1,"lg-gap-row",0),C(2,ot,6,12)(3,rt,2,4,"lg-button",1),s(),x(4),s()),e&2&&(c(),p("center",!0),c(),w(t.selectionMode()==="selection"?2:3))},dependencies:[I,ee,te],encapsulation:2})};var z=class o{constructor(n){this.templateRef=n}static \u0275fac=function(e){return new(e||o)(T(Q))};static \u0275dir=W({type:o,selectors:[["","lgQuickActionsTpl",""]]})};var lt=["*"];function at(o,n){o&1&&P(0)}function st(o,n){if(o&1&&(a(0,"div",4),F(1,at,1,0,"ng-container",6),s()),o&2){let e,t=d();c(),p("ngTemplateOutlet",(e=t.quickActionsTpl())==null?null:e.templateRef)}}var Ve=class o{opened=L(!1);quickActionsTpl=X(z);toggle(){this.opened.update(n=>!n)}ngOnInit(){console.log("Controls bar mounted")}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=y({type:o,selectors:[["lg-controls-bar"]],contentQueries:function(e,t,i){e&1&&Z(i,t.quickActionsTpl,z,5),e&2&&k()},ngContentSelectors:lt,decls:7,vars:7,consts:[[1,"lg-controls-bar"],[1,"lg-controls-bar__inner"],[1,"lg-controls-bar__caret",3,"click","keydown.enter","swipeleft","swiperight","icon"],["aria-hidden","false","fontIcon","design_services"],[1,"lg-controls-bar__quickActions"],[1,"lg-controls-bar__content"],[4,"ngTemplateOutlet"]],template:function(e,t){e&1&&(b(),a(0,"div",0)(1,"div",1)(2,"lg-button",2),_("click",function(){return t.toggle()})("keydown.enter",function(){return t.toggle()})("swipeleft",function(){return t.toggle()})("swiperight",function(){return t.toggle()}),q(3,"mat-icon",3),s(),C(4,st,2,1,"div",4),a(5,"div",5),x(6),s()()()),e&2&&(V("opened",t.opened()),p("@fromLeft",void 0),c(2),g("transcluent"),p("icon",!0),c(2),w(t.quickActionsTpl()?4:-1))},dependencies:[ke,K,I],styles:[".lg-controls-bar[_ngcontent-%COMP%]{position:fixed;right:0;top:var(--app-content-top-padding);display:flex;gap:8px;border-radius:4px}.lg-controls-bar__inner[_ngcontent-%COMP%]{display:flex;transform:translate(calc(100% - 16px));position:relative;transition:transform .3s ease-in-out;border-radius:0 0 15px 15px;padding:0 16px}.lg-controls-bar.opened[_ngcontent-%COMP%]   .lg-controls-bar__inner[_ngcontent-%COMP%]{transform:translate(0)}.lg-controls-bar__caret[_ngcontent-%COMP%]{position:absolute;right:100%;top:0;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;scroll-snap-align:center;color:#fff;transition:opacity .3s ease-in-out;scroll-snap-type:both mandatory;overscroll-behavior-x:contain}.lg-controls-bar__quickActions[_ngcontent-%COMP%]{position:absolute;right:100%;top:66px}.lg-controls-bar.opened[_ngcontent-%COMP%]   .lg-controls-bar__caret[_ngcontent-%COMP%]{transform:rotate(180deg)}.lg-controls-bar__content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start;gap:8px;border-radius:16px;padding:16px;min-width:200px;-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px);background-color:#ffffffb3}@media (max-width: 768px){.lg-controls-bar__content[_ngcontent-%COMP%]{min-width:100px}}"],data:{animation:[ve("fromLeft",[Te(":enter",[pe({transform:"translateX(100%)"}),Se("0.3s ease-in-out",pe({transform:"translateX(0)"}))])])]}})};var Pe=class o{constructor(n,e){this._indexDbService=n;this._csvReaderService=e}exportTable(i){return R(this,arguments,function*(n,e="csv",t={}){let r=[];if(t.selected?.length?r=yield this._indexDbService.getMany(n,t.selected):r=yield this._indexDbService.getAll(n),e==="json"){this._csvReaderService.saveToJSONFile(r,this._getFileName(n,e));return}this._csvReaderService.saveToCSVFile(r,this._getFileName(n,e))})}makeCsv(n){return this._csvReaderService.makeCsv(n)}_getFileName(n,e){let t=new Date().toISOString();return`${n}_export_${t}.${e}`}static \u0275fac=function(e){return new(e||o)(le(Y),le(O))};static \u0275prov=B({token:o,factory:o.\u0275fac,providedIn:"root"})};var Yt=(o,n)=>o.reduce((e,t)=>{let i=t[n]||"unknown";return e[i]||(e[i]=[]),e[i].push(t),e},{});export{N as a,O as b,Re as c,Yt as d,Fe as e,z as f,Ve as g,Pe as h};
