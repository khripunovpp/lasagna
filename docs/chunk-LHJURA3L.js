import{a as x,b as w}from"./chunk-BF6WJXXA.js";import{B as v,y as R}from"./chunk-I5MUGXQZ.js";import{W as d,_ as m,f as F}from"./chunk-OZXQ5JHJ.js";import{a as S,b as A,f as u}from"./chunk-2WH2EVR6.js";var I=r=>r.replace(/[^a-zA-Zа-яА-ЯёЁ0-9\s-:()]/g,"");var U=()=>`rgb(${Math.floor(Math.random()*256)}, ${Math.floor(Math.random()*256)}, ${Math.floor(Math.random()*256)})`,H=r=>{let t=0;for(let n=0;n<r.length;n++)t=r.charCodeAt(n)+((t<<5)-t),t=t&t;let e=80,i=255,o="#";for(let n=0;n<3;n++){let a=t>>n*8&255;a=Math.floor(a/255*(i-e)+e),o+=a.toString(16).padStart(2,"0")}return o},T=r=>{let t=new Option().style;return t.color=r,t.color!==""},s=r=>{let t=I(r);return t.length>0?H(t):U()};var y=class r{constructor(t,e,i){this.name=String(t??"").trim(),this.color=String(e??"").trim()||s(this.name),this.uuid=i||void 0}name;color;uuid;get bgColor(){return T(this.color??"")?this.color:s(this.name)}static fromRaw(t){return typeof t=="string"?new r(t):new r(t?.name||t?.label||t?.value||t,t?.color,t?.uuid)}toDTO(){return{name:this.name||"",color:this.color||s(this.name),uuid:this.uuid||void 0}}toString(){return String(this.name)}};var D=r=>{if(typeof r=="number")return r;if(typeof r=="string"){let t=r.replace(",","."),e=parseFloat(t);return isNaN(e)?0:e}return 0};var l=class r{constructor(t){this.name=t.name,this.amount=parseFloat(String(t.amount)),this.price=t.price,this.unit=t.unit,this.source=t.source,this.category_id=x.fromRaw(t.category_id),this.tags=t.tags?.map(e=>y.fromRaw(e)),this.uuid=t.uuid,this.createdAt=t.createdAt?Number(t.createdAt):void 0,this.updatedAt=t.updatedAt?Number(t.updatedAt):void 0,this.color=this.color=String(t.color??"").trim()||s(this.name)}name;amount;price;unit;category_id;source;tags;uuid;createdAt;updatedAt;color;get ownColor(){return T(this.color||"")?this.color:s(this.name)}get pricePerUnit(){return D(this.price)===0||D(this.amount)===0?0:D(this.price)/D(this.amount)}get perUnitLabel(){return!this.unit||this.unit==="gram"?"per gram":`per ${this.unit}`}static fromRaw(t){return new r({name:t?.name||"",amount:Number(t?.amount)||0,price:Number(t?.price)||0,unit:t?.unit||"gram",source:t?.source||"",category_id:t?.category_id||"",tags:t?.tags,uuid:t?.uuid,createdAt:t?.createdAt,updatedAt:t?.updatedAt,color:t?.color})}static empty(){return new r({name:"",amount:0,price:0,unit:"gram",source:void 0,category_id:"",tags:[],uuid:void 0,createdAt:void 0,updatedAt:void 0,color:void 0})}update(t){return this.name=t.name||this.name,this.amount=t.amount?Number(t.amount):this.amount,this.price=t.price?Number(t.price):this.price,this.unit=t.unit||this.unit,this.source=t.source||this.source,this.category_id=x.fromRaw(t.category_id||""),this.tags=t.tags?.map(e=>y.fromRaw(e))||this.tags,this.uuid=t.uuid||this.uuid,this.createdAt=t.createdAt?Number(t.createdAt):this.createdAt,this.updatedAt=t?.updatedAt||Date.now(),this.color=t?.color?s(t.color):this.color,this}toDTO(){return{name:this.name,amount:this.amount,price:this.price,unit:this.unit,source:this.source??"",category_id:this.category_id.toUUID(),tags:this.tags?.map(t=>t.toString()),uuid:this.uuid,createdAt:this.createdAt??Date.now(),updatedAt:this.updatedAt??Date.now(),color:this.color||s(this.name)}}};var b=class r{constructor(){}read(t){try{let e=JSON.parse(localStorage.getItem(t+"_top")||"{}"),i=JSON.parse(localStorage.getItem(t+"_recent")||"{}");return{top:e,recent:i}}catch(e){return console.error("Error reading from localStorage:",e),{top:{},recent:{}}}}count(t,e){if(!e)return;let i=t+"_history",o=t+"_recent",n=t+"_top",a=JSON.parse(localStorage.getItem(i)||"{}"),c=Date.now(),g=c-30*24*60*60*1e3;a[e]={count:(a[e]?.count||0)+1,updatedAt:c};let p=Object.entries(a).filter(([h,f])=>f.updatedAt>=g),N=p.sort((h,f)=>f[1].updatedAt-h[1].updatedAt).slice(0,5),j=p.sort((h,f)=>f[1].count-h[1].count||f[1].updatedAt-h[1].updatedAt).slice(0,5);localStorage.setItem(i,JSON.stringify(Object.fromEntries(p))),localStorage.setItem(o,JSON.stringify(Object.fromEntries(N))),localStorage.setItem(n,JSON.stringify(Object.fromEntries(j)))}static \u0275fac=function(e){return new(e||r)};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})};var _=class r{constructor(){}getDraftForms=t=>{let e=localStorage.getItem(t);return e?JSON.parse(e):null};setDraftForm=(t,e,i,o={})=>{let n=this.getDraftForms(t),a=Date.now(),c=R(),g={uuid:c,createdAt:a,data:e,mode:i,meta:o},p=A(S({},n),{[c]:g});return localStorage.setItem(t,JSON.stringify(p)),g};updateDraftForm=(t,e,i,o,n={})=>{let a=this.getDraftForms(t),c={},g=a;a?.[i]&&(c=A(S({},a?.[i]),{updatedAt:Date.now(),data:S(S({},a?.[i].data),e),mode:o,meta:n}),g[i]=c),localStorage.setItem(t,JSON.stringify(g))};removeDraftForm=(t,e)=>{let i=this.getDraftForms(t);if(i){if(e)delete i[e];else{localStorage.removeItem(t);return}localStorage.setItem(t,JSON.stringify(i))}};static \u0275fac=function(e){return new(e||r)};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})};var O=class r{constructor(t){this._indexDbService=t}addOne(t){return this._indexDbService.addData("tags",t.toDTO(),t.name)}getOne(t){return u(this,null,function*(){return this._indexDbService.getOne("tags",t)})}getAll(){return this._indexDbService.getAll("tags")}getMany(t){return this._indexDbService.getMany("tags",t)}editOne(t,e){return this._indexDbService.replaceData("tags",t,e.toDTO())}deleteOne(t){return this._indexDbService.remove("tags",t)}static \u0275fac=function(e){return new(e||r)(m(v))};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})};var C=class r{constructor(t,e,i,o,n){this._indexDbService=t;this._categoryRepository=e;this._usingHistoryService=i;this._draftFormsService=o;this._tagsRepository=n}_stream$=new F;get products$(){return this._stream$.asObservable()}loadAll(){return this._indexDbService.getAll("productsStore").then(t=>(this._stream$.next(t.map(e=>l.fromRaw(e))),t))}addOne(t){return u(this,null,function*(){let e=yield this._indexDbService.addData("productsStore",t.toDTO());if(t.category_id&&this._saveCategory(t.category_id.toString()),t.source&&this._saveSource(t.source),this._saveProductToHistory(e),t.tags)for(let i of t.tags)yield this._saveTag(i);return e})}updateOne(t,e){return u(this,null,function*(){if(yield this._indexDbService.replaceData("productsStore",t,e.toDTO()),this._saveProductToHistory(t),e.tags)for(let i of e.tags)yield this._saveTag(i)})}getOne(t){return u(this,null,function*(){return new Promise((e,i)=>u(this,null,function*(){if(t=typeof t=="string"?t:t.uuid,!t){e(void 0);return}yield this._indexDbService.getOne("productsStore",t).then(o=>{e(l.fromRaw(o))})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}getLastProducts(){let{top:t}=this._usingHistoryService.read("products"),e=Object.keys(t);return e.length===0?Promise.resolve([]):this._indexDbService.getMany("productsStore",e).then(i=>i.toSorted((o,n)=>!o.uuid||!n.uuid?0:t[n.uuid].count>t[o.uuid].count?1:-1).map(o=>({product:l.fromRaw(o),updatedAt:o.uuid?t[o.uuid].updatedAt:0,count:o.uuid?t[o.uuid].count:0})))}deleteProduct(t){return this._indexDbService.remove("productsStore",t)}getTopCategories(){let{top:t}=this._usingHistoryService.read("products_categories"),e=Object.keys(t);return this._categoryRepository.getMany(e).then(i=>i.toSorted((o,n)=>!o.uuid||!n.uuid?0:t[n.uuid].count>t[o.uuid].count?1:-1))}getTopSources(){return u(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(t,e){return this._draftFormsService.setDraftForm("draft_products",t.toDTO(),e?.length?"edit":"add",e?{uuid:e}:{})}updateDraftProduct(t,e,i){return this._draftFormsService.updateDraftForm("draft_products",e.toDTO(),t,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftProducts(t){let e=this._draftFormsService.getDraftForms("draft_products");return t&&e?.[t]?[e?.[t]]:e?Object.values(e):[]}removeDraftProduct(t){this._draftFormsService.removeDraftForm("draft_products",t)}_saveCategory(t){this._usingHistoryService.count("products_categories",t)}_saveSource(t){this._usingHistoryService.count("products_sources",t)}_saveProductToHistory(t){this._usingHistoryService.count("products",t)}_saveTag(t){return this._tagsRepository.addOne(t)}static \u0275fac=function(e){return new(e||r)(m(v),m(w),m(b),m(_),m(O))};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})};export{D as a,U as b,y as c,l as d,b as e,_ as f,O as g,C as h};
