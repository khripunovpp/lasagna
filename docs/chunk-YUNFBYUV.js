import{a as Le,b as Ue,c as Oe}from"./chunk-OSMMHRLS.js";import{a as Fe}from"./chunk-NJMPSY7O.js";import{a as ne,b as be,c as Te}from"./chunk-2MXD6BT6.js";import"./chunk-XB3AHOA5.js";import"./chunk-JVZXL7NL.js";import{a as Re}from"./chunk-YBLVVA3I.js";import{a as je}from"./chunk-4TQRSWVC.js";import"./chunk-SE7OTRAS.js";import{b as Pe,e as Ae,i as Ee,p as Me}from"./chunk-HDECGXVV.js";import{a as Se,c as Q,d as G}from"./chunk-DDUOHXAE.js";import{a as q}from"./chunk-3VZX72VK.js";import{a as ke,b as Ie}from"./chunk-K4QPAAJ7.js";import{$a as m,Ab as ie,Ca as _,Da as f,E as J,Ea as pe,G as X,Ga as E,Ha as M,Ia as a,Ib as Ce,Ja as l,Ka as de,Lb as ve,M as U,Mb as xe,Nb as ye,Oa as y,P as Y,Pa as u,Qa as c,Ra as N,Sa as z,U as g,V as C,Va as me,Wa as ue,Wb as he,Xa as _e,Ya as V,Z as O,Za as W,Zb as we,_a as fe,a as ae,ab as b,ac as De,b as le,bb as h,cb as te,db as T,eb as D,f as A,fb as k,ia as r,j as K,la as v,lb as I,mb as R,na as x,nb as ge,ra as se,wa as p,wb as B,xa as ce,xb as F,ya as ee,yb as $,za as S}from"./chunk-6C36DQV4.js";var Be=["input"],$e=["*"],P=class n{filesSelected=B();accept=F(".csv");input=$("input");onFileChange(i){let t=i.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=x({type:n,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&V(t.input,Be,5),e&2&&W()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:$e,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let o=y();N(),a(0,"div",1),u("click",function(){g(o);let d=fe(2);return C(d.click())}),a(1,"input",2,0),u("change",function(d){return g(o),C(t.onFileChange(d))}),l(),a(3,"div",3),z(4),l()()}e&2&&(r(),p("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Qe=["*"],L=class n{constructor(){}displayed=O(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=x({type:n,selectors:[["lg-dialog"]],ngContentSelectors:Qe,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(N(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),z(5),l()()()()()),e&2&&ce("display",t.displayed()?"flex":"none")},dependencies:[ke],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var w=class n{constructor(){}readFromFile(i){return new Promise((e,t)=>{let o=new FileReader;o.onload=()=>{let s=o.result,d=this.parseData(s),[ze,...Ve]=d,We=this.arrayToObjects(Ve,ze);e(We)},o.onerror=()=>{t(o.error)},o.readAsText(i)})}parseData(i){return i.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(i,e){return i.map(t=>{let o={};return e.forEach((s,d)=>{o[s]=t[d]}),o})}makeCsv(i){let e=Object.keys(i[0]),t=i.map(s=>e.map(d=>s[d]));return[e,...t].map(s=>s.join(",")).join(`\r
`)}saveToFile(i,e){let t=this.makeCsv(i),o=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(o),d=document.createElement("a");document.body.appendChild(d),d.setAttribute("href",s),d.setAttribute("download",e),d.click(),URL.revokeObjectURL(s)}static \u0275fac=function(e){return new(e||n)};static \u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})};var qe=(n,i)=>i.name+i.uuid;function Ze(n,i){if(n&1){let e=y();a(0,"input",9),k("ngModelChange",function(o){g(e);let s=c().$implicit,d=c(3);return D(d.rowsToUpdate[s.name],o)||(d.rowsToUpdate[s.name]=o),C(o)}),l(),m(1," Update ")}if(n&2){let e=c().$implicit,t=c(3);T("ngModel",t.rowsToUpdate[e.name]),p("disabled",t.rowsToSkip[e.name])}}function He(n,i){if(n&1){let e=y();a(0,"input",10),k("ngModelChange",function(o){g(e);let s=c().$implicit,d=c(3);return D(d.rowsToAdd[s.name],o)||(d.rowsToAdd[s.name]=o),C(o)}),l(),m(1," Add ")}if(n&2){let e=c().$implicit,t=c(3);T("ngModel",t.rowsToAdd[e.name]),p("disabled",t.rowsToSkip[e.name])}}function Ke(n,i){if(n&1&&(a(0,"span"),m(1),l()),n&2){let e=c().$implicit;r(),h("from ",e.source)}}function Je(n,i){if(n&1&&(a(0,"span"),m(1),l()),n&2){let e=c(2).$implicit,t=c();r(),h("from ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).source)}}function Xe(n,i){if(n&1){let e=y();a(0,"div",11)(1,"input",9),k("ngModelChange",function(o){g(e);let s=c().$implicit,d=c(3);return D(d.rowsToSkip[s.name],o)||(d.rowsToSkip[s.name]=o),C(o)}),l(),a(2,"span"),m(3),l(),a(4,"span"),m(5),l(),a(6,"span"),m(7),l(),_(8,Je,2,1,"span"),l()}if(n&2){let e=c().$implicit,t=c(),o=c(2);ee("disabled",o.rowsToUpdate[e.name])("skip",o.rowsToUpdate[e.name]),p("ngClass",o.rowsToSkip[e.name]?"skip":"duplicated"),r(),T("ngModel",o.rowsToSkip[e.name]),p("disabled",o.rowsToAdd[e.name]||o.rowsToUpdate[e.name]),r(2),b(o.rowsToSkip[e.name]?"Skip":"Duplicates"),r(2),b((t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).name),r(2),te("",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).amount," gr for ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).price),r(),f((t[e.uuid]||t[e.name])!=null&&(t[e.uuid]||t[e.name]).source?8:-1)}}function Ye(n,i){if(n&1&&(a(0,"lg-gap-column",6)(1,"div",7),_(2,Ze,2,2)(3,He,2,2),a(4,"span"),m(5),l(),a(6,"span"),m(7),l(),_(8,Ke,2,1,"span"),l(),_(9,Xe,9,12,"div",8),l()),n&2){let e=i.$implicit,t=c(),o=c(2);p("size","small"),r(),ee("update",o.rowsToUpdate[e.name])("add",o.rowsToAdd[e.name])("disabled",o.rowsToSkip[e.name]),r(),f(t[e.uuid]||t[e.name]?2:3),r(3),b(e.name),r(2),te("",e.amount,"gr for ",e.price),r(),f(e.source?8:-1),r(),f(t[e.uuid]||t[e.name]?9:-1)}}function et(n,i){if(n&1&&(a(0,"lg-gap-column",6),E(1,Ye,10,13,"lg-gap-column",6,qe),l()),n&2){let e=c();p("size","medium"),r(),M(e)}}function tt(n,i){if(n&1&&(_(0,et,3,1,"lg-gap-column",6),I(1,"async")),n&2){let e,t=c();f((e=R(1,1,t.analize$))?0:-1,e)}}var Z=class n{constructor(i,e){this._csvReaderService=i;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=B();storeName=F(null);schema=F();skipAllDuplicates=ie(!1);replaceAll=ie(!1);analizeSubject=new K;dataSubject=new K;data$=this.dataSubject.asObservable().pipe(X([]),J((i,e)=>e==null?[]:[...i,e]));analize$=this.analizeSubject.asObservable().pipe(X([]),J((i,e)=>e==null?[]:!e.uuid||!e.name?i:le(ae({},i),{[e.uuid]:e,[e.name]:e})));dialog;upload=$(P);parsedData=[];onConfirm(){return A(this,null,function*(){for(let i of this.parsedData)this.rowsToAdd[i.name]?(yield this._indexDbService.addData(this.storeName(),i),console.log("add",i)):this.rowsToUpdate[i.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),i.uuid,i),console.log("replace",i));this.clear(),this.onDone.emit(),this.dialog.close()})}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToUpdate[i.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToSkip[i.name]=!0,this.rowsToUpdate[i.name]&&(this.rowsToUpdate[i.name]=!1))}):this.rowsToSkip={}}onFileSelected(i){this.dialog.open(),this._csvReaderService.readFromFile(i[0]).then(e=>A(this,null,function*(){for(let t of e){let o=this.schema()?.safeParse(t);if(!o?.success){console.log("error",o?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(o.data),yield this._analyzeDuplicates(o.data).then(s=>{s.duplicate?this.analizeSubject.next(s.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(i){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",i.name).then(o=>{o.length?e({data:o,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||n)(v(w),v(Q))};static \u0275cmp=x({type:n,selectors:[["lg-import"]],viewQuery:function(e,t){if(e&1&&(V(t.upload,P,5),me(L,5)),e&2){W();let o;ue(o=_e())&&(t.dialog=o.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(a(0,"lg-upload",0),u("filesSelected",function(s){return t.onFileSelected(s)}),a(1,"lg-button",1),m(2," Import "),l()(),a(3,"lg-dialog")(4,"lg-gap-column"),_(5,tt,2,3),I(6,"async"),a(7,"lg-gap-row",2)(8,"input",3),u("change",function(){return t.onSkipAllDuplicates()}),k("ngModelChange",function(s){return D(t.skipAllDuplicates,s)||(t.skipAllDuplicates=s),s}),l(),a(9,"label"),m(10,"Skip all duplicates"),l()(),a(11,"lg-gap-row",2)(12,"input",3),u("change",function(){return t.onReplaceAll()}),k("ngModelChange",function(s){return D(t.replaceAll,s)||(t.replaceAll=s),s}),l(),a(13,"label"),m(14,"Replace all with new"),l()(),a(15,"lg-gap-row",4)(16,"lg-button",5),u("click",function(){return t.onConfirm()}),m(17," Confirm "),l()()()()),e&2){let o;r(),S("warning"),p("flat",!0)("size","small"),r(4),f((o=R(6,17,t.data$))?5:-1,o),r(2),p("center",!0)("hidden",t.replaceAll())("size","small"),r(),T("ngModel",t.skipAllDuplicates),r(3),p("center",!0)("hidden",t.skipAllDuplicates())("size","small"),r(),T("ngModel",t.replaceAll),r(3),p("center",!0),r(),S("success"),p("size","small")}},dependencies:[P,G,L,ve,q,Re,Me,Pe,Ae,Ee,Ce],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var H=class n{constructor(i,e){this._indexDbService=i;this._csvReaderService=e}exportTable(i){return this._indexDbService.getAll(i).then(e=>{this._csvReaderService.saveToFile(e,`${i}_export_${new Date().toISOString()}.csv`)})}makeCsv(i){return this._csvReaderService.makeCsv(i)}static \u0275fac=function(e){return new(e||n)(Y(Q),Y(w))};static \u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})};var nt=(n,i)=>i.value==null?null:i.value.category;function ot(n,i){n&1&&m(0," per gram ")}function rt(n,i){if(n&1&&m(0),n&2){let e=c(2).$implicit;h(" per ",e.unit," ")}}function at(n,i){if(n&1){let e=y();a(0,"lg-gap-row",0)(1,"div",6)(2,"lg-gap-row",0)(3,"div",7)(4,"a",8),m(5),l()(),a(6,"div",9),m(7),l(),a(8,"div",10),m(9),I(10,"number"),_(11,ot,1,0)(12,rt,1,1),l()()(),a(13,"lg-button",11),u("click",function(){g(e);let o=c().$implicit,s=c(3);return C(s.deleteProduct(o))}),de(14,"mat-icon",12),l()()}if(n&2){let e=c().$implicit,t=c(3);p("center",!0),r(2),p("center",!0),r(2),p("routerLink","/edit-product/"+e.uuid),r(),b(e.name),r(2),h(" ",e.source??""),r(2),h(" ",ge(10,11,t.getPricePerGram(e),"1.2-5")," "),r(2),f(!e.unit||e.unit==="gram"?11:12),r(2),S("danger"),p("size","small")("icon",!0)}}function lt(n,i){n&1&&se(0,at,15,14,"ng-template",5)}function st(n,i){if(n&1&&(a(0,"lg-title",4),m(1),l(),a(2,"lg-card-list"),E(3,lt,1,0,null,5,pe),l()),n&2){let e=i;p("level",3),r(),h(" ",e.category||"Uncategorized"," "),r(2),M(e.products)}}function ct(n,i){if(n&1&&_(0,st,5,2),n&2){let e,t=i.$implicit;f((e=t.value)?0:-1,e)}}function pt(n,i){n&1&&(a(0,"lg-gap-row",0)(1,"lg-title",4),m(2," No products found "),l()()),n&2&&(p("center",!0),r(),p("level",5))}var Ne=class n{constructor(i,e,t,o,s){this._productsRepository=i;this._csvReaderService=e;this._transferDataService=t;this._activatedRoute=o;this._notificationsService=s;this._activatedRoute.data.pipe(Fe()).subscribe(d=>{this.products.set(d.list)})}products=O([]);ProductDbInputScheme=be;Stores=Se;getPricePerGram(i){return(ne(i.price)||1)/(ne(i.amount)||1)}exportProducts(){this._transferDataService.exportTable("productsStore")}deleteProduct(i){i.uuid&&this._productsRepository.deleteProduct(i.uuid).then(()=>{this._notificationsService.success("Product deleted"),this.loadProducts()})}ngOnInit(){return A(this,null,function*(){yield this.loadProducts()})}loadProducts(){}static \u0275fac=function(e){return new(e||n)(v(Te),v(w),v(H),v(he),v(je))};static \u0275cmp=x({type:n,selectors:[["lg-product-list"]],decls:13,vars:15,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],[3,"level"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[3,"routerLink"],[2,"flex","10%"],[2,"flex","70%"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(e,t){e&1&&(a(0,"lg-container")(1,"lg-title"),m(2," Products "),l(),a(3,"lg-gap-row",0)(4,"lg-button",1),m(5," Add "),l(),a(6,"lg-button",2),u("click",function(){return t.exportProducts()}),m(7," Export "),l(),a(8,"lg-import",3),u("onDone",function(){return t.loadProducts()}),l()(),E(9,ct,1,1,null,null,nt,!1,pt,3,2,"lg-gap-row",0),I(12,"keyvalue"),l()),e&2&&(r(3),p("center",!0),r(),S("primary"),p("flat",!0)("link","/add-product")("size","small"),r(2),S("info"),p("flat",!0)("size","small"),r(2),p("schema",t.ProductDbInputScheme)("storeName",t.Stores.PRODUCTS),r(),M(R(12,13,t.products())))},dependencies:[q,G,Oe,De,Ie,ye,Ue,Le,Z,we,xe],styles:["[_nghost-%COMP%]{display:block}"]})};export{Ne as ProductListComponent};
