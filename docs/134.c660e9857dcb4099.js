"use strict";(self.webpackChunklasagna=self.webpackChunklasagna||[]).push([[134],{3134:(it,g,s)=>{s.r(g),s.d(g,{ProductListComponent:()=>et});var m=s(467),t=s(1007),h=s(7512),C=s(1119),x=s(1072),y=s(5642),D=s(1086),p=s(177),v=s(4625),k=s(553);let F=(()=>{class o{template;constructor(e){this.template=e}static \u0275fac=function(n){return new(n||o)(t.rXU(t.C4Q))};static \u0275dir=t.FsC({type:o,selectors:[["","lgCardListItem",""]]})}return o})();function A(o,c){if(1&o&&(t.j41(0,"div",2),t.eu8(1,4),t.k0s()),2&o){const e=c.$implicit;t.R7$(),t.Y8G("ngTemplateOutlet",e.template)}}function G(o,c){1&o&&(t.j41(0,"div",3),t.EFF(1,"No items found"),t.k0s())}let I=(()=>{class o{constructor(){}items;static \u0275fac=function(n){return new(n||o)};static \u0275cmp=t.VBU({type:o,selectors:[["lg-card-list"]],contentQueries:function(n,i,a){if(1&n&&t.wni(a,F,4),2&n){let l;t.mGM(l=t.lsd())&&(i.items=l)}},decls:5,vars:2,consts:[[3,"flat"],[1,"lg-card-list"],[1,"lg-card-list__item"],[2,"padding","0 24px"],[3,"ngTemplateOutlet"]],template:function(n,i){1&n&&(t.j41(0,"lg-card",0)(1,"section",1),t.Z7z(2,A,2,1,"div",2,t.Vm6,!1,G,2,0,"div",3),t.k0s()()),2&n&&(t.Y8G("flat",!0),t.R7$(2),t.Dyx(i.items))},dependencies:[k.i,p.T3],styles:[":host{display:flex;width:100%}.lg-card-list{display:flex;flex-direction:column;width:100%;gap:32px;padding:24px 0}.lg-card-list__item{padding:0 24px}\n"],encapsulation:2})}return o})();var T=s(4374);const $=["input"],P=["*"];let _=(()=>{class o{filesSelected=(0,t.CGW)();accept=(0,t.hFB)(".csv");input=(0,t.ebz)("input");onFileChange(e){const i=e.target.files?.[0];i&&this.filesSelected.emit([i])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=t.VBU({type:o,selectors:[["lg-upload"]],viewQuery:function(n,i){1&n&&t.wEZ(i.input,$,5),2&n&&t.NyB()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:P,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(n,i){if(1&n){const a=t.RV6();t.NAR(),t.j41(0,"div",1),t.bIt("click",function(){t.eBV(a);const r=t.sdS(2);return t.Njj(r.click())}),t.j41(1,"input",2,0),t.bIt("change",function(r){return t.eBV(a),t.Njj(i.onFileChange(r))}),t.k0s(),t.j41(3,"div",3),t.SdG(4),t.k0s()()}2&n&&(t.R7$(),t.Y8G("accept",i.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})}return o})();var w=s(1413),R=s(9172),S=s(2816);const E=["*"];let j=(()=>{class o{constructor(){}displayed=(0,t.vPA)(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(n){return new(n||o)};static \u0275cmp=t.VBU({type:o,selectors:[["lg-dialog"]],ngContentSelectors:E,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(n,i){1&n&&(t.NAR(),t.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),t.SdG(5),t.k0s()()()()()),2&n&&t.xc7("display",i.displayed()?"flex":"none")},dependencies:[k.i],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})}return o})();var M=s(7782),d=s(9417);let f=(()=>{class o{constructor(){}readFromFile(e){return new Promise((n,i)=>{const a=new FileReader;a.onload=()=>{const r=this.parseData(a.result),[u,...nt]=r,ot=this.arrayToObjects(nt,u);n(ot)},a.onerror=()=>{i(a.error)},a.readAsText(e)})}parseData(e){return e.split("\r\n").map(n=>n.split(",")).filter(n=>n.length>1&&n.some(i=>i.length>0))}arrayToObjects(e,n){return e.map(i=>{const a={};return n.forEach((l,r)=>{a[l]=i[r]}),a})}makeCsv(e){const n=Object.keys(e[0]),i=e.map(l=>n.map(r=>l[r]));return[n,...i].map(l=>l.join(",")).join("\r\n")}saveToFile(e,n){const i=this.makeCsv(e),a=new Blob([i],{type:"text/csv"}),l=URL.createObjectURL(a),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",l),r.setAttribute("download",n),r.click(),URL.revokeObjectURL(l)}static \u0275fac=function(n){return new(n||o)};static \u0275prov=t.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var b=s(6659);const U=(o,c)=>c.name+c.uuid;function N(o,c){if(1&o){const e=t.RV6();t.j41(0,"input",9),t.mxI("ngModelChange",function(i){t.eBV(e);const a=t.XpG().$implicit,l=t.XpG(3);return t.DH7(l.rowsToUpdate[a.name],i)||(l.rowsToUpdate[a.name]=i),t.Njj(i)}),t.k0s(),t.EFF(1," Update ")}if(2&o){const e=t.XpG().$implicit,n=t.XpG(3);t.R50("ngModel",n.rowsToUpdate[e.name]),t.Y8G("disabled",n.rowsToSkip[e.name])}}function X(o,c){if(1&o){const e=t.RV6();t.j41(0,"input",10),t.mxI("ngModelChange",function(i){t.eBV(e);const a=t.XpG().$implicit,l=t.XpG(3);return t.DH7(l.rowsToAdd[a.name],i)||(l.rowsToAdd[a.name]=i),t.Njj(i)}),t.k0s(),t.EFF(1," Add ")}if(2&o){const e=t.XpG().$implicit,n=t.XpG(3);t.R50("ngModel",n.rowsToAdd[e.name]),t.Y8G("disabled",n.rowsToSkip[e.name])}}function z(o,c){if(1&o&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&o){const e=t.XpG().$implicit;t.R7$(),t.SpI("from ",e.source,"")}}function O(o,c){if(1&o&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&o){const e=t.XpG(2).$implicit,n=t.XpG();t.R7$(),t.SpI("from ",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).source,"")}}function L(o,c){if(1&o){const e=t.RV6();t.j41(0,"div",11)(1,"input",9),t.mxI("ngModelChange",function(i){t.eBV(e);const a=t.XpG().$implicit,l=t.XpG(3);return t.DH7(l.rowsToSkip[a.name],i)||(l.rowsToSkip[a.name]=i),t.Njj(i)}),t.k0s(),t.j41(2,"span"),t.EFF(3),t.k0s(),t.j41(4,"span"),t.EFF(5),t.k0s(),t.j41(6,"span"),t.EFF(7),t.k0s(),t.DNE(8,O,2,1,"span"),t.k0s()}if(2&o){const e=t.XpG().$implicit,n=t.XpG(),i=t.XpG(2);t.AVh("disabled",i.rowsToUpdate[e.name])("skip",i.rowsToUpdate[e.name]),t.Y8G("ngClass",i.rowsToSkip[e.name]?"skip":"duplicated"),t.R7$(),t.R50("ngModel",i.rowsToSkip[e.name]),t.Y8G("disabled",i.rowsToAdd[e.name]||i.rowsToUpdate[e.name]),t.R7$(2),t.JRh(i.rowsToSkip[e.name]?"Skip":"Duplicates"),t.R7$(2),t.JRh(null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).name),t.R7$(2),t.Lme("",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).amount," gr for ",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).price,""),t.R7$(),t.vxM(null!=(n[e.uuid]||n[e.name])&&(n[e.uuid]||n[e.name]).source?8:-1)}}function Y(o,c){if(1&o&&(t.j41(0,"lg-gap-column",6)(1,"div",7),t.DNE(2,N,2,2)(3,X,2,2),t.j41(4,"span"),t.EFF(5),t.k0s(),t.j41(6,"span"),t.EFF(7),t.k0s(),t.DNE(8,z,2,1,"span"),t.k0s(),t.DNE(9,L,9,12,"div",8),t.k0s()),2&o){const e=c.$implicit,n=t.XpG(),i=t.XpG(2);t.Y8G("size","small"),t.R7$(),t.AVh("update",i.rowsToUpdate[e.name])("add",i.rowsToAdd[e.name])("disabled",i.rowsToSkip[e.name]),t.R7$(),t.vxM(n[e.uuid]||n[e.name]?2:3),t.R7$(3),t.JRh(e.name),t.R7$(2),t.Lme("",e.amount,"gr for ",e.price,""),t.R7$(),t.vxM(e.source?8:-1),t.R7$(),t.vxM(n[e.uuid]||n[e.name]?9:-1)}}function V(o,c){if(1&o&&(t.j41(0,"lg-gap-column",6),t.Z7z(1,Y,10,13,"lg-gap-column",6,U),t.k0s()),2&o){const e=t.XpG();t.Y8G("size","medium"),t.R7$(),t.Dyx(e)}}function B(o,c){if(1&o&&(t.DNE(0,V,3,1,"lg-gap-column",6),t.nI1(1,"async")),2&o){let e;const n=t.XpG();t.vxM((e=t.bMT(1,1,n.analize$))?0:-1,e)}}let Q=(()=>{class o{_csvReaderService;_indexDbService;constructor(e,n){this._csvReaderService=e,this._indexDbService=n}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=(0,t.CGW)();storeName=(0,t.hFB)(null);schema=(0,t.hFB)();skipAllDuplicates=(0,t.geq)(!1);replaceAll=(0,t.geq)(!1);analizeSubject=new w.B;dataSubject=new w.B;data$=this.dataSubject.asObservable().pipe((0,R.Z)([]),(0,S.S)((e,n)=>null==n?[]:[...e,n]));analize$=this.analizeSubject.asObservable().pipe((0,R.Z)([]),(0,S.S)((e,n)=>null==n?[]:n.uuid&&n.name?{...e,[n.uuid]:n,[n.name]:n}:e));dialog;upload=(0,t.ebz)(_);parsedData=[];onConfirm(){var e=this;return(0,m.A)(function*(){for(const n of e.parsedData)e.rowsToAdd[n.name]?(yield e._indexDbService.addData(e.storeName(),n),console.log("add",n)):e.rowsToUpdate[n.name]&&!e.skipAllDuplicates()&&(yield e._indexDbService.replaceData(e.storeName(),n.uuid,n),console.log("replace",n));e.clear(),e.onDone.emit(),e.dialog.close()})()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(e=>{this.rowsToAdd[e.name]||(this.rowsToUpdate[e.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(e=>{this.rowsToAdd[e.name]||(this.rowsToSkip[e.name]=!0,this.rowsToUpdate[e.name]&&(this.rowsToUpdate[e.name]=!1))}):this.rowsToSkip={}}onFileSelected(e){var n=this;this.dialog.open(),this._csvReaderService.readFromFile(e[0]).then(function(){var i=(0,m.A)(function*(a){for(const l of a){const r=n.schema()?.safeParse(l);if(!r?.success)return void console.log("error",r?.error);if(!n.storeName())return void console.log("storeName is not set");n.dataSubject.next(l),n.parsedData.push(r.data),yield n._analyzeDuplicates(r.data).then(u=>{u.duplicate?n.analizeSubject.next(u.data[0]):n.rowsToAdd[l.name]=!0})}});return function(a){return i.apply(this,arguments)}}())}_analyzeDuplicates(e){return new Promise((n,i)=>{this._indexDbService.search(this.storeName(),"name",e.name).then(a=>{n(a.length?{data:a,duplicate:!0}:{data:null,duplicate:!1})})})}static \u0275fac=function(n){return new(n||o)(t.rXU(f),t.rXU(b.j))};static \u0275cmp=t.VBU({type:o,selectors:[["lg-import"]],viewQuery:function(n,i){if(1&n&&(t.wEZ(i.upload,_,5),t.GBs(j,5)),2&n){let a;t.NyB(),t.mGM(a=t.lsd())&&(i.dialog=a.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(n,i){if(1&n&&(t.j41(0,"lg-upload",0),t.bIt("filesSelected",function(l){return i.onFileSelected(l)}),t.j41(1,"lg-button",1),t.EFF(2," Import "),t.k0s()(),t.j41(3,"lg-dialog")(4,"lg-gap-column"),t.DNE(5,B,2,3),t.nI1(6,"async"),t.j41(7,"lg-gap-row",2)(8,"input",3),t.bIt("change",function(){return i.onSkipAllDuplicates()}),t.mxI("ngModelChange",function(l){return t.DH7(i.skipAllDuplicates,l)||(i.skipAllDuplicates=l),l}),t.k0s(),t.j41(9,"label"),t.EFF(10,"Skip all duplicates"),t.k0s()(),t.j41(11,"lg-gap-row",2)(12,"input",3),t.bIt("change",function(){return i.onReplaceAll()}),t.mxI("ngModelChange",function(l){return t.DH7(i.replaceAll,l)||(i.replaceAll=l),l}),t.k0s(),t.j41(13,"label"),t.EFF(14,"Replace all with new"),t.k0s()(),t.j41(15,"lg-gap-row",4)(16,"lg-button",5),t.bIt("click",function(){return i.onConfirm()}),t.EFF(17," Confirm "),t.k0s()()()()),2&n){let a;t.R7$(),t.Aen("warning"),t.Y8G("flat",!0)("size","small"),t.R7$(4),t.vxM((a=t.bMT(6,17,i.data$))?5:-1,a),t.R7$(2),t.Y8G("center",!0)("hidden",i.replaceAll())("size","small"),t.R7$(),t.R50("ngModel",i.skipAllDuplicates),t.R7$(3),t.Y8G("center",!0)("hidden",i.skipAllDuplicates())("size","small"),t.R7$(),t.R50("ngModel",i.replaceAll),t.R7$(3),t.Y8G("center",!0),t.R7$(),t.Aen("success"),t.Y8G("size","small")}},dependencies:[_,C.Q,j,p.Jj,h.I,M.K,d.YN,d.Zm,d.BC,d.vS,p.YU],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})}return o})();var H=s(4726),Z=s(7201);let J=(()=>{class o{_indexDbService;_csvReaderService;constructor(e,n){this._indexDbService=e,this._csvReaderService=n}exportTable(e){return this._indexDbService.getAll(e).then(n=>{this._csvReaderService.saveToFile(n,`${e}_export_${(new Date).toISOString()}.csv`)})}makeCsv(e){return this._csvReaderService.makeCsv(e)}static \u0275fac=function(n){return new(n||o)(t.KVO(b.j),t.KVO(f))};static \u0275prov=t.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();function W(o,c){1&o&&t.EFF(0," per gram ")}function K(o,c){if(1&o&&t.EFF(0),2&o){const e=t.XpG(2).$implicit;t.SpI(" per ",e.unit," ")}}function q(o,c){if(1&o){const e=t.RV6();t.j41(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6),t.EFF(4),t.k0s(),t.j41(5,"div",7),t.EFF(6),t.k0s(),t.j41(7,"div",8),t.EFF(8),t.nI1(9,"number"),t.DNE(10,W,1,0)(11,K,1,1),t.k0s()()(),t.j41(12,"lg-button",9),t.EFF(13," Edit "),t.k0s(),t.j41(14,"lg-button",10),t.bIt("click",function(){t.eBV(e);const i=t.XpG().$implicit,a=t.XpG();return t.Njj(a.deleteProduct(i))}),t.nrm(15,"mat-icon",11),t.k0s()()}if(2&o){let e;const n=t.XpG().$implicit,i=t.XpG();t.Y8G("center",!0),t.R7$(2),t.Y8G("center",!0),t.R7$(2),t.JRh(n.name),t.R7$(2),t.SpI(" ",null!==(e=n.source)&&void 0!==e?e:"",""),t.R7$(2),t.SpI(" ",t.i5U(9,15,i.getPricePerGram(n),"1.2-5")," "),t.R7$(2),t.vxM(n.unit&&"gram"!==n.unit?11:10),t.R7$(2),t.Aen("primary"),t.Y8G("size","small")("link","/edit-product/"+n.uuid)("flat",!0),t.R7$(2),t.Aen("danger"),t.Y8G("size","small")("icon",!0)}}function tt(o,c){1&o&&t.DNE(0,q,16,18,"ng-template",4)}let et=(()=>{class o{_productsRepository;_csvReaderService;_transferDataService;constructor(e,n,i){this._productsRepository=e,this._csvReaderService=n,this._transferDataService=i}products=(0,t.vPA)([]);ProductDbInputScheme=H.j;Stores=T.F;getPricePerGram(e){return((0,v.N)(e.price)||1)/((0,v.N)(e.amount)||1)}exportProducts(){this._transferDataService.exportTable(T.F.PRODUCTS)}deleteProduct(e){e.uuid&&this._productsRepository.deleteProduct(e.uuid).then(()=>{this.loadProducts()})}ngOnInit(){var e=this;return(0,m.A)(function*(){yield e.loadProducts()})()}loadProducts(){this._productsRepository.getProducts().then(e=>{const n=e.toSorted((i,a)=>i.name.localeCompare(a.name));this.products.set(n)})}static \u0275fac=function(n){return new(n||o)(t.rXU(Z.d),t.rXU(f),t.rXU(J))};static \u0275cmp=t.VBU({type:o,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[2,"flex","10%"],[2,"flex","70%"],[3,"size","link","flat"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(n,i){1&n&&(t.j41(0,"lg-container")(1,"lg-title"),t.EFF(2," Products "),t.k0s(),t.j41(3,"lg-gap-row",0)(4,"lg-button",1),t.EFF(5," Add "),t.k0s(),t.j41(6,"lg-button",2),t.bIt("click",function(){return i.exportProducts()}),t.EFF(7," Export "),t.k0s(),t.j41(8,"lg-import",3),t.bIt("onDone",function(){return i.loadProducts()}),t.k0s()(),t.j41(9,"lg-card-list"),t.Z7z(10,tt,1,0,null,4,t.Vm6),t.k0s()()),2&n&&(t.R7$(3),t.Y8G("center",!0),t.R7$(),t.Aen("primary"),t.Y8G("flat",!0)("link","/add-product")("size","small"),t.R7$(2),t.Aen("info"),t.Y8G("flat",!0)("size","small"),t.R7$(2),t.Y8G("schema",i.ProductDbInputScheme)("storeName",i.Stores.PRODUCTS),t.R7$(2),t.Dyx(i.products()))},dependencies:[h.I,C.Q,x.d,y.H,D.W,p.QX,I,F,Q],styles:["[_nghost-%COMP%]{display:block}"]})}return o})()}}]);