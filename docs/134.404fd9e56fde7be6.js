"use strict";(self.webpackChunklasagna=self.webpackChunklasagna||[]).push([[134],{3134:(nt,C,l)=>{l.r(C),l.d(C,{ProductListComponent:()=>et});var p=l(467),t=l(1007),v=l(7512),k=l(1119),D=l(1072),A=l(5642),G=l(1086),u=l(177),T=l(4625),F=l(553);let w=(()=>{class i{template;constructor(e){this.template=e}static \u0275fac=function(n){return new(n||i)(t.rXU(t.C4Q))};static \u0275dir=t.FsC({type:i,selectors:[["","lgCardListItem",""]]})}return i})();function I(i,c){if(1&i&&(t.j41(0,"div",2),t.eu8(1,4),t.k0s()),2&i){const e=c.$implicit;t.R7$(),t.Y8G("ngTemplateOutlet",e.template)}}function P(i,c){1&i&&(t.j41(0,"div",3),t.EFF(1,"No items found"),t.k0s())}let M=(()=>{class i{constructor(){}items;static \u0275fac=function(n){return new(n||i)};static \u0275cmp=t.VBU({type:i,selectors:[["lg-card-list"]],contentQueries:function(n,o,a){if(1&n&&t.wni(a,w,4),2&n){let r;t.mGM(r=t.lsd())&&(o.items=r)}},decls:5,vars:2,consts:[[3,"flat"],[1,"lg-card-list"],[1,"lg-card-list__item"],[2,"padding","0 24px"],[3,"ngTemplateOutlet"]],template:function(n,o){1&n&&(t.j41(0,"lg-card",0)(1,"section",1),t.Z7z(2,I,2,1,"div",2,t.Vm6,!1,P,2,0,"div",3),t.k0s()()),2&n&&(t.Y8G("flat",!0),t.R7$(2),t.Dyx(o.items))},dependencies:[F.i,u.T3],styles:[":host{display:flex;width:100%}.lg-card-list{display:flex;flex-direction:column;width:100%;gap:32px;padding:24px 0}.lg-card-list__item{padding:0 24px}\n"],encapsulation:2})}return i})();var b=l(4374);const $=["input"],E=["*"];let _=(()=>{class i{filesSelected=(0,t.CGW)();accept=(0,t.hFB)(".csv");input=(0,t.ebz)("input");onFileChange(e){const o=e.target.files?.[0];o&&this.filesSelected.emit([o])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=t.VBU({type:i,selectors:[["lg-upload"]],viewQuery:function(n,o){1&n&&t.wEZ(o.input,$,5),2&n&&t.NyB()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:E,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(n,o){if(1&n){const a=t.RV6();t.NAR(),t.j41(0,"div",1),t.bIt("click",function(){t.eBV(a);const s=t.sdS(2);return t.Njj(s.click())}),t.j41(1,"input",2,0),t.bIt("change",function(s){return t.eBV(a),t.Njj(o.onFileChange(s))}),t.k0s(),t.j41(3,"div",3),t.SdG(4),t.k0s()()}2&n&&(t.R7$(),t.Y8G("accept",o.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})}return i})();var y=l(1413),R=l(9172),j=l(2816);const U=["*"];let S=(()=>{class i{constructor(){}displayed=(0,t.vPA)(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=t.VBU({type:i,selectors:[["lg-dialog"]],ngContentSelectors:U,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(n,o){1&n&&(t.NAR(),t.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),t.SdG(5),t.k0s()()()()()),2&n&&t.xc7("display",o.displayed()?"flex":"none")},dependencies:[F.i],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})}return i})();var z=l(7782),m=l(9417);let f=(()=>{class i{constructor(){}readFromFile(e){return new Promise((n,o)=>{const a=new FileReader;a.onload=()=>{const s=this.parseData(a.result),[d,...g]=s,h=this.arrayToObjects(g,d);n(h)},a.onerror=()=>{o(a.error)},a.readAsText(e)})}parseData(e){return e.split("\r\n").map(n=>n.split(",")).filter(n=>n.length>1&&n.some(o=>o.length>0))}arrayToObjects(e,n){return e.map(o=>{const a={};return n.forEach((r,s)=>{a[r]=o[s]}),a})}makeCsv(e){const n=Object.keys(e[0]),o=e.map(r=>n.map(s=>r[s]));return[n,...o].map(r=>r.join(",")).join("\r\n")}saveToFile(e,n){const o=this.makeCsv(e),a=new Blob([o],{type:"text/csv"}),r=URL.createObjectURL(a),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",n),s.click(),URL.revokeObjectURL(r)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=t.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var x=l(5559);const N=(i,c)=>c.name+c.uuid;function X(i,c){if(1&i){const e=t.RV6();t.j41(0,"input",9),t.mxI("ngModelChange",function(o){t.eBV(e);const a=t.XpG().$implicit,r=t.XpG(3);return t.DH7(r.rowsToUpdate[a.name],o)||(r.rowsToUpdate[a.name]=o),t.Njj(o)}),t.k0s(),t.EFF(1," Update ")}if(2&i){const e=t.XpG().$implicit,n=t.XpG(3);t.R50("ngModel",n.rowsToUpdate[e.name]),t.Y8G("disabled",n.rowsToSkip[e.name])}}function O(i,c){if(1&i){const e=t.RV6();t.j41(0,"input",10),t.mxI("ngModelChange",function(o){t.eBV(e);const a=t.XpG().$implicit,r=t.XpG(3);return t.DH7(r.rowsToAdd[a.name],o)||(r.rowsToAdd[a.name]=o),t.Njj(o)}),t.k0s(),t.EFF(1," Add ")}if(2&i){const e=t.XpG().$implicit,n=t.XpG(3);t.R50("ngModel",n.rowsToAdd[e.name]),t.Y8G("disabled",n.rowsToSkip[e.name])}}function Y(i,c){if(1&i&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.SpI("from ",e.source,"")}}function V(i,c){if(1&i&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&i){const e=t.XpG(2).$implicit,n=t.XpG();t.R7$(),t.SpI("from ",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).source,"")}}function L(i,c){if(1&i){const e=t.RV6();t.j41(0,"div",11)(1,"input",9),t.mxI("ngModelChange",function(o){t.eBV(e);const a=t.XpG().$implicit,r=t.XpG(3);return t.DH7(r.rowsToSkip[a.name],o)||(r.rowsToSkip[a.name]=o),t.Njj(o)}),t.k0s(),t.j41(2,"span"),t.EFF(3),t.k0s(),t.j41(4,"span"),t.EFF(5),t.k0s(),t.j41(6,"span"),t.EFF(7),t.k0s(),t.DNE(8,V,2,1,"span"),t.k0s()}if(2&i){const e=t.XpG().$implicit,n=t.XpG(),o=t.XpG(2);t.AVh("disabled",o.rowsToUpdate[e.name])("skip",o.rowsToUpdate[e.name]),t.Y8G("ngClass",o.rowsToSkip[e.name]?"skip":"duplicated"),t.R7$(),t.R50("ngModel",o.rowsToSkip[e.name]),t.Y8G("disabled",o.rowsToAdd[e.name]||o.rowsToUpdate[e.name]),t.R7$(2),t.JRh(o.rowsToSkip[e.name]?"Skip":"Duplicates"),t.R7$(2),t.JRh(null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).name),t.R7$(2),t.Lme("",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).amount," gr for ",null==(n[e.uuid]||n[e.name])?null:(n[e.uuid]||n[e.name]).price,""),t.R7$(),t.vxM(null!=(n[e.uuid]||n[e.name])&&(n[e.uuid]||n[e.name]).source?8:-1)}}function B(i,c){if(1&i&&(t.j41(0,"lg-gap-column",6)(1,"div",7),t.DNE(2,X,2,2)(3,O,2,2),t.j41(4,"span"),t.EFF(5),t.k0s(),t.j41(6,"span"),t.EFF(7),t.k0s(),t.DNE(8,Y,2,1,"span"),t.k0s(),t.DNE(9,L,9,12,"div",8),t.k0s()),2&i){const e=c.$implicit,n=t.XpG(),o=t.XpG(2);t.Y8G("size","small"),t.R7$(),t.AVh("update",o.rowsToUpdate[e.name])("add",o.rowsToAdd[e.name])("disabled",o.rowsToSkip[e.name]),t.R7$(),t.vxM(n[e.uuid]||n[e.name]?2:3),t.R7$(3),t.JRh(e.name),t.R7$(2),t.Lme("",e.amount,"gr for ",e.price,""),t.R7$(),t.vxM(e.source?8:-1),t.R7$(),t.vxM(n[e.uuid]||n[e.name]?9:-1)}}function Q(i,c){if(1&i&&(t.j41(0,"lg-gap-column",6),t.Z7z(1,B,10,13,"lg-gap-column",6,N),t.k0s()),2&i){const e=t.XpG();t.Y8G("size","medium"),t.R7$(),t.Dyx(e)}}function H(i,c){if(1&i&&(t.DNE(0,Q,3,1,"lg-gap-column",6),t.nI1(1,"async")),2&i){let e;const n=t.XpG();t.vxM((e=t.bMT(1,1,n.analize$))?0:-1,e)}}let Z=(()=>{class i{_csvReaderService;_indexDbService;constructor(e,n){this._csvReaderService=e,this._indexDbService=n}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=(0,t.CGW)();storeName=(0,t.hFB)(null);schema=(0,t.hFB)();skipAllDuplicates=(0,t.geq)(!1);replaceAll=(0,t.geq)(!1);analizeSubject=new y.B;dataSubject=new y.B;data$=this.dataSubject.asObservable().pipe((0,R.Z)([]),(0,j.S)((e,n)=>null==n?[]:[...e,n]));analize$=this.analizeSubject.asObservable().pipe((0,R.Z)([]),(0,j.S)((e,n)=>null==n?[]:n.uuid&&n.name?{...e,[n.uuid]:n,[n.name]:n}:e));dialog;upload=(0,t.ebz)(_);parsedData=[];onConfirm(){var e=this;return(0,p.A)(function*(){for(const n of e.parsedData)e.rowsToAdd[n.name]?(yield e._addData(n,e.storeName()),console.log("add",n)):e.rowsToUpdate[n.name]&&!e.skipAllDuplicates()&&(yield e._indexDbService.replaceData(e.storeName(),n.uuid,n),console.log("replace",n));e.clear(),e.onDone.emit(),e.dialog.close()})()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(e=>{this.rowsToAdd[e.name]||(this.rowsToUpdate[e.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(e=>{this.rowsToAdd[e.name]||(this.rowsToSkip[e.name]=!0,this.rowsToUpdate[e.name]&&(this.rowsToUpdate[e.name]=!1))}):this.rowsToSkip={}}onFileSelected(e){var n=this;this.dialog.open(),this._csvReaderService.readFromFile(e[0]).then(function(){var o=(0,p.A)(function*(a){for(const r of a){const s=n.schema()?.safeParse(r);if(!s?.success)return void console.log("error",s?.error);if(!n.storeName())return void console.log("storeName is not set");n.dataSubject.next(r),n.parsedData.push(s.data),yield n._analyzeDuplicates(s.data).then(d=>{d.duplicate?n.analizeSubject.next(d.data[0]):n.rowsToAdd[r.name]=!0})}});return function(a){return o.apply(this,arguments)}}())}_addData(e,n){var o=this;return new Promise(function(){var a=(0,p.A)(function*(r,s){yield o._indexDbService.addData(n,e),r()});return function(r,s){return a.apply(this,arguments)}}())}_analyzeDuplicates(e){return new Promise((n,o)=>{this._indexDbService.search(this.storeName(),"name",e.name,a=>{n(a.length?{data:a,duplicate:!0}:{data:null,duplicate:!1})})})}static \u0275fac=function(n){return new(n||i)(t.rXU(f),t.rXU(x.Q))};static \u0275cmp=t.VBU({type:i,selectors:[["lg-import"]],viewQuery:function(n,o){if(1&n&&(t.wEZ(o.upload,_,5),t.GBs(S,5)),2&n){let a;t.NyB(),t.mGM(a=t.lsd())&&(o.dialog=a.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(n,o){if(1&n&&(t.j41(0,"lg-upload",0),t.bIt("filesSelected",function(r){return o.onFileSelected(r)}),t.j41(1,"lg-button",1),t.EFF(2," Import "),t.k0s()(),t.j41(3,"lg-dialog")(4,"lg-gap-column"),t.DNE(5,H,2,3),t.nI1(6,"async"),t.j41(7,"lg-gap-row",2)(8,"input",3),t.bIt("change",function(){return o.onSkipAllDuplicates()}),t.mxI("ngModelChange",function(r){return t.DH7(o.skipAllDuplicates,r)||(o.skipAllDuplicates=r),r}),t.k0s(),t.j41(9,"label"),t.EFF(10,"Skip all duplicates"),t.k0s()(),t.j41(11,"lg-gap-row",2)(12,"input",3),t.bIt("change",function(){return o.onReplaceAll()}),t.mxI("ngModelChange",function(r){return t.DH7(o.replaceAll,r)||(o.replaceAll=r),r}),t.k0s(),t.j41(13,"label"),t.EFF(14,"Replace all with new"),t.k0s()(),t.j41(15,"lg-gap-row",4)(16,"lg-button",5),t.bIt("click",function(){return o.onConfirm()}),t.EFF(17," Confirm "),t.k0s()()()()),2&n){let a;t.R7$(),t.Aen("warning"),t.Y8G("flat",!0)("size","small"),t.R7$(4),t.vxM((a=t.bMT(6,17,o.data$))?5:-1,a),t.R7$(2),t.Y8G("center",!0)("hidden",o.replaceAll())("size","small"),t.R7$(),t.R50("ngModel",o.skipAllDuplicates),t.R7$(3),t.Y8G("center",!0)("hidden",o.skipAllDuplicates())("size","small"),t.R7$(),t.R50("ngModel",o.replaceAll),t.R7$(3),t.Y8G("center",!0),t.R7$(),t.Aen("success"),t.Y8G("size","small")}},dependencies:[_,k.Q,S,u.Jj,v.I,z.K,m.YN,m.Zm,m.BC,m.vS,u.YU],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})}return i})();var J=l(4726),W=l(7201);let K=(()=>{class i{_indexDbService;_csvReaderService;constructor(e,n){this._indexDbService=e,this._csvReaderService=n}exportTable(e){var n=this;this._indexDbService.openDb(function(){var o=(0,p.A)(function*(a){a.transaction(e,"readonly").objectStore(e).getAll().onsuccess=g=>{n._csvReaderService.saveToFile(g.target.result,"export.csv")}});return function(a){return o.apply(this,arguments)}}())}importTable(e,n,o){return this._csvReaderService.readFromFile(n).then(function(){var a=(0,p.A)(function*(r){for(const s of r);});return function(r){return a.apply(this,arguments)}}())}makeCsv(e){return this._csvReaderService.makeCsv(e)}static \u0275fac=function(n){return new(n||i)(t.KVO(x.Q),t.KVO(f))};static \u0275prov=t.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function q(i,c){if(1&i){const e=t.RV6();t.j41(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6),t.EFF(4),t.k0s(),t.j41(5,"div",7),t.EFF(6),t.k0s(),t.j41(7,"div",8),t.EFF(8),t.nI1(9,"number"),t.k0s()()(),t.j41(10,"lg-button",9),t.EFF(11," Edit "),t.k0s(),t.j41(12,"lg-button",10),t.bIt("click",function(){t.eBV(e);const o=t.XpG().$implicit,a=t.XpG();return t.Njj(a.deleteProduct(o))}),t.nrm(13,"mat-icon",11),t.k0s()()}if(2&i){let e;const n=t.XpG().$implicit,o=t.XpG();t.Y8G("center",!0),t.R7$(2),t.Y8G("center",!0),t.R7$(2),t.JRh(n.name),t.R7$(2),t.SpI(" ",null!==(e=n.source)&&void 0!==e?e:"",""),t.R7$(2),t.SpI("",t.i5U(9,14,o.getPricePerGram(n),"1.2-5")," per gram "),t.R7$(2),t.Aen("primary"),t.Y8G("size","small")("link","/edit-product/"+n.uuid)("flat",!0),t.R7$(2),t.Aen("danger"),t.Y8G("size","small")("icon",!0)}}function tt(i,c){1&i&&t.DNE(0,q,14,17,"ng-template",4)}let et=(()=>{class i{_productsRepository;_csvReaderService;_transferDataService;constructor(e,n,o){this._productsRepository=e,this._csvReaderService=n,this._transferDataService=o}products=(0,t.vPA)([]);getPricePerGram(e){return((0,T.N)(e.price)||1)/((0,T.N)(e.amount)||1)}exportProducts(){this._transferDataService.exportTable(b.F.PRODUCTS)}deleteProduct(e){e.uuid&&this._productsRepository.deleteProduct(e.uuid,()=>{this.loadProducts()})}ngOnInit(){var e=this;return(0,p.A)(function*(){yield e.loadProducts()})()}loadProducts(){this._productsRepository.getProducts(e=>{const n=e.toSorted((o,a)=>o.name.localeCompare(a.name));this.products.set(n)})}ProductDbInputScheme=J.j;Stores=b.F;static \u0275fac=function(n){return new(n||i)(t.rXU(W.d),t.rXU(f),t.rXU(K))};static \u0275cmp=t.VBU({type:i,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[2,"flex","10%"],[2,"flex","70%"],[3,"size","link","flat"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(n,o){1&n&&(t.j41(0,"lg-container")(1,"lg-title"),t.EFF(2," Products "),t.k0s(),t.j41(3,"lg-gap-row",0)(4,"lg-button",1),t.EFF(5," Add "),t.k0s(),t.j41(6,"lg-button",2),t.bIt("click",function(){return o.exportProducts()}),t.EFF(7," Export "),t.k0s(),t.j41(8,"lg-import",3),t.bIt("onDone",function(){return o.loadProducts()}),t.k0s()(),t.j41(9,"lg-card-list"),t.Z7z(10,tt,1,0,null,4,t.Vm6),t.k0s()()),2&n&&(t.R7$(3),t.Y8G("center",!0),t.R7$(),t.Aen("primary"),t.Y8G("flat",!0)("link","/add-product")("size","small"),t.R7$(2),t.Aen("info"),t.Y8G("flat",!0)("size","small"),t.R7$(2),t.Y8G("schema",o.ProductDbInputScheme)("storeName",o.Stores.PRODUCTS),t.R7$(2),t.Dyx(o.products()))},dependencies:[v.I,k.Q,D.d,A.H,G.W,u.QX,M,w,Z],styles:["[_nghost-%COMP%]{display:block}"]})}return i})()}}]);