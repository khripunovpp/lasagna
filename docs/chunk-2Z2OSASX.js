import{a as Ee,b as Re,c as je}from"./chunk-2PNTZ6X2.js";import{a as ne,b as ye,c as Se}from"./chunk-SAILQXXD.js";import"./chunk-2CXQCMUY.js";import{b as ke,e as Pe,i as Ie,p as Ae}from"./chunk-AJ3UBX7E.js";import{a as Me}from"./chunk-MCS5HOGQ.js";import{a as we,b as Q,c as $}from"./chunk-234JSS2H.js";import{a as G}from"./chunk-3AY3FMR5.js";import{a as Te,b as De}from"./chunk-VLWAUHYT.js";import{$a as m,$b as be,Ab as ie,Ca as C,Da as g,E as J,Ea as ce,G as K,Ga as O,Ha as U,Ia as a,Ib as ge,Ja as s,Ka as de,Lb as xe,M as j,Mb as ve,Oa as v,P as X,Pa as u,Qa as p,Ra as L,Sa as z,U as _,V as f,Va as me,Wa as ue,Xa as _e,Ya as N,Yb as he,Z as F,Za as V,_a as fe,a as ae,ab as b,b as le,bb as S,cb as ee,db as T,eb as D,f as I,fb as k,ia as r,j as H,la as w,lb as A,mb as te,na as x,nb as Ce,ra as se,wa as d,wb as W,xa as pe,xb as M,ya as Y,yb as B,za as y}from"./chunk-7BPNVVWP.js";var ze=["input"],Ne=["*"],P=class o{filesSelected=W();accept=M(".csv");input=B("input");onFileChange(i){let t=i.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&N(t.input,ze,5),e&2&&V()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Ne,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let n=v();L(),a(0,"div",1),u("click",function(){_(n);let c=fe(2);return f(c.click())}),a(1,"input",2,0),u("change",function(c){return _(n),f(t.onFileChange(c))}),s(),a(3,"div",3),z(4),s()()}e&2&&(r(),d("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Ve=["*"],R=class o{constructor(){}displayed=F(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Ve,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(L(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),z(5),s()()()()()),e&2&&pe("display",t.displayed()?"flex":"none")},dependencies:[Te],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var h=class o{constructor(){}readFromFile(i){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{let l=n.result,c=this.parseData(l),[Oe,...Ue]=c,Le=this.arrayToObjects(Ue,Oe);e(Le)},n.onerror=()=>{t(n.error)},n.readAsText(i)})}parseData(i){return i.split(`\r
`).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(i,e){return i.map(t=>{let n={};return e.forEach((l,c)=>{n[l]=t[c]}),n})}makeCsv(i){let e=Object.keys(i[0]),t=i.map(l=>e.map(c=>l[c]));return[e,...t].map(l=>l.join(",")).join(`\r
`)}saveToFile(i,e){let t=this.makeCsv(i),n=new Blob([t],{type:"text/csv"}),l=URL.createObjectURL(n),c=document.createElement("a");document.body.appendChild(c),c.setAttribute("href",l),c.setAttribute("download",e),c.click(),URL.revokeObjectURL(l)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})};var Be=(o,i)=>i.name+i.uuid;function Qe(o,i){if(o&1){let e=v();a(0,"input",9),k("ngModelChange",function(n){_(e);let l=p().$implicit,c=p(3);return D(c.rowsToUpdate[l.name],n)||(c.rowsToUpdate[l.name]=n),f(n)}),s(),m(1," Update ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToUpdate[e.name]),d("disabled",t.rowsToSkip[e.name])}}function $e(o,i){if(o&1){let e=v();a(0,"input",10),k("ngModelChange",function(n){_(e);let l=p().$implicit,c=p(3);return D(c.rowsToAdd[l.name],n)||(c.rowsToAdd[l.name]=n),f(n)}),s(),m(1," Add ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToAdd[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Ge(o,i){if(o&1&&(a(0,"span"),m(1),s()),o&2){let e=p().$implicit;r(),S("from ",e.source)}}function qe(o,i){if(o&1&&(a(0,"span"),m(1),s()),o&2){let e=p(2).$implicit,t=p();r(),S("from ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).source)}}function Ze(o,i){if(o&1){let e=v();a(0,"div",11)(1,"input",9),k("ngModelChange",function(n){_(e);let l=p().$implicit,c=p(3);return D(c.rowsToSkip[l.name],n)||(c.rowsToSkip[l.name]=n),f(n)}),s(),a(2,"span"),m(3),s(),a(4,"span"),m(5),s(),a(6,"span"),m(7),s(),C(8,qe,2,1,"span"),s()}if(o&2){let e=p().$implicit,t=p(),n=p(2);Y("disabled",n.rowsToUpdate[e.name])("skip",n.rowsToUpdate[e.name]),d("ngClass",n.rowsToSkip[e.name]?"skip":"duplicated"),r(),T("ngModel",n.rowsToSkip[e.name]),d("disabled",n.rowsToAdd[e.name]||n.rowsToUpdate[e.name]),r(2),b(n.rowsToSkip[e.name]?"Skip":"Duplicates"),r(2),b((t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).name),r(2),ee("",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).amount," gr for ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).price),r(),g((t[e.uuid]||t[e.name])!=null&&(t[e.uuid]||t[e.name]).source?8:-1)}}function He(o,i){if(o&1&&(a(0,"lg-gap-column",6)(1,"div",7),C(2,Qe,2,2)(3,$e,2,2),a(4,"span"),m(5),s(),a(6,"span"),m(7),s(),C(8,Ge,2,1,"span"),s(),C(9,Ze,9,12,"div",8),s()),o&2){let e=i.$implicit,t=p(),n=p(2);d("size","small"),r(),Y("update",n.rowsToUpdate[e.name])("add",n.rowsToAdd[e.name])("disabled",n.rowsToSkip[e.name]),r(),g(t[e.uuid]||t[e.name]?2:3),r(3),b(e.name),r(2),ee("",e.amount,"gr for ",e.price),r(),g(e.source?8:-1),r(),g(t[e.uuid]||t[e.name]?9:-1)}}function Je(o,i){if(o&1&&(a(0,"lg-gap-column",6),O(1,He,10,13,"lg-gap-column",6,Be),s()),o&2){let e=p();d("size","medium"),r(),U(e)}}function Ke(o,i){if(o&1&&(C(0,Je,3,1,"lg-gap-column",6),A(1,"async")),o&2){let e,t=p();g((e=te(1,1,t.analize$))?0:-1,e)}}var q=class o{constructor(i,e){this._csvReaderService=i;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=W();storeName=M(null);schema=M();skipAllDuplicates=ie(!1);replaceAll=ie(!1);analizeSubject=new H;dataSubject=new H;data$=this.dataSubject.asObservable().pipe(K([]),J((i,e)=>e==null?[]:[...i,e]));analize$=this.analizeSubject.asObservable().pipe(K([]),J((i,e)=>e==null?[]:!e.uuid||!e.name?i:le(ae({},i),{[e.uuid]:e,[e.name]:e})));dialog;upload=B(P);parsedData=[];onConfirm(){return I(this,null,function*(){for(let i of this.parsedData)this.rowsToAdd[i.name]?(yield this._indexDbService.addData(this.storeName(),i),console.log("add",i)):this.rowsToUpdate[i.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),i.uuid,i),console.log("replace",i));this.clear(),this.onDone.emit(),this.dialog.close()})}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToUpdate[i.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToSkip[i.name]=!0,this.rowsToUpdate[i.name]&&(this.rowsToUpdate[i.name]=!1))}):this.rowsToSkip={}}onFileSelected(i){this.dialog.open(),this._csvReaderService.readFromFile(i[0]).then(e=>I(this,null,function*(){for(let t of e){let n=this.schema()?.safeParse(t);if(!n?.success){console.log("error",n?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(n.data),yield this._analyzeDuplicates(n.data).then(l=>{l.duplicate?this.analizeSubject.next(l.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(i){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",i.name).then(n=>{n.length?e({data:n,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(w(h),w(Q))};static \u0275cmp=x({type:o,selectors:[["lg-import"]],viewQuery:function(e,t){if(e&1&&(N(t.upload,P,5),me(R,5)),e&2){V();let n;ue(n=_e())&&(t.dialog=n.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(a(0,"lg-upload",0),u("filesSelected",function(l){return t.onFileSelected(l)}),a(1,"lg-button",1),m(2," Import "),s()(),a(3,"lg-dialog")(4,"lg-gap-column"),C(5,Ke,2,3),A(6,"async"),a(7,"lg-gap-row",2)(8,"input",3),u("change",function(){return t.onSkipAllDuplicates()}),k("ngModelChange",function(l){return D(t.skipAllDuplicates,l)||(t.skipAllDuplicates=l),l}),s(),a(9,"label"),m(10,"Skip all duplicates"),s()(),a(11,"lg-gap-row",2)(12,"input",3),u("change",function(){return t.onReplaceAll()}),k("ngModelChange",function(l){return D(t.replaceAll,l)||(t.replaceAll=l),l}),s(),a(13,"label"),m(14,"Replace all with new"),s()(),a(15,"lg-gap-row",4)(16,"lg-button",5),u("click",function(){return t.onConfirm()}),m(17," Confirm "),s()()()()),e&2){let n;r(),y("warning"),d("flat",!0)("size","small"),r(4),g((n=te(6,17,t.data$))?5:-1,n),r(2),d("center",!0)("hidden",t.replaceAll())("size","small"),r(),T("ngModel",t.skipAllDuplicates),r(3),d("center",!0)("hidden",t.skipAllDuplicates())("size","small"),r(),T("ngModel",t.replaceAll),r(3),d("center",!0),r(),y("success"),d("size","small")}},dependencies:[P,$,R,xe,G,Me,Ae,ke,Pe,Ie,ge],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var Z=class o{constructor(i,e){this._indexDbService=i;this._csvReaderService=e}exportTable(i){return this._indexDbService.getAll(i).then(e=>{this._csvReaderService.saveToFile(e,`${i}_export_${new Date().toISOString()}.csv`)})}makeCsv(i){return this._csvReaderService.makeCsv(i)}static \u0275fac=function(e){return new(e||o)(X(Q),X(h))};static \u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})};function Ye(o,i){o&1&&m(0," per gram ")}function et(o,i){if(o&1&&m(0),o&2){let e=p(2).$implicit;S(" per ",e.unit," ")}}function tt(o,i){if(o&1){let e=v();a(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6)(4,"a",7),m(5),s()(),a(6,"div",8),m(7),s(),a(8,"div",9),m(9),A(10,"number"),C(11,Ye,1,0)(12,et,1,1),s()()(),a(13,"lg-button",10),u("click",function(){_(e);let n=p().$implicit,l=p();return f(l.deleteProduct(n))}),de(14,"mat-icon",11),s()()}if(o&2){let e=p().$implicit,t=p();d("center",!0),r(2),d("center",!0),r(2),d("routerLink","/edit-product/"+e.uuid),r(),b(e.name),r(2),S(" ",e.source??""),r(2),S(" ",Ce(10,11,t.getPricePerGram(e),"1.2-5")," "),r(2),g(!e.unit||e.unit==="gram"?11:12),r(2),y("danger"),d("size","small")("icon",!0)}}function it(o,i){o&1&&se(0,tt,15,14,"ng-template",4)}var Fe=class o{constructor(i,e,t){this._productsRepository=i;this._csvReaderService=e;this._transferDataService=t}products=F([]);ProductDbInputScheme=ye;Stores=we;getPricePerGram(i){return(ne(i.price)||1)/(ne(i.amount)||1)}exportProducts(){this._transferDataService.exportTable("productsStore")}deleteProduct(i){i.uuid&&this._productsRepository.deleteProduct(i.uuid).then(()=>{this.loadProducts()})}ngOnInit(){return I(this,null,function*(){yield this.loadProducts()})}loadProducts(){this._productsRepository.getProducts().then(i=>{let e=i.toSorted((t,n)=>t.name.localeCompare(n.name));this.products.set(e)})}static \u0275fac=function(e){return new(e||o)(w(Se),w(h),w(Z))};static \u0275cmp=x({type:o,selectors:[["lg-product-list"]],decls:12,vars:12,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[3,"routerLink"],[2,"flex","10%"],[2,"flex","70%"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(e,t){e&1&&(a(0,"lg-container")(1,"lg-title"),m(2," Products "),s(),a(3,"lg-gap-row",0)(4,"lg-button",1),m(5," Add "),s(),a(6,"lg-button",2),u("click",function(){return t.exportProducts()}),m(7," Export "),s(),a(8,"lg-import",3),u("onDone",function(){return t.loadProducts()}),s()(),a(9,"lg-card-list"),O(10,it,1,0,null,4,ce),s()()),e&2&&(r(3),d("center",!0),r(),y("primary"),d("flat",!0)("link","/add-product")("size","small"),r(2),y("info"),d("flat",!0)("size","small"),r(2),d("schema",t.ProductDbInputScheme)("storeName",t.Stores.PRODUCTS),r(2),U(t.products()))},dependencies:[G,$,je,be,De,ve,Re,Ee,q,he],styles:["[_nghost-%COMP%]{display:block}"]})};export{Fe as ProductListComponent};
