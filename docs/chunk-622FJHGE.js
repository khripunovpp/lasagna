import{a as We,b as qe}from"./chunk-BKERZ4O2.js";import{a as Be}from"./chunk-7TT4R52F.js";import{a as $e}from"./chunk-B5XPTPFV.js";import{e as ze}from"./chunk-L4663ATQ.js";import{a as He}from"./chunk-ITJQZPJZ.js";import{a as Oe}from"./chunk-I4TFDDOB.js";import{a as Ke}from"./chunk-ACC6FC2Y.js";import{a as Le,c as Qe}from"./chunk-HJNGTLSS.js";import{a as Ye}from"./chunk-EQDI7HRC.js";import{a as je}from"./chunk-B4BPCK6P.js";import"./chunk-CWUUYJTE.js";import"./chunk-FK6H3RFT.js";import{a as Ge,b as Ue}from"./chunk-E6W2XPUP.js";import{a as Pe}from"./chunk-GFKJ3IXC.js";import{v as Ne}from"./chunk-LJ5EVNTD.js";import{a as Ee}from"./chunk-ZL6WWUML.js";import{a as q}from"./chunk-VQHUADFJ.js";import{a as Te}from"./chunk-IVWGGHZS.js";import{a as Me}from"./chunk-OIONDWIZ.js";import{b as ke}from"./chunk-VIPBUB74.js";import{c as W}from"./chunk-BJIJ7REJ.js";import"./chunk-4U4Z3QUR.js";import{a as Ve}from"./chunk-I27O3RKJ.js";import"./chunk-MPFUNZLY.js";import{a as De}from"./chunk-Q75E6UIP.js";import{F as Re,H as he,I as ve,J,L as x,N as xe,Q as ye,R as Se,S as be,T as Ae,U as we,V as Ie,W as Fe,Y as $,_ as N,ca as Q,da as H,e as _e,g as Y,l as ge,q as Ce,t as L}from"./chunk-N3CXADBY.js";import{m as j,p as ue,q as fe}from"./chunk-3NSY2Z6P.js";import"./chunk-CABIONZL.js";import"./chunk-EMIJRNYJ.js";import"./chunk-HDEG74LV.js";import{Bc as m,Cb as _,Cc as u,Dc as de,Eb as g,G,Hb as ee,Ib as te,Jb as a,Kb as l,Lb as p,Lc as me,Mb as v,Mc as se,Nb as k,Ob as M,Qb as S,Qc as B,Rc as O,Sc as z,Ub as h,Vb as d,Wb as ie,Xb as ne,_a as r,bc as I,cc as U,da as Z,db as y,dc as P,gc as F,ic as s,jc as oe,ka as C,kb as D,kc as f,la as R,lc as re,pb as w,s as X,tc as ae,ua as b,uc as le,vc as pe,xc as ce}from"./chunk-NHWKWTII.js";import"./chunk-2RGDSI3Q.js";import{a as T,b as E}from"./chunk-C6Q5SG76.js";var et=["*"];function tt(i,t){if(i&1&&(l(0,"p",1),s(1),p()),i&2){let e=d();r(),f(" ",e.label()," ")}}var K=class i{constructor(){}label=B("");static \u0275fac=function(e){return new(e||i)};static \u0275cmp=D({type:i,selectors:[["lg-control-group"]],inputs:{label:[1,"label"]},ngContentSelectors:et,decls:4,vars:1,consts:[[1,"control-group"],[1,"control-group__label"],[1,"control-group__content"]],template:function(e,n){e&1&&(ie(),l(0,"div",0),_(1,tt,2,1,"p",1),l(2,"div",2),ne(3),p()()),e&2&&(r(),g(n.label()?1:-1))},styles:["[_nghost-%COMP%]{display:flex;flex:1}.control-group[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:16px}.control-group__label[_ngcontent-%COMP%]{font-size:1.2rem;margin:0}.control-group__content[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:flex-end}.control-group__content[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{flex:1}"]})};var nt=["tooltipComponent"],ot=["products"],rt=["productsSelector"],at=["nameField"],lt=i=>({unit:i}),pt=(i,t)=>t.value.amount+i+1;function ct(i,t){i&1&&v(0,"lg-unit-switcher",17)}function dt(i,t){if(i&1){let e=S();l(0,"lg-multiselect",30),h("onSelected",function(){C(e);let o=d().$index,c=P(15),A=d();return R(A.onIngredientSelected(c,o,["product_id","name"]))}),p()}i&2&&a("resource","recipes")("autoLoad",!0)}function mt(i,t){if(i&1){let e=S();l(0,"lg-multiselect",31,3),h("onSelected",function(){C(e);let o=d().$index,c=P(15),A=d();return R(A.onIngredientSelected(c,o,["recipe_id","name"]))}),p()}i&2&&a("resource","products")("autoLoad",!0)}function st(i,t){i&1&&v(0,"lg-unit-switcher",32)}function ut(i,t){i&1&&v(0,"hr",29)}function ft(i,t){if(i&1){let e=S();k(0,12),l(1,"lg-controls-row",18)(2,"lg-gap-column",19)(3,"lg-control"),k(4,20),l(5,"lg-button",21),h("click",function(){let o=C(e).$index,c=d();return R(c.closeRecipeField(o))}),s(6),m(7,"translate"),p(),M(),k(8,22),l(9,"lg-button",21),h("click",function(){let o=C(e).$index,c=d();return R(c.openRecipeField(o))}),s(10),m(11,"translate"),p(),M(),_(12,dt,1,2,"lg-multiselect",23)(13,mt,2,2,"lg-multiselect",24),p()(),l(14,"lg-number-input",25,1),m(16,"translate"),h("onKeydown",function(){C(e);let o=d();return R(o.addLast())}),w(17,st,1,0,"ng-template",9),p(),k(18,26),l(19,"lg-button",27),h("click",function(){let o=C(e).$index,c=d();return R(c.deleteIngredient(o))}),v(20,"mat-icon",28),p(),M(),p(),_(21,ut,1,0,"hr",29),M()}if(i&2){let e=t.$index,n=t.$count,o=d();a("formGroupName",e),r(),a("mobileMode",!0),r(),a("size","small"),r(3),a("flat",!0)("size","small")("active",!o.recipeFieldState()[e]),r(),f(" ",u(7,18,"recipe.form.ingredients.product_id.label")," "),r(3),a("flat",!0)("size","small")("active",o.recipeFieldState()[e]),r(),f(" ",u(11,20,"recipe.form.ingredients.recipe_id.label")," "),r(2),g(o.recipeFieldState()[e]?12:13),r(2),a("placeholder",de(16,22,"recipe.form.ingredients.amount.placeholder",ce(25,lt,(o.form.value.ingredients==null||o.form.value.ingredients[e]==null?null:o.form.value.ingredients[e].unit)||"gram"))),r(5),F("danger"),a("size","tiny")("icon",!0),r(2),g(e!==n-1?21:-1)}}function _t(i,t){if(i&1&&v(0,"lg-chips-list",16),i&2){let e=d(),n=P(26);a("control",n)("items",e.topCategories())}}var V=class i{constructor(t,e,n,o,c){this._recipesRepository=t;this._selectResourcesService=e;this._router=n;this._aRoute=o;this._notificationsService=c}recipe=B(void 0);uuid=Ce("uuid");form=new J({name:new x(null,Re.required),description:new x(""),outcome_amount:new x(null),outcome_unit:new x(""),ingredients:new we([this._getIngredientGroup()]),category_id:new x(null)},t=>L.fromRaw(t.value).outcomeAmountGreaterThanIngredients?{outcomeAmountGreaterThanIngredients:!0}:null);recipeFieldState=b({});tooltipComponent=z("tooltipComponent");productsWidget=z("products");productsSelector=z("productsSelector");nameField=O("nameField");topCategories=b([]);recipeEffect=se(()=>{this.recipe()&&this.fillForm(this.recipe())});get ingredients(){return this.form.get("ingredients")}get _formValid(){return this.form.valid&&!this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())}fillForm(t){this.form.reset({ingredients:[]}),this.ingredients.clear(),t&&(this.form.reset(E(T({},ge(t)),{ingredients:[]})),t.ingredients.length?t.ingredients.forEach((e,n)=>{this.ingredients.push(this._getIngredientGroup(e)),e.recipe_id&&this.openRecipeField(n)}):this.ingredients.push(this._getIngredientGroup()),this.form.updateValueAndValidity(),this.form.markAsPristine())}resetForm(t){this.fillForm(t),this._loadUsingHistory(),this.form.markAsPristine()}validateForm(){return this._formValid?!0:(this._notificationsService.error(this._notificationsService.parseFormErrors(this.form).join(", ")),!1)}addLast(){let t=this.ingredients.at(this.ingredients.length-1);(t.value.name||t.value.amount||t.value.product_id)&&this.addIngredient()}ngOnInit(){this._loadUsingHistory(),this.form.valueChanges.pipe(G(100)).subscribe({next:t=>{if(!this.form.dirty)return;this.recipe()?.update(this.form.getRawValue()),this.checkCycleRecipe(this.form.getRawValue().ingredients,this.uuid())&&this._notificationsService.error("You cannot add a recipe to itself")}})}ngAfterViewInit(){this._selectResourcesService.load().then(t=>{}),this.recipe()?.uuid||this.nameField().focus()}addIngredient(){this.ingredients.push(this._getIngredientGroup()),this.form.markAsDirty()}deleteIngredient(t){this.ingredients.removeAt(t),this.form.markAsDirty()}onIngredientSelected(t,e,n){t.focus();let o=this.ingredients.at(e).value;this.ingredients.at(e).patchValue(E(T({},Array.isArray(n)?n.reduce((c,A)=>E(T({},c),{[A]:null}),{}):{[n]:null}),{unit:o.product_id?.unit||o.recipe_id?.unit||"gram"}))}openRecipeField(t){this.recipeFieldState.update(e=>E(T({},e),{[t]:!0}))}closeRecipeField(t){this.recipeFieldState.update(e=>E(T({},e),{[t]:!1}))}checkCycleRecipe(t,e){let n=!1;for(let o of t){let c=o.recipe_id?.uuid;if(c&&c===e){n=!0;break}}return n}_loadUsingHistory(){this._recipesRepository.getTopCategories().then(t=>{this.topCategories.set(t.map(e=>({label:e.name,value:{uuid:e.uuid,name:e.name}})))})}_getIngredientGroup(t){return new J({name:new x(t?.name),amount:new x(t?.amount?.toString()??null),product_id:new x(t?.product_id?t.product_id:null),recipe_id:new x(t?.recipe_id?t.recipe_id:null),unit:new x(t?.unit??"gram")},e=>{let n=_e.fromRaw(e.value);if(n.allEmpty)return null;if(n.typeSelected&&!n.amountValid)return{ingredientAmountRequired:!0};if(!this.uuid)return null;let o=this.uuid();return this.checkCycleRecipe([e.value],o)?{cycleRecipe:!0}:n.typeSelected?null:{ingredientRequired:!0}})}static \u0275fac=function(e){return new(e||i)(y(Q),y(N),y(ue),y(j),y($))};static \u0275cmp=D({type:i,selectors:[["lg-add-recipe-form"]],viewQuery:function(e,n){e&1&&(I(n.tooltipComponent,nt,5),I(n.productsWidget,ot,5),I(n.productsSelector,rt,5),I(n.nameField,at,5)),e&2&&U(4)},inputs:{recipe:[1,"recipe"]},features:[pe([{provide:N,useClass:N}])],decls:28,vars:30,consts:[["nameField",""],["amount",""],["categorySelect",""],["productsSelector",""],[3,"formGroup"],[3,"position"],["formControlName","name","lgExpand","",3,"key","placeholder","resource"],["formControlName","description","lgExpand","",3,"placeholder"],["formControlName","outcome_amount","lgExpand","","lgParseMath","",3,"placeholder"],["lgExtraTpl","","place","after"],["lgExpand","",3,"label"],["formArrayName","ingredients","lgExpand","",3,"size"],[3,"formGroupName"],[3,"click","size"],[2,"--control-bg","#ffffff",3,"position","size"],["formControlName","category_id","lgExpand","",3,"resource"],[3,"control","items"],["formControlName","outcome_unit"],[3,"mobileMode"],[3,"size"],["ngProjectAs","labelTpl",5,["labelTpl"]],[3,"click","flat","size","active"],["ngProjectAs","afterLabelTpl",5,["afterLabelTpl"]],["formControlName","recipe_id",3,"resource","autoLoad"],["formControlName","product_id",3,"resource","autoLoad"],["lgParseMath","","formControlName","amount",3,"onKeydown","placeholder"],["ngProjectAs","rowActions",5,["rowActions"]],[3,"click","size","icon"],["aria-hidden","false","fontIcon","close"],["size","2","lgExpand","","color","#fafafa"],["formControlName","recipe_id",3,"onSelected","resource","autoLoad"],["formControlName","product_id",3,"onSelected","resource","autoLoad"],["formControlName","unit"]],template:function(e,n){if(e&1){let o=S();l(0,"form",4)(1,"lg-gap-column")(2,"lg-card")(3,"lg-gap-column",5),v(4,"lg-autocomplete",6,0),m(6,"translate"),v(7,"lg-textarea",7),m(8,"translate"),p()(),l(9,"lg-card")(10,"lg-gap-column",5)(11,"lg-number-input",8,1),m(13,"translate"),w(14,ct,1,0,"ng-template",9),p(),l(15,"lg-control-group",10),m(16,"translate"),l(17,"lg-gap-column",5)(18,"lg-gap-column",11),ee(19,ft,22,27,"ng-container",12,pt),p(),l(21,"lg-button",13),h("click",function(){return C(o),R(n.addIngredient())}),s(22),m(23,"translate"),p()()()()(),l(24,"lg-gap-column",14),v(25,"lg-multiselect",15,2),_(27,_t,1,2,"lg-chips-list",16),p()()()}e&2&&(a("formGroup",n.form),r(3),a("position","start"),r(),a("key","name")("placeholder",u(6,20,"recipe.form.name.placeholder"))("resource","recipes-names"),r(3),a("placeholder",u(8,22,"recipe.form.description.placeholder")),r(3),a("position","start"),r(),a("placeholder",u(13,24,"recipe.form.outcome_amount.placeholder")),r(4),a("label",ae(u(16,26,"recipe.form.ingredients.label"))),r(2),a("position","start"),r(),a("size","medium"),r(),te(n.ingredients.controls),r(2),F("success"),a("size","small"),r(),f(" ",u(23,28,"recipe.form.ingredients.add-btn")," "),r(2),a("position","start")("size","medium"),r(),a("resource","recipes-categories"),r(2),g(n.topCategories().length?27:-1))},dependencies:[Fe,xe,he,ve,ye,Ae,Se,be,Be,K,q,H,Oe,ze,Le,$e,Pe,Qe,We,qe,Ie,Ne,W,He,Ee,je],encapsulation:2})};function gt(i,t){i&1&&(l(0,"p"),s(1,"You just added new recipe. "),l(2,"a",4),s(3,"Want to have a look?"),p()()),i&2&&(r(2),a("routerLink",le("/recipes/edit/",t)))}function Ct(i,t){if(i&1&&(l(0,"lg-button",9),s(1),m(2,"translate"),p()),i&2){let e,n=d(2);F("primary"),a("flat",!0)("link","/recipes/calculate/"+((e=n.recipe())==null?null:e.uuid))("size","small"),r(),f(" ",u(2,6,"recipe.calculate-btn")," ")}}function Rt(i,t){i&1&&(l(0,"lg-fade-in"),s(1),m(2,"translate"),p()),i&2&&(r(),f(" ",u(2,1,"saved-draft-label")," "))}function ht(i,t){i&1&&w(0,Rt,3,3,"ng-template",7)}function vt(i,t){if(i&1){let e=S();l(0,"lg-button",11),h("click",function(){C(e);let o=d(3);return R(o.onRemoveDraft())}),s(1),m(2,"translate"),p()}i&2&&(F("danger"),a("flat",!0),r(),f(" ",u(2,4,"recipe.form.delete-draft-btn")," "))}function xt(i,t){if(i&1){let e=S();l(0,"lg-button",11),h("click",function(){C(e);let o=d(3);return R(o.onDeleteRecipe())}),s(1),m(2,"translate"),p()}i&2&&(F("danger"),a("flat",!0),r(),f(" ",u(2,4,"recipe.form.delete-btn")," "))}function yt(i,t){if(i&1&&_(0,vt,3,6,"lg-button",10)(1,xt,3,6,"lg-button",10),i&2){let e,n=d(2);g(n.isDraftRoute()?0:(e=n.recipe())!=null&&e.uuid?1:-1)}}function St(i,t){if(i&1&&(l(0,"small",8),s(1),m(2,"translate"),m(3,"timeAgo"),p()),i&2){let e,n=d(2);r(),re(" ",u(2,2,"edited-at-label")," ",u(3,4,(e=n.recipe())==null?null:e.updatedAt)," ")}}function bt(i,t){if(i&1&&(l(0,"lg-gap-row",5)(1,"lg-title")(2,"span",6),s(3),p()()(),l(4,"lg-inline-separated-group"),w(5,Ct,3,8,"ng-template",7),_(6,ht,1,0,null,7),w(7,yt,2,1,"ng-template",7),p(),_(8,St,4,6,"small",8)),i&2){let e,n,o,c=d();a("mobileMode",!0)("center",!0),r(3),oe((e=c.recipe())==null?null:e.name),r(3),g(c.draftRef()&&(!((n=c.formComponent())==null||n.form==null)&&n.form.dirty)?6:-1),r(2),g((o=c.recipe())!=null&&o.updatedAt?8:-1)}}function At(i,t){i&1&&(l(0,"lg-title"),s(1),m(2,"translate"),p()),i&2&&(r(),f(" ",u(2,1,"recipe.form.title")," "))}function wt(i,t){i&1&&(s(0),m(1,"translate")),i&2&&f(" ",u(1,1,"recipe.form.save-btn.edit.active")," ")}function It(i,t){i&1&&(s(0),m(1,"translate")),i&2&&f(" ",u(1,1,"recipe.form.save-btn.edit.disabled")," ")}function Ft(i,t){if(i&1){let e=S();l(0,"lg-button",12),h("click",function(){C(e);let o=d();return R(o.onEditRecipe())}),_(1,wt,2,3)(2,It,2,3),p()}if(i&2){let e,n,o=d();a("disabled",!(!((e=o.formComponent())==null||e.form==null)&&e.form.dirty)&&!o.draftRef()),r(),g(!((n=o.formComponent())==null||n.form==null)&&n.form.dirty||o.draftRef()?1:2)}}function Tt(i,t){i&1&&(s(0),m(1,"translate")),i&2&&f(" ",u(1,1,"recipe.form.save-btn.add.active")," ")}function Et(i,t){i&1&&(s(0),m(1,"translate")),i&2&&f(" ",u(1,1,"recipe.form.save-btn.add.disabled")," ")}function Dt(i,t){if(i&1){let e=S();l(0,"lg-button",12),h("click",function(){C(e);let o=d();return R(o.onAddRecipe())}),_(1,Tt,2,3)(2,Et,2,3),p()}if(i&2){let e,n,o=d();a("disabled",!(!((e=o.formComponent())==null||e.form==null)&&e.form.dirty)&&!o.draftRef()),r(),g(!((n=o.formComponent())==null||n.form==null)&&n.form.dirty||o.draftRef()?1:2)}}var Ze=class i{constructor(t,e,n){this._aRoute=t;this._recipesRepository=e;this._notificationsService=n}draftOrRecipeUUID=b(void 0);recipe=b(void 0);formComponent=O(V);draftRef=b(void 0);draftByExistingRecipe=me(()=>this.draftRef().meta?.uuid);isDraftRoute=b(!1);draftRecipeModel;addedRecipeInformerUUID=b(null);_routerManager=Z(Ye);ngOnInit(){X([this._aRoute.params,this._aRoute.data]).subscribe(([t,e])=>{let n=e.draft;this.draftOrRecipeUUID.set(t.uuid),n?(this.draftRef.set(n),this.recipe.set(n.data)):e.recipe?this.recipe.set(e.recipe):this.draftOrRecipeUUID()?this._loadRecipe(this.draftOrRecipeUUID()):this.recipe.set(L.empty()),this.isDraftRoute.set(!!e.draftRoute)})}ngAfterViewInit(){this.formComponent()?.form.valueChanges.pipe(G(500)).subscribe(t=>{this.formComponent().form.dirty&&(this.draftRef()?.uuid?this._recipesRepository.updateDraftRecipe(this.draftRef().uuid,this.recipe(),this.draftRef().meta?.uuid):this.recipe()&&(this.draftRef.set(this._recipesRepository.saveDraftRecipe(this.recipe(),this.draftOrRecipeUUID()??"")),this.isDraftRoute()||this._routerManager.replace(["recipes/draft/"+this.draftRef().uuid])))})}async onAddRecipe(){try{if(!this.formComponent()?.validateForm()||!this.recipe())return;let t=await this._addRecipe(this.recipe());this.addedRecipeInformerUUID.set(t)}catch(t){this._notificationsService.error(Y(t))}}async onEditRecipe(){try{if(!this.formComponent()?.validateForm()||!this.recipe())return;await this._editRecipe(this.recipe())}catch(t){this._notificationsService.error(Y(t))}}onRemoveDraft(){this._removeDraft(),this._routerManager.navigate(["recipes"])}onDeleteRecipe(){this.recipe()?.uuid&&this._recipesRepository.deleteOne(this.recipe().uuid).then(()=>{this._notificationsService.success("Recipe deleted"),this._routerManager.navigate(["recipes"])})}_addRecipe(t){return this._recipesRepository.addRecipe(t).then(e=>(this.formComponent()?.resetForm(),this._notificationsService.success("Recipe added"),this.recipe.set(void 0),this.draftRef()&&this._removeDraft(),this._routerManager.navigateWithReset(["recipes","edit",e]),e))}_editRecipe(t){if(!this.draftOrRecipeUUID())return Promise.resolve();let e=this.draftRef()?.meta?.uuid??this.draftOrRecipeUUID();return this._recipesRepository.editRecipe(e,t).then(()=>{this.formComponent()?.resetForm(t),this._notificationsService.success("Recipe edited"),this.draftRef()&&this._removeDraft(),this._routerManager.navigateWithReset(["recipes","edit",e])})}_removeDraft(){this.draftRef()&&(this._recipesRepository.removeDraftRecipe(this.draftRef().uuid),this.draftRef.set(void 0))}_loadRecipe(t){t&&this._recipesRepository.getOne(t).then(e=>{e&&this.recipe.set(e)})}static \u0275fac=function(e){return new(e||i)(y(j),y(Q),y($))};static \u0275cmp=D({type:i,selectors:[["app-add-recipe"]],viewQuery:function(e,n){e&1&&I(n.formComponent,V,5),e&2&&U()},decls:10,vars:6,consts:[["size","medium"],[3,"recipe"],[3,"mobileMode","relaxed"],["lgShrink","",3,"disabled"],[3,"routerLink"],[3,"mobileMode","center"],[1,"text-active"],["lgInlineSeparatedGroup",""],[1,"text-muted","text-cursive"],[3,"flat","link","size"],["lgShrink","",3,"style","flat"],["lgShrink","",3,"click","flat"],["lgShrink","",3,"click","disabled"]],template:function(e,n){if(e&1&&(l(0,"lg-fade-in")(1,"lg-container")(2,"lg-gap-column",0),_(3,gt,4,2,"p"),_(4,bt,9,5)(5,At,3,3,"lg-title"),p(),v(6,"lg-add-recipe-form",1),l(7,"lg-gap-row",2),_(8,Ft,3,2,"lg-button",3)(9,Dt,3,2,"lg-button",3),p()()()),e&2){let o,c,A;r(3),g((o=n.addedRecipeInformerUUID())?3:-1,o),r(),g((c=n.recipe())!=null&&c.uuid&&!n.draftRef()||n.draftRef()&&n.draftByExistingRecipe()?4:5),r(2),a("recipe",n.recipe()),r(),a("mobileMode",!0)("relaxed",!0),r(),g((A=n.recipe())!=null&&A.uuid&&!n.draftRef()||n.draftRef()&&n.draftByExistingRecipe()?8:9)}},dependencies:[Te,De,V,H,Me,Ve,Ke,ke,q,W,fe,Ue,Ge],encapsulation:2})};export{Ze as AddRecipeComponent};
