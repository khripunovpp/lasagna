import{a as je,b as Ue,c as Le}from"./chunk-HRJJTZRZ.js";import{a as Fe}from"./chunk-KJHYIYGH.js";import{a as ne,b as be,c as Te}from"./chunk-6O2QYWSA.js";import"./chunk-RYPD5HVN.js";import{b as Ie,e as Ae,i as Me,p as Ee}from"./chunk-FMSTASSM.js";import{a as Re}from"./chunk-GKQZ6TBK.js";import{a as Se,b as Q,c as G}from"./chunk-TQTLV33A.js";import{a as q}from"./chunk-2NSFWKSX.js";import{a as ke,b as Pe}from"./chunk-HMFW6PL3.js";import{$a as c,Ab as ie,Ca as _,Da as f,E as H,Ea as ce,G as X,Ga as M,Ha as E,Ia as l,Ib as ge,Ja as s,Ka as de,Lb as ve,M as L,Mb as xe,Nb as he,Oa as h,P as Y,Pa as u,Qa as p,Ra as z,Sa as N,U as C,V as g,Va as me,Wa as ue,Wb as ye,Xa as _e,Ya as V,Z as O,Za as W,Zb as we,_a as fe,a as ae,ab as b,ac as De,b as le,bb as y,cb as te,db as T,eb as D,f as A,fb as k,ia as r,j as Z,la as v,lb as P,mb as R,na as x,nb as Ce,ra as se,wa as m,wb as B,xa as pe,xb as F,ya as ee,yb as $,za as S}from"./chunk-EBX4ADAM.js";var We=["input"],Be=["*"],I=class o{filesSelected=B();accept=F(".csv");input=$("input");onFileChange(i){let t=i.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&V(t.input,We,5),e&2&&W()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Be,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let n=h();z(),l(0,"div",1),u("click",function(){C(n);let d=fe(2);return g(d.click())}),l(1,"input",2,0),u("change",function(d){return C(n),g(t.onFileChange(d))}),s(),l(3,"div",3),N(4),s()()}e&2&&(r(),m("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var $e=["*"],U=class o{constructor(){}displayed=O(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["lg-dialog"]],ngContentSelectors:$e,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(z(),l(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),N(5),s()()()()()),e&2&&pe("display",t.displayed()?"flex":"none")},dependencies:[ke],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var w=class o{constructor(){}readFromFile(i){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{let a=n.result,d=this.parseData(a),[ze,...Ne]=d,Ve=this.arrayToObjects(Ne,ze);e(Ve)},n.onerror=()=>{t(n.error)},n.readAsText(i)})}parseData(i){return i.split(`\r
`).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(i,e){return i.map(t=>{let n={};return e.forEach((a,d)=>{n[a]=t[d]}),n})}makeCsv(i){let e=Object.keys(i[0]),t=i.map(a=>e.map(d=>a[d]));return[e,...t].map(a=>a.join(",")).join(`\r
`)}saveToFile(i,e){let t=this.makeCsv(i),n=new Blob([t],{type:"text/csv"}),a=URL.createObjectURL(n),d=document.createElement("a");document.body.appendChild(d),d.setAttribute("href",a),d.setAttribute("download",e),d.click(),URL.revokeObjectURL(a)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=L({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ge=(o,i)=>i.name+i.uuid;function qe(o,i){if(o&1){let e=h();l(0,"input",9),k("ngModelChange",function(n){C(e);let a=p().$implicit,d=p(3);return D(d.rowsToUpdate[a.name],n)||(d.rowsToUpdate[a.name]=n),g(n)}),s(),c(1," Update ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToUpdate[e.name]),m("disabled",t.rowsToSkip[e.name])}}function Je(o,i){if(o&1){let e=h();l(0,"input",10),k("ngModelChange",function(n){C(e);let a=p().$implicit,d=p(3);return D(d.rowsToAdd[a.name],n)||(d.rowsToAdd[a.name]=n),g(n)}),s(),c(1," Add ")}if(o&2){let e=p().$implicit,t=p(3);T("ngModel",t.rowsToAdd[e.name]),m("disabled",t.rowsToSkip[e.name])}}function Ke(o,i){if(o&1&&(l(0,"span"),c(1),s()),o&2){let e=p().$implicit;r(),y("from ",e.source)}}function Ze(o,i){if(o&1&&(l(0,"span"),c(1),s()),o&2){let e=p(2).$implicit,t=p();r(),y("from ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).source)}}function He(o,i){if(o&1){let e=h();l(0,"div",11)(1,"input",9),k("ngModelChange",function(n){C(e);let a=p().$implicit,d=p(3);return D(d.rowsToSkip[a.name],n)||(d.rowsToSkip[a.name]=n),g(n)}),s(),l(2,"span"),c(3),s(),l(4,"span"),c(5),s(),l(6,"span"),c(7),s(),_(8,Ze,2,1,"span"),s()}if(o&2){let e=p().$implicit,t=p(),n=p(2);ee("disabled",n.rowsToUpdate[e.name])("skip",n.rowsToUpdate[e.name]),m("ngClass",n.rowsToSkip[e.name]?"skip":"duplicated"),r(),T("ngModel",n.rowsToSkip[e.name]),m("disabled",n.rowsToAdd[e.name]||n.rowsToUpdate[e.name]),r(2),b(n.rowsToSkip[e.name]?"Skip":"Duplicates"),r(2),b((t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).name),r(2),te("",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).amount," gr for ",(t[e.uuid]||t[e.name])==null?null:(t[e.uuid]||t[e.name]).price),r(),f((t[e.uuid]||t[e.name])!=null&&(t[e.uuid]||t[e.name]).source?8:-1)}}function Xe(o,i){if(o&1&&(l(0,"lg-gap-column",6)(1,"div",7),_(2,qe,2,2)(3,Je,2,2),l(4,"span"),c(5),s(),l(6,"span"),c(7),s(),_(8,Ke,2,1,"span"),s(),_(9,He,9,12,"div",8),s()),o&2){let e=i.$implicit,t=p(),n=p(2);m("size","small"),r(),ee("update",n.rowsToUpdate[e.name])("add",n.rowsToAdd[e.name])("disabled",n.rowsToSkip[e.name]),r(),f(t[e.uuid]||t[e.name]?2:3),r(3),b(e.name),r(2),te("",e.amount,"gr for ",e.price),r(),f(e.source?8:-1),r(),f(t[e.uuid]||t[e.name]?9:-1)}}function Ye(o,i){if(o&1&&(l(0,"lg-gap-column",6),M(1,Xe,10,13,"lg-gap-column",6,Ge),s()),o&2){let e=p();m("size","medium"),r(),E(e)}}function et(o,i){if(o&1&&(_(0,Ye,3,1,"lg-gap-column",6),P(1,"async")),o&2){let e,t=p();f((e=R(1,1,t.analize$))?0:-1,e)}}var J=class o{constructor(i,e){this._csvReaderService=i;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=B();storeName=F(null);schema=F();skipAllDuplicates=ie(!1);replaceAll=ie(!1);analizeSubject=new Z;dataSubject=new Z;data$=this.dataSubject.asObservable().pipe(X([]),H((i,e)=>e==null?[]:[...i,e]));analize$=this.analizeSubject.asObservable().pipe(X([]),H((i,e)=>e==null?[]:!e.uuid||!e.name?i:le(ae({},i),{[e.uuid]:e,[e.name]:e})));dialog;upload=$(I);parsedData=[];onConfirm(){return A(this,null,function*(){for(let i of this.parsedData)this.rowsToAdd[i.name]?(yield this._indexDbService.addData(this.storeName(),i),console.log("add",i)):this.rowsToUpdate[i.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),i.uuid,i),console.log("replace",i));this.clear(),this.onDone.emit(),this.dialog.close()})}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToUpdate[i.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(i=>{this.rowsToAdd[i.name]||(this.rowsToSkip[i.name]=!0,this.rowsToUpdate[i.name]&&(this.rowsToUpdate[i.name]=!1))}):this.rowsToSkip={}}onFileSelected(i){this.dialog.open(),this._csvReaderService.readFromFile(i[0]).then(e=>A(this,null,function*(){for(let t of e){let n=this.schema()?.safeParse(t);if(!n?.success){console.log("error",n?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(n.data),yield this._analyzeDuplicates(n.data).then(a=>{a.duplicate?this.analizeSubject.next(a.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(i){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",i.name).then(n=>{n.length?e({data:n,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(v(w),v(Q))};static \u0275cmp=x({type:o,selectors:[["lg-import"]],viewQuery:function(e,t){if(e&1&&(V(t.upload,I,5),me(U,5)),e&2){W();let n;ue(n=_e())&&(t.dialog=n.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:18,vars:19,consts:[[3,"filesSelected"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(l(0,"lg-upload",0),u("filesSelected",function(a){return t.onFileSelected(a)}),l(1,"lg-button",1),c(2," Import "),s()(),l(3,"lg-dialog")(4,"lg-gap-column"),_(5,et,2,3),P(6,"async"),l(7,"lg-gap-row",2)(8,"input",3),u("change",function(){return t.onSkipAllDuplicates()}),k("ngModelChange",function(a){return D(t.skipAllDuplicates,a)||(t.skipAllDuplicates=a),a}),s(),l(9,"label"),c(10,"Skip all duplicates"),s()(),l(11,"lg-gap-row",2)(12,"input",3),u("change",function(){return t.onReplaceAll()}),k("ngModelChange",function(a){return D(t.replaceAll,a)||(t.replaceAll=a),a}),s(),l(13,"label"),c(14,"Replace all with new"),s()(),l(15,"lg-gap-row",4)(16,"lg-button",5),u("click",function(){return t.onConfirm()}),c(17," Confirm "),s()()()()),e&2){let n;r(),S("warning"),m("flat",!0)("size","small"),r(4),f((n=R(6,17,t.data$))?5:-1,n),r(2),m("center",!0)("hidden",t.replaceAll())("size","small"),r(),T("ngModel",t.skipAllDuplicates),r(3),m("center",!0)("hidden",t.skipAllDuplicates())("size","small"),r(),T("ngModel",t.replaceAll),r(3),m("center",!0),r(),S("success"),m("size","small")}},dependencies:[I,G,U,ve,q,Re,Ee,Ie,Ae,Me,ge],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var K=class o{constructor(i,e){this._indexDbService=i;this._csvReaderService=e}exportTable(i){return this._indexDbService.getAll(i).then(e=>{this._csvReaderService.saveToFile(e,`${i}_export_${new Date().toISOString()}.csv`)})}makeCsv(i){return this._csvReaderService.makeCsv(i)}static \u0275fac=function(e){return new(e||o)(Y(Q),Y(w))};static \u0275prov=L({token:o,factory:o.\u0275fac,providedIn:"root"})};var it=(o,i)=>i.value==null?null:i.value.category;function nt(o,i){o&1&&c(0," per gram ")}function ot(o,i){if(o&1&&c(0),o&2){let e=p(2).$implicit;y(" per ",e.unit," ")}}function rt(o,i){if(o&1){let e=h();l(0,"lg-gap-row",0)(1,"div",5)(2,"lg-gap-row",0)(3,"div",6)(4,"a",7),c(5),s()(),l(6,"div",8),c(7),s(),l(8,"div",9),c(9),P(10,"number"),_(11,nt,1,0)(12,ot,1,1),s()()(),l(13,"lg-button",10),u("click",function(){C(e);let n=p().$implicit,a=p(3);return g(a.deleteProduct(n))}),de(14,"mat-icon",11),s()()}if(o&2){let e=p().$implicit,t=p(3);m("center",!0),r(2),m("center",!0),r(2),m("routerLink","/edit-product/"+e.uuid),r(),b(e.name),r(2),y(" ",e.source??""),r(2),y(" ",Ce(10,11,t.getPricePerGram(e),"1.2-5")," "),r(2),f(!e.unit||e.unit==="gram"?11:12),r(2),S("danger"),m("size","small")("icon",!0)}}function at(o,i){o&1&&se(0,rt,15,14,"ng-template",4)}function lt(o,i){if(o&1&&(l(0,"lg-title"),c(1),s(),l(2,"lg-card-list"),M(3,at,1,0,null,4,ce),s()),o&2){let e=i;r(),y(" ",e.category||"Uncategorized"," "),r(2),E(e.products)}}function st(o,i){if(o&1&&_(0,lt,5,1),o&2){let e,t=i.$implicit;f((e=t.value)?0:-1,e)}}var Oe=class o{constructor(i,e,t,n){this._productsRepository=i;this._csvReaderService=e;this._transferDataService=t;this._activatedRoute=n;this._activatedRoute.data.pipe(Fe()).subscribe(a=>{console.log(a),this.products.set(a.list)})}products=O([]);ProductDbInputScheme=be;Stores=Se;getPricePerGram(i){return(ne(i.price)||1)/(ne(i.amount)||1)}exportProducts(){this._transferDataService.exportTable("productsStore")}deleteProduct(i){i.uuid&&this._productsRepository.deleteProduct(i.uuid).then(()=>{this.loadProducts()})}ngOnInit(){return A(this,null,function*(){yield this.loadProducts()})}loadProducts(){}static \u0275fac=function(e){return new(e||o)(v(Te),v(w),v(K),v(ye))};static \u0275cmp=x({type:o,selectors:[["lg-product-list"]],decls:12,vars:14,consts:[[3,"center"],[3,"flat","link","size"],[3,"click","flat","size"],[3,"onDone","schema","storeName"],["lgCardListItem",""],[1,"expand"],[2,"flex","20%"],[3,"routerLink"],[2,"flex","10%"],[2,"flex","70%"],[3,"click","size","icon"],["aria-hidden","false","aria-label","Example home icon","fontIcon","close"]],template:function(e,t){e&1&&(l(0,"lg-container")(1,"lg-title"),c(2," Products "),s(),l(3,"lg-gap-row",0)(4,"lg-button",1),c(5," Add "),s(),l(6,"lg-button",2),u("click",function(){return t.exportProducts()}),c(7," Export "),s(),l(8,"lg-import",3),u("onDone",function(){return t.loadProducts()}),s()(),M(9,st,1,1,null,null,it),P(11,"keyvalue"),s()),e&2&&(r(3),m("center",!0),r(),S("primary"),m("flat",!0)("link","/add-product")("size","small"),r(2),S("info"),m("flat",!0)("size","small"),r(2),m("schema",t.ProductDbInputScheme)("storeName",t.Stores.PRODUCTS),r(),E(R(11,12,t.products())))},dependencies:[q,G,Le,De,Pe,he,Ue,je,J,we,xe],styles:["[_nghost-%COMP%]{display:block}"]})};export{Oe as ProductListComponent};
