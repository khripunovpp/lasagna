import{a as y}from"./chunk-KWYRKVA4.js";import{a as t}from"./chunk-RFEBMF6P.js";import{a as p}from"./chunk-FG5PJ7WR.js";import{c as m}from"./chunk-6CXN2K45.js";import{$ as g,da as n,f as o,m as a}from"./chunk-46OIECST.js";var c=i=>{if(typeof i=="number")return i;if(typeof i=="string"){let e=i.replace(",","."),r=parseFloat(e);return isNaN(r)?null:r}return null};var d=t.object({name:t.string(),price:t.number().or(t.string()),amount:t.number().or(t.string()),source:t.string(),category_id:t.string().nullable().optional(),uuid:t.string().optional(),unit:t.string()});var S=class i{constructor(e,r,s){this._indexDbService=e;this._categoryRepository=r;this._usingHistoryService=s}_stream$=new a;get products$(){return this._stream$.asObservable()}loadRecipes(){return this._indexDbService.getAll("productsStore").then(e=>(this._stream$.next(e),e))}addProduct(e){return this._indexDbService.addData("productsStore",this._toDbValue(e)).then(r=>(e.category_id&&this._saveCategory(e.category_id),e.source&&this._saveSource(e.source),r))}getOne(e){return o(this,null,function*(){return new Promise((r,s)=>o(this,null,function*(){if(!e){r(void 0);return}e=e.uuid||e,yield this._indexDbService.getOne("productsStore",e).then(u=>{r(u)})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}editProduct(e,r){return this._indexDbService.replaceData("productsStore",e,this._toDbValue(r))}deleteProduct(e){return this._indexDbService.remove("productsStore",e)}makeFromData(e){return Array.isArray(e)?e.map(r=>({uuid:r.uuid,name:r.name,price:r.price,amount:r.amount,source:r.source,category_id:r.category_id,unit:r.unit})):{uuid:e.uuid,name:e.name,price:e.price,amount:e.amount,source:e.source,category_id:e.category_id,unit:e.unit}}getTopCategories(){let{top:e}=this._usingHistoryService.read("products_categories"),r=Object.keys(e);return this._categoryRepository.getManyCategories(r).then(s=>s.toSorted((u,_)=>e[_.uuid].count>e[u.uuid].count?1:-1))}getTopSources(){return o(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}_toDbValue(e){return e!=null?d.parse({name:String(e.name||""),price:c(e.price)||0,amount:c(e.amount)||0,source:String(e.source||""),category_id:String(e.category_id||""),unit:String(e.unit||"")}):null}_saveCategory(e){this._usingHistoryService.count("products_categories",e)}_saveSource(e){this._usingHistoryService.count("products_sources",e)}static \u0275fac=function(r){return new(r||i)(n(m),n(y),n(p))};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};export{c as a,d as b,S as c};
