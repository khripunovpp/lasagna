import{a as l}from"./chunk-W227WBY4.js";import{a as e}from"./chunk-BBWM53XJ.js";import{a as f,b as S}from"./chunk-2DQNHQVY.js";import{g as y}from"./chunk-LN6FDTLB.js";import{U as g,Y as a,f as p}from"./chunk-KOVCW6OE.js";import{a as u,b as d,f as s}from"./chunk-2WH2EVR6.js";var m=n=>{if(typeof n=="number")return n;if(typeof n=="string"){let t=n.replace(",","."),r=parseFloat(t);return isNaN(r)?null:r}return null};var v=e.object({name:e.string(),price:e.number().or(e.string()),amount:e.number().or(e.string()),source:e.string(),category_id:e.string().nullable().optional(),uuid:e.string().optional(),unit:e.string(),createdAt:e.number().optional(),updatedAt:e.number().optional()});var P=class n{constructor(t,r,i,o){this._indexDbService=t;this._categoryRepository=r;this._usingHistoryService=i;this._draftFormsService=o}_stream$=new p;get products$(){return this._stream$.asObservable()}loadRecipes(){return this._indexDbService.getAll("productsStore").then(t=>(this._stream$.next(t),t))}addProduct(t){return this._indexDbService.addData("productsStore",this._toDbValue(d(u({},t),{createdAt:Date.now()}))).then(r=>(t.category_id&&this._saveCategory(t.category_id),t.source&&this._saveSource(t.source),this._saveProductToHistory(r),r))}getOne(t){return s(this,null,function*(){return new Promise((r,i)=>s(this,null,function*(){if(!t){r(void 0);return}t=t.uuid||t,yield this._indexDbService.getOne("productsStore",t).then(o=>{r(o)})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}getLastProducts(){let{top:t}=this._usingHistoryService.read("products"),r=Object.keys(t);return r.length===0?Promise.resolve([]):this._indexDbService.getMany("productsStore",r).then(i=>i.toSorted((o,c)=>t[c.uuid].count>t[o.uuid].count?1:-1).map(o=>({product:o,updatedAt:t[o.uuid].updatedAt,count:t[o.uuid].count})))}editProduct(t,r){return s(this,null,function*(){yield this._indexDbService.replaceData("productsStore",t,this._toDbValue(d(u({},r),{updatedAt:Date.now()}))),this._saveProductToHistory(t)})}deleteProduct(t){return this._indexDbService.remove("productsStore",t)}getTopCategories(){let{top:t}=this._usingHistoryService.read("products_categories"),r=Object.keys(t);return this._categoryRepository.getManyCategories(r).then(i=>i.toSorted((o,c)=>t[c.uuid].count>t[o.uuid].count?1:-1))}getTopSources(){return s(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(t,r){return this._draftFormsService.setDraftForm("draft_products",t,r?.length?"edit":"add",r?{uuid:r}:{})}updateDraftProduct(t,r,i){return this._draftFormsService.updateDraftForm("draft_products",r,t,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftProducts(t){let r=this._draftFormsService.getDraftForms("draft_products");return t&&r?.[t]?[r?.[t]]:r?Object.values(r):[]}removeDraftProduct(t){this._draftFormsService.removeDraftForm("draft_products",t)}_toDbValue(t){return t!=null?v.parse({name:String(t.name||""),price:m(t.price)||0,amount:m(t.amount)||0,source:String(t.source||""),category_id:String(t.category_id||""),unit:String(t.unit||""),createdAt:Number(t.createdAt),updatedAt:Number(t.updatedAt)}):null}_saveCategory(t){this._usingHistoryService.count("products_categories",t)}_saveSource(t){this._usingHistoryService.count("products_sources",t)}_saveProductToHistory(t){this._usingHistoryService.count("products",t)}static \u0275fac=function(r){return new(r||n)(a(y),a(l),a(f),a(S))};static \u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})};export{m as a,v as b,P as c};
