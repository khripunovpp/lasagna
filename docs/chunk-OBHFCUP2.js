import{a as y}from"./chunk-SULQO2OJ.js";import{a as t}from"./chunk-OORM3A2M.js";import{a as g,b as p}from"./chunk-RPM6F7YV.js";import{f as d}from"./chunk-72IHLCPW.js";import{$ as m,da as n,f as a,m as u}from"./chunk-AOSYXQIS.js";var c=i=>{if(typeof i=="number")return i;if(typeof i=="string"){let r=i.replace(",","."),e=parseFloat(r);return isNaN(e)?null:e}return null};var f=t.object({name:t.string(),price:t.number().or(t.string()),amount:t.number().or(t.string()),source:t.string(),category_id:t.string().nullable().optional(),uuid:t.string().optional(),unit:t.string()});var _=class i{constructor(r,e,o,s){this._indexDbService=r;this._categoryRepository=e;this._usingHistoryService=o;this._draftFormsService=s}_stream$=new u;get products$(){return this._stream$.asObservable()}loadRecipes(){return this._indexDbService.getAll("productsStore").then(r=>(this._stream$.next(r),r))}addProduct(r){return this._indexDbService.addData("productsStore",this._toDbValue(r)).then(e=>(r.category_id&&this._saveCategory(r.category_id),r.source&&this._saveSource(r.source),e))}getOne(r){return a(this,null,function*(){return new Promise((e,o)=>a(this,null,function*(){if(!r){e(void 0);return}r=r.uuid||r,yield this._indexDbService.getOne("productsStore",r).then(s=>{e(s)})}))})}getProducts(){return this._indexDbService.getAll("productsStore")}editProduct(r,e){return this._indexDbService.replaceData("productsStore",r,this._toDbValue(e))}deleteProduct(r){return this._indexDbService.remove("productsStore",r)}makeFromData(r){return Array.isArray(r)?r.map(e=>({uuid:e.uuid,name:e.name,price:e.price,amount:e.amount,source:e.source,category_id:e.category_id,unit:e.unit})):{uuid:r.uuid,name:r.name,price:r.price,amount:r.amount,source:r.source,category_id:r.category_id,unit:r.unit}}getTopCategories(){let{top:r}=this._usingHistoryService.read("products_categories"),e=Object.keys(r);return this._categoryRepository.getManyCategories(e).then(o=>o.toSorted((s,S)=>r[S.uuid].count>r[s.uuid].count?1:-1))}getTopSources(){return a(this,null,function*(){return Object.keys(this._usingHistoryService.read("products_sources").top)})}saveDraftProduct(r,e){return this._draftFormsService.setDraftForm("draft_products",r,e?.length?"edit":"add",e?{uuid:e}:{})}updateDraftProduct(r,e,o){return this._draftFormsService.updateDraftForm("draft_products",e,r,o?.length?"edit":"add",o?{uuid:o}:{})}getDraftProducts(r){let e=this._draftFormsService.getDraftForms("draft_products");return r&&e?.[r]?[e?.[r]]:e?Object.values(e):[]}removeDraftProduct(r){this._draftFormsService.removeDraftForm("draft_products",r)}_toDbValue(r){return r!=null?f.parse({name:String(r.name||""),price:c(r.price)||0,amount:c(r.amount)||0,source:String(r.source||""),category_id:String(r.category_id||""),unit:String(r.unit||"")}):null}_saveCategory(r){this._usingHistoryService.count("products_categories",r)}_saveSource(r){this._usingHistoryService.count("products_sources",r)}static \u0275fac=function(e){return new(e||i)(n(d),n(y),n(g),n(p))};static \u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})};export{c as a,f as b,_ as c};
