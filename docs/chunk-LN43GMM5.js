import{a as _}from"./chunk-S3FYHLGE.js";import{a as g,b as f}from"./chunk-2DQNHQVY.js";import{g as m}from"./chunk-LN6FDTLB.js";import{U as p,Y as n,f as u}from"./chunk-KOVCW6OE.js";import{a as s,b as d,f as o}from"./chunk-2WH2EVR6.js";var R=class a{constructor(e,t,i,r){this._indexDbService=e;this._usingHistoryService=t;this._categoryRepository=i;this._draftFormsService=r}_stream$=new u;get recipes$(){return this._stream$.asObservable()}addRecipe(e){return o(this,null,function*(){return this._indexDbService.addData("recipesStore",Object.assign(e,{createdAt:Date.now()})).then(t=>(e.category_id&&this._saveCategory(e.category_id),this._saveRecipeToHistory(t),t))})}loadRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>(this._stream$.next(e),e))}getRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>e.toSorted((t,i)=>t.name.localeCompare(i.name)))}getOne(e){return o(this,null,function*(){return new Promise((t,i)=>o(this,null,function*(){if(!e){t(void 0);return}e=e.uuid||e,yield this._indexDbService.getOne("recipesStore",e).then(r=>{t(this.recipeFromDTO(r))})}))})}editRecipe(e,t){return o(this,null,function*(){yield this._indexDbService.replaceData("recipesStore",e,Object.assign(t,{updatedAt:Date.now()})),this._saveRecipeToHistory(e)})}saveDraftRecipe(e,t){return this._draftFormsService.setDraftForm("draft_recipes",e,t?.length?"edit":"add",t?{uuid:t}:{})}updateDraftRecipe(e,t,i){return this._draftFormsService.updateDraftForm("draft_recipes",t,e,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftRecipe(e){let t=this._draftFormsService.getDraftForms("draft_recipes");return e&&t?.[e]?[t?.[e]]:t?Object.values(t):[]}removeDraftRecipe(e){this._draftFormsService.removeDraftForm("draft_recipes",e)}deleteRecipe(e){return this._indexDbService.remove("recipesStore",e)}ingredientToDto(e){return{name:e.name,amount:e.amount,unit:e.unit,product_id:e.product_id?.uuid,recipe_id:e.recipe_id?.uuid,uuid:e.uuid}}recipeFromDTO(e){if(e)return{name:e.name,description:e.description,outcome_amount:e.outcome_amount,outcome_unit:e.outcome_unit,uuid:e.uuid,ingredients:e.ingredients.map(t=>d(s({},t),{product_id:t.product_id?{uuid:t.product_id}:void 0,recipe_id:t.recipe_id?{uuid:t.recipe_id}:void 0})),taxTemplateName:e.taxTemplateName,category_id:e.category_id?{uuid:e.category_id}:null,createdAt:e.createdAt,updatedAt:e.updatedAt}}recipeToDto(e){return{name:e.name,description:e.description,outcome_amount:e.outcome_amount,outcome_unit:e.outcome_unit,uuid:e.uuid,ingredients:e.ingredients.map(t=>this.ingredientToDto(t)),taxTemplateName:e.taxTemplateName,category_id:e.category_id?e.category_id.uuid:null,createdAt:e.createdAt,updatedAt:e.updatedAt}}getTopCategories(){let{top:e}=this._usingHistoryService.read("recipes_categories"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._categoryRepository.getManyCategories(t).then(i=>i.toSorted((r,c)=>e[c.uuid].count>e[r.uuid].count?1:-1))}getLastRecipes(){let{top:e}=this._usingHistoryService.read("recipes"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._indexDbService.getMany("recipesStore",t).then(i=>i.toSorted((r,c)=>e[c.uuid].count>e[r.uuid].count?1:-1).map(r=>({recipe:r,updatedAt:e[r.uuid].updatedAt,count:e[r.uuid].count})))}_saveCategory(e){this._usingHistoryService.count("recipes_categories",e)}_saveRecipeToHistory(e){this._usingHistoryService.count("recipes",e)}static \u0275fac=function(t){return new(t||a)(n(m),n(g),n(_),n(f))};static \u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})};export{R as a};
