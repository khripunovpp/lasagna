import{a as Te}from"./chunk-65PCG7KQ.js";import{b as ke,e as De,i as Me,p as Ae}from"./chunk-Q24HNGKZ.js";import{c as L,d as Q}from"./chunk-6CXN2K45.js";import{a as Z}from"./chunk-E64ZE4KI.js";import{a as W}from"./chunk-5PVAHMKX.js";import{b as xe}from"./chunk-PXM5XOY4.js";import{b as we,d as he,e as be}from"./chunk-JUGNCNLY.js";import{$ as N,$a as re,$b as fe,Ab as w,Ac as z,Bb as h,Bc as F,Cc as B,Eb as se,Ec as Ce,Fb as ce,Fc as v,Gb as a,Hb as l,Ib as pe,Lb as K,Mb as b,Pb as m,Qb as c,Rb as x,Sb as y,Sc as ye,T as q,Tc as ve,V as G,Vb as de,Vc as ne,Wb as me,Wc as Se,Xb as _e,Yb as ue,Za as d,Zb as V,_b as j,a as oe,ac as _,b as ie,bc as ge,cb as I,da as H,ec as T,f as O,fc as k,gc as D,hb as g,jb as ae,jc as Y,la as u,m as J,ma as f,mb as X,nc as ee,oc as te,sa as U,ub as p,vb as le,wb as P,xb as C}from"./chunk-46OIECST.js";var R=class i{constructor(n){this.templateRef=n}static \u0275fac=function(e){return new(e||i)(I(re))};static \u0275dir=ae({type:i,selectors:[["","lgImportRowTpl",""]]})};var M=class i{constructor(){}readFromCSVFile(n){return new Promise((e,t)=>{let o=new FileReader;o.onload=()=>{let r=o.result,s=this.parseData(r),[Re,...Ee]=s,Ne=this.arrayToObjects(Ee,Re);e(Ne)},o.onerror=()=>{t(o.error)},o.readAsText(n)})}readFromJSONFile(n){return new Promise((e,t)=>{let o=new FileReader;o.onload=()=>{try{let r=o.result,s=JSON.parse(r);e(s)}catch(r){t(r)}},o.onerror=()=>{t(o.error)},o.readAsText(n)})}parseData(n){return n.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(n,e){return n.map(t=>{let o={};return e.forEach((r,s)=>{o[r]=t[s]}),o})}makeCsv(n){let e=Object.keys(n[0]),t=n.map(r=>e.map(s=>r[s]));return[e,...t].map(r=>r.join(",")).join(`\r
`)}saveToCSVFile(n,e){let t=this.makeCsv(n),o=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(o),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",e),s.click(),URL.revokeObjectURL(r)}saveToJSONFile(n,e){let t=JSON.stringify(n,null,2),o=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",e),s.click(),URL.revokeObjectURL(r)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=N({token:i,factory:i.\u0275fac,providedIn:"root"})};var Ue=["input"],Ve=["*"],A=class i{filesSelected=z();accept=F(".csv");input=B("input");onFileChange(n){let t=n.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=g({type:i,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&V(t.input,Ue,5),e&2&&j()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Ve,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let o=b();x(),a(0,"div",1),m("click",function(){u(o);let s=fe(2);return f(s.click())}),a(1,"input",2,0),m("change",function(s){return u(o),f(t.onFileChange(s))}),l(),a(3,"div",3),y(4),l()()}e&2&&(d(),p("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var ze=["*"],E=class i{constructor(){}displayed=U(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=g({type:i,selectors:[["lg-dialog"]],ngContentSelectors:ze,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(x(),a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),y(5),l()()()()()),e&2&&le("display",t.displayed()?"flex":"none")},dependencies:[xe],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var Le=i=>({$implicit:i,flow:"new"}),We=i=>({$implicit:i,flow:"old"}),Qe=(i,n)=>n.name+n.uuid;function Ze(i,n){if(i&1){let e=b();a(0,"input",9),D("ngModelChange",function(o){u(e);let r=c().$implicit,s=c(3);return k(s.rowsToUpdate[r.name],o)||(s.rowsToUpdate[r.name]=o),f(o)}),l(),_(1," Update ")}if(i&2){let e=c().$implicit,t=c(3);T("ngModel",t.rowsToUpdate[e.name]),p("disabled",t.rowsToSkip[e.name])}}function $e(i,n){if(i&1){let e=b();a(0,"input",10),D("ngModelChange",function(o){u(e);let r=c().$implicit,s=c(3);return k(s.rowsToAdd[r.name],o)||(s.rowsToAdd[r.name]=o),f(o)}),l(),_(1," Add ")}if(i&2){let e=c().$implicit,t=c(3);T("ngModel",t.rowsToAdd[e.name]),p("disabled",t.rowsToSkip[e.name])}}function Je(i,n){i&1&&K(0)}function qe(i,n){if(i&1&&X(0,Je,1,0,"ng-container",11),i&2){let e=c().$implicit,t=c(3);p("ngTemplateOutlet",t.rowTemplate().templateRef)("ngTemplateOutletContext",Y(2,Le,e))}}function Ge(i,n){i&1&&K(0)}function He(i,n){if(i&1&&X(0,Ge,1,0,"ng-container",11),i&2){let e=c(2).$implicit,t=c(),o=c(2);p("ngTemplateOutlet",o.rowTemplate().templateRef)("ngTemplateOutletContext",Y(2,We,t[e.uuid]||t[e.name]))}}function Xe(i,n){if(i&1){let e=b();a(0,"div",12)(1,"input",9),D("ngModelChange",function(o){u(e);let r=c().$implicit,s=c(3);return k(s.rowsToSkip[r.name],o)||(s.rowsToSkip[r.name]=o),f(o)}),l(),a(2,"span"),_(3),l(),w(4,He,1,4,"ng-container"),l()}if(i&2){let e=c().$implicit,t=c(3);P("disabled",t.rowsToUpdate[e.name])("skip",t.rowsToUpdate[e.name]),p("ngClass",t.rowsToSkip[e.name]?"skip":"duplicated"),d(),T("ngModel",t.rowsToSkip[e.name]),p("disabled",t.rowsToAdd[e.name]||t.rowsToUpdate[e.name]),d(2),ge(t.rowsToSkip[e.name]?"Skip":"Duplicates"),d(),h(t.rowTemplate()?4:-1)}}function Ke(i,n){if(i&1&&(a(0,"lg-gap-column",6)(1,"div",7),w(2,Ze,2,2)(3,$e,2,2),w(4,qe,1,4,"ng-container"),l(),w(5,Xe,5,9,"div",8),l()),i&2){let e=n.$implicit,t=c(),o=c(2);p("size","small"),d(),P("update",o.rowsToUpdate[e.name])("add",o.rowsToAdd[e.name])("disabled",o.rowsToSkip[e.name]),d(),h(t[e.uuid]||t[e.name]?2:3),d(2),h(o.rowTemplate()?4:-1),d(),h(t[e.uuid]||t[e.name]?5:-1)}}function Ye(i,n){if(i&1&&(a(0,"lg-gap-column",6),se(1,Ke,6,10,"lg-gap-column",6,Qe),l()),i&2){let e=c();p("size","medium"),d(),ce(e)}}function et(i,n){if(i&1&&(w(0,Ye,3,1,"lg-gap-column",6),ee(1,"async")),i&2){let e,t=c();h((e=te(1,1,t.analize$))?0:-1,e)}}var Ie=class i{constructor(n,e){this._csvReaderService=n;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=z();storeName=F(null);schema=F();skipAllDuplicates=v(!1);replaceAll=v(!1);rowTemplate=Ce(R);analizeSubject=new J;dataSubject=new J;data$=this.dataSubject.asObservable().pipe(G([]),q((n,e)=>e==null?[]:[...n,e]));analize$=this.analizeSubject.asObservable().pipe(G([]),q((n,e)=>e==null?[]:!e.uuid||!e.name?n:ie(oe({},n),{[e.uuid]:e,[e.name]:e})));dialog;upload=B(A);parsedData=[];onConfirm(){return O(this,null,function*(){for(let n of this.parsedData)this.rowsToAdd[n.name]?yield this._indexDbService.addData(this.storeName(),n):this.rowsToUpdate[n.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),n.uuid,n));this.clear(),this.onDone.emit(),this.dialog.close()})}onClose(){this.clear(),this.dialog.close()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToUpdate[n.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToSkip[n.name]=!0,this.rowsToUpdate[n.name]&&(this.rowsToUpdate[n.name]=!1))}):this.rowsToSkip={}}onFileSelected(n){this.dialog.open(),this._csvReaderService.readFromJSONFile(n[0]).then(e=>O(this,null,function*(){for(let t of e){let o=this.schema()?.safeParse(t);if(!o?.success){console.log("error",o?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(o.data),yield this._analyzeDuplicates(o.data).then(r=>{r.duplicate?this.analizeSubject.next(r.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(n){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",n.name).then(o=>{o.length?e({data:o,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||i)(I(M),I(L))};static \u0275cmp=g({type:i,selectors:[["lg-import"]],contentQueries:function(e,t,o){e&1&&ue(o,t.rowTemplate,R,5),e&2&&j()},viewQuery:function(e,t){if(e&1&&(V(t.upload,A,5),de(E,5)),e&2){j();let o;me(o=_e())&&(t.dialog=o.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:20,vars:23,consts:[[3,"filesSelected","accept"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(a(0,"lg-upload",0),m("filesSelected",function(r){return t.onFileSelected(r)}),a(1,"lg-button",1),_(2," Import "),l()(),a(3,"lg-dialog")(4,"lg-gap-column"),w(5,et,2,3),ee(6,"async"),a(7,"lg-gap-row",2)(8,"input",3),m("change",function(){return t.onSkipAllDuplicates()}),D("ngModelChange",function(r){return k(t.skipAllDuplicates,r)||(t.skipAllDuplicates=r),r}),l(),a(9,"label"),_(10,"Skip all duplicates"),l()(),a(11,"lg-gap-row",2)(12,"input",3),m("change",function(){return t.onReplaceAll()}),D("ngModelChange",function(r){return k(t.replaceAll,r)||(t.replaceAll=r),r}),l(),a(13,"label"),_(14,"Replace all with new"),l()(),a(15,"lg-gap-row",4)(16,"lg-button",5),m("click",function(){return t.onClose()}),_(17," Close "),l(),a(18,"lg-button",5),m("click",function(){return t.onConfirm()}),_(19," Confirm "),l()()()()),e&2){let o;p("accept",".json"),d(),C("warning"),p("flat",!0)("size","small"),d(4),h((o=te(6,21,t.data$))?5:-1,o),d(2),p("center",!0)("hidden",t.replaceAll())("size","small"),d(),T("ngModel",t.skipAllDuplicates),d(3),p("center",!0)("hidden",t.skipAllDuplicates())("size","small"),d(),T("ngModel",t.replaceAll),d(3),p("center",!0),d(),C("danger"),p("size","small"),d(2),C("success"),p("size","small")}},dependencies:[A,Q,E,be,W,Z,Ae,ke,De,Me,we,he],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var tt=["*"];function nt(i,n){if(i&1){let e=b();a(0,"lg-button",2),m("click",function(){u(e);let o=c();return f(o.onSelection())}),_(1," Hide selection "),l(),a(2,"lg-button",2),m("click",function(){u(e);let o=c();return f(o.onAllSelection())}),_(3," Select all "),l(),a(4,"lg-button",2),m("click",function(){u(e);let o=c();return f(o.onDeselectAll())}),_(5," Deselect all "),l()}i&2&&(C("success"),p("flat",!0)("size","small"),d(2),C("danger"),p("flat",!0)("size","small"),d(2),C("danger"),p("flat",!0)("size","small"))}function ot(i,n){if(i&1){let e=b();a(0,"lg-button",2),m("click",function(){u(e);let o=c();return f(o.onSelection())}),_(1," Select many "),l()}i&2&&(C("success"),p("flat",!0)("size","small"))}var Pe=class i{constructor(){}selectionMode=v("default");selectAll=v(!1);deselectAll=v(!1);selected=v(new Set);onSelection(){this.selectionMode.set(this.selectionMode()==="default"?"selection":"default"),this.selected.set(new Set)}onAllSelection(){this.selectAll.set(!0),this.deselectAll.set(!1)}onDeselectAll(){this.selectAll.set(!1),this.deselectAll.set(!0)}putSelected(n){let[e,t]=n;this.selected.update(o=>(e?o.add(t):o.delete(t),o)),console.log("selected",this.selected())}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=g({type:i,selectors:[["lg-selection-zone"]],inputs:{selectionMode:[1,"selectionMode"],selectAll:[1,"selectAll"],deselectAll:[1,"deselectAll"],selected:[1,"selected"]},outputs:{selectionMode:"selectionModeChange",selectAll:"selectAllChange",deselectAll:"deselectAllChange",selected:"selectedChange"},ngContentSelectors:tt,decls:5,vars:2,consts:[[3,"center"],[3,"flat","size","style"],[3,"click","flat","size"]],template:function(e,t){e&1&&(x(),a(0,"lg-gap-column")(1,"lg-gap-row",0),w(2,nt,6,12)(3,ot,2,4,"lg-button",1),l(),y(4),l()),e&2&&(d(),p("center",!0),d(),h(t.selectionMode()==="selection"?2:3))},dependencies:[Q,W,Z],encapsulation:2})};var it=["*"],je=class i{opened=U(!1);toggle(){this.opened.update(n=>!n)}ngOnInit(){console.log("Controls bar mounted")}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=g({type:i,selectors:[["lg-controls-bar"]],ngContentSelectors:it,decls:6,vars:3,consts:[[1,"lg-controls-bar"],[1,"lg-controls-bar__inner"],["role","button","tabindex","0",1,"lg-controls-bar__caret",3,"click","keydown.enter","swipeleft","swiperight"],["aria-hidden","false","fontIcon","chevron_left"],[1,"lg-controls-bar__content"]],template:function(e,t){e&1&&(x(),a(0,"div",0)(1,"div",1)(2,"div",2),m("click",function(){return t.toggle()})("keydown.enter",function(){return t.toggle()})("swipeleft",function(){return t.toggle()})("swiperight",function(){return t.toggle()}),pe(3,"mat-icon",3),l(),a(4,"div",4),y(5),l()()()),e&2&&(P("opened",t.opened()),p("@fromLeft",void 0))},dependencies:[Te],styles:[".lg-controls-bar[_ngcontent-%COMP%]{position:fixed;right:0;top:var(--app-content-top-padding);display:flex;gap:8px;border-radius:4px}.lg-controls-bar__inner[_ngcontent-%COMP%]{display:flex;transform:translate(calc(100% - 16px));position:relative;transition:transform .3s ease-in-out;border-radius:0 0 15px 15px;padding:0 16px}.lg-controls-bar.opened[_ngcontent-%COMP%]   .lg-controls-bar__inner[_ngcontent-%COMP%]{transform:translate(0)}.lg-controls-bar__caret[_ngcontent-%COMP%]{position:absolute;right:100%;top:0;border-radius:50%;display:flex;align-items:center;justify-content:center;padding:8px;cursor:pointer;scroll-snap-align:center;-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px);background-color:#a26dc7b3;color:#fff;transition:opacity .3s ease-in-out;scroll-snap-type:both mandatory;overscroll-behavior-x:contain}@media (hover: hover){.lg-controls-bar__caret[_ngcontent-%COMP%]:hover{background-color:#a26dc7}}.lg-controls-bar__caret[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:34px}.lg-controls-bar__caret[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:34px;height:34px}@media (max-width: 768px){.lg-controls-bar__caret[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:24px}.lg-controls-bar__caret[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:24px;height:24px}}.lg-controls-bar.opened[_ngcontent-%COMP%]   .lg-controls-bar__caret[_ngcontent-%COMP%]{background-color:#a26dc7cc;transform:rotate(180deg)}.lg-controls-bar__content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start;gap:8px;border-radius:16px;padding:16px;min-width:200px;-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px);background-color:#ffffffb3}@media (max-width: 768px){.lg-controls-bar__content[_ngcontent-%COMP%]{min-width:100px}}"],data:{animation:[ye("fromLeft",[Se(":enter",[ne({transform:"translateX(100%)"}),ve("0.3s ease-in-out",ne({transform:"translateX(0)"}))])])]}})};var Fe=class i{constructor(n,e){this._indexDbService=n;this._csvReaderService=e}exportTable(o){return O(this,arguments,function*(n,e="csv",t={}){let r=[];if(t.selected?.length?r=yield this._indexDbService.getMany(n,t.selected):r=yield this._indexDbService.getAll(n),e==="json"){this._csvReaderService.saveToJSONFile(r,this._getFileName(n,e));return}this._csvReaderService.saveToCSVFile(r,this._getFileName(n,e))})}makeCsv(n){return this._csvReaderService.makeCsv(n)}_getFileName(n,e){let t=new Date().toISOString();return`${n}_export_${t}.${e}`}static \u0275fac=function(e){return new(e||i)(H(L),H(M))};static \u0275prov=N({token:i,factory:i.\u0275fac,providedIn:"root"})};var Qt=(i,n)=>i.reduce((e,t)=>{let o=t[n]||"unknown";return e[o]||(e[o]=[]),e[o].push(t),e},{});export{R as a,M as b,Ie as c,Qt as d,Pe as e,je as f,Fe as g};
