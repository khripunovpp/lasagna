import{b as he,e as ye,i as ve,p as xe}from"./chunk-KZZMX7TE.js";import{c as N,d as Ce}from"./chunk-YBVUJ3DZ.js";import{a as we}from"./chunk-7XJBFH7X.js";import{a as ge}from"./chunk-OIABF7X4.js";import{b as fe}from"./chunk-JVT2USDN.js";import{$a as D,Aa as M,Ab as k,Bb as P,Da as g,Db as de,Ea as C,Eb as H,F as W,H as L,Ha as ie,Ia as oe,Ja as l,Ka as p,Mb as me,N as F,Oa as J,Ob as ue,Pa as h,Pb as _e,Q as B,Qa as m,Ra as s,Sa as R,Ta as O,V as _,W as f,Wa as re,Xa as ae,Ya as le,Za as se,_ as Y,_a as E,a as K,ab as pe,b as X,bb as u,cb as ce,f as V,fb as y,gb as v,hb as x,j as z,ja as c,ka as ee,kb as q,ma as T,oa as w,ob as G,pb as Z,qa as te,sa as Q,xa as d,ya as ne,za as $,zb as U}from"./chunk-AWPX63HX.js";var A=class o{constructor(n){this.templateRef=n}static \u0275fac=function(e){return new(e||o)(T(ee))};static \u0275dir=te({type:o,selectors:[["","lgImportRowTpl",""]]})};var S=class o{constructor(){}readFromCSVFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{let r=i.result,a=this.parseData(r),[ke,...Ae]=a,Ie=this.arrayToObjects(Ae,ke);e(Ie)},i.onerror=()=>{t(i.error)},i.readAsText(n)})}readFromJSONFile(n){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{try{let r=i.result,a=JSON.parse(r);e(a)}catch(r){t(r)}},i.onerror=()=>{t(i.error)},i.readAsText(n)})}parseData(n){return n.split(/\r\n|\n/).map(e=>e.split(",")).filter(e=>e.length>1&&e.some(t=>t.length>0))}arrayToObjects(n,e){return n.map(t=>{let i={};return e.forEach((r,a)=>{i[r]=t[a]}),i})}makeCsv(n){let e=Object.keys(n[0]),t=n.map(r=>e.map(a=>r[a]));return[e,...t].map(r=>r.join(",")).join(`\r
`)}saveToCSVFile(n,e){let t=this.makeCsv(n),i=new Blob([t],{type:"text/csv"}),r=URL.createObjectURL(i),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",r),a.setAttribute("download",e),a.click(),URL.revokeObjectURL(r)}saveToJSONFile(n,e){let t=JSON.stringify(n,null,2),i=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(i),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",r),a.setAttribute("download",e),a.click(),URL.revokeObjectURL(r)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=F({token:o,factory:o.\u0275fac,providedIn:"root"})};var je=["input"],Fe=["*"],b=class o{filesSelected=U();accept=k(".csv");input=P("input");onFileChange(n){let t=n.target.files?.[0];t&&this.filesSelected.emit([t])}clear(){this.input()?.nativeElement&&(this.input().nativeElement.value="",this.input().nativeElement.files=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=w({type:o,selectors:[["lg-upload"]],viewQuery:function(e,t){e&1&&E(t.input,je,5),e&2&&D()},inputs:{accept:[1,"accept"]},outputs:{filesSelected:"filesSelected"},ngContentSelectors:Fe,decls:5,vars:1,consts:[["input",""],[1,"lg-upload",3,"click"],["type","file",3,"change","accept"],[1,"lg-upload__content"]],template:function(e,t){if(e&1){let i=h();R(),l(0,"div",1),m("click",function(){_(i);let a=pe(2);return f(a.click())}),l(1,"input",2,0),m("change",function(a){return _(i),f(t.onFileChange(a))}),p(),l(3,"div",3),O(4),p()()}e&2&&(c(),d("accept",t.accept()))},styles:["input[_ngcontent-%COMP%]{display:none}"]})};var Me=["*"],j=class o{constructor(){}displayed=Y(!1);open(){this.displayed.set(!0)}close(){this.displayed.set(!1)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=w({type:o,selectors:[["lg-dialog"]],ngContentSelectors:Me,decls:6,vars:2,consts:[[1,"dialog"],[1,"dialog__container"],[1,"dialog__wrap"],[1,"dialog__box"]],template:function(e,t){e&1&&(R(),l(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"lg-card"),O(5),p()()()()()),e&2&&ne("display",t.displayed()?"flex":"none")},dependencies:[fe],styles:[".dialog[_ngcontent-%COMP%]{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;justify-content:center;align-items:center;overflow-y:auto}.dialog__container[_ngcontent-%COMP%]{max-width:80%;min-width:300px;width:100%;height:100%}.dialog__wrap[_ngcontent-%COMP%]{padding:32px}"]})};var Oe=o=>({$implicit:o,flow:"new"}),Ee=o=>({$implicit:o,flow:"old"}),Ue=(o,n)=>n.name+n.uuid;function Pe(o,n){if(o&1){let e=h();l(0,"input",9),x("ngModelChange",function(i){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToUpdate[r.name],i)||(a.rowsToUpdate[r.name]=i),f(i)}),p(),u(1," Update ")}if(o&2){let e=s().$implicit,t=s(3);y("ngModel",t.rowsToUpdate[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Ne(o,n){if(o&1){let e=h();l(0,"input",10),x("ngModelChange",function(i){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToAdd[r.name],i)||(a.rowsToAdd[r.name]=i),f(i)}),p(),u(1," Add ")}if(o&2){let e=s().$implicit,t=s(3);y("ngModel",t.rowsToAdd[e.name]),d("disabled",t.rowsToSkip[e.name])}}function Ve(o,n){o&1&&J(0)}function ze(o,n){if(o&1&&Q(0,Ve,1,0,"ng-container",11),o&2){let e=s().$implicit,t=s(3);d("ngTemplateOutlet",t.rowTemplate().templateRef)("ngTemplateOutletContext",q(2,Oe,e))}}function We(o,n){o&1&&J(0)}function Le(o,n){if(o&1&&Q(0,We,1,0,"ng-container",11),o&2){let e=s(2).$implicit,t=s(),i=s(2);d("ngTemplateOutlet",i.rowTemplate().templateRef)("ngTemplateOutletContext",q(2,Ee,t[e.uuid]||t[e.name]))}}function Be(o,n){if(o&1){let e=h();l(0,"div",12)(1,"input",9),x("ngModelChange",function(i){_(e);let r=s().$implicit,a=s(3);return v(a.rowsToSkip[r.name],i)||(a.rowsToSkip[r.name]=i),f(i)}),p(),l(2,"span"),u(3),p(),g(4,Le,1,4,"ng-container"),p()}if(o&2){let e=s().$implicit,t=s(3);$("disabled",t.rowsToUpdate[e.name])("skip",t.rowsToUpdate[e.name]),d("ngClass",t.rowsToSkip[e.name]?"skip":"duplicated"),c(),y("ngModel",t.rowsToSkip[e.name]),d("disabled",t.rowsToAdd[e.name]||t.rowsToUpdate[e.name]),c(2),ce(t.rowsToSkip[e.name]?"Skip":"Duplicates"),c(),C(t.rowTemplate()?4:-1)}}function Qe(o,n){if(o&1&&(l(0,"lg-gap-column",6)(1,"div",7),g(2,Pe,2,2)(3,Ne,2,2),g(4,ze,1,4,"ng-container"),p(),g(5,Be,5,9,"div",8),p()),o&2){let e=n.$implicit,t=s(),i=s(2);d("size","small"),c(),$("update",i.rowsToUpdate[e.name])("add",i.rowsToAdd[e.name])("disabled",i.rowsToSkip[e.name]),c(),C(t[e.uuid]||t[e.name]?2:3),c(2),C(i.rowTemplate()?4:-1),c(),C(t[e.uuid]||t[e.name]?5:-1)}}function $e(o,n){if(o&1&&(l(0,"lg-gap-column",6),ie(1,Qe,6,10,"lg-gap-column",6,Ue),p()),o&2){let e=s();d("size","medium"),c(),oe(e)}}function Je(o,n){if(o&1&&(g(0,$e,3,1,"lg-gap-column",6),G(1,"async")),o&2){let e,t=s();C((e=Z(1,1,t.analize$))?0:-1,e)}}var Te=class o{constructor(n,e){this._csvReaderService=n;this._indexDbService=e}rowsToAdd={};rowsToUpdate={};rowsToSkip={};onDone=U();storeName=k(null);schema=k();skipAllDuplicates=H(!1);replaceAll=H(!1);rowTemplate=de(A);analizeSubject=new z;dataSubject=new z;data$=this.dataSubject.asObservable().pipe(L([]),W((n,e)=>e==null?[]:[...n,e]));analize$=this.analizeSubject.asObservable().pipe(L([]),W((n,e)=>e==null?[]:!e.uuid||!e.name?n:X(K({},n),{[e.uuid]:e,[e.name]:e})));dialog;upload=P(b);parsedData=[];onConfirm(){return V(this,null,function*(){for(let n of this.parsedData)this.rowsToAdd[n.name]?yield this._indexDbService.addData(this.storeName(),n):this.rowsToUpdate[n.name]&&!this.skipAllDuplicates()&&(yield this._indexDbService.replaceData(this.storeName(),n.uuid,n));this.clear(),this.onDone.emit(),this.dialog.close()})}onClose(){this.clear(),this.dialog.close()}clear(){this.upload().clear(),this.rowsToAdd={},this.rowsToUpdate={},this.rowsToSkip={},this.parsedData=[],this.dataSubject.next(null),this.analizeSubject.next(null),this.skipAllDuplicates.set(!1),this.replaceAll.set(!1)}onReplaceAll(){this.replaceAll()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToUpdate[n.name]=!0)}):this.rowsToAdd={}}onSkipAllDuplicates(){this.skipAllDuplicates()?this.parsedData.forEach(n=>{this.rowsToAdd[n.name]||(this.rowsToSkip[n.name]=!0,this.rowsToUpdate[n.name]&&(this.rowsToUpdate[n.name]=!1))}):this.rowsToSkip={}}onFileSelected(n){this.dialog.open(),this._csvReaderService.readFromJSONFile(n[0]).then(e=>V(this,null,function*(){for(let t of e){let i=this.schema()?.safeParse(t);if(!i?.success){console.log("error",i?.error);return}if(!this.storeName()){console.log("storeName is not set");return}this.dataSubject.next(t),this.parsedData.push(i.data),yield this._analyzeDuplicates(i.data).then(r=>{r.duplicate?this.analizeSubject.next(r.data[0]):this.rowsToAdd[t.name]=!0})}}))}_analyzeDuplicates(n){return new Promise((e,t)=>{this._indexDbService.search(this.storeName(),"name",n.name).then(i=>{i.length?e({data:i,duplicate:!0}):e({data:null,duplicate:!1})})})}static \u0275fac=function(e){return new(e||o)(T(S),T(N))};static \u0275cmp=w({type:o,selectors:[["lg-import"]],contentQueries:function(e,t,i){e&1&&se(i,t.rowTemplate,A,5),e&2&&D()},viewQuery:function(e,t){if(e&1&&(E(t.upload,b,5),re(j,5)),e&2){D();let i;ae(i=le())&&(t.dialog=i.first)}},inputs:{storeName:[1,"storeName"],schema:[1,"schema"],skipAllDuplicates:[1,"skipAllDuplicates"],replaceAll:[1,"replaceAll"]},outputs:{onDone:"onDone",skipAllDuplicates:"skipAllDuplicatesChange",replaceAll:"replaceAllChange"},decls:20,vars:23,consts:[[3,"filesSelected","accept"],[3,"flat","size"],[3,"center","hidden","size"],["type","checkbox",3,"change","ngModelChange","ngModel"],[3,"center"],[3,"click","size"],[3,"size"],[1,"import-row"],[1,"import-row",2,"margin-left","16px",3,"ngClass","disabled","skip"],["type","checkbox",3,"ngModelChange","ngModel","disabled"],["checked","","type","checkbox",3,"ngModelChange","ngModel","disabled"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"import-row",2,"margin-left","16px",3,"ngClass"]],template:function(e,t){if(e&1&&(l(0,"lg-upload",0),m("filesSelected",function(r){return t.onFileSelected(r)}),l(1,"lg-button",1),u(2," Import "),p()(),l(3,"lg-dialog")(4,"lg-gap-column"),g(5,Je,2,3),G(6,"async"),l(7,"lg-gap-row",2)(8,"input",3),m("change",function(){return t.onSkipAllDuplicates()}),x("ngModelChange",function(r){return v(t.skipAllDuplicates,r)||(t.skipAllDuplicates=r),r}),p(),l(9,"label"),u(10,"Skip all duplicates"),p()(),l(11,"lg-gap-row",2)(12,"input",3),m("change",function(){return t.onReplaceAll()}),x("ngModelChange",function(r){return v(t.replaceAll,r)||(t.replaceAll=r),r}),p(),l(13,"label"),u(14,"Replace all with new"),p()(),l(15,"lg-gap-row",4)(16,"lg-button",5),m("click",function(){return t.onClose()}),u(17," Close "),p(),l(18,"lg-button",5),m("click",function(){return t.onConfirm()}),u(19," Confirm "),p()()()()),e&2){let i;d("accept",".json"),c(),M("warning"),d("flat",!0)("size","small"),c(4),C((i=Z(6,21,t.data$))?5:-1,i),c(2),d("center",!0)("hidden",t.replaceAll())("size","small"),c(),y("ngModel",t.skipAllDuplicates),c(3),d("center",!0)("hidden",t.skipAllDuplicates())("size","small"),c(),y("ngModel",t.replaceAll),c(3),d("center",!0),c(),M("danger"),d("size","small"),c(2),M("success"),d("size","small")}},dependencies:[b,Ce,j,_e,ge,we,xe,he,ye,ve,me,ue],styles:[".import-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:8px;border:1px solid #f5f5f5;border-radius:24px;padding:8px 16px}.import-row.disabled[_ngcontent-%COMP%]{opacity:.5}.import-row.skip[_ngcontent-%COMP%]{border-color:#008ad8;background-color:#dceaff}.import-row.duplicated[_ngcontent-%COMP%]{border-color:#ffbaba;background-color:#fff4f4}.import-row.update[_ngcontent-%COMP%], .import-row.add[_ngcontent-%COMP%]{border-color:#8ca68c;background-color:#e5f4e3}"]})};var De=class o{constructor(n,e){this._indexDbService=n;this._csvReaderService=e}exportTable(n,e="csv"){return this._indexDbService.getAll(n).then(t=>{if(e==="json"){this._csvReaderService.saveToJSONFile(t,this._getFileName(n,e));return}this._csvReaderService.saveToCSVFile(t,this._getFileName(n,e))})}_getFileName(n,e){let t=new Date().toISOString();return`${n}_export_${t}.${e}`}makeCsv(n){return this._csvReaderService.makeCsv(n)}static \u0275fac=function(e){return new(e||o)(B(N),B(S))};static \u0275prov=F({token:o,factory:o.\u0275fac,providedIn:"root"})};var yt=(o,n)=>o.reduce((e,t)=>{let i=t[n]||"unknown";return e[i]||(e[i]=[]),e[i].push(t),e},{});export{A as a,S as b,Te as c,yt as d,De as e};
