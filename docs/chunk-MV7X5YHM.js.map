{
  "version": 3,
  "sources": ["src/app/features/settings/const/settings-keys.const.ts", "src/app/shared/helpers/pdf-generators/prefix-generator.ts", "src/app/features/settings/service/models/Settings.ts", "src/app/features/settings/service/repositories/settings.repository.ts", "src/app/features/settings/service/services/settings.service.ts"],
  "sourcesContent": ["export enum SettingsKeysConst {\n  invoicePrefix = 'invoicePrefix',\n  invoiceLogo = 'invoiceLogo',\n  pricePrecision = 'pricePrecision',\n  currency = 'currency',\n  lang = 'lang',\n}\n", "import {Invoice} from '../../../features/invoices/service/Inovice/Invoice';\n\nexport const generateRandomInvoicePrefix = (): string => {\n  // like GT-SF or DT-AQ\n  const getRandIdx = () => Math.floor(Math.random() * letters.length);\n  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n  return `${letters[getRandIdx()]}${letters[getRandIdx()]}-${letters[getRandIdx()]}${letters[getRandIdx()]}`;\n}\n\nexport const generateInvoiceNumber = (invoice?: Invoice): string => {\n  const createdAt = new Date();\n  return `${createdAt.getFullYear()}${String(createdAt.getMonth() + 1).padStart(2, '0')}${String(createdAt.getDate()).padStart(2, '0')}-${invoice?.uuid?.slice(0, 2)}`;\n}\n", "export interface SettingGroup<T> {\n  key: string\n  data: T\n}\n\nexport class Settings {\n  constructor(\n    settings?: any,\n  ) {\n    if (settings && Array.isArray(settings)) {\n\n    }\n  }\n\n  settings = new Map<string, SettingGroup<unknown>>();\n\n  static empty() {\n    return new Settings();\n  }\n\n  static fromRaw(dto: any) {\n    if (dto instanceof Settings) {\n      return dto;\n    }\n\n    const settings = new Settings();\n    if (Array.isArray(dto)) {\n      dto.forEach((setting: SettingGroup<unknown>) => {\n        settings.addSetting(setting.key, setting.data);\n      });\n    } else {\n      Object.entries(dto).forEach(([key, data]) => {\n        settings.addSetting(key, data);\n      });\n    }\n    return settings;\n  }\n\n  addSetting<T>(key: string, data: T) {\n    this.settings.set(key, {key, data});\n  }\n\n  getSetting<T>(key: string): SettingGroup<T> | undefined {\n    return this.settings.get(key) as SettingGroup<T>;\n  }\n\n  getAllSettings(): SettingGroup<unknown>[] {\n    return Array.from(this.settings.values());\n  }\n\n  getSettingsMap(): Record<string, any> {\n    return this.getAllSettings().reduce((acc, setting) => {\n      acc[setting.key] = setting.data\n      return acc;\n    }, {} as Record<string, any>);\n  }\n\n  removeSetting(key: string) {\n    this.settings.delete(key);\n  }\n\n  toDTO() {\n    return {\n      settings: Array.from(this.settings.values())\n    };\n  }\n\n}\n", "import {Injectable} from '@angular/core';\nimport {DexieIndexDbService} from '../../../../shared/service/db/dexie-index-db.service';\nimport {Stores} from '../../../../shared/service/db/const/stores';\nimport {Settings} from '../models/Settings';\nimport {SettingsDTO} from '../schemes/Settings.scheme';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class SettingsRepository {\n  constructor(\n    public _indexDbService: DexieIndexDbService,\n  ) {\n  }\n\n  async updateSettings(settings: Settings) {\n    await this._indexDbService.clear(Stores.SETTINGS);\n    return this._indexDbService.balkAdd(Stores.SETTINGS, settings.toDTO().settings);\n  }\n\n  getOne(key: string) {\n    return this._indexDbService.search(Stores.SETTINGS, 'key', key).then((settings) => {\n      if (settings) {\n        return settings[0] as SettingsDTO['settings']\n      } else {\n        return null;\n      }\n    })\n  }\n\n  getAll() {\n    return this._indexDbService.getAll(Stores.SETTINGS).then((settings) => {\n      return Settings.fromRaw(settings);\n    })\n  }\n}\n", "import {inject, Injectable, signal} from '@angular/core';\nimport {SettingsRepository} from '../repositories/settings.repository';\nimport {LanguageService} from './language.service';\nimport {Settings} from '../models/Settings';\nimport {SettingsKeysConst} from '../../const/settings-keys.const';\nimport {LoggerService} from '../../../logger/logger.service';\nimport {generateRandomInvoicePrefix} from '../../../../shared/helpers/pdf-generators/prefix-generator';\nimport {APP_SERVER_IS_RU} from '../../../../shared/service/tokens/app-server-region.token';\nimport {WINDOW} from '../../../../shared/service/tokens/window.token';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class SettingsService {\n  constructor(\n    private _settingsRepository: SettingsRepository,\n    private _localisationService: LanguageService,\n  ) {\n  }\n\n  settingsModel?: Settings;\n  settingsSignal = signal<Settings | undefined>(undefined);\n  private _logger = inject(LoggerService).withContext({\n    label: 'SettingsService',\n    color: '#4CAF50',\n  })\n  private readonly _isRuRegion = inject(APP_SERVER_IS_RU);\n  private readonly _window = inject(WINDOW);\n\n  get lang() {\n    return this._localisationService.lang;\n  }\n\n  get languages(): string[] {\n    if (this._isRuRegion) {\n      return Array.from(new Set(['ru', this._localisationService.currentLang]))\n    }\n    return this._localisationService.languages;\n  }\n\n  loadSettings() {\n    return this._settingsRepository.getAll().then((settings) => {\n      this.settingsModel = settings;\n      this.settingsSignal.set(settings);\n      // Sync language to localStorage for JavaScript files\n      const lang = settings?.getSetting<string>(SettingsKeysConst.lang)?.data;\n      if (lang) {\n        this._window?.localStorage.setItem('lang', lang);\n      }\n      this._logger.log('Settings loaded', settings);\n      return settings;\n    });\n  }\n\n  async saveSettings() {\n    if (this.settingsModel) {\n      this.settingsSignal.set(this.settingsModel);\n      await this._settingsRepository.updateSettings(this.settingsModel);\n      this._logger.log('Settings saved', this.settingsModel);\n      return this.settingsModel;\n    } else {\n      return Promise.resolve<undefined>(undefined)\n    }\n  }\n\n  setDefaultSettings() {\n    let changed = false;\n    if (!this.settingsSignal()?.getSetting<string>(SettingsKeysConst.lang)?.data) {\n      const defaultLang = this._localisationService.lang();\n      this.settingsModel?.addSetting(SettingsKeysConst.lang, defaultLang);\n      // Store language in localStorage for JavaScript files\n      this._window?.localStorage.setItem('lang', defaultLang);\n      changed = true;\n    }\n    if (!this.settingsSignal()?.getSetting<string>(SettingsKeysConst.currency)?.data) {\n      const currency = this._isRuRegion ? 'RUB' : 'USD';\n      this.settingsModel?.addSetting(SettingsKeysConst.currency, currency);\n      changed = true;\n    }\n    if (!this.settingsSignal()?.getSetting<string>(SettingsKeysConst.invoicePrefix)?.data) {\n      this.settingsModel?.addSetting(SettingsKeysConst.invoicePrefix, generateRandomInvoicePrefix());\n      changed = true;\n    }\n\n    if (!changed) {\n      this._logger.log('Default settings already set');\n      return Promise.resolve(this.settingsModel);\n    }\n    return this.saveSettings();\n  }\n\n  changeLang(lang: string) {\n    this._localisationService.changeLang(lang);\n    this.settingsModel?.addSetting(SettingsKeysConst.lang, lang);\n    // Store language in localStorage for JavaScript files\n    this._window?.localStorage.setItem('lang', lang);\n    return this.saveSettings();\n  }\n\n  changeCurrency(currency: string) {\n    this.settingsModel?.addSetting(SettingsKeysConst.currency, currency);\n    return this.saveSettings();\n  }\n\n  getInvoicePrefix(): string | undefined {\n    return this.settingsModel?.getSetting<string>(SettingsKeysConst.invoicePrefix)?.data;\n  }\n\n  setInvoicePrefix(\n    prefix: string\n  ) {\n    this.settingsModel?.addSetting(SettingsKeysConst.invoicePrefix, prefix);\n  }\n\n  getInvoiceLogo(): string | undefined {\n    return this.settingsModel?.getSetting<string>(SettingsKeysConst.invoiceLogo)?.data;\n  }\n\n  setInvoiceLogo(\n    logo: string | null\n  ) {\n    this.settingsModel?.addSetting(SettingsKeysConst.invoiceLogo, logo);\n  }\n\n  setInvoicePrecisions(\n    precision: number | null,\n  ) {\n    this.settingsModel?.addSetting(SettingsKeysConst.pricePrecision, precision);\n  }\n\n  getInvoicePrecision(): [number, number] {\n    const precision = this.settingsModel?.getSetting<number>(SettingsKeysConst.pricePrecision)?.data;\n\n    return [precision ?? 2, precision ?? 2];\n  }\n}\n"],
  "mappings": "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",
  "names": ["SettingsKeysConst"]
}
