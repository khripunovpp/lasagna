import{a as Ee,b as Pe}from"./chunk-PQ2Y55FI.js";import{a as B}from"./chunk-LN43GMM5.js";import"./chunk-S3FYHLGE.js";import{a as Fe}from"./chunk-KVV4HYGD.js";import{a as Me,b as Oe,c as Ge}from"./chunk-4QK25GBP.js";import{a as Ve}from"./chunk-DC4SJ5W7.js";import{e as Te}from"./chunk-BKL4BFJJ.js";import{a as M}from"./chunk-VZS3BA7B.js";import{a as De,b as ke,c as Ne,d as je}from"./chunk-LY4QQ6ZK.js";import{a as Ie}from"./chunk-KSLY57VD.js";import{a as Ae}from"./chunk-ZGOGMANF.js";import{b as W}from"./chunk-SIPVOCOP.js";import{a as ue}from"./chunk-AVXGYE4I.js";import{a as Q,d as _e,f as ge,g as Ce,h as K,i as R,k as ve,m as Re,n as he,o as xe,p as ye,q as we,r as be,s as Se}from"./chunk-AHEQBTWV.js";import{a as me}from"./chunk-4KMY27TT.js";import{a as ce,b as se,c as fe}from"./chunk-CPI3FXNZ.js";import"./chunk-2DQNHQVY.js";import{a as de}from"./chunk-HL6AWMYV.js";import{a as pe}from"./chunk-GFLX5G5M.js";import"./chunk-SNDQO5FA.js";import{c as N,d as ae}from"./chunk-LN6FDTLB.js";import{o as L,r as z}from"./chunk-WGXVQ5TO.js";import"./chunk-CPBCMYDO.js";import{Ab as r,Bb as x,Cb as F,Db as A,F as P,Fb as v,Ib as f,Jb as c,Kb as O,Lb as V,Sa as a,Sb as I,Tb as G,Ub as k,Vb as d,Xa as C,Xb as j,ab as S,ac as ie,ea as m,fa as u,gc as ne,hc as oe,la as y,nb as s,pb as Z,pc as re,qb as D,qc as le,tb as _,ub as g,uc as E,vc as U,wc as $,xb as ee,yb as te,zb as o}from"./chunk-KOVCW6OE.js";import"./chunk-DELOOZDJ.js";import{a as w,b,f as X}from"./chunk-2WH2EVR6.js";var $e=["*"];function Le(n,t){if(n&1&&(o(0,"p",1),d(1),r()),n&2){let e=c();a(),j(" ",e.label()," ")}}var H=class n{constructor(){}label=E("");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=S({type:n,selectors:[["lg-control-group"]],inputs:{label:[1,"label"]},ngContentSelectors:$e,decls:4,vars:1,consts:[[1,"control-group"],[1,"control-group__label"],[1,"control-group__content"]],template:function(e,i){e&1&&(O(),o(0,"div",0),_(1,Le,2,1,"p",1),o(2,"div",2),V(3),r()()),e&2&&(a(),g(i.label()?1:-1))},styles:["[_nghost-%COMP%]{display:flex;flex:1}.control-group[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:16px}.control-group__label[_ngcontent-%COMP%]{font-size:1.2rem;margin:0}.control-group__content[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:flex-end}.control-group__content[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{flex:1}"]})};var ze=["*",[["rowActions"]]],Be=["*","rowActions"],q=class n{constructor(){}mobileMode=E(!1);static \u0275fac=function(e){return new(e||n)};static \u0275cmp=S({type:n,selectors:[["lg-controls-row"]],inputs:{mobileMode:[1,"mobileMode"]},ngContentSelectors:Be,decls:5,vars:2,consts:[[1,"controls-row"],[1,"controls-row__controls"],[1,"controls-row__actions"]],template:function(e,i){e&1&&(O(ze),o(0,"div",0)(1,"div",1),V(2),r(),o(3,"div",2),V(4,1),r()()),e&2&&Z("controls-row__mobile",i.mobileMode())},styles:[`:host{display:flex;gap:16px}.controls-row{width:100%;display:flex;align-items:flex-end;gap:16px;flex:1}.controls-row__controls,.controls-row__actions{display:flex;align-items:flex-end;gap:16px}.controls-row__controls{flex:1}.controls-row__actions{flex:0;white-space:nowrap}.controls-row__controls>*,.controls-row__actions>*{flex:1}@media (max-width: 600px){.controls-row__mobile,.controls-row__mobile .controls-row__controls{flex-direction:column;align-items:stretch}}
`],encapsulation:2})};var qe=["tooltipComponent"],Ke=["products"],Ye=["productsSelector"],Je=["nameField"],Xe=(n,t)=>(t.value.product_id==null?null:t.value.product_id.id)||t.value.name||t.value.amount;function Ze(n,t){if(n&1){let e=v();o(0,"lg-gap-column",22)(1,"lg-control",27),F(2,28),o(3,"span",29),f("click",function(){m(e);let l=c().$index,p=c();return u(p.closeTextField(l))}),d(4,"Hide"),r(),A(),o(5,"lg-input",30),f("onInputChanged",function(){m(e);let l=c().$index,p=k(6),h=c();return u(h.onIngredientSelected(p,l,["product_id","recipe_id"]))}),r()()()}n&2&&(s("size","small"),a(5),s("placeholder","Here you can write the name of the ingredient"))}function et(n,t){if(n&1){let e=v();o(0,"lg-multiselect",36),f("onSelected",function(){m(e);let l=c(2).$index,p=k(6),h=c();return u(h.onIngredientSelected(p,l,["product_id","name"]))}),r()}n&2&&s("resource","recipes")("autoLoad",!0)}function tt(n,t){if(n&1){let e=v();o(0,"lg-multiselect",37,3),f("onSelected",function(){m(e);let l=c(2).$index,p=k(6),h=c();return u(h.onIngredientSelected(p,l,["recipe_id","name"]))}),r()}n&2&&s("resource","products")("autoLoad",!0)}function it(n,t){if(n&1){let e=v();o(0,"lg-gap-column",22)(1,"lg-control"),F(2,31),o(3,"lg-button",32),f("click",function(){m(e);let l=c().$index,p=c();return u(p.closeRecipeField(l))}),d(4," Product "),r(),A(),F(5,33),o(6,"lg-button",32),f("click",function(){m(e);let l=c().$index,p=c();return u(p.openRecipeField(l))}),d(7,"Recipe "),r(),A(),F(8,28),o(9,"span",29),f("click",function(){m(e);let l=c().$index,p=c();return u(p.openTextField(l))}),d(10,"As text"),r(),A(),_(11,et,1,2,"lg-multiselect",34)(12,tt,2,2,"lg-multiselect",35),r()()}if(n&2){let e=c().$index,i=c();s("size","small"),a(3),s("flat",!0)("size","small")("active",!i.recipeFieldState()[e]),a(3),s("flat",!0)("size","small")("active",i.recipeFieldState()[e]),a(5),g(i.recipeFieldState()[e]?11:12)}}function nt(n,t){if(n&1){let e=v();F(0,16),o(1,"lg-controls-row",21),_(2,Ze,6,2,"lg-gap-column",22)(3,it,13,8,"lg-gap-column",22),o(4,"lg-control",23)(5,"lg-number-input",24,1),f("onKeydown",function(){m(e);let l=c();return u(l.addLast())}),r()(),x(7,"lg-buttons-group",25),F(8,26),o(9,"lg-button",17),f("click",function(){let l=m(e).$index,p=c();return u(p.deleteIngredient(l))}),d(10," Delete Ingredient "),r(),A(),r(),A()}if(n&2){let e=t.$index,i=c();s("formGroupName",e),a(),s("mobileMode",!0),a(),g(i.textFieldState()[e]?2:3),a(3),s("placeholder","In "+((i.form.value.ingredients==null||i.form.value.ingredients[e]==null?null:i.form.value.ingredients[e].unit)||"gram")),a(2),s("items",i.buttons),a(2),D("danger"),s("size","small")}}function ot(n,t){if(n&1&&x(0,"lg-chips-list",20),n&2){let e=c(),i=k(21);s("control",i)("items",e.topCategories())}}var T=class n{constructor(t,e,i,l,p){this._recipesRepository=t;this._selectResourcesService=e;this._router=i;this._aRoute=l;this._notificationsService=p}recipe=E(null);uuid=Pe("uuid");form=new K({name:new R(null,_e.required),description:new R(""),outcome_amount:new R(null),outcome_unit:new R(""),ingredients:new we([this._getIngredientGroup()]),category_id:new R(null)},t=>{let e=t.value?.outcome_amount,i=t.value?.outcome_unit,l=t.value?.ingredients?.reduce((p,h)=>h.unit!=="gram"?p:p+(+h.amount||0),0)||0;return e&&i=="gram"&&e>l?{outcomeAmountGreaterThanIngredients:!0}:null});textFieldState=y({});recipeFieldState=y({});buttons=[{label:"Grams",value:"gram",style:"secondary",onClick:()=>{console.log("Grams")}},{label:"Pieces",value:"piece",style:"secondary",onClick:()=>{console.log("Piece")}}];tooltipComponent=$("tooltipComponent");productsWidget=$("products");productsSelector=$("productsSelector");nameField=U("nameField");topCategories=y([]);recipeEffect=le(()=>{this.recipe()&&(this.form.reset(b(w({},this.recipe()),{ingredients:[]})),this.form.get("ingredients").clear(),this.recipe()?.ingredients.forEach((t,e)=>{this.ingredients.push(this._getIngredientGroup(t)),t.recipe_id&&this.openRecipeField(e),t.name&&this.openTextField(e)}),this.form.updateValueAndValidity(),this.form.markAsPristine())});get ingredients(){return this.form.get("ingredients")}get value(){return this.form.value}get _values(){let t=this.form.value;return ae(N(t))}get _formValid(){return this.form.valid&&!this.checkCycleRecipe(this.form.value.ingredients,this.uuid())}resetForm(t){this.ingredients.clear(),this.form.reset({}),this.addIngredient(),this._loadUsingHistory(),this.form.markAsPristine()}validateForm(){return this._formValid?!0:(this._notificationsService.error(this._notificationsService.parseFormErrors(this.form).join(", ")),!1)}productAdded(t,e){return X(this,null,function*(){yield this._selectResourcesService.load(),this.tooltipComponent()?.at(e)?.close(),this.productsWidget()?.at(e)?.stopCamera(),this.ingredients.at(e).get("product_id")?.reset({uuid:t.uuid,name:t.name})})}addLast(){let t=this.ingredients.at(this.ingredients.length-1);(t.value.name||t.value.amount||t.value.product_id)&&this.addIngredient()}ngOnInit(){this._loadUsingHistory(),this.form.valueChanges.pipe(P(100)).subscribe({next:t=>{this.checkCycleRecipe(t.ingredients,this.uuid())&&this._notificationsService.error("You cannot add a recipe to itself")}})}ngAfterViewInit(){this._selectResourcesService.load().then(t=>{}),this.nameField().focus()}addIngredient(){this.ingredients.push(this._getIngredientGroup())}deleteIngredient(t){this.ingredients.removeAt(t)}onIngredientSelected(t,e,i){t.focus();let l=this.ingredients.at(e).value;this.ingredients.at(e).patchValue(b(w({},Array.isArray(i)?i.reduce((p,h)=>b(w({},p),{[h]:null}),{}):{[i]:null}),{unit:l.product_id?.unit||l.recipe_id?.unit||"gram"}))}openTextField(t){this.textFieldState.update(e=>b(w({},e),{[t]:!0}))}closeTextField(t){this.textFieldState.update(e=>b(w({},e),{[t]:!1}))}openRecipeField(t){this.recipeFieldState.update(e=>b(w({},e),{[t]:!0}))}closeRecipeField(t){this.recipeFieldState.update(e=>b(w({},e),{[t]:!1}))}checkCycleRecipe(t,e){let i=!1;for(let l of t){let p=l.recipe_id?.uuid;if(p&&p===e){i=!0;break}}return i}_loadUsingHistory(){this._recipesRepository.getTopCategories().then(t=>{this.topCategories.set(t.map(e=>({label:e.name,value:e.uuid})))})}_getIngredientGroup(t){return new K({name:new R(t?.name),amount:new R(t?.amount?.toString()??null),product_id:new R(t?.product_id?t.product_id:null),recipe_id:new R(t?.recipe_id?t.recipe_id:null),unit:new R(t?.unit??"gram")},e=>{if(!e.value.product_id&&!e.value.name&&!e.value.recipe_id&&!parseFloat(e.value.amount))return null;if((e.value.product_id||e.value.name||e.value.recipe_id)&&!parseFloat(e.value.amount))return{ingredientAmountRequired:!0};if(!this.uuid)return null;let i=this.uuid();return this.checkCycleRecipe([e.value],i)?{cycleRecipe:!0}:!e.value.product_id&&!e.value.name&&!e.value.recipe_id?{ingredientRequired:!0}:null})}static \u0275fac=function(e){return new(e||n)(C(B),C(M),C(z),C(L),C(W))};static \u0275cmp=S({type:n,selectors:[["lg-add-recipe-form"]],viewQuery:function(e,i){e&1&&(I(i.tooltipComponent,qe,5),I(i.productsWidget,Ke,5),I(i.productsSelector,Ye,5),I(i.nameField,Je,5)),e&2&&G(4)},inputs:{recipe:[1,"recipe"]},features:[ie([{provide:M,useClass:M}])],decls:23,vars:14,consts:[["nameField",""],["amount",""],["categorySelect",""],["productsSelector",""],[3,"formGroup"],[3,"position"],["label","Name","lgExpand",""],["formControlName","name",3,"key","resource"],["label","Description","lgExpand",""],["formControlName","description",3,"placeholder"],["lgExpand","",3,"mobileMode"],["label","Amount of the outcome","lgExpand",""],["formControlName","outcome_amount","lgParseMath","",3,"placeholder"],["formControlName","outcome_unit",3,"items"],["label","Ingredients","lgExpand",""],["formArrayName","ingredients","lgExpand",""],[3,"formGroupName"],[3,"click","size"],["label","Category","lgExpand",""],["formControlName","category_id",3,"resource"],[3,"control","items"],[3,"mobileMode"],[3,"size"],["label","Amount"],["lgParseMath","","formControlName","amount",3,"onKeydown","placeholder"],["formControlName","unit",3,"items"],["ngProjectAs","rowActions",5,["rowActions"]],["label","Name"],["ngProjectAs","endLabelTpl",5,["endLabelTpl"]],[3,"click"],["formControlName","name",3,"onInputChanged","placeholder"],["ngProjectAs","labelTpl",5,["labelTpl"]],[3,"click","flat","size","active"],["ngProjectAs","afterLabelTpl",5,["afterLabelTpl"]],["formControlName","recipe_id",3,"resource","autoLoad"],["formControlName","product_id",3,"resource","autoLoad"],["formControlName","recipe_id",3,"onSelected","resource","autoLoad"],["formControlName","product_id",3,"onSelected","resource","autoLoad"]],template:function(e,i){if(e&1){let l=v();o(0,"form",4)(1,"lg-gap-column",5)(2,"lg-control",6),x(3,"lg-autocomplete",7,0),r(),o(5,"lg-control",8),x(6,"lg-textarea",9),r(),o(7,"lg-controls-row",10)(8,"lg-control",11),x(9,"lg-number-input",12,1),r(),x(11,"lg-buttons-group",13),r(),o(12,"lg-control-group",14)(13,"lg-gap-column",5)(14,"lg-gap-column",15),ee(15,nt,11,8,"ng-container",16,Xe),r(),o(17,"lg-button",17),f("click",function(){return m(l),u(i.addIngredient())}),d(18," Add Ingredient "),r()()(),o(19,"lg-control",18),x(20,"lg-multiselect",19,2),r(),_(22,ot,1,2,"lg-chips-list",20),r()()}e&2&&(s("formGroup",i.form),a(),s("position","start"),a(2),s("key","name")("resource","recipes-names"),a(3),s("placeholder","Describe your recipe, how to make it, what to pay attention to, etc."),a(),s("mobileMode",!0),a(2),s("placeholder",i.form.value.outcome_unit||"Here you can write the amount of the outcome (e.g. 100, 12, etc.)"),a(2),s("items",i.buttons),a(2),s("position","start"),a(2),te(i.ingredients.controls),a(2),D("success"),s("size","small"),a(3),s("resource","recipes-categories"),a(2),g(i.topCategories().length?22:-1))},dependencies:[Se,ve,ge,Ce,Re,ye,he,xe,Ae,Ie,H,me,Q,Ee,Te,De,q,Ve,Ne,Me,Oe,Ge,be],encapsulation:2})};function rt(n,t){if(n&1&&(d(0),ne(1,"timeAgo")),n&2){let e,i=c(2);j(" (last edited ",oe(1,1,(e=i.recipe())==null?null:e.updatedAt),") ")}}function lt(n,t){if(n&1&&(o(0,"lg-title"),d(1,"Edit Recipe"),r(),_(2,rt,2,3)),n&2){let e,i=c();a(2),g((e=i.recipe())!=null&&e.updatedAt?2:-1)}}function at(n,t){n&1&&(o(0,"lg-title"),d(1,"Add Recipe"),r())}function ct(n,t){n&1&&d(0," (saved as draft) ")}function st(n,t){if(n&1){let e=v();o(0,"lg-button",5),f("click",function(){m(e);let l=c();return u(l.onEditRecipe())}),d(1," Edit Recipe "),r()}}function pt(n,t){if(n&1){let e=v();o(0,"lg-button",5),f("click",function(){m(e);let l=c();return u(l.onAddRecipe())}),d(1," Add Recipe "),r()}}function dt(n,t){if(n&1){let e=v();o(0,"lg-button",5),f("click",function(){m(e);let l=c();return u(l.onRemoveDraft())}),d(1," Delete this draft "),r()}n&2&&D("danger")}var Ue=class n{constructor(t,e,i,l){this._router=t;this._aRoute=e;this._recipesRepository=i;this._notificationsService=l;this._aRoute.data.pipe(Fe()).subscribe(p=>{this.recipe.set(p.recipe||null)})}draftOrRecipeUUID=y(void 0);recipe=y(null);formComponent=U(T);draftRef=y(null);draftByExistingRecipe=re(()=>this.draftRef().meta?.uuid);isDraftRoute=y(!1);re=ke;ngOnInit(){this._aRoute.params.subscribe(t=>{this.draftOrRecipeUUID.set(t.uuid),this._loadRecipe(this.draftOrRecipeUUID())}),this._aRoute.data.subscribe(t=>{t.draft&&(this.draftRef.set(t.draft),this.recipe.set(t.draft.data)),this.isDraftRoute.set(!!t.draftRoute)})}ngAfterViewInit(){this.formComponent()?.form.valueChanges.pipe(P(500)).subscribe(t=>{this.formComponent().form.dirty&&(this.draftRef()?.uuid?this._recipesRepository.updateDraftRecipe(this.draftRef().uuid,t,this.draftRef().meta?.uuid):this.draftRef.set(this._recipesRepository.saveDraftRecipe(t,this.draftOrRecipeUUID()??"")))})}onAddRecipe(){this.formComponent()?.validateForm()&&this._addRecipe(this.formComponent().value)}onEditRecipe(){this.formComponent()?.validateForm()&&this._editRecipe(this.formComponent().value)}onRemoveDraft(){this._removeDraft(),this._router.navigate(["recipes"])}_addRecipe(t){this._recipesRepository.addRecipe(N(t)).then(()=>{this.formComponent()?.resetForm(),this._notificationsService.success("Recipe added"),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes"])})}_editRecipe(t){if(!this.draftOrRecipeUUID())return;let e=this.draftRef()?.meta?.uuid??this.draftOrRecipeUUID();this._recipesRepository.editRecipe(e,N(t)).then(()=>{this.formComponent()?.resetForm(t),this._notificationsService.success("Recipe edited"),this.draftRef()&&this._removeDraft(),this.isDraftRoute()&&this._router.navigate(["recipes","edit",e])})}_removeDraft(){this.draftRef()&&(this._recipesRepository.removeDraftRecipe(this.draftRef().uuid),this.draftRef.set(null))}_loadRecipe(t){t&&this._recipesRepository.getOne(t).then(e=>{e&&this.recipe.set(e)})}static \u0275fac=function(e){return new(e||n)(C(z),C(L),C(B),C(W))};static \u0275cmp=S({type:n,selectors:[["app-add-recipe"]],viewQuery:function(e,i){e&1&&I(i.formComponent,T,5),e&2&&G()},decls:12,vars:9,consts:[[3,"center","mobileMode"],[3,"recipe"],[3,"mobileMode","relaxed"],["lgShrink",""],["lgShrink","",3,"style"],["lgShrink","",3,"click"]],template:function(e,i){e&1&&(o(0,"lg-fade-in")(1,"lg-container")(2,"lg-gap-row",0),_(3,lt,3,1)(4,at,2,0,"lg-title"),_(5,ct,1,0),r(),o(6,"lg-card"),x(7,"lg-add-recipe-form",1),r(),o(8,"lg-gap-row",2),_(9,st,2,0,"lg-button",3)(10,pt,2,0,"lg-button",3),_(11,dt,2,2,"lg-button",4),r()()()),e&2&&(a(2),s("center",!0)("mobileMode",!0),a(),g(i.recipe()&&!i.draftRef()||i.draftRef()&&i.draftByExistingRecipe()?3:4),a(2),g(i.draftRef()?5:-1),a(2),s("recipe",i.recipe()),a(),s("mobileMode",!0)("relaxed",!0),a(),g(i.recipe()&&!i.draftRef()||i.draftRef()&&i.draftByExistingRecipe()?9:10),a(2),g(i.isDraftRoute()?11:-1))},dependencies:[ce,se,pe,T,Q,fe,de,je,ue],encapsulation:2})};export{Ue as AddRecipeComponent};
