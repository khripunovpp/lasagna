import{a as g}from"./chunk-NM3VQREC.js";import{a as p,b as _}from"./chunk-CL46QNG2.js";import{g as m}from"./chunk-X5YAN5AH.js";import{U as u,Y as r,f as d}from"./chunk-SYQBEC7E.js";import{a as c,b as s,f as n}from"./chunk-2WH2EVR6.js";var f=class a{constructor(e,t,i,o){this._indexDbService=e;this._usingHistoryService=t;this._categoryRepository=i;this._draftFormsService=o}_stream$=new d;get recipes$(){return this._stream$.asObservable()}addRecipe(e){return n(this,null,function*(){return this._indexDbService.addData("recipesStore",e).then(t=>(e.category_id&&this._saveCategory(e.category_id),t))})}loadRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>(this._stream$.next(e),e))}getRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>e.toSorted((t,i)=>t.name.localeCompare(i.name)))}getOne(e){return n(this,null,function*(){return new Promise((t,i)=>n(this,null,function*(){if(!e){t(void 0);return}e=e.uuid||e,yield this._indexDbService.getOne("recipesStore",e).then(o=>{t(this.recipeFromDTO(o))})}))})}editRecipe(e,t){return this._indexDbService.replaceData("recipesStore",e,t)}saveDraftRecipe(e,t){return this._draftFormsService.setDraftForm("draft_recipes",e,t?.length?"edit":"add",t?{uuid:t}:{})}updateDraftRecipe(e,t,i){return this._draftFormsService.updateDraftForm("draft_recipes",t,e,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftRecipe(e){let t=this._draftFormsService.getDraftForms("draft_recipes");return e&&t?.[e]?[t?.[e]]:t?Object.values(t):[]}removeDraftRecipe(e){this._draftFormsService.removeDraftForm("draft_recipes",e)}deleteRecipe(e){return this._indexDbService.remove("recipesStore",e)}ingredientToDto(e){return{name:e.name,amount:e.amount,unit:e.unit,product_id:e.product_id?.uuid,recipe_id:e.recipe_id?.uuid,uuid:e.uuid}}recipeFromDTO(e){if(e)return{name:e.name,description:e.description,outcome_amount:e.outcome_amount,outcome_unit:e.outcome_unit,uuid:e.uuid,ingredients:e.ingredients.map(t=>s(c({},t),{product_id:t.product_id?{uuid:t.product_id}:void 0,recipe_id:t.recipe_id?{uuid:t.recipe_id}:void 0})),taxTemplateName:e.taxTemplateName,category_id:e.category_id?{uuid:e.category_id}:null}}recipeToDto(e){return{name:e.name,description:e.description,outcome_amount:e.outcome_amount,outcome_unit:e.outcome_unit,uuid:e.uuid,ingredients:e.ingredients.map(t=>this.ingredientToDto(t)),taxTemplateName:e.taxTemplateName,category_id:e.category_id?e.category_id.uuid:null}}getTopCategories(){let{top:e}=this._usingHistoryService.read("recipes_categories"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._categoryRepository.getManyCategories(t).then(i=>i.toSorted((o,R)=>e[R.uuid].count>e[o.uuid].count?1:-1))}_saveCategory(e){this._usingHistoryService.count("recipes_categories",e)}static \u0275fac=function(t){return new(t||a)(r(m),r(p),r(g),r(_))};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{f as a};
