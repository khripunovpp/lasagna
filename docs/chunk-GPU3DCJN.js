import{a as g,b as v}from"./chunk-EAZWZNEB.js";import{a as o,b as d,c as y,d as l,e as D,f as S}from"./chunk-PCM6VO4L.js";import{z as R}from"./chunk-Z5IKK74Y.js";import{U as _,Y as s,f}from"./chunk-RDTQHNEQ.js";import{a as p,b as h,f as c}from"./chunk-2WH2EVR6.js";var m=class n{constructor(e){this.name=e.name,this.amount=o(e.amount),this.product_id=e.product_id?y.fromRaw(typeof e.product_id=="string"?{uuid:e.product_id}:e.product_id):void 0,this.recipe_id=e.recipe_id,this.unit=e.unit}name;product_id;recipe_id;amount;unit;get blanked(){return!this.amount}get typeSelected(){return!!this.product_id||!!this.recipe_id||!!this.name}get amountValid(){return o(this.amount)>0}get allEmpty(){return!this.name&&!this.amount&&!this.product_id&&!this.recipe_id}static fromRaw(e){return new n({name:e?.name,amount:e?.amount,product_id:e?.product_id,recipe_id:e?.recipe_id,unit:e?.unit})}static empty(){return new n({name:"",amount:0,product_id:void 0,recipe_id:void 0,unit:"gram"})}toDTO(){return{name:this.name?.trim(),amount:o(this.amount),product_id:this.product_id?.uuid,recipe_id:this.recipe_id,unit:this.unit||"gram"}}update(e){return this.name=e?.name||this.name,this.amount=e?.amount||this.amount,this.product_id=e?.product_id||this.product_id,this.recipe_id=e?.recipe_id||this.recipe_id,this.unit=e?.unit||this.unit,this}};var a=class n{constructor(e){this.name=String(e.name).trim(),this.description=String(e.description).trim(),this.ingredients=e.ingredients.map(t=>m.fromRaw(t)),this.outcome_amount=parseFloat(String(e.outcome_amount)),this.outcome_unit=String(e.outcome_unit)||"gram",this.uuid=String(e.uuid).trim()||void 0,this.taxTemplateName=String(e.taxTemplateName).trim()||void 0,this.category_id=g.fromRaw(typeof e.category_id=="string"?{uuid:e.category_id}:e.category_id),this.tags=e.tags?.map(t=>d.fromRaw(t)),this.createdAt=e.createdAt?Number(e.createdAt):void 0,this.updatedAt=e.updatedAt?Number(e.updatedAt):void 0}name;description;ingredients;outcome_amount;outcome_unit;uuid;taxTemplateName;category_id;createdAt;updatedAt;tags;removeIngredient(e){this.ingredients.splice(e,1)}addIngredient(e){this.ingredients.push(e)}get valid(){return this.name&&this.ingredients.length>0&&this.outcome_amount>0&&this.category_id}get totalIngredientsWeight(){return this.ingredients.reduce((e,t)=>e+t.amount*(t.unit==="gram"?1:0),0)}get checkCycleRecipe(){let e=!1;for(let t of this.ingredients){let i=t.recipe_id;if(i&&i===this.uuid){e=!0;break}}return e}get outcomeAmountGreaterThanIngredients(){return o(this.outcome_amount)>this.totalIngredientsWeight}static fromRaw(e){return new n({name:e?.name||"",description:e?.description||"",ingredients:e?.ingredients||[],outcome_amount:e?.outcome_amount||0,outcome_unit:e?.outcome_unit||"gram",uuid:e?.uuid,taxTemplateName:e?.taxTemplateName,category_id:e?.category_id,createdAt:e?.createdAt,updatedAt:e?.updatedAt,tags:e?.tags})}static empty(){return new n({name:"",description:"",ingredients:[],outcome_amount:0,outcome_unit:"gram",uuid:void 0,taxTemplateName:void 0,category_id:null,createdAt:void 0,updatedAt:void 0})}clearEmpty(){this.ingredients=this.ingredients.filter(e=>!e.blanked)}toDTO(){return{name:this.name,description:this.description,ingredients:this.ingredients.map(e=>e.toDTO()),outcome_amount:this.outcome_amount,outcome_unit:this.outcome_unit,uuid:this.uuid,taxTemplateName:this.taxTemplateName,category_id:this.category_id.toUUID(),createdAt:this.createdAt||Date.now(),updatedAt:this.updatedAt||Date.now(),tags:this.tags?.map(e=>e.toString())}}update(e){this.name=e?.name||this.name,this.description=e?.description||this.description,this.ingredients=e?.ingredients?e.ingredients.map(t=>m.fromRaw(t)):this.ingredients,this.outcome_amount=e?.outcome_amount||this.outcome_amount,this.outcome_unit=e?.outcome_unit||this.outcome_unit,this.uuid=e?.uuid||this.uuid,this.taxTemplateName=e?.taxTemplateName||this.taxTemplateName,this.category_id=g.fromRaw(e?.category_id)||this.category_id,this.createdAt=e?.createdAt||this.createdAt,this.updatedAt=e?.updatedAt||Date.now(),this.tags=e?.tags?e.tags.map(t=>d.fromRaw(t)):this.tags}};var T=class n{constructor(e,t,i,r,u){this._indexDbService=e;this._usingHistoryService=t;this._categoryRepository=i;this._draftFormsService=r;this._tagsRepository=u}_stream$=new f;get recipes$(){return this._stream$.asObservable()}addRecipe(e){return c(this,null,function*(){e.clearEmpty();let t=e.toDTO(),i=yield this._indexDbService.addData("recipesStore",t);if(t.category_id&&this._saveCategory(t.category_id),this._saveRecipeToHistory(i),e.tags?.length)for(let r of e.tags)yield this._saveTag(r);return i})}loadRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>{let t=e.map(i=>a.fromRaw(i));return this._stream$.next(t),t})}getRecipes(){return this._indexDbService.getAll("recipesStore").then(e=>e.map(t=>a.fromRaw(t)).toSorted((t,i)=>t.name.localeCompare(i.name)))}getOne(e){return c(this,null,function*(){return new Promise((t,i)=>c(this,null,function*(){if(!e){t(void 0);return}e=e.uuid||e,yield this._indexDbService.getOne("recipesStore",e).then(r=>{t(a.fromRaw(r))})}))})}editRecipe(e,t){return c(this,null,function*(){if(t.clearEmpty(),yield this._indexDbService.replaceData("recipesStore",e,t.toDTO()),this._saveRecipeToHistory(e),t.tags?.length)for(let i of t.tags)yield this._saveTag(i)})}saveDraftRecipe(e,t){let i=this._draftFormsService.setDraftForm("draft_recipes",e.toDTO(),t?.length?"edit":"add",t?{uuid:t}:{});return i?h(p({},i),{data:e}):void 0}updateDraftRecipe(e,t,i){this._draftFormsService.updateDraftForm("draft_recipes",t.toDTO(),e,i?.length?"edit":"add",i?{uuid:i}:{})}getDraftRecipe(e){let t=this._draftFormsService.getDraftForms("draft_recipes");return e&&t?.[e]?[t?.[e]]:t?Object.values(t):[]}removeDraftRecipe(e){this._draftFormsService.removeDraftForm("draft_recipes",e)}deleteRecipe(e){return this._indexDbService.remove("recipesStore",e)}getTopCategories(){let{top:e}=this._usingHistoryService.read("recipes_categories"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._categoryRepository.getManyCategories(t).then(i=>i.toSorted((r,u)=>!r.uuid||!u.uuid?0:e[u.uuid].count>e[r.uuid].count?1:-1))}getLastRecipes(){let{top:e}=this._usingHistoryService.read("recipes"),t=Object.keys(e);return t.length===0?Promise.resolve([]):this._indexDbService.getMany("recipesStore",t).then(i=>i.toSorted((r,u)=>e[u.uuid].count>e[r.uuid].count?1:-1).map(r=>({recipe:a.fromRaw(r),updatedAt:e[r.uuid].updatedAt,count:e[r.uuid].count})))}_saveCategory(e){this._usingHistoryService.count("recipes_categories",e)}_saveRecipeToHistory(e){this._usingHistoryService.count("recipes",e)}_saveTag(e){return this._tagsRepository.addOne(e)}static \u0275fac=function(t){return new(t||n)(s(R),s(l),s(v),s(D),s(S))};static \u0275prov=_({token:n,factory:n.\u0275fac,providedIn:"root"})};export{m as a,a as b,T as c};
