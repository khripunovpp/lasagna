{
  "version": 3,
  "sources": ["src/app/features/home/service/storage-quota.service.ts"],
  "sourcesContent": ["import {inject, Injectable, signal} from '@angular/core';\nimport {WINDOW} from '../../../shared/service/tokens/window.token';\n\nexport interface StorageQuotaSnapshot {\n  timestamp: number;\n  supported: {\n    storageEstimate: boolean;\n    indexedDB: boolean;\n    localStorage: boolean;\n  };\n  total: {\n    usageBytes: number | null;\n    quotaBytes: number | null;\n    availableBytes: number | null;\n  };\n  indexedDb: {\n    usageBytes: number | null;\n  };\n  localStorage: {\n    usageBytes: number;\n    quotaBytesApprox: number;\n    availableBytesApprox: number;\n  };\n}\n\n@Injectable({providedIn: 'root'})\nexport class StorageQuotaService {\n  constructor() {\n    this.refresh();\n  }\n\n  private static readonly DEFAULT_LOCAL_STORAGE_QUOTA_BYTES = 5 * 1024 * 1024; // ~5MB\n  private readonly _window = inject(WINDOW);\n  private readonly snapshotSignal = signal<StorageQuotaSnapshot>({\n    timestamp: Date.now(),\n    supported: this._window ? {\n      storageEstimate: typeof this._window.navigator !== 'undefined' && !!this._window.navigator.storage && !!this._window.navigator.storage.estimate,\n      indexedDB: typeof this._window.indexedDB !== 'undefined',\n      localStorage: typeof this._window.localStorage !== 'undefined',\n    } : {\n      storageEstimate: false,\n      indexedDB: false,\n      localStorage: false,\n    },\n    total: {usageBytes: null, quotaBytes: null, availableBytes: null},\n    indexedDb: {usageBytes: null},\n    localStorage: {\n      usageBytes: 0,\n      quotaBytesApprox: StorageQuotaService.DEFAULT_LOCAL_STORAGE_QUOTA_BYTES,\n      availableBytesApprox: StorageQuotaService.DEFAULT_LOCAL_STORAGE_QUOTA_BYTES,\n    },\n  });\n\n  get snapshot() {\n    return this.snapshotSignal;\n  }\n\n  async refresh(): Promise<void> {\n    await Promise.all([this.refreshEstimatePart(), this.refreshLocalStoragePart()]);\n  }\n\n  // No periodic tracking by design; call refresh() manually when needed\n\n  private async refreshEstimatePart(): Promise<void> {\n    const supportsEstimate = typeof this._window?.navigator !== 'undefined' && !!this._window.navigator.storage && !!this._window.navigator.storage.estimate;\n\n    if (!supportsEstimate) {\n      this.snapshotSignal.update((prev) => ({\n        ...prev,\n        timestamp: Date.now(),\n        supported: {...prev.supported, storageEstimate: false},\n        total: {usageBytes: null, quotaBytes: null, availableBytes: null},\n        indexedDb: {usageBytes: null},\n      }));\n      return;\n    }\n\n    try {\n      const estimate = await this._window?.navigator.storage.estimate();\n      const usage = estimate?.usage ?? null;\n      const quota = estimate?.quota ?? null;\n      const usageDetails: any = (estimate as any).usageDetails;\n      const idbUsage = usageDetails?.['indexedDB'] ?? null;\n\n      const available = usage != null && quota != null ? Math.max(quota - usage, 0) : null;\n\n      this.snapshotSignal.update((prev) => ({\n        ...prev,\n        timestamp: Date.now(),\n        supported: {...prev.supported, storageEstimate: true},\n        total: {usageBytes: usage, quotaBytes: quota, availableBytes: available},\n        indexedDb: {usageBytes: idbUsage},\n      }));\n    } catch {\n      this.snapshotSignal.update((prev) => ({\n        ...prev,\n        timestamp: Date.now(),\n        supported: {...prev.supported, storageEstimate: true},\n        total: {usageBytes: null, quotaBytes: null, availableBytes: null},\n        indexedDb: {usageBytes: null},\n      }));\n    }\n  }\n\n  private refreshLocalStoragePart(): void {\n    const supportsLs = typeof this._window?.localStorage !== 'undefined';\n    if (!supportsLs) {\n      this.snapshotSignal.update((prev) => ({\n        ...prev,\n        timestamp: Date.now(),\n        supported: {...prev.supported, localStorage: false},\n        localStorage: {\n          usageBytes: 0,\n          quotaBytesApprox: StorageQuotaService.DEFAULT_LOCAL_STORAGE_QUOTA_BYTES,\n          availableBytesApprox: StorageQuotaService.DEFAULT_LOCAL_STORAGE_QUOTA_BYTES,\n        },\n      }));\n      return;\n    }\n\n    const usageBytes = this.computeLocalStorageUsageBytesSafely();\n    const quotaBytesApprox = StorageQuotaService.DEFAULT_LOCAL_STORAGE_QUOTA_BYTES;\n    const availableBytesApprox = Math.max(quotaBytesApprox - usageBytes, 0);\n\n    this.snapshotSignal.update((prev) => ({\n      ...prev,\n      timestamp: Date.now(),\n      supported: {...prev.supported, localStorage: true},\n      localStorage: {usageBytes, quotaBytesApprox, availableBytesApprox},\n    }));\n  }\n\n  private computeLocalStorageUsageBytesSafely(): number {\n    try {\n      if (!this._window) {\n        return 0;\n      }\n      const encoder = typeof TextEncoder !== 'undefined' ? new TextEncoder() : null;\n      let bytes = 0;\n      for (let i = 0; i < this._window.localStorage.length; i++) {\n        const key = this._window.localStorage.key(i);\n        if (!key) continue;\n        const value = this._window.localStorage.getItem(key) ?? '';\n        if (encoder) {\n          // Count both key and value bytes\n          bytes += encoder.encode(key).length + encoder.encode(value).length;\n        } else {\n          // Fallback rough estimate (2 bytes per char)\n          bytes += (key.length + value.length) * 2;\n        }\n      }\n      return bytes;\n    } catch {\n      return 0;\n    }\n  }\n}\n\n\n"],
  "mappings": ";;;;;;;;;;;;;;;;AA0BM,IAAO,sBAAP,MAAO,qBAAmB;EAC9B,cAAA;AACE,SAAK,QAAO;EACd;EAEQ,OAAgB,oCAAoC,IAAI,OAAO;;EACtD,UAAU,OAAO,MAAM;EACvB,iBAAiB,OAA6B;IAC7D,WAAW,KAAK,IAAG;IACnB,WAAW,KAAK,UAAU;MACxB,iBAAiB,OAAO,KAAK,QAAQ,cAAc,eAAe,CAAC,CAAC,KAAK,QAAQ,UAAU,WAAW,CAAC,CAAC,KAAK,QAAQ,UAAU,QAAQ;MACvI,WAAW,OAAO,KAAK,QAAQ,cAAc;MAC7C,cAAc,OAAO,KAAK,QAAQ,iBAAiB;QACjD;MACF,iBAAiB;MACjB,WAAW;MACX,cAAc;;IAEhB,OAAO,EAAC,YAAY,MAAM,YAAY,MAAM,gBAAgB,KAAI;IAChE,WAAW,EAAC,YAAY,KAAI;IAC5B,cAAc;MACZ,YAAY;MACZ,kBAAkB,qBAAoB;MACtC,sBAAsB,qBAAoB;;KAE7C,GAAA,YAAA,CAAA,EAAA,WAAA,iBAAA,CAAA,IAAA,CAAA,CAAA;EAED,IAAI,WAAQ;AACV,WAAO,KAAK;EACd;EAEA,MAAM,UAAO;AACX,UAAM,QAAQ,IAAI,CAAC,KAAK,oBAAmB,GAAI,KAAK,wBAAuB,CAAE,CAAC;EAChF;;EAIQ,MAAM,sBAAmB;AAC/B,UAAM,mBAAmB,OAAO,KAAK,SAAS,cAAc,eAAe,CAAC,CAAC,KAAK,QAAQ,UAAU,WAAW,CAAC,CAAC,KAAK,QAAQ,UAAU,QAAQ;AAEhJ,QAAI,CAAC,kBAAkB;AACrB,WAAK,eAAe,OAAO,CAAC,SAAU,iCACjC,OADiC;QAEpC,WAAW,KAAK,IAAG;QACnB,WAAW,iCAAI,KAAK,YAAT,EAAoB,iBAAiB,MAAK;QACrD,OAAO,EAAC,YAAY,MAAM,YAAY,MAAM,gBAAgB,KAAI;QAChE,WAAW,EAAC,YAAY,KAAI;QAC5B;AACF;IACF;AAEA,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,SAAS,UAAU,QAAQ,SAAQ;AAC/D,YAAM,QAAQ,UAAU,SAAS;AACjC,YAAM,QAAQ,UAAU,SAAS;AACjC,YAAM,eAAqB,SAAiB;AAC5C,YAAM,WAAW,eAAe,WAAW,KAAK;AAEhD,YAAM,YAAY,SAAS,QAAQ,SAAS,OAAO,KAAK,IAAI,QAAQ,OAAO,CAAC,IAAI;AAEhF,WAAK,eAAe,OAAO,CAAC,SAAU,iCACjC,OADiC;QAEpC,WAAW,KAAK,IAAG;QACnB,WAAW,iCAAI,KAAK,YAAT,EAAoB,iBAAiB,KAAI;QACpD,OAAO,EAAC,YAAY,OAAO,YAAY,OAAO,gBAAgB,UAAS;QACvE,WAAW,EAAC,YAAY,SAAQ;QAChC;IACJ,QAAQ;AACN,WAAK,eAAe,OAAO,CAAC,SAAU,iCACjC,OADiC;QAEpC,WAAW,KAAK,IAAG;QACnB,WAAW,iCAAI,KAAK,YAAT,EAAoB,iBAAiB,KAAI;QACpD,OAAO,EAAC,YAAY,MAAM,YAAY,MAAM,gBAAgB,KAAI;QAChE,WAAW,EAAC,YAAY,KAAI;QAC5B;IACJ;EACF;EAEQ,0BAAuB;AAC7B,UAAM,aAAa,OAAO,KAAK,SAAS,iBAAiB;AACzD,QAAI,CAAC,YAAY;AACf,WAAK,eAAe,OAAO,CAAC,SAAU,iCACjC,OADiC;QAEpC,WAAW,KAAK,IAAG;QACnB,WAAW,iCAAI,KAAK,YAAT,EAAoB,cAAc,MAAK;QAClD,cAAc;UACZ,YAAY;UACZ,kBAAkB,qBAAoB;UACtC,sBAAsB,qBAAoB;;QAE5C;AACF;IACF;AAEA,UAAM,aAAa,KAAK,oCAAmC;AAC3D,UAAM,mBAAmB,qBAAoB;AAC7C,UAAM,uBAAuB,KAAK,IAAI,mBAAmB,YAAY,CAAC;AAEtE,SAAK,eAAe,OAAO,CAAC,SAAU,iCACjC,OADiC;MAEpC,WAAW,KAAK,IAAG;MACnB,WAAW,iCAAI,KAAK,YAAT,EAAoB,cAAc,KAAI;MACjD,cAAc,EAAC,YAAY,kBAAkB,qBAAoB;MACjE;EACJ;EAEQ,sCAAmC;AACzC,QAAI;AACF,UAAI,CAAC,KAAK,SAAS;AACjB,eAAO;MACT;AACA,YAAM,UAAU,OAAO,gBAAgB,cAAc,IAAI,YAAW,IAAK;AACzE,UAAI,QAAQ;AACZ,eAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,aAAa,QAAQ,KAAK;AACzD,cAAM,MAAM,KAAK,QAAQ,aAAa,IAAI,CAAC;AAC3C,YAAI,CAAC;AAAK;AACV,cAAM,QAAQ,KAAK,QAAQ,aAAa,QAAQ,GAAG,KAAK;AACxD,YAAI,SAAS;AAEX,mBAAS,QAAQ,OAAO,GAAG,EAAE,SAAS,QAAQ,OAAO,KAAK,EAAE;QAC9D,OAAO;AAEL,oBAAU,IAAI,SAAS,MAAM,UAAU;QACzC;MACF;AACA,aAAO;IACT,QAAQ;AACN,aAAO;IACT;EACF;;qCAjIW,sBAAmB;EAAA;4EAAnB,sBAAmB,SAAnB,qBAAmB,WAAA,YADP,OAAM,CAAA;;;sEAClB,qBAAmB,CAAA;UAD/B;WAAW,EAAC,YAAY,OAAM,CAAC;;;",
  "names": []
}
